---
title: 如何写好一个服务器
date: 2017-12-17 14:19:14
tags:
- Linux
- 网络编程
- 服务器开发
---

嗯，很久没写博客了，最近在忙着面试，我面的是PHP岗位。说一说我最近面试碰到的问题吧，大致如下：数据结构方面有快速排序，堆排序，一致性哈希算法。计算机网络方面有tcp/ip三次握手，如何确定是否是同一个tcp连接，http报文内容，http状态码。操作系统方面有进程与线程的区别，超线程，互斥锁，Linux内存管理，slab分配器，网络编程，IO多路复用的epoll模型，CGI等等。数据库方面有哈希索引和B+树索引的区别，聚集索引和非聚集索引区别等等。MVC思想，如果让你设计一个PV系统，你会怎么设计？还问了我最近看了些什么书，也是一些基础的书籍，比如《TCP/IP详解》、《UNIX环境高级编程》。额，还有一些问题不是很记得了。

可以看出，这些问题还是很基础的，不是很难，可以答个70%~80%。我面试的时候，技术官就问了我这些基础性的东西。通过这次面试，我得出了一个道理，**基础知识真的很重要**，可以说是万金油。无论哪家知名公司，都会问基础知识的。我们需要不断的阅读、写代码，去理解这些基础知识。虽然说我还是很菜，但是我还在大三，还可以学很多东西，哈哈哈哈哈......

有了这些基础知识，真的可以学得比别人快。

OK，回到正题，这篇博客分享的是**如何去写好一个服务器**。例如一些比较好用、高效的API（例如减少用户空间和内核空间数据之间的拷贝），一些服务器程序的规范（例如日志）。

这些内容主要是来自《Linux高性能服务器编程》（强烈推荐）。这是我三个月之后，第二次阅读这本书。

## Linux网络编程基础API

### 命名socket

```c
int bind(int socket, const struct sockaddr *address,
           socklen_t address_len);
```

当我们创建了一个`socket`之后，**对于服务器而言**我们需要给这个`socket`命名。就好比那些常用的服务器占有固定的端口（Web服务器一般占用80端口，Mysql占用3306端口等等）。

### 关闭连接

以前，我一直使用close这个API来关闭一个连接的，但是，我再次读这本书的时候，发现了这个API：

```c
int shutdown(int sockfd,int howto);
```

这个API可以立即终止连接。而不是将`socket`的引用计数减1。

## 高级I/O函数

### dup函数和dup2函数

有时候，我们希望把标准输入重定向到一个文件，或者把标准输出重定向到一个网络连接（比如**CGI编程**）。可以使用这两个函数来完成。

```c
int dup(int file_descriptor);
int dup2(int file_descriptor_one, int file_descriptor_two);
```

 `dup`函数创建一个新的文件描述符，该文件描述符和原有文件描述符`file_descriptor`指向相同的文件、管道或者网络连接。并且`dup`返回的文件描述符总是取系统当前可用的最小整数值。

### readv函数和writev函数

`readv`函数将数据从文件描述符读到分散的内存块中，即分散读；`writev`函数则将多块分散的内存数据一并写入文件描述符中，即集中写。

例如，一个HTTP应答包含一个状态行、多个头部字段、一个空行和文档内容。其中，前三部分可能被Web服务器放置在一块内存中，而文档的内容则通常被读入到另外一块单独的内存中（通过read函数或mmap函数）。我们并不需要把这两部分内容拼接到一起再发送，而是可以使用`writev`函数将它们同时写出。

### sendfile函数

当初我没有理解这个API，虽然知道有零拷贝这个东西，但是理解的不是很透彻。现在对Linux内核有一定的认识，再次看到这个API，眼前一亮。

`sendfile`函数在两个文件描述符之间直接传递数据（完全在内核中操作），从而避免了内核缓冲区和用户缓冲区之间的数据拷贝，效率很高，这被称为零拷贝。

### mmap函数和munmap函数

`mmap`函数用于申请一段内存空间。我们可以将这段内存空间作为进程通信的共享内存，也可以将文件直接映射到其中。

### fcntl函数

提供了对文件描述符的各种控制操作。



以上这些高级函数，很多时候我都没有去用，而是用一些更低效的函数去实现服务器。所以，下次写服务器的时候，得思考一下，在哪些地方可以去用它们，让服务器更加的高效。

（未完）