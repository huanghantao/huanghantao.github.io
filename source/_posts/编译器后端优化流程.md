---
title: 编译器后端优化流程
date: 2020-11-18 16:56:04
tags:
- 编译器
---

用一个图来总结一下：

```bash
                                                   ┌───────────────────────────────┐                                                   
                                                   │                               │                                                   
                                                   │      create IRGenerator       │                                                   
                                         ┌────────▶│                               │                                                   
                                         │         │                               │                                                   
                                         │         └───────────────────────────────┘                                                   
                                         │                         │                                                                   
                                         │                         │                                                                   
                                         │                         ▼                                                                   
                                         │         ┌───────────────────────────────┐                                                   
                                         │         │                               │                                                   
                                         │         │create cfg -- ControlFlowGraph │                                                   
                                         │         │                               │                                                   
┌───────────────────────────────┐        │         │                               │                                                   
│                               │        │         └───────────────────────────────┘                                                   
│      1. init IRGenerator      │        │                         │                                                                   
│                               │────────┤                         │                                                                   
│                               │        │                         ▼                                                                   
└───────────────────────────────┘        │         ┌───────────────────────────────┐                                                   
                │                        │         │   create entry basic block    │                                                   
                │                        │         │                               │                                                   
                │                        │         │ maybe we should set the block │                                                   
                │                        │         │     index and block name      │                                                   
                │                        │         └───────────────────────────────┘                                                   
                │                        │                         │                                                                   
                │                        │                         │                                                                   
                │                        │                         │                                                                   
                │                        │                         ▼                                                                   
                │                        │         ┌───────────────────────────────┐                                                   
                │                        │         │                               │                                                   
                │                        │         │  add the basic block to cfg   │                                                   
                │                        └────────▶│                               │                                                   
                │                                  │                               │                                                   
                │                                  └───────────────────────────────┘                                                   
                │                                                                                                                      
                │                                                                                                                      
                ▼                                                                                                                      
┌───────────────────────────────┐                  ┌───────────────────────────────┐                                                   
│                               │                  │                               │                                                   
│        2. generate IR         │                  │          expressions          │                                                   
│                               │─────────────────▶│                               │◀─┐                                                
│                               │                  │                               │  │                                                
└───────────────────────────────┘                  └───────────────────────────────┘  │                                                
                │                                                  │                  │                                                
                │                                                  │                  │                                                
                │                                                  ▼                  │                                                
                │                                  ┌───────────────────────────────┐  │                                                
                │                                  │                               │  │                                                
                ▼                                  │  get the current expression   │  │                                                
┌───────────────────────────────┐                  │                               │  │                                                
│                               │                  │                               │  │                                                
│   3. build inpred order and   │                  └───────────────────────────────┘  │                                                
│      inpost order graph       │                                  │                  │                                                
│                               │                                  │                  │                                                
└───────────────────────────────┘                                  ▼                  │                                                
                │                                  ┌───────────────────────────────┐  │     ┌───────────────────────────────┐          
                │                                  │                               │  │     │   (maybe we should set up a   │          
                │                                  │  change the expression to IR  │  │     │ mapping between the variable  │          
                ▼                                  │                               │──┼────▶│        and the block)         │          
┌───────────────────────────────┐                  │                               │  │     │                               │          
│                               │                  └───────────────────────────────┘  │     └───────────────────────────────┘          
│    4. build dominator tree    │                                  │                  │                                                
│                               │                                  │                  │                                                
│                               │                                  │                  │                                                
└───────────────────────────────┘                                  ▼                  │     ┌─────────────────────────────────────────┐
                │                                  ┌───────────────────────────────┐  │     │                                         │
                │                                  │                               │  │     │ we should create new basic block for if │
                ▼                                  │     add IR to basic block     │  │     │  statement, loop condition, loop body,  │
┌───────────────────────────────┐                  │                               │──┼────▶│then add basic block link and add to cfg.│
│                               │                  │                               │  │     │(so we should create a branch statement) │
│      5. insert PhiNodes       │                  └───────────────────────────────┘  │     │                                         │
│                               │                                  │                  │     │                                         │
│                               │                                  │                  │     └─────────────────────────────────────────┘
└───────────────────────────────┘                                  └──────────────────┘                                                
                │                                                                                                                      
                │                                                                                                                      
                ▼                                                                                                                      
┌───────────────────────────────┐                                                                                                      
│                               │                                                                                                      
│         6. build SSA          │                                                                                                      
│                               │                                                                                                      
│                               │                                                                                                      
└───────────────────────────────┘                                                                                                      
```
