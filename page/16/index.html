<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>codinghuang的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="比PHP多一些">
<meta property="og:type" content="website">
<meta property="og:title" content="codinghuang的个人博客">
<meta property="og:url" content="http://huanghantao.github.io/page/16/index.html">
<meta property="og:site_name" content="codinghuang的个人博客">
<meta property="og:description" content="比PHP多一些">
<meta property="og:locale">
<meta property="article:author" content="codinghuang">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="codinghuang的个人博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">codinghuang的个人博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">简洁些、干净些、直接些...</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://huanghantao.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-PHP扩展开发-二-处理用户传来的数组" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/12/18/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91-%E4%BA%8C-%E5%A4%84%E7%90%86%E7%94%A8%E6%88%B7%E4%BC%A0%E6%9D%A5%E7%9A%84%E6%95%B0%E7%BB%84/" class="article-date">
  <time class="dt-published" datetime="2018-12-18T09:07:30.000Z" itemprop="datePublished">2018-12-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/12/18/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91-%E4%BA%8C-%E5%A4%84%E7%90%86%E7%94%A8%E6%88%B7%E4%BC%A0%E6%9D%A5%E7%9A%84%E6%95%B0%E7%BB%84/">PHP扩展开发(二)--处理用户传来的数组</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>很多时候，我们需要处理用户传来的数组，例如我们的tinyswoole server的set函数，它是接收一个数组的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$serv-&gt;set([</span><br><span class="line">    <span class="string">&#x27;reactor_num&#x27;</span> =&gt; <span class="number">2</span>,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>

<p>然后，tinyswoole server需要保存这些数组信息。</p>
<p>这个时候，我们就需要去获取这个数组里面的值。这里，我们可以这样写：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">PHP_METHOD(tinyswoole_server, <span class="built_in">set</span>)</span><br><span class="line">&#123;</span><br><span class="line">	zval *zset = <span class="literal">NULL</span>;</span><br><span class="line">	tswServer *serv;</span><br><span class="line">	HashTable *vht;</span><br><span class="line">	zval *v;</span><br><span class="line"></span><br><span class="line">	serv = TSwooleG.serv;</span><br><span class="line"></span><br><span class="line">	ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        Z_PARAM_ARRAY(zset)</span><br><span class="line">    ZEND_PARSE_PARAMETERS_END_EX(RETURN_FALSE);</span><br><span class="line"></span><br><span class="line">    vht = Z_ARRVAL_P(zset);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (php_tinyswoole_array_get_value(vht, <span class="string">&quot;reactor_num&quot;</span>, v)) &#123;</span><br><span class="line">        convert_to_long(v);</span><br><span class="line">        serv-&gt;reactor_num = (<span class="keyword">uint16_t</span>)Z_LVAL_P(v);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		serv-&gt;reactor_num = <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>Z_ARRVAL_P(zset)</code>可以获取zval结构里面的<code>HashTable *</code>。</p>
<p>其中<code>php_tinyswoole_array_get_value</code>这个宏可以用来获取数组key所对应的值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> php_tinyswoole_array_get_value(ht, str, v)     ((v = zend_hash_str_find(ht, str, sizeof(str)-1)) &amp;&amp; !ZVAL_IS_NULL(v))</span></span><br></pre></td></tr></table></figure>

<p><code>convert_to_long</code>函数的作用是进行zval类型的转换。我们来看一看zval的数据结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span> &#123;</span></span><br><span class="line">	zend_value        value;			<span class="comment">/* value */</span></span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			ZEND_ENDIAN_LOHI_4(</span><br><span class="line">				zend_uchar    type,			<span class="comment">/* active type */</span></span><br><span class="line">				zend_uchar    type_flags,</span><br><span class="line">				zend_uchar    const_flags,</span><br><span class="line">				zend_uchar    reserved)	    <span class="comment">/* call info for EX(This) */</span></span><br><span class="line">		&#125; v;</span><br><span class="line">		<span class="keyword">uint32_t</span> type_info;</span><br><span class="line">	&#125; u1;</span><br><span class="line">	<span class="keyword">union</span> &#123;</span><br><span class="line">		<span class="keyword">uint32_t</span>     next;                 <span class="comment">/* hash collision chain */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     cache_slot;           <span class="comment">/* literal cache slot */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     lineno;               <span class="comment">/* line number (for ast nodes) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     num_args;             <span class="comment">/* arguments number for EX(This) */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     fe_pos;               <span class="comment">/* foreach position */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     fe_iter_idx;          <span class="comment">/* foreach iterator index */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     access_flags;         <span class="comment">/* class constant access flags */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     property_guard;       <span class="comment">/* single property guard */</span></span><br><span class="line">		<span class="keyword">uint32_t</span>     extra;                <span class="comment">/* not further specified */</span></span><br><span class="line">	&#125; u2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这里的<code>zend_uchar type</code>会记录变量的类型。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2018/12/18/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91-%E4%BA%8C-%E5%A4%84%E7%90%86%E7%94%A8%E6%88%B7%E4%BC%A0%E6%9D%A5%E7%9A%84%E6%95%B0%E7%BB%84/" data-id="ckkj72zrt0030f6vxdi084qxw" data-title="PHP扩展开发(二)--处理用户传来的数组" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHP 扩展开发</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-PHP扩展开发-一-获取用户传递过来的值之后，转变成zval结构" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/12/18/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91-%E4%B8%80-%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BC%A0%E9%80%92%E8%BF%87%E6%9D%A5%E7%9A%84%E5%80%BC%E4%B9%8B%E5%90%8E%EF%BC%8C%E8%BD%AC%E5%8F%98%E6%88%90zval%E7%BB%93%E6%9E%84/" class="article-date">
  <time class="dt-published" datetime="2018-12-18T04:10:25.000Z" itemprop="datePublished">2018-12-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/12/18/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91-%E4%B8%80-%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BC%A0%E9%80%92%E8%BF%87%E6%9D%A5%E7%9A%84%E5%80%BC%E4%B9%8B%E5%90%8E%EF%BC%8C%E8%BD%AC%E5%8F%98%E6%88%90zval%E7%BB%93%E6%9E%84/">PHP扩展开发(一)--把基本类型的值转变成zval结构</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>我们在开发PHP扩展的时候，经常会有需要把基本类型的值转化为zval结构的需求，这里，我给出两段代码，来完成这个需求。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line">zval *zfd;</span><br><span class="line"></span><br><span class="line">fd = <span class="number">1</span>;</span><br><span class="line">TSW_MAKE_STD_ZVAL(zfd); <span class="comment">// Let zfd point to a piece of memory in the stack</span></span><br><span class="line">ZVAL_LONG(zfd, fd); <span class="comment">// Before using ZVAL_LONG, you need to allocate memory first.</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TSW_MAKE_STD_ZVAL(p)		zval _stack_zval_##p; p = &amp;(_stack_zval_##p)</span></span><br></pre></td></tr></table></figure>

<p><code>TSW_MAKE_STD_ZVAL</code>宏的作用就是在栈上创建一块临时的内存，然后让p指针指向这块内存。然后，我们再使用<code>ZVAL_*</code>系列的函数来进行转换。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2018/12/18/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91-%E4%B8%80-%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E4%BC%A0%E9%80%92%E8%BF%87%E6%9D%A5%E7%9A%84%E5%80%BC%E4%B9%8B%E5%90%8E%EF%BC%8C%E8%BD%AC%E5%8F%98%E6%88%90zval%E7%BB%93%E6%9E%84/" data-id="ckkj72zrs002yf6vxg3pydnbn" data-title="PHP扩展开发(一)--把基本类型的值转变成zval结构" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHP 扩展开发</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-浅谈Reactor设计模式" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/12/11/%E6%B5%85%E8%B0%88Reactor%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="article-date">
  <time class="dt-published" datetime="2018-12-11T08:02:03.000Z" itemprop="datePublished">2018-12-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/12/11/%E6%B5%85%E8%B0%88Reactor%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">浅谈Reactor设计模式</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>顾名思义，Reactor是一种事件发生时候做出某种<strong>反应</strong>的机制。我们先来说一说概念，Reactor设计模式至少应该具备什么东西：</p>
<ul>
<li>事件源（Handle）</li>
<li>事件处理器 （Event Handler）</li>
<li>反应器 （Reactor）</li>
<li>同步事件分离器（Synchronous Event Demultiplexer）</li>
</ul>
<p>我们一个一个来解释一下。</p>
<p><strong>事件源</strong></p>
<p>可以产生事件的东西。例如文件，可以产生可读/可写事件。</p>
<p><strong>事件处理器</strong></p>
<p>当事件发生的时候，用来处理事件的函数。</p>
<p><strong>反应器</strong></p>
<p>注册/移除事件处理器；执行事件分发器；调度合适的事件处理器。</p>
<p><strong>同步事件分离器</strong></p>
<p>分离（区分）不同handle上发生的事件。我们可以通过操作系统为我们提供的某些接口（例如epoll）来实现同步事件分离器。</p>
<p>从上面的介绍可以看出，整个Reactor围绕的都是事件，而不是事件源。这样做的好处是可以让我们从众多的事件源中解放出来。这里贴两段代码对比一下：</p>
<p><strong>没有使用Reactor的代码</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="keyword">int</span> nfds;</span><br><span class="line"></span><br><span class="line">    nfds = epoll_wait(epollfd, events, MAXEVENTS, <span class="number">-1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nfds; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (events[i].data.fd == listenfd) &#123;</span><br><span class="line">            <span class="keyword">int</span> connfd;</span><br><span class="line">            tswEvent event;</span><br><span class="line">            event.fd = events[i].data.fd;</span><br><span class="line">            connfd = tswServer_master_onAccept(epollfd, &amp;event);</span><br><span class="line">            <span class="keyword">if</span> (serv-&gt;onConnect != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                serv-&gt;onConnect(connfd);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (events[i].events &amp; EPOLLIN) &#123;</span><br><span class="line">            <span class="keyword">int</span> n;</span><br><span class="line"></span><br><span class="line">            n = read(events[i].data.fd, buffer, MAX_BUF_SIZE);</span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">                epoll_del(epollfd, events[i].data.fd);</span><br><span class="line">                close(events[i].data.fd);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            buffer[n] = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (serv-&gt;onReceive != <span class="literal">NULL</span>) &#123;</span><br><span class="line">                serv-&gt;onReceive(serv, events[i].data.fd, buffer);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用了Reactor的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="keyword">int</span> nfds;</span><br><span class="line"></span><br><span class="line">    nfds = reactor-&gt;wait(reactor);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nfds; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> connfd;</span><br><span class="line">        tswReactorEpoll *reactor_epoll_object = reactor-&gt;object;</span><br><span class="line"></span><br><span class="line">        tswEvent *tswev = (tswEvent *)reactor_epoll_object-&gt;events[i].data.ptr;</span><br><span class="line">        <span class="keyword">if</span> (tswev-&gt;event_handler(reactor, tswev) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            tswWarn(<span class="string">&quot;event_handler error&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现，使用了Reactor的代码看起来变干净了许多。为什么会这样呢？我个人认为，第一种写法我们关注的点是复杂多变的事件源，例如，我们先判断了一下这个fd是不是listenfd，如果是的话，我们执行accept，如果不是的话，我们进行其他处理。因为第一段代码还算是业务简单，要么是accept一个客户端连接，要么是处理客户端发来的请求，但是如果业务变复杂了，应该是有点痛苦的。而第二种写法我们关注的点是<strong>事件</strong>，我们只需要调用处理事件的处理器（函数）即可。我不管你是什么类型的事件源，统一调用事件处理器。</p>
<p>为什么我这里要特别说一说Reactor呢？因为这会有助于我们理解Swoole。后续，我会介绍如何实现Reactor设计模式。同学们也可以提前学习，<a target="_blank" rel="noopener" href="https://github.com/huanghantao/tinyswoole">仓库地址</a>。也欢迎大家一起来贡献代码，一同学习如何开发服务器扩展。（不用担心没有基础，勇敢的迈出第一步）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2018/12/11/%E6%B5%85%E8%B0%88Reactor%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" data-id="ckkj72zuk00alf6vx6herfh9j" data-title="浅谈Reactor设计模式" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-怎样通俗的理解操作系统中内存管理分页和分段？" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/12/11/%E6%80%8E%E6%A0%B7%E9%80%9A%E4%BF%97%E7%9A%84%E7%90%86%E8%A7%A3%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%88%86%E9%A1%B5%E5%92%8C%E5%88%86%E6%AE%B5%EF%BC%9F/" class="article-date">
  <time class="dt-published" datetime="2018-12-11T07:26:16.000Z" itemprop="datePublished">2018-12-11</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/12/11/%E6%80%8E%E6%A0%B7%E9%80%9A%E4%BF%97%E7%9A%84%E7%90%86%E8%A7%A3%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%88%86%E9%A1%B5%E5%92%8C%E5%88%86%E6%AE%B5%EF%BC%9F/">怎样通俗的理解操作系统中内存管理分页和分段？</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近看到一个问题：<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/50796850/answer/522734117">怎样通俗的理解操作系统中内存管理分页和分段？</a></p>
<p>这个问题相信有很多初学操作系统的同学都有过。因为这两个概念有很多相似的地方，所以自然就会有疑问了。希望这篇文章可以帮助同学们理解。</p>
<p>要理解分段和分页，那么得理解为什么会出现分段和分页的技术</p>
<p>首先，这两个技术都是<strong>为了利用和管理好计算机的资源–内存</strong>。</p>
<p>在分段这个技术还没有出现之前，程序运行是需要从内存中分配出足够多的<strong>连续的</strong>内存，然后把<strong>整个</strong>程序装载进去。举个例子，某个程序大小是10M，然后，就需要有<strong>连续的</strong>10M内存空间才能把这个程序装载到内存里面。如果无法找到连续的10M内存，就无法把这个程序装载进内存里面，程序也就无法得到运行。</p>
<p>上面这种直接把整个程序装载进内存的方式是有一定的问题的。例如：</p>
<p>1、地址空间不隔离</p>
<p>如何理解地址空间不隔离？</p>
<p>举个例子，假设我有两个程序，一个是程序A，一个是程序B。程序A在内存中的地址<strong>假设</strong>是0x00000000<del>0x00000099，程序B在内存中的地址<strong>假设</strong>是0x00000100</del>x00000199。那么假设你在程序A中，本来想操作地址0x00000050，不小心<strong>手残</strong>操作了地址0x00000150，那么，不好的事情或许会发生。你影响了程序A也就罢了，你把程序B也搞了一顿。</p>
<p>2、程序运行时候的地址不确定</p>
<p>如何理解程序运行时候的地址不确定？</p>
<p>因为我们程序每次要运行的时候，都是需要装载到内存中的，假设你在程序中写死了要操作某个地址的内存，例如你要地址0x00000010。但是问题来了，你能够保证你操作的地址0x00000010真的就是你<strong>原来</strong>想操作的那个位置吗？很可能程序第一次装载进内存的位置是0x00000000<del>0x00000099，而程序第二次运行的时候，这个程序装载进内存的位置变成了0x00000200</del>0x00000299，而你操作的0x00000010地址压根就不是属于这个程序所占有的内存。</p>
<p>3、内存使用率低下</p>
<p>如何理解内存使用率低下呢？</p>
<p>举个例子，假设你写了3个程序，其中程序A大小为10M，程序B为70M，程序C的大小为30M你的计算机的内存总共有100M。</p>
<p>这三个程序加起来有110M，显然这三个程序是无法<strong>同时</strong>存在于内存中的。</p>
<p>并且最多只能够同时运行两个程序。可能是这样的，程序A占有的内存空间是0x00000000～0x00000009，程序B占有的内存空间是0x00000010～0x00000079。假设这个时候程序C要运行该怎么做？可以<strong>把其中的一个程序换出到磁盘上</strong>，然后再把程序C装载到内存中。假设是把程序A换出，那么程序C还是无法装载进内存中，因为内存中空闲的连续区域有两块，一块是原来程序A占有的那10M，还有就是从0x00000080～0x00000099这20M，所以，30M的程序C无法装载进内存中。那么，唯一的办法就是把程序B换出，保留程序A，但是，此时会有60M的内存无法利用起来，<strong>很浪费</strong>对吧。</p>
<p>然后，人们就去寻求一种办法来解决这些问题。</p>
<p>有一句话说的好：计算机科学领域的任何问题都可以通过增加一个间接的<strong>中间层</strong>来解决。</p>
<p>（这种思想在现在也用的很广泛，例如很多优秀的中间层：Nginx、Redis等等）</p>
<p>所以，分段这种技术就出现了。</p>
<p>为了实现分段的这个技术，需要引入虚拟地址空间的概念。那么什么是地址空间呢？简单的说就是可以寻址的一片空间。如果这个空间是虚拟的，我们就叫做虚拟地址空间；如果这个空间是真实存在的，我们就叫做物理地址空间。虚拟地址空间是可以<strong>任意的</strong>大的，因为是虚拟的。而物理地址空间是真实存在的，所以是有限的。</p>
<p>然后，分段这个技术做了一件什么事情呢？</p>
<p>它<strong>把虚拟地址空间映射到了物理地址空间，并且你写的程序操作的是虚拟地址</strong>。假设，程序A的虚拟地址空间是0x00000100～0x00000200。此时，不仅需要一块<strong>连续的</strong>物理内存来存放程序A，还需要把程序A的虚拟地址空间映射到（转换为）物理地址空间。可能，程序A的虚拟地址空间从0x00000100～0x00000200映射到了物理地址空间0x00000000～0x00000100。</p>
<p>那么分段的技术可以解决什么问题呢？可以解决上面1、2两个问题。</p>
<p>在问题1中，假设程序A的<strong>虚拟</strong>地址空间是0x00000000<del>0x00000099，映射到的物理地址空间是0x00000600</del>0x00000699，程序B的<strong>虚拟</strong>地址空间是0x00000100<del>0x00000199，映射到的物理地址空间是0x00000300</del>0x00000399。假设你还是手残，在程序A中操作了地址0x00000150，但是英文此时的地址0x00000150是虚拟的，而虚拟化的操作是在操作系统的掌控中的，所以，操作系统有能力判断，这个虚拟地址0x00000150是有问题的，然后阻止后续的操作。所以，<strong>体现出了</strong>隔离性。（另一种体现隔离性的方式就是，操作同一个虚拟地址，实际上<strong>可能</strong>操作的是不同的物理地址）</p>
<p>（注意，实际上，很可能程序A和程序B的虚拟地址都是0x00000000~0x00000099。这里的举例只是为了方便理解。）</p>
<p>问题2也很好的解决了。正是因为这种映射，使得程序<strong>无需关注物理地址</strong>是多少，只要虚拟地址没有改变，那么，程序就不会操作地址不当。</p>
<p>但是<strong>问题3仍然没有解决</strong>。</p>
<p>因为第三个问题是换入换出的问题，这个问题的关键是能不能在换出一个<strong>完整的</strong>程序之后，把另一个<strong>完整的</strong>程序换进来。而这种分段机制，映射的是一片<strong>连续的</strong>物理内存，所以问题3得不到解决。</p>
<p>而问题出在哪呢？就是<strong>完整和连续</strong>。</p>
<p>而分页技术的出现就是为了解决这个问题的。分页这个技术仍然是一种虚拟地址空间到物理地址空间映射的机制。但是，粒度更加的小了。单位不是整个程序，而是某个“页”，一段虚拟地址空间组成的某一页映射到一段物理地址空间组成的某一页。（如何理解这个“页”的概念，这个问题下的其他同学回答过）</p>
<p>分页这个技术，它的虚拟地址空间仍然是连续的，但是，每一页映射后的物理地址就不一定是连续的了。正是因为有了分页的概念，程序的换入换出就可以以页为单位了。那么，为什么就可以只换出某一页呢？实际上，不是为什么可以换出某一页，而是可以换出CPU还用不到的那些程序代码、数据。但是，把这些都换出到磁盘，万一下次CPU就要使用这些代码和数据怎么办？又得把这些代码、数据装载进内存。性能有影响对吧。所以，我们把换入换出的单位变小，变成了“页”。（实际上，这利用了空间局部性）</p>
<p>所以，同学们想想，问题3是不是就解决了呢？</p>
<p>所以，分段和分页的区别在于：<strong>粒度</strong>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2018/12/11/%E6%80%8E%E6%A0%B7%E9%80%9A%E4%BF%97%E7%9A%84%E7%90%86%E8%A7%A3%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E4%B8%AD%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%E5%88%86%E9%A1%B5%E5%92%8C%E5%88%86%E6%AE%B5%EF%BC%9F/" data-id="ckkj72zub00a1f6vx1o26589g" data-title="怎样通俗的理解操作系统中内存管理分页和分段？" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《就是要你懂swoole》-Server（三）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/11/29/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-Server%EF%BC%88%E4%B8%89%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2018-11-29T07:27:49.000Z" itemprop="datePublished">2018-11-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/11/29/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-Server%EF%BC%88%E4%B8%89%EF%BC%89/">《就是要你懂swoole》-Server（三）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>上一篇文章我们讲解完了下面这段代码的<code>$config</code>含义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// filename: server.php</span></span><br><span class="line"></span><br><span class="line">$config = [</span><br><span class="line">    <span class="string">&#x27;reactor_num&#x27;</span> =&gt;<span class="number">2</span>, <span class="comment">// Reactor线程个数</span></span><br><span class="line">    <span class="string">&#x27;worker_num&#x27;</span> =&gt; <span class="number">4</span>, <span class="comment">// Worker进程个数</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">$serv = <span class="keyword">new</span> swoole_server(<span class="string">&quot;0.0.0.0&quot;</span>, <span class="number">9501</span>, SWOOLE_PROCESS, SWOOLE_SOCK_TCP);</span><br><span class="line"></span><br><span class="line">$serv-&gt;set($config);</span><br><span class="line"></span><br><span class="line">$serv-&gt;on(<span class="string">&#x27;connect&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd</span>) </span>&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Client: Connect.\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$serv-&gt;on(<span class="string">&#x27;receive&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd, $from_id, $data</span>) </span>&#123;</span><br><span class="line">    $serv-&gt;send($fd, <span class="string">&quot;Server: &quot;</span>.$data);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$serv-&gt;on(<span class="string">&#x27;close&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Client: Close.\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$serv-&gt;start();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>OK，这一篇文章我们来解释剩下的部分 – serv的on方法。对应的官方文档<a target="_blank" rel="noopener" href="https://wiki.swoole.com/wiki/page/142.html">在这里</a>。</p>
<p>on方法的声明如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> Server-&gt;on(<span class="keyword">string</span> $event, mixed $callback);</span><br></pre></td></tr></table></figure>

<p>on方法是用来给我们的服务器serv<strong>注册事件回调函数</strong>的。其中，<code>$event</code>是事件名字，<code>$callback</code>是事件对应的回调函数。在上面这段代码中，分别注册了connect、receive、close，3个事件的回调函数。</p>
<p>这里，小伙伴们要注意了，<strong>on方法是用来注册事件回调函数的，不是用来注册事件的</strong>。为什么？因为这些connect、receive、close等等事件都是已经被服务器支持了的，我们通过swoole的源码可以很容易的分析出来，我后面也会给我们的tinyswoole服务器支持这些事件。</p>
<p>那么注册这些事件回调函数是为了什么？很容易理解，就是当我们的服务器遇到了这些事件之后，触发这些函数。OK，现在我们运行一下这个服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php server.php</span><br></pre></td></tr></table></figure>

<p>我们新开一个shell，输入如下命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 127.0.0.1 9501</span><br></pre></td></tr></table></figure>

<p>此时，会启动一个客户端连接我们的服务器。此时，我们查看一下服务器的输出，可以看到：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Client: Connect.</span><br></pre></td></tr></table></figure>

<p>被打印了出来。说明，服务器的<code>connect</code>事件被触发了，所以执行了回调函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd</span>) </span>&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Client: Connect.\n&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，connect是在客户端连接了服务器时触发的。</p>
<p>OK，我们在执行nc命令的这个终端中输入一个字符串<code>hello world</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nc 127.0.0.1 9501</span><br><span class="line">hello world</span><br><span class="line">Server: hello world</span><br></pre></td></tr></table></figure>

<p>你将会发现，这个nc客户端接收到了字符串<code>Server: hello world</code>。说明，我们的<code>receive</code>事件被触发了。也就是说，receive事件是在服务器收到了客户端的消息时触发。</p>
<p>OK，我们在执行nc命令的这个终端中按下<code>ctrl + c</code>。此时，nc这个客户端就会挂了（结束进程）。此时，我们查看一下服务器的输出，可以看到：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Client: Close.</span><br></pre></td></tr></table></figure>

<p>被打印了出来。说明，服务器的<code>close</code>事件被触发了。也就是说，close事件是在服务器知道客户端断开了连接时触发的。</p>
<p>OK，接下来，我们就来给我们tinyswoole服务器扩展支持on方法吧。你将会学习到如下知识点：</p>
<ul>
<li><p>如何在php扩展中注册事件回调函数。</p>
</li>
<li><p>事件触发的时候如何去执行用户定义的函数。</p>
</li>
</ul>
<p>如果小伙伴们想提前感受一下这部分功能如何去写，可以<a target="_blank" rel="noopener" href="https://github.com/huanghantao/tinyswoole/tree/dev">点击这里</a>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2018/11/29/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-Server%EF%BC%88%E4%B8%89%EF%BC%89/" data-id="ckkj72zt50068f6vx6qwqfnmr" data-title="《就是要你懂swoole》-Server（三）" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《就是要你懂swoole》-动手写一个服务器扩展（一）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/11/19/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%A9%E5%B1%95%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2018-11-19T07:45:51.000Z" itemprop="datePublished">2018-11-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/11/19/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%A9%E5%B1%95%EF%BC%88%E4%B8%80%EF%BC%89/">《就是要你懂swoole》-动手写一个服务器扩展（一）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>小伙伴们大家好，这篇博客教大家如何开发一个服务器扩展雏形。</p>
<p>我们的环境如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">操作系统：alpine（小伙伴们如果不是这个Linux发行版的话也没事）</span><br><span class="line">PHP版本：7.2.10</span><br></pre></td></tr></table></figure>

<h2 id="初始化目录结构"><a href="#初始化目录结构" class="headerlink" title="初始化目录结构"></a>初始化目录结构</h2><p>PHP官方给我们提供了构建PHP扩展的一个工具<code>ext_skel</code>，我们可以在PHP的源码（你可以在PHP的官网得到PHP源码）里面找到。</p>
<p>我们找到这个工具之后，执行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./ext_skel --extname=tinyswoole</span><br><span class="line">cd tinyswoole</span><br></pre></td></tr></table></figure>

<p>然后我们执行一下tree命令查看一下生成的目录结构：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">tree</span><br><span class="line">.</span><br><span class="line">├── CREDITS</span><br><span class="line">├── EXPERIMENTAL</span><br><span class="line">├── config.m4</span><br><span class="line">├── config.w32</span><br><span class="line">├── tinyswoole.c</span><br><span class="line">├── tinyswoole.php</span><br><span class="line">├── php_tinyswoole.h</span><br><span class="line">└── tests</span><br><span class="line">    └── 001.phpt</span><br><span class="line"></span><br><span class="line">1 directory, 8 files</span><br></pre></td></tr></table></figure>

<p>（OK，文件很多，但是我们只需要关注一部分即可）</p>
<p>我们首先在<code>tinyswoole</code>目录下面创建一个<code>src</code>目录用来存放我们开发的扩展源码。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir src</span><br><span class="line">touch src/server.c</span><br></pre></td></tr></table></figure>

<p>编辑一下<code>config.m4</code>文件，把这个文件的内容替换为如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PHP_ARG_ENABLE(tinyswoole, whether to enable tinyswoole support,</span><br><span class="line">dnl Make sure that the comment is aligned:</span><br><span class="line">[  --enable-tinyswoole           Enable tinyswoole support])</span><br><span class="line"></span><br><span class="line">if test &quot;$PHP_TINYSWOOLE&quot; !&#x3D; &quot;no&quot;; then</span><br><span class="line">  PHP_SUBST(TINYSWOOLE_SHARED_LIBADD)</span><br><span class="line">  source_file&#x3D;&quot;tinyswoole.c tinyswoole_client.c src&#x2F;client.c src&#x2F;server.c&quot;</span><br><span class="line">  PHP_NEW_EXTENSION(tinyswoole, $source_file, $ext_shared,, -DZEND_ENABLE_STATIC_TSRMLS_CACHE&#x3D;1)</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>我这里说一点，<code>source_file</code>这个变量里面的文件直接使用空格隔开的，不要用逗号哈。</p>
<p>OK，到了这一步，我们的准备工作已经做完了。我们可以开始开发服务器扩展了。</p>
<h2 id="开发扩展"><a href="#开发扩展" class="headerlink" title="开发扩展"></a>开发扩展</h2><p>我们编写我们的<code>src/server.c</code>文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim src/server.c</span><br></pre></td></tr></table></figure>

<p>然后，把这个文件的内容替换为如下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LISTENQ 10</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_BUF_SIZE 1024</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">server</span><span class="params">(<span class="keyword">char</span> *ip, <span class="keyword">int</span> port)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> listenfd;</span><br><span class="line">    <span class="keyword">int</span> connfd;</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    <span class="keyword">socklen_t</span> len;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">servaddr</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">cliaddr</span>;</span></span><br><span class="line">    <span class="keyword">char</span> buffer[MAX_BUF_SIZE];</span><br><span class="line"></span><br><span class="line">    listenfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    bzero(&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</span><br><span class="line">    servaddr.sin_family = AF_INET;</span><br><span class="line">    inet_aton(ip, &amp;(servaddr.sin_addr));</span><br><span class="line">    servaddr.sin_port = htons(port);</span><br><span class="line">    bind(listenfd, (struct sockaddr *)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</span><br><span class="line">    listen(listenfd, LISTENQ);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        len = <span class="keyword">sizeof</span>(cliaddr);</span><br><span class="line">        connfd = accept(listenfd, (struct sockaddr *)&amp;cliaddr, &amp;len);</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            n = read(connfd, buffer, MAX_BUF_SIZE);</span><br><span class="line">            <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                close(connfd);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            write(connfd, buffer, n);  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    close(listenfd);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过之前我对swoole服务器的讲解，小伙伴们应该是可以读懂这个代码的。这里我解释一下。</p>
<p>1、创建一个监听socket</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listenfd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>2、指定服务器绑定的端口</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bind(listenfd, (struct sockaddr *)&amp;servaddr, <span class="keyword">sizeof</span>(servaddr));</span><br></pre></td></tr></table></figure>

<p>3、监听客户端的连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listen(listenfd, LISTENQ);</span><br></pre></td></tr></table></figure>

<p>4、获取一个连接</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connfd = accept(listenfd, (struct sockaddr *)&amp;cliaddr, &amp;len);</span><br></pre></td></tr></table></figure>

<p>5、读取客户端发来的数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">n = read(connfd, buffer, MAX_BUF_SIZE);</span><br></pre></td></tr></table></figure>

<p>6、返回客户端数据</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">write(connfd, buffer, n);</span><br></pre></td></tr></table></figure>

<p>所以，这个服务器做的事情很简单，客户端发给服务器什么数据，服务器就原样返回给客户端。</p>
<h2 id="注册这个server函数"><a href="#注册这个server函数" class="headerlink" title="注册这个server函数"></a>注册这个server函数</h2><p>然后，我们编辑<code>tinyswoole.c</code>文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim tinyswoole.c</span><br></pre></td></tr></table></figure>

<p>把里面的内容替换为如下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_ini.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;php_tinyswoole.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">zend_class_entry *tinyswoole_ce;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_INFO_EX(arginfo_tinyswoole__construct, <span class="number">0</span>, <span class="number">0</span>, <span class="number">2</span>)</span><br><span class="line">	ZEND_ARG_INFO(<span class="number">0</span>, ip)</span><br><span class="line">    ZEND_ARG_INFO(<span class="number">0</span>, port)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> zval* <span class="title">tsw_zend_read_property</span><span class="params">(zend_class_entry *class_ptr, zval *obj, <span class="keyword">const</span> <span class="keyword">char</span> *s, <span class="keyword">int</span> len, <span class="keyword">int</span> silent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    zval rv;</span><br><span class="line">    <span class="keyword">return</span> zend_read_property(class_ptr, obj, s, len, silent, &amp;rv);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PHP_METHOD(tinyswoole_server, __construct)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">char</span> *ip;</span><br><span class="line">	<span class="keyword">size_t</span> ip_len;</span><br><span class="line">	<span class="keyword">long</span> port;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="string">&quot;sl&quot;</span>, &amp;ip, &amp;ip_len, &amp;port) == FAILURE) &#123;</span><br><span class="line">		RETURN_NULL();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	zend_update_property_string(tinyswoole_ce, getThis(), <span class="string">&quot;ip&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;ip&quot;</span>) - <span class="number">1</span>, ip);</span><br><span class="line">	zend_update_property_long(tinyswoole_ce, getThis(), <span class="string">&quot;port&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;port&quot;</span>) - <span class="number">1</span>, port);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PHP_METHOD(tinyswoole, start)</span><br><span class="line">&#123;</span><br><span class="line">	zval *ip;</span><br><span class="line">	zval *port;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;running server...\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	ip = tsw_zend_read_property(tinyswoole_ce, getThis(), <span class="string">&quot;ip&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;ip&quot;</span>) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">	port = tsw_zend_read_property(tinyswoole_ce, getThis(), <span class="string">&quot;port&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;port&quot;</span>) - <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	server(Z_STRVAL(*ip), Z_LVAL(*port));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">zend_function_entry tinyswoole_method[]=</span><br><span class="line">&#123;</span><br><span class="line">	ZEND_ME(tinyswoole_server, __construct, arginfo_tinyswoole__construct, ZEND_ACC_PUBLIC)</span><br><span class="line">	ZEND_ME(tinyswoole_server, start, <span class="literal">NULL</span>, ZEND_ACC_PUBLIC)</span><br><span class="line">	&#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PHP_MINIT_FUNCTION(tinyswoole)</span><br><span class="line">&#123;</span><br><span class="line">	zend_class_entry ce;</span><br><span class="line">	INIT_CLASS_ENTRY(ce, <span class="string">&quot;tinyswoole_server&quot;</span>, tinyswoole_method);</span><br><span class="line">	tinyswoole_ce = zend_register_internal_class(&amp;ce TSRMLS_CC);</span><br><span class="line"></span><br><span class="line">	zend_declare_property_null(tinyswoole_ce, <span class="string">&quot;ip&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;ip&quot;</span>) - <span class="number">1</span>, ZEND_ACC_PRIVATE);</span><br><span class="line">	zend_declare_property_null(tinyswoole_ce, <span class="string">&quot;port&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;port&quot;</span>) - <span class="number">1</span>, ZEND_ACC_PRIVATE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PHP_MSHUTDOWN_FUNCTION(tinyswoole)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PHP_RINIT_FUNCTION(tinyswoole)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(COMPILE_DL_TINYSWOOLE) &amp;&amp; defined(ZTS)</span></span><br><span class="line">	ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PHP_RSHUTDOWN_FUNCTION(tinyswoole)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PHP_MINFO_FUNCTION(tinyswoole)</span><br><span class="line">&#123;</span><br><span class="line">	php_info_print_table_start();</span><br><span class="line">	php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;tinyswoole support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	php_info_print_table_end();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> zend_function_entry tinyswoole_functions[] = &#123;</span><br><span class="line">	PHP_FE_END</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">zend_module_entry tinyswoole_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;tinyswoole&quot;</span>,</span><br><span class="line">	tinyswoole_functions,</span><br><span class="line">	PHP_MINIT(tinyswoole),</span><br><span class="line">	PHP_MSHUTDOWN(tinyswoole),</span><br><span class="line">	PHP_RINIT(tinyswoole),</span><br><span class="line">	PHP_RSHUTDOWN(tinyswoole),</span><br><span class="line">	PHP_MINFO(tinyswoole),</span><br><span class="line">	PHP_TINYSWOOLE_VERSION,</span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> COMPILE_DL_TINYSWOOLE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(tinyswoole)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="测试扩展"><a href="#测试扩展" class="headerlink" title="测试扩展"></a>测试扩展</h2><p>然后，我们编译这个扩展：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">phpize</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>然后，我们在php.ini配置文件里面加上这个扩展：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension&#x3D;tinyswoole</span><br></pre></td></tr></table></figure>

<p>然后，我们编写一个脚本来测试一下这个扩展：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$serv = <span class="keyword">new</span> tinyswoole_server(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9501</span>);</span><br><span class="line">$serv-&gt;start();</span><br></pre></td></tr></table></figure>

<p>执行这个脚本，你将会得到如下输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php server.php </span><br><span class="line">running server...</span><br></pre></td></tr></table></figure>

<p>然后，我们用一个客户端去连接我们写好的服务器。可以使用nc命令去连接它：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 127.0.0.1 9501</span><br></pre></td></tr></table></figure>

<p>然后，输入字符串<code>hello world</code>，你将会收到服务器发回给你的<code>hello world</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nc 127.0.0.1 9501</span><br><span class="line">hello world</span><br><span class="line">hello world</span><br></pre></td></tr></table></figure>

<p>OK，到了这里，我们的服务器扩展算是开发完成了，尽管他的功能很弱。但是，随着我们的学习，这个扩展会一步一步的变得更加的强大。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2018/11/19/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AA%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%89%A9%E5%B1%95%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="ckkj72zt7006ff6vx6p91ajpd" data-title="《就是要你懂swoole》-动手写一个服务器扩展（一）" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/swoole/" rel="tag">swoole</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《就是要你懂swoole》-Server（二）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/11/06/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-Server%EF%BC%88%E4%BA%8C%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2018-11-06T06:14:19.000Z" itemprop="datePublished">2018-11-06</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/11/06/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-Server%EF%BC%88%E4%BA%8C%EF%BC%89/">《就是要你懂swoole》-Server（二）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>小伙伴们，大家好，这篇博客给大家带来的是有关swoole server的<code>set</code>方法的相关知识。对应的官方文档<a target="_blank" rel="noopener" href="https://wiki.swoole.com/wiki/page/13.html">在这里</a>。</p>
<p>这个方法是用来设置服务器启动时候的参数的。官网中给出了一个例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$serv-&gt;set(<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;reactor_num&#x27;</span> =&gt; <span class="number">2</span>, <span class="comment">//reactor thread num</span></span><br><span class="line">    <span class="string">&#x27;worker_num&#x27;</span> =&gt; <span class="number">4</span>,    <span class="comment">//worker process num</span></span><br><span class="line">    <span class="string">&#x27;backlog&#x27;</span> =&gt; <span class="number">128</span>,   <span class="comment">//listen backlog</span></span><br><span class="line">    <span class="string">&#x27;max_request&#x27;</span> =&gt; <span class="number">50</span>,</span><br><span class="line">    <span class="string">&#x27;dispatch_mode&#x27;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">));</span><br></pre></td></tr></table></figure>

<p>我们一个一个的来看看这几个参数是什么意思。</p>
<p>第一个参数说是设置Reactor线程的数目。说到Reactor线程，我们得先理清一下swoole进程、线程的架构了。</p>
<p><img src="https://wiki.swoole.com/static/image/process.jpg" alt="来自官网的图片"></p>
<p><img src="https://wiki.swoole.com/static/uploads/wiki/201808/03/635680420659.png"></p>
<p>（图片来自官网）</p>
<p>总结一下：</p>
<ul>
<li>Master线程对连接进行accept。</li>
<li>Reactor线程处理连接，读取客户端发来的请求数据（Receive），将请求封装好后投递给work进程。</li>
<li>Work进程用来处理业务数据，然后把处理后的结果返回给Reactor线程。</li>
<li>Reactor线程将结果发送给客户端（Sendto）。</li>
</ul>
<p>（至于其他的一些功能，我们这篇文章先不讲，我们聚焦官网给出的那5个参数）</p>
<p>第二个参数说的是设置Worker进程（进程的概念请看我<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/40762899">第二篇文章</a>）的数目。</p>
<p>第三个参数说的是设置监督的backlog大小。它指定了等待<code>accept</code>系统调用的已建立连接队列的长度。</p>
<p>第四个参数说的是每个worker进程处理50次请求之后就会自动重启。</p>
<p>第五个参数说的是worker进程数据包分配模式，1代表平均分配。</p>
<p>ok，我们接下来通过实践来直观的感受一下。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$config = [</span><br><span class="line">    <span class="string">&#x27;reactor_num&#x27;</span> =&gt;<span class="number">2</span>, <span class="comment">// Reactor线程个数</span></span><br><span class="line">    <span class="string">&#x27;worker_num&#x27;</span> =&gt; <span class="number">4</span>, <span class="comment">// Worker进程个数</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">$serv = <span class="keyword">new</span> swoole_server(<span class="string">&quot;0.0.0.0&quot;</span>, <span class="number">9501</span>, SWOOLE_PROCESS, SWOOLE_SOCK_TCP);</span><br><span class="line"></span><br><span class="line">$serv-&gt;set($config);</span><br><span class="line"></span><br><span class="line">$serv-&gt;on(<span class="string">&#x27;connect&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd</span>) </span>&#123;  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Client: Connect.\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$serv-&gt;on(<span class="string">&#x27;receive&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd, $from_id, $data</span>) </span>&#123;</span><br><span class="line">    $serv-&gt;send($fd, <span class="string">&quot;Server: &quot;</span>.$data);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$serv-&gt;on(<span class="string">&#x27;close&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Client: Close.\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$serv-&gt;start();</span><br></pre></td></tr></table></figure>

<p>然后启动服务器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php server2.php</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[2018-11-06 16:35:16 @53435.0]	TRACE	php_swoole_server_before_start(:593): Create swoole_server host=0.0.0.0, port=9501, mode=2, type=1</span><br><span class="line">[2018-11-06 16:35:16 @53435.0]	TRACE	swReactorKqueue_add(:152): [THREAD #0]EP=14|FD=4, events=1</span><br><span class="line">[2018-11-06 16:35:16 @53435.0]	TRACE	swReactorKqueue_add(:152): [THREAD #1]EP=15|FD=9, events=5</span><br><span class="line">[2018-11-06 16:35:16 @53435.0]	TRACE	swReactorKqueue_add(:152): [THREAD #0]EP=16|FD=7, events=5</span><br><span class="line">[2018-11-06 16:35:16 @53435.0]	TRACE	swReactorKqueue_add(:152): [THREAD #1]EP=15|FD=13, events=5</span><br><span class="line">[2018-11-06 16:35:16 @53435.0]	TRACE	swReactorKqueue_add(:152): [THREAD #0]EP=16|FD=11, events=5</span><br><span class="line">[2018-11-06 16:35:17 #53435.2]	TRACE	swTimer_add(:171): id=1, exec_msec=1000, msec=1000, round=0</span><br><span class="line">[2018-11-06 16:35:17 @53437.0]	TRACE	swReactorKqueue_add(:152): [THREAD #0]EP=4|FD=5, events=517</span><br><span class="line">[2018-11-06 16:35:17 @53438.0]	TRACE	swReactorKqueue_add(:152): [THREAD #0]EP=4|FD=8, events=517</span><br><span class="line">[2018-11-06 16:35:17 @53439.0]	TRACE	swReactorKqueue_add(:152): [THREAD #0]EP=4|FD=10, events=517</span><br><span class="line">[2018-11-06 16:35:17 @53440.0]	TRACE	swReactorKqueue_add(:152): [THREAD #0]EP=4|FD=12, events=517</span><br></pre></td></tr></table></figure>

<p>之后，我们通过命令<code>pstree</code>来查看一下进程之间的关系：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pstree | grep server2</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">| |   \-+= 53435 hantaohuang php server2.php</span><br><span class="line">| |     \-+- 53436 hantaohuang php server2.php</span><br><span class="line">| |       |--- 53437 hantaohuang php server2.php</span><br><span class="line">| |       |--- 53438 hantaohuang php server2.php</span><br><span class="line">| |       |--- 53439 hantaohuang php server2.php</span><br><span class="line">| |       \--- 53440 hantaohuang php server2.php</span><br></pre></td></tr></table></figure>

<p>可以看出，我们启动服务器之后，有6个进程与服务器有关，进程id分别为53435、53436、53437、53438、53439、53440。它们的层次关系就体现出了谁是父进程，谁是子进程。结合上面的架构图，我们可以很轻易的分析出这四个进程分别对应着：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">53435 --&gt; Master进程</span><br><span class="line">53436 --&gt; Manager进程</span><br><span class="line">53437 --&gt; Worker1进程</span><br><span class="line">53438 --&gt; Worker2进程</span><br><span class="line">53439 --&gt; Worker3进程</span><br><span class="line">53440 --&gt; Worker4进程</span><br></pre></td></tr></table></figure>

<p>然后我们查看一下Reactor线程的个数。我们从上面的架构图已经知道了Reactor线程是属于Master进程的。所以，我们可以通过如下命令查看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps M 53435</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">USER          PID   TT   %CPU STAT PRI     STIME     UTIME COMMAND</span><br><span class="line">hantaohuang 53435 s006    2.1 S    31T   0:02.44   0:00.93 php server2.php</span><br><span class="line">            53435         0.0 S    31T   0:00.00   0:00.00 </span><br><span class="line">            53435         0.0 S    31T   0:00.00   0:00.00 </span><br></pre></td></tr></table></figure>

<p>可以看出，这里有3个线程，一个是Master线程，两个Reactor线程。</p>
<p>这里，我们又抛出了线程的概念。如果同学们之前理解了进程的概念，然后再来理解线程的概念，就会比较简单了。目前，我们只需要这样简单理解此时的进程和线程模型即可：</p>
<p>![1(1)](/Users/hantaohuang/Library/Containers/com.tencent.WeWorkMac/Data/Library/Application Support/WXWork/Data/1688850523145108/Cache/Image/2018-11/1(1).PNG)</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2018/11/06/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-Server%EF%BC%88%E4%BA%8C%EF%BC%89/" data-id="ckkj72zt6006df6vx47oh6ur6" data-title="《就是要你懂swoole》-Server（二）" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/swoole/" rel="tag">swoole</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-手把手教你使用JWT" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/29/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/" class="article-date">
  <time class="dt-published" datetime="2018-08-29T11:01:17.000Z" itemprop="datePublished">2018-08-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/29/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/">手把手教你使用JWT</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>实习期间比较忙，好久没有写博客了，今天做完了项目来写一写。</p>
<p>这篇博客介绍的东西是JWT（json web token的简称）。用户通过JWT，就可以登录到我们的系统。OK，接下来让菜鸡我来给小伙伴们演示一下，以PHP的Laravel框架为例子，并且通过jwt-auth这个库来进行演示。这个库的官方文档<a target="_blank" rel="noopener" href="https://jwt-auth.readthedocs.io/en/develop/">这这里</a>。</p>
<h2 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h2><p>为了能够跑我们的项目，我们需要一个可以跑Laravel项目的环境，这里我就直接使用一个可以跑Laravel项目的Docker镜像，小伙伴们可以自己去找比较流行的镜像。</p>
<p>我这里Laravel框架的版本是5.6的，大家也尽量使用5.6的版本，和我的保持一致。</p>
<p>（注：如果小伙伴们自己的电脑已经可以跑Laravel项目了，<strong>准备环境</strong>这一步就可以省略了）</p>
<h2 id="准备一个空的Laravel项目"><a href="#准备一个空的Laravel项目" class="headerlink" title="准备一个空的Laravel项目"></a>准备一个空的Laravel项目</h2><p>准备一个空的Laravel项目，项目名字叫做<strong>jwt-test</strong>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo composer create-project --prefer-dist laravel/laravel jwt-test</span><br></pre></td></tr></table></figure>

<h2 id="准备jwt-auth库"><a href="#准备jwt-auth库" class="headerlink" title="准备jwt-auth库"></a>准备jwt-auth库</h2><p>安装jwt-auth这个库：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo composer require tymon/jwt-auth</span><br></pre></td></tr></table></figure>

<p>然后，我们打开jwt-test项目下的composer.json文件，找到如下地方：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/1.png"></p>
<p>然后把</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;tymon/jwt-auth&quot;: &quot;^0.5.12&quot;</span><br></pre></td></tr></table></figure>

<p>换成</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;tymon/jwt-auth&quot;: &quot;^1.0.0-rc.2&quot;</span><br></pre></td></tr></table></figure>

<p>（注意，一定要记得改这里的版本，要不然后面的发布配置会出问题）</p>
<p>然后在命令行中执行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo composer update</span><br></pre></td></tr></table></figure>

<p>然后再发布配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan vendor:publish --provider=&quot;Tymon\JWTAuth\Providers\LaravelServiceProvider&quot;</span><br></pre></td></tr></table></figure>

<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/2.png"></p>
<p>此时，会在<code>jwt-test/config</code>目录下多出一个文件<code>jwt.php</code>（这个文件保存了一些和jwt有关的默认配置信息），并且，我们执行<code>php artisan</code>命令的时候，也会多出一个命令：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/3.png"></p>
<p>然后生成密钥：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo php artisan jwt:secret</span><br></pre></td></tr></table></figure>

<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/5.png"></p>
<p>此时，在<code>jwt-test/.env</code>文件中会有这个密钥：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/6.png"></p>
<p>（注：我后面会解释这个密钥是用来干嘛的）</p>
<p>然后，我们修改一下Laravel框架默认给我们生成的User.php文件的内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Tymon</span>\<span class="title">JWTAuth</span>\<span class="title">Contracts</span>\<span class="title">JWTSubject</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Notifications</span>\<span class="title">Notifiable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Auth</span>\<span class="title">User</span> <span class="title">as</span> <span class="title">Authenticatable</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">extends</span> <span class="title">Authenticatable</span> <span class="keyword">implements</span> <span class="title">JWTSubject</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Notifiable</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The attributes that are mass assignable.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $fillable = [</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The attributes that should be hidden for arrays.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $hidden = [</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;remember_token&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Get the identifier that will be stored in the subject claim of the JWT.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getJWTIdentifier</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;getKey();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Return a key value array, containing any custom claims to be added to the JWT.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getJWTCustomClaims</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后，我们再修改一下<code>jwt-test/config/auth.php</code>文件里面的内容：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;defaults&#x27;</span> =&gt; [</span><br><span class="line">    <span class="string">&#x27;guard&#x27;</span> =&gt; <span class="string">&#x27;web&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;passwords&#x27;</span> =&gt; <span class="string">&#x27;users&#x27;</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<p>改成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;defaults&#x27;</span> =&gt; [</span><br><span class="line">    <span class="string">&#x27;guard&#x27;</span> =&gt; <span class="string">&#x27;api&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;passwords&#x27;</span> =&gt; <span class="string">&#x27;users&#x27;</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;api&#x27;</span> =&gt; [</span><br><span class="line">    <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;token&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;provider&#x27;</span> =&gt; <span class="string">&#x27;users&#x27;</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<p>改成</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;api&#x27;</span> =&gt; [</span><br><span class="line">    <span class="string">&#x27;driver&#x27;</span> =&gt; <span class="string">&#x27;jwt&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;provider&#x27;</span> =&gt; <span class="string">&#x27;users&#x27;</span>,</span><br><span class="line">],</span><br></pre></td></tr></table></figure>

<h2 id="模拟用户数据"><a href="#模拟用户数据" class="headerlink" title="模拟用户数据"></a>模拟用户数据</h2><p>因为Laravel框架为我们准备好了一张users表的迁移表，所以我们就不创建新的users迁移表了。我们直接在框架提供的迁移表上进行修改。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Schema::create(<span class="string">&#x27;users&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">Blueprint $table</span>) </span>&#123;</span><br><span class="line">        $table-&gt;increments(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">        $table-&gt;string(<span class="string">&#x27;username&#x27;</span>);</span><br><span class="line">        $table-&gt;string(<span class="string">&#x27;password&#x27;</span>);</span><br><span class="line">        $table-&gt;timestamps();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/7.png"></p>
<p>然后<code>jwt-test/User.php</code>文件我们也修改一下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> $fillable = [</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/8.png"></p>
<p>然后<code>database/UserFactory.php</code>文件我们也修改一下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$factory-&gt;define(App\User::class, <span class="function"><span class="keyword">function</span> (<span class="params">Faker $faker</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> [</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span> =&gt; $faker-&gt;name,</span><br><span class="line">        <span class="string">&#x27;password&#x27;</span> =&gt; bcrypt(<span class="string">&#x27;123456&#x27;</span>), <span class="comment">// 123456</span></span><br><span class="line">    ];</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/9.png"></p>
<p>然后，我们在<code>.env</code>文件中配置一下我们的数据库：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DB_DATABASE&#x3D;jwt</span><br><span class="line">DB_USERNAME&#x3D;USERNAME</span><br><span class="line">DB_PASSWORD&#x3D;PASSWORD</span><br></pre></td></tr></table></figure>

<p>（注意：这里的DB_USERNAME和DB_PASSWORD根据小伙伴们的自身情况填写）</p>
<p>然后，我们用MySQL客户端连接上MySQL服务器，创建一个数据库，命名为<code>jwt</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create database jwt;</span><br></pre></td></tr></table></figure>

<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/10.png"></p>
<p>然后，我们在jwt-test项目的根目录下执行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan migrate</span><br></pre></td></tr></table></figure>

<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/11.png"></p>
<p>然后，我们通过tinker来模拟出用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php artisan tinker</span><br><span class="line">Factory(App\User::class, 3)-&gt;create();</span><br></pre></td></tr></table></figure>

<p>这样，在数据表users就有3个用户了，他们的明文密码都是<code>123456</code>。</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/12.png"></p>
<h2 id="编写登录接口"><a href="#编写登录接口" class="headerlink" title="编写登录接口"></a>编写登录接口</h2><p>现在用户有了，我们需要开始编写接口了。首先，我们先定义一个登录接口，这个接口在用户登录成功的时候，返回一个token给客户端。</p>
<p>我们在<code>routes/api.php</code>中做如下定义：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Route::group([<span class="string">&#x27;prefix&#x27;</span>=&gt;<span class="string">&#x27;user&#x27;</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">    Route::post(<span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;UserController@login&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>然后，我们创建对应的<code>UserController</code>控制器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo php artisan make:controller UserController</span><br></pre></td></tr></table></figure>

<p>我们在这个控制器里面编写<code>login</code>方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $credentials = request([<span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;password&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! $token = auth()-&gt;attempt($credentials)) &#123;</span><br><span class="line">        <span class="keyword">return</span> response()-&gt;json([<span class="string">&#x27;error&#x27;</span> =&gt; <span class="string">&#x27;Unauthorized&#x27;</span>], <span class="number">401</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response()-&gt;json([</span><br><span class="line">        <span class="string">&#x27;token&#x27;</span> =&gt; $token,</span><br><span class="line">    ]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>编写完之后，我们通过postman来测试这个接口：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/29.png"></p>
<p>（注意：图中的https是因为我制作的这个docker容器里面使用了证书，所以用了https协议，如果大家是http协议的话，那么把https改成http协议即可）</p>
<p>然后，我们在postman中填写用户名和密码：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/14.png"></p>
<p>（这个是刚才我们模拟出来的第一个用户）</p>
<p>然后，我们点击右边蓝色的按钮<code>Send</code>：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/15.png"></p>
<p>这个字符串就是jwt。</p>
<p>好了，接下来，我们编写新的接口。我们在<code>routes/api.php</code>文件中定义一下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Route::group([<span class="string">&#x27;prefix&#x27;</span>=&gt;<span class="string">&#x27;user&#x27;</span>], <span class="function"><span class="keyword">function</span> (<span class="params"></span>)</span>&#123;</span><br><span class="line">    Route::post(<span class="string">&#x27;login&#x27;</span>, <span class="string">&#x27;UserController@login&#x27;</span>);</span><br><span class="line">    Route::post(<span class="string">&#x27;hello&#x27;</span>, <span class="string">&#x27;UserController@hello&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>然后，我们编写这个接口对应的hello方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> response()-&gt;json([</span><br><span class="line">        <span class="string">&#x27;info&#x27;</span> =&gt; <span class="string">&#x27;hello&#x27;</span>,</span><br><span class="line">    ]); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们增加了一个接口：<code>/api/user/hello</code>，但是，我们又不希望没有登录的用户访问这个接口。那么，我们该怎么做呢？</p>
<p>我们可以编写一个中间件，专门用来检测用户是否登录了，这个中间件就叫做jwt吧。以下是中间件编写的过程。</p>
<p>在jwt-test项目的根目录下执行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php artisan make:middleware Jwt</span><br></pre></td></tr></table></figure>

<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/16.png"></p>
<p>执行完之后，会在<code>app/Http/Middleware</code>目录下创建一个<code>Jwt.php</code>文件。</p>
<p>然后，我们在<code>Jwt.php</code>文件里面写入如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Closure</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Jwt</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Handle an incoming request.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Illuminate\Http\Request  $request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span>  \Closure  $next</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> mixed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params">$request, <span class="built_in">Closure</span> $next</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (auth()-&gt;user() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> response()-&gt;json([</span><br><span class="line">                <span class="string">&#x27;code&#x27;</span> =&gt; <span class="number">1001</span>,</span><br><span class="line">                <span class="string">&#x27;info&#x27;</span> =&gt; <span class="string">&#x27;Not logged in&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;body&#x27;</span> =&gt; []</span><br><span class="line">            ]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $next($request);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编写完中间件之后，我们需要注册这个中间件。</p>
<p>在<code>app/Http/Kernel.php</code>文件中的<code>$routeMiddleware</code>变量加入上面所写的中间件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;jwt&#x27;</span> =&gt; \App\Http\Middleware\Jwt::class,</span><br></pre></td></tr></table></figure>

<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/17.png"></p>
<p>注册完jwt中间件之后，我们就可以使用这个jwt中间件了，我们在UserController控制器中使用。</p>
<p>在UserController中的构造函数里面这样写：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;middleware(<span class="string">&#x27;jwt&#x27;</span>, [<span class="string">&#x27;except&#x27;</span> =&gt; [<span class="string">&#x27;login&#x27;</span>]]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它代表的意思就是除了login方法外，其他的方法都需要经过中间件。OK，我们现在来测试以下我们的那个hello接口。</p>
<p>首先，我们得进行登录，因此，需要先访问login接口得到一个token字符串：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/18.png"></p>
<p>我们拿着这个token字符串去访问hello接口：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/19.png"></p>
<p>那么，如果我们的这个token是错误的，会有什么现象呢？我们来试试：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/20.png"></p>
<p>我们把正确的那个token的最后一个字符Q删除了时候，得到了用户未登录的信息。为什么？因为你的token是错误的，所以说明用户没有登录过。</p>
<p>博客写到这里，大家应该就知道如何使用jwt了吧。</p>
<p>小伙伴们可能会想，这个token到底是个啥呢？别急，我们对这个token串进行base64解码。我们随便找一个可以进行base64解码的网站：</p>
<p>我们把jwt中第一个<code>.</code>前面的字符串都删掉（包括这个<code>.</code>），然后再把第二个<code>.</code>后面的字符串都删掉（包括这个<code>.</code>）：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/21.png"></p>
<p>然后再点击解密：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/22.png"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;iss&quot;</span>: <span class="string">&quot;https://localhost/api/user/login&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;iat&quot;</span>: <span class="number">1535557634</span>,</span><br><span class="line">  <span class="attr">&quot;exp&quot;</span>: <span class="number">1535561234</span>,</span><br><span class="line">  <span class="attr">&quot;nbf&quot;</span>: <span class="number">1535557634</span>,</span><br><span class="line">  <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;kjNhwJ7KESuX2AGR&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;sub&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;prv&quot;</span>: <span class="string">&quot;87e0af1ef9fd15812fdec97153a14e0b047546aa&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，sub对应的1就指的是用户的id。这个token默认保存的用户信息就是用户的id值。</p>
<p>那么为什么我要删除掉两个<code>.</code>号前面和后面的字符串呢？因为我想重点说一下这两个东西。我们单独解码一下第一个<code>.</code>号的内容：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/23.png"></p>
<p>我们点击解密：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/24.png"></p>
<p>typ代表这是一个jwt字符串、alg代表使用了哈希算法hash256。那么，这个哈希算法用在了什么地方呢？</p>
<p>我们第二个<code>.</code>后面的字符串就用到了。</p>
<p>我们对第二个点后面的内容进行解码：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/25.png"></p>
<p>我们点击解密：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/26.png"></p>
<p>这个就是一个签名。</p>
<p>那么这个签名是怎么来的呢？就是通过<code>hash256</code>算法得来的。</p>
<p>OK，那么又有小伙伴们会问了。那我是不是就可以伪造出其他用户的token啦！！因为我可以先用自己的账号进行一个登录，登录完之后，我对第一部分字符串进行解码，知道了用的是什么hash算法。然后，我再解码第二部分的字符串，得到了：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;iss&quot;</span>: <span class="string">&quot;https://localhost/api/user/login&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;iat&quot;</span>: <span class="number">1535557634</span>,</span><br><span class="line">  <span class="attr">&quot;exp&quot;</span>: <span class="number">1535561234</span>,</span><br><span class="line">  <span class="attr">&quot;nbf&quot;</span>: <span class="number">1535557634</span>,</span><br><span class="line">  <span class="attr">&quot;jti&quot;</span>: <span class="string">&quot;kjNhwJ7KESuX2AGR&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;sub&quot;</span>: <span class="number">1</span>,</span><br><span class="line">  <span class="attr">&quot;prv&quot;</span>: <span class="string">&quot;87e0af1ef9fd15812fdec97153a14e0b047546aa&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我就去修改sub的值，改成其他用户的，去构造一个新的字符串，这样总会构造出一个正确的jwt吧。</p>
<p>如果没有第三部分的字符串（即签名部分），理论上来说是可以的。但是，有了签名，就很难构造了。因为，这个签名的得来用到了我们之前生成的那个密钥。因为密钥是服务器才知道的，所以，构造者除非是得到了这个密钥，要不然想要构造出jwt，是比较难的。</p>
<p>OK，那么这个jwt是存放在哪里的呢？如果小伙伴们阅读jwt-auth的源码就会发现，其实它是存放在Laravel框架的<code>jwt-test/storage/</code>里面。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2018/08/29/%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E4%BD%BF%E7%94%A8JWT/" data-id="ckkj72zud00a8f6vxbv3vgmv7" data-title="手把手教你使用JWT" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/JWT/" rel="tag">JWT</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Laravel/" rel="tag">Laravel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《就是要你懂swoole》-Server（一）" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/08/04/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-Server%EF%BC%88%E4%B8%80%EF%BC%89/" class="article-date">
  <time class="dt-published" datetime="2018-08-04T10:59:42.000Z" itemprop="datePublished">2018-08-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/08/04/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-Server%EF%BC%88%E4%B8%80%EF%BC%89/">《就是要你懂swoole》-Server（一）</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>小伙伴们，大家好，这篇博客给大家带来的是有关swoole server的<code>__construct</code>的相关知识。对应的官方文档<a target="_blank" rel="noopener" href="https://wiki.swoole.com/wiki/page/14.html">在这里</a>。</p>
<p>构造函数的原型如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">swoole_server(<span class="keyword">string</span> $host, <span class="keyword">int</span> $port = <span class="number">0</span>, <span class="keyword">int</span> $mode = SWOOLE_PROCESS,</span><br><span class="line">    <span class="keyword">int</span> $sock_type = SWOOLE_SOCK_TCP);</span><br></pre></td></tr></table></figure>

<p>我们一个一个的过一下构造函数里面的参数。</p>
<h2 id="host"><a href="#host" class="headerlink" title="host"></a>host</h2><p><code>$host</code>，翻译过来就是主机的意思。什么是主机呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">主机是指计算机除去输入输出设备以外的主要机体部分。也是用于放置主板及其他主要部件的控制箱体（容器Mainframe）。通常包括 CPU、内存、硬盘、光驱、电源、以及其他输入输出控制器和接口。</span><br></pre></td></tr></table></figure>

<p>这是百度百科的解释。但是，在这个系列的文章里面，为了描述简单，我们直接把我们的计算机叫做主机。（我个人觉得计算机这个名词是包含了输入输出设备的，例如鼠标、键盘、显示器等等）</p>
<h2 id="port"><a href="#port" class="headerlink" title="port"></a>port</h2><p><code>$port</code>，翻译过来就是端口的意思。什么是端口呢？</p>
<p>在这里，我们所说的端口不是指硬件领域的端口。也就是说不是指USB端口、串行端口等（即不是指IO接口里面的数据寄存器等等东西）。<strong>而指的是软件领域的端口</strong>。也就是说指的是网络中面向连接服务和无连接服务（后面会说什么是面向连接服务和无连接服务）的<strong>通信协议端口</strong>，<strong>是一种抽象的软件结构</strong>，包括一些数据结构和I/O（基本输入输出）缓冲区。</p>
<p>如果还是有一些抽象，不要紧，我们去看看Linux中端口这个数据结构的定义是怎样的。数据结构的定义<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/include/net/inet_hashtables.h">在这里</a>，大概是在80行的位置：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-Server%EF%BC%88%E4%B8%80%EF%BC%89/1.png"></p>
<p>这个数据结构里面，就有我们现在正在说的port：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">inet_bind_bucket</span> &#123;</span></span><br><span class="line">    <span class="comment">/* other member */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span>		port; <span class="comment">/* 端口号 */</span></span><br><span class="line">    <span class="keyword">signed</span> <span class="keyword">char</span>		fastreuse; <span class="comment">/* 端口是否允许被重用 */</span></span><br><span class="line">    <span class="comment">/* other member */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>所以说，当我们给<code>swoole_server</code>这个构造函数传递一个端口号的时候，实际上就会在这个数据结构中的port成员变量中记录下这个端口号。</p>
<p>OK，说到这里，小伙伴们应该就更加理解什么是端口了吧。它也和进程一样，是<strong>一种数据结构</strong>。</p>
<h2 id="mode"><a href="#mode" class="headerlink" title="mode"></a>mode</h2><p><code>$mode</code>，翻译过来就是模式的意思。在这里指的是服务器运行的模式：</p>
<ul>
<li><code>SWOOLE_PROCESS</code>多进程模式（默认）</li>
<li><code>SWOOLE_BASE</code>基本模式</li>
</ul>
<p>模式这一块我们现在先放一下，到时候我会专门开一篇文章来讲。</p>
<h2 id="sock-type"><a href="#sock-type" class="headerlink" title="sock_type"></a>sock_type</h2><p><code>$sock_type</code>，翻译过来就是套接字类型的意思。</p>
<p>swoole支持<code>TCP</code>、<code>UDP</code>、<code>TCP6</code>、<code>UDP6</code>、<code>UnixSocket Stream/Dgram</code> 6种。在这里，我们重点看一下TCP和UDP。</p>
<p>首先，我们得知道套接字（socket）是什么？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">它是网络通信过程中端点的抽象表示，包含进行网络通信必需的五种信息：连接使用的协议，本地主机的IP地址，本地进程的协议端口，远地主机的IP地址，远地进程的协议端口。</span><br></pre></td></tr></table></figure>

<p>这是百度百科的解释。直接看的话，如果之前没有网络编程的基础，理解起来还是有一定的难度的，所以我们来做一个简单的解释。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">网络通信过程中端点的抽象</span><br></pre></td></tr></table></figure>

<p>首先，我们要理解网络通信的<strong>本质</strong>。实际上网络通信的本质是进程之间进行通信（要说更加本质的，可以扯到通信链路等等东西，但是在这里我们只讨论软件）。为什么这么说？因为你会发现，客户端和服务器本质上是两个跑起来的程序（即进程），然后客户端和服务器之间进行数据的交流，即所谓的通信。所以，本质上是两个进程之间的通信。</p>
<p>其次，我们要理解这里所说的<code>端点</code>是什么意思。小伙伴们可能会说，这个问题简单嘛，不就是之前所说的主机嘛，不就是通信双方的主机嘛。其实，这么说是不准确的。我们上面说了，网络通信的本质是进程之间的通信，因此，这里所说的<code>端点</code>实际上指的是通信双方的主机上面的<strong>进程</strong>。</p>
<p>然后，我们再来看一看这句话里面所说的<code>抽象</code>指的是什么呢？就是后面那句话：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">网络通信必需的五种信息</span><br></pre></td></tr></table></figure>

<p>也就是说，套接字把这五种信息给结合起来了，只要你把套接字所需要的这五种信息描述清楚了，那么，你就可以通过这个套接字，去和其他进程进行通信。</p>
<p>OK，我们讲完了套接字之后，现在可以讲一讲描述套接字所需要的信息之一 – 连接使用的协议（这里所说的是传输层的协议，而不是应用层的协议）。而协议，就是这里所说的<code>sock_type</code>了。那么，TCP是什么、UDP又是什么呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TCP（Transmission Control Protocol 传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议，由IETF的RFC 793定义。</span><br></pre></td></tr></table></figure>

<p>这是百度百科的解释。所以，简单的来说，TCP实际上是一种协议，由专门的网络专家经过研究而得出的一种<strong>规范</strong>（例如源端口所占的位数、目的端口所占的位数等等规范）。然后，操作系统的研发人员就按照专家们制定的规范，开发出了和TCP协议有关的数据结构，以及对这些数据结构的相关操作（通过这些操作，实现了TCP协议面向连接、可靠、基于字节流的特点）。所以说，TCP直接的连接，更多的指的是软件层面上的连接，即通过一些变量来表示是否建立连接，以及和谁进行了连接。至于什么是<code>面向连接的、可靠的、基于字节流</code>，我这里就不说了，因为这个可以单独写成一篇文章了，为了控制这篇博客的长度，小伙伴们可以直接在网上搜一下TCP的特点就好了。</p>
<p>UDP也是类似的道理，这里就不多说了。</p>
<p>最后，如果小伙伴们想要更加清晰的理解套接字，建议用C语言写一写网络编程的小demo。因为概念这东西，你不动手去写，要理解起来还是有一定难度的，不是说脑瓜子笨，而是说，如果你写过，那么你的眼睛就看过，你理解的就更深刻。</p>
<p>（未完，明天接着写）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2018/08/04/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-Server%EF%BC%88%E4%B8%80%EF%BC%89/" data-id="ckkj72zt6006bf6vx5rsh5lrw" data-title="《就是要你懂swoole》-Server（一）" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/swoole/" rel="tag">swoole</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《就是要你懂swoole》-编程须知" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2018/07/28/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-%E7%BC%96%E7%A8%8B%E9%A1%BB%E7%9F%A5/" class="article-date">
  <time class="dt-published" datetime="2018-07-28T03:41:13.000Z" itemprop="datePublished">2018-07-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2018/07/28/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-%E7%BC%96%E7%A8%8B%E9%A1%BB%E7%9F%A5/">《就是要你懂swoole》-- 编程须知</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>小伙伴们，这篇博客对应的官方文档<a target="_blank" rel="noopener" href="https://wiki.swoole.com/wiki/page/p-instruction.html">在此处</a>。建议大家对照着官方文档来阅读我的博客，这样效果会更好。OK，开始我们的学习。</p>
<h2 id="进程隔离"><a href="#进程隔离" class="headerlink" title="进程隔离"></a>进程隔离</h2><p>官网上有那么一句话：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">进程隔离也是很多新手经常遇到的问题。修改了全局变量的值，为什么不生效，原因就是全局变量在不同的进程，内存空间是隔离的，所以无效。</span><br></pre></td></tr></table></figure>

<p>如果小伙伴们之前对进程没有概念，要理解起来还是有一定难度的。所以在这里，我有必要说一下进程是什么东西。</p>
<p>简单来说，进程是一个<strong>数据结构</strong>，数据结构里面存放了很多成员变量，这个是最本质的。很多书说：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">进程是资源的集合</span><br></pre></td></tr></table></figure>

<p>那么这句话所说的资源指的就是这些变量存放的东西，集合指的就是进程这个数据结构。</p>
<p>如果还是有一些抽象，不要紧，我们去看看Linux中进程这个数据结构的定义是怎样的。数据结构的定义<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/include/linux/sched.h">在这里</a>，大概是在593行的位置：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B--%20%E7%BC%96%E7%A8%8B%E9%A1%BB%E7%9F%A5/1.png"></p>
<p>我列举几个这个数据结构里面我们听的比较多的成员变量：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">pid_t</span>					pid;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>		<span class="title">children</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span>		*<span class="title">files</span>;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，<code>pid</code>变量里面保存着这个进程的标识，也就是说给进程标一个号，区分一下各个进程。通过<code>children</code>变量，操作系统可以找到这个进程的所有子进程。变量<code>files</code>里面有一个变量<code>fdtab</code>，通过<code>fdtab</code>里面的<code>fd</code>指针，可以找到当前进程打开的所有文件，如下图所示：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B--%20%E7%BC%96%E7%A8%8B%E9%A1%BB%E7%9F%A5/2.png"></p>
<p>操作系统会为每一个进程分配一个<code>task_struct</code>数据结构，一旦CPU执行某个进程的代码的时候，操作系统把当前进程的这些变量提供给CPU。因为每个进程都有自己的这个<code>task_struct</code>数据结构，所以每个进程的变量是在各自的进程里面的，因此不同进程的变量是隔离的，<strong>这些变量也包括全局变量、文件句柄（即上图中的fd）</strong>。</p>
<p>紧接着，官网又给出那么一句话：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不同进程的文件句柄是隔离的，所以在A进程创建的Socket连接或打开的文件，在B进程内是无效，即使是将它的fd发送到B进程也是不可用的</span><br></pre></td></tr></table></figure>

<p>这句话什么意思呢？为了搞清楚，我们要知道文件句柄的作用。</p>
<p>当用户调用open系统调用（或者其他打开文件的系统调用）的时候，内核会创建一个打开文件对象来表示该文件的一个打开实例。内核同时也会分配一个文件描述符（也就是上图中的fd）作为打开文件对象的句柄。如下图所示：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B--%20%E7%BC%96%E7%A8%8B%E9%A1%BB%E7%9F%A5/3.png"></p>
<p>open系统调用向进程返回这个文件描述符，然后这个文件描述符就被存放在<code>file array</code>里面了。然后进程就可以通过这个<code>fd1</code>来找到对应的文件。那么，图中的offset是什么意思呢（我们把offset叫做<strong>打开文件对象</strong>）？在Unix系统中，文件默认是顺序访问的。当用户打开文件的时候，内核初始化这个offset的偏移指针为0。举个例子，如果当前进程刚打开一个文件（文件内容是字符串<code>abcdefghijklnm</code>），那么此时offset的状态如下：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B--%20%E7%BC%96%E7%A8%8B%E9%A1%BB%E7%9F%A5/5.png"></p>
<p>因为offset的偏移指针为0，所以指向字母a。所以，当我们通过fd去读取文件内容的时候，读取到的第一个字符就是字母<code>a</code>。假设我连续读了3个字节，那么此时的状态应该是这个样子的：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B--%20%E7%BC%96%E7%A8%8B%E9%A1%BB%E7%9F%A5/6.png"></p>
<p>也就是说，当进程从文件里面读取3个字节之后，offset此时指向字母d。当进程下一次读取文件的时候，读取出来的第一个字母就是d了。这就是offset的概念。</p>
<p>同一个进程还可以多次打开同一个文件，如下图所示：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B--%20%E7%BC%96%E7%A8%8B%E9%A1%BB%E7%9F%A5/7.png"></p>
<p>可以看出，虽然fd1和fd2都是指向同一个文件，但是，如果进程通过fd1去读取文件的话，读到的第一个字母是d；如果进程通过fd2去读取文件的话，读取到的第一个字母是a。所以，每个文件描述符代表着与文件的一个独立会话，对应的打开文件对象（即图中的offset）保存者该会话的内容，这包括了被打开文件的模式（只读、只写、读写）以及下一次读取或者写入时的偏移指针。</p>
<p>我们通过代码来直观感受一下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$handle1 = fopen(<span class="string">&quot;file.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">$handle2 = fopen(<span class="string">&quot;file.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"></span><br><span class="line">$content = fread ($handle1 , <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;The process reads three bytes through handle1, the content is: &quot;</span> . $content . PHP_EOL;</span><br><span class="line"></span><br><span class="line">$content1 = fread ($handle1 , <span class="number">1</span>);</span><br><span class="line">$content2 = fread ($handle2 , <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;The process reads one bytes through handle1, the content is: &quot;</span> . $content1 . PHP_EOL;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;The process reads one bytes through handle2, the content is: &quot;</span> . $content2 . PHP_EOL;</span><br></pre></td></tr></table></figure>

<p>结果如下：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B--%20%E7%BC%96%E7%A8%8B%E9%A1%BB%E7%9F%A5/8.png"></p>
<p>验证了我们的说法。</p>
<p>正是因为offset这个打开文件对象对同一个文件的不同会话进行了隔离，所以，才有了官网的这句话：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不同进程的文件句柄是隔离的，所以在A进程创建的Socket连接或打开的文件，在B进程内是无效，即使是将它的fd发送到B进程也是不可用的</span><br></pre></td></tr></table></figure>

<p>也就是说，<strong>就算fd是一样的，但是offset是不一样的</strong>。</p>
<p>其实到这里算是讲完了隔离，但是，我还想再讲一点其他的东西。</p>
<p>即，同一个进程是否可以让多个fd指向同一个offset，从而达到多个fd共享同一个offset的效果呢？答案是可以做到。</p>
<p>进程可以通过dup系统调用来复制一个文件描述符fd，这样一来，两个文件描述符共享着相同的会话：</p>
<p><img src="http://oklbfi1yj.bkt.clouddn.com/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B--%20%E7%BC%96%E7%A8%8B%E9%A1%BB%E7%9F%A5/9.png"></p>
<p>代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$handle1 = fopen(<span class="string">&quot;file.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">$handle2 = dup($handle1);</span><br><span class="line"></span><br><span class="line">$content = fread ($handle1 , <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;The process reads three bytes through handle1, the content is: &quot;</span> . $content . PHP_EOL;</span><br><span class="line"></span><br><span class="line">$content1 = fread ($handle1 , <span class="number">1</span>);</span><br><span class="line">$content2 = fread ($handle2 , <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;The process reads one bytes through handle1, the content is: &quot;</span> . $content1 . PHP_EOL;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;The process reads one bytes through handle2, the content is: &quot;</span> . $content2 . PHP_EOL;</span><br></pre></td></tr></table></figure>

<p>（注意，这段代码运行不了，因为PHP没有提供dup这个函数）</p>
<p>假设，这个函数是可以运行，那么输出的结果应该是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The process reads three bytes through handle1, the content is: abc</span><br><span class="line">The process reads one bytes through handle1, the content is: d</span><br><span class="line">The process reads one bytes through handle2, the content is: e</span><br></pre></td></tr></table></figure>



<hr>
<p>下面是更新的内容，经过热心网友 <a target="_blank" rel="noopener" href="https://www.zhihu.com/people/0521957489f668a5ea4b848d93eb2494">@许怀远</a>的指正，unix domain socket可以用来在不同的进程之间传递fd，而且传过去后还可以正常使用。至于如何使用unix domain socket，小伙伴们可以在《UNIX网络编程》卷一的第15章找到答案。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2018/07/28/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-%E7%BC%96%E7%A8%8B%E9%A1%BB%E7%9F%A5/" data-id="ckkj72zt7006gf6vxbwfcfp1r" data-title="《就是要你懂swoole》-- 编程须知" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/swoole/" rel="tag">swoole</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/15/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="page-number" href="/page/15/">15</a><span class="page-number current">16</span><a class="page-number" href="/page/17/">17</a><a class="page-number" href="/page/18/">18</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/17/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost/" rel="tag">Boost</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Composer/" rel="tag">Composer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C%E8%AF%AD%E8%A8%80/" rel="tag">C语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dockerfile/" rel="tag">Dockerfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GRPC/" rel="tag">GRPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GraphQL/" rel="tag">GraphQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hyperf/" rel="tag">Hyperf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" rel="tag">I/O多路复用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JIT/" rel="tag">JIT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JWT/" rel="tag">JWT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Laravel/" rel="tag">Laravel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MacOS/" rel="tag">MacOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/" rel="tag">Mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OPcache/" rel="tag">OPcache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHP 扩展开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP7/" rel="tag">PHP7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHP内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95/" rel="tag">PHP扩展</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHP扩展开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/" rel="tag">PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Protobuf/" rel="tag">Protobuf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swoole%E5%BE%AE%E8%AF%BE%E7%A8%8B/" rel="tag">Swoole微课程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vscode/" rel="tag">Vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xdebug/" rel="tag">Xdebug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/composer/" rel="tag">composer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c%E8%AF%AD%E8%A8%80/" rel="tag">c语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-compose/" rel="tag">docker-compose</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/epoll/" rel="tag">epoll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fpm/" rel="tag">fpm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gqlgen/" rel="tag">gqlgen</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/migrate/" rel="tag">migrate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swoole/" rel="tag">swoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swore/" rel="tag">swore</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tinyswoole/" rel="tag">tinyswoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unique-lock/" rel="tag">unique_lock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-js/" rel="tag">vue.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%B6%E4%BB%96/" rel="tag">其他</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%8F%E7%A8%8B/" rel="tag">协程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%96%E9%83%A8%E6%8E%92%E5%BA%8F/" rel="tag">外部排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" rel="tag">多线程编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/" rel="tag">引用计数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD/" rel="tag">性能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" rel="tag">性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" rel="tag">性能分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" rel="tag">服务器开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" rel="tag">服务器编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" rel="tag">汇编语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" rel="tag">秒杀系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B/" rel="tag">线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A0%81/" rel="tag">编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" rel="tag">编译器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag">网络编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag">虚拟机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" rel="tag">计算机基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" rel="tag">计算机系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E8%AF%BB%E4%BB%A3%E7%A0%81/" rel="tag">读读代码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B0%83%E8%AF%95/" rel="tag">调试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%92%E5%BD%92/" rel="tag">递归</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%94%81/" rel="tag">锁</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Boost/" style="font-size: 10px;">Boost</a> <a href="/tags/C/" style="font-size: 11.43px;">C</a> <a href="/tags/C/" style="font-size: 16.43px;">C++</a> <a href="/tags/Composer/" style="font-size: 10px;">Composer</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 15px;">C语言</a> <a href="/tags/Docker/" style="font-size: 11.43px;">Docker</a> <a href="/tags/Dockerfile/" style="font-size: 10px;">Dockerfile</a> <a href="/tags/GRPC/" style="font-size: 10.71px;">GRPC</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/GraphQL/" style="font-size: 10px;">GraphQL</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Hyperf/" style="font-size: 10.71px;">Hyperf</a> <a href="/tags/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" style="font-size: 10.71px;">I/O多路复用</a> <a href="/tags/JIT/" style="font-size: 10px;">JIT</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Laravel/" style="font-size: 10px;">Laravel</a> <a href="/tags/Linux/" style="font-size: 17.14px;">Linux</a> <a href="/tags/MacOS/" style="font-size: 10px;">MacOS</a> <a href="/tags/MySQL/" style="font-size: 10.71px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/OPcache/" style="font-size: 10px;">OPcache</a> <a href="/tags/PHP/" style="font-size: 20px;">PHP</a> <a href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size: 10.71px;">PHP 扩展开发</a> <a href="/tags/PHP7/" style="font-size: 10px;">PHP7</a> <a href="/tags/PHP%E5%86%85%E6%A0%B8/" style="font-size: 17.86px;">PHP内核</a> <a href="/tags/PHP%E6%89%A9%E5%B1%95/" style="font-size: 13.57px;">PHP扩展</a> <a href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size: 12.14px;">PHP扩展开发</a> <a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="/tags/Protobuf/" style="font-size: 10.71px;">Protobuf</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/Swoole/" style="font-size: 19.29px;">Swoole</a> <a href="/tags/Swoole%E5%BE%AE%E8%AF%BE%E7%A8%8B/" style="font-size: 10px;">Swoole微课程</a> <a href="/tags/Vscode/" style="font-size: 10px;">Vscode</a> <a href="/tags/Xdebug/" style="font-size: 10.71px;">Xdebug</a> <a href="/tags/c/" style="font-size: 10.71px;">c++</a> <a href="/tags/composer/" style="font-size: 10px;">composer</a> <a href="/tags/c%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">c语言</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/docker-compose/" style="font-size: 10px;">docker-compose</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/fpm/" style="font-size: 10px;">fpm</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/gqlgen/" style="font-size: 10px;">gqlgen</a> <a href="/tags/leetcode/" style="font-size: 12.14px;">leetcode</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/migrate/" style="font-size: 10px;">migrate</a> <a href="/tags/nginx/" style="font-size: 10.71px;">nginx</a> <a href="/tags/php/" style="font-size: 15.71px;">php</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/swoole/" style="font-size: 15.71px;">swoole</a> <a href="/tags/swore/" style="font-size: 10px;">swore</a> <a href="/tags/tinyswoole/" style="font-size: 10px;">tinyswoole</a> <a href="/tags/unique-lock/" style="font-size: 10px;">unique_lock</a> <a href="/tags/vue-js/" style="font-size: 10.71px;">vue.js</a> <a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 12.14px;">其他</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">前端</a> <a href="/tags/%E5%8D%8F%E7%A8%8B/" style="font-size: 15.71px;">协程</a> <a href="/tags/%E5%A4%96%E9%83%A8%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">外部排序</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">多线程编程</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">并发</a> <a href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/" style="font-size: 10px;">引用计数</a> <a href="/tags/%E6%80%A7%E8%83%BD/" style="font-size: 10px;">性能</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 10px;">性能优化</a> <a href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" style="font-size: 10px;">性能分析</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 13.57px;">操作系统</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 10.71px;">数据结构</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" style="font-size: 12.86px;">服务器开发</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">服务器编程</a> <a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">汇编语言</a> <a href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">秒杀系统</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">算法</a> <a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 10px;">线程</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 10px;">线程池</a> <a href="/tags/%E7%BC%96%E7%A0%81/" style="font-size: 10px;">编码</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" style="font-size: 18.57px;">编译原理</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" style="font-size: 10px;">编译器</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" style="font-size: 14.29px;">网络编程</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 10px;">虚拟机</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">计算机基础</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">计算机系统</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 10.71px;">计算机网络</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10.71px;">设计模式</a> <a href="/tags/%E8%AF%BB%E8%AF%BB%E4%BB%A3%E7%A0%81/" style="font-size: 10.71px;">读读代码</a> <a href="/tags/%E8%B0%83%E8%AF%95/" style="font-size: 10px;">调试</a> <a href="/tags/%E9%80%92%E5%BD%92/" style="font-size: 10px;">递归</a> <a href="/tags/%E9%94%81/" style="font-size: 10px;">锁</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/30/PHP%E5%87%BD%E6%95%B0%E7%BC%96%E8%AF%91%E4%B9%8B%E5%90%8E%E7%9A%84%E5%86%85%E5%AD%98%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/">PHP函数编译之后的内存存储结构</a>
          </li>
        
          <li>
            <a href="/2021/01/07/%E5%9C%A8PHP-RSHUTDOWN%E9%98%B6%E6%AE%B5%E8%B0%83%E7%94%A8zend-bailout%E5%AF%BC%E8%87%B4zend-mm-heap-corrupted%E9%97%AE%E9%A2%98/">在PHP RSHUTDOWN阶段调用zend_bailout导致zend_mm_heap corrupted问题</a>
          </li>
        
          <li>
            <a href="/2021/01/07/PHP%E6%89%A9%E5%B1%95%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E7%A7%81%E6%9C%89%E5%B1%9E%E6%80%A7%E7%9A%84%E5%90%8D%E5%AD%97/">PHP扩展如何获取私有属性的名字</a>
          </li>
        
          <li>
            <a href="/2020/12/16/PHP%E6%89%A9%E5%B1%95%E5%A6%82%E4%BD%95%E5%8E%BB%E6%A3%80%E6%9F%A5%E4%BE%9D%E8%B5%96%E7%9A%84C-%E5%BA%93%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8/">PHP扩展如何去检查依赖的C++库是否存在</a>
          </li>
        
          <li>
            <a href="/2020/11/24/Swoole-native-curl%E5%8D%8F%E7%A8%8B%E5%8C%96%E6%80%9D%E8%B7%AF/">Swoole native curl协程化思路</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 codinghuang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>