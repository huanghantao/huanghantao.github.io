<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>codinghuang的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="比PHP多一些">
<meta property="og:type" content="website">
<meta property="og:title" content="codinghuang的个人博客">
<meta property="og:url" content="http://huanghantao.github.io/page/3/index.html">
<meta property="og:site_name" content="codinghuang的个人博客">
<meta property="og:description" content="比PHP多一些">
<meta property="og:locale">
<meta property="article:author" content="codinghuang">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="codinghuang的个人博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">codinghuang的个人博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">简洁些、干净些、直接些...</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://huanghantao.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-PHP内核对字面量的优化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/05/PHP%E5%86%85%E6%A0%B8%E5%AF%B9%E5%AD%97%E9%9D%A2%E9%87%8F%E7%9A%84%E4%BC%98%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2020-11-05T14:35:49.000Z" itemprop="datePublished">2020-11-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/05/PHP%E5%86%85%E6%A0%B8%E5%AF%B9%E5%AD%97%E9%9D%A2%E9%87%8F%E7%9A%84%E4%BC%98%E5%8C%96/">PHP内核对字面量的优化</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>前几天，我发现<code>PHP</code>内核在处理字面量的时候是比较简单粗暴的，编译出一个常量，就直接把它放到<code>literals</code>里面了。那么这就会导致同一个常量会被存储多份，这显然是没有必要的。然后我对这部分代码优化好几个小时后发现，<code>opcache</code>已经对这个进行了优化，在函数<code>zend_optimizer_compact_literals</code>里面，会对等价的字面量进行合并。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/11/05/PHP%E5%86%85%E6%A0%B8%E5%AF%B9%E5%AD%97%E9%9D%A2%E9%87%8F%E7%9A%84%E4%BC%98%E5%8C%96/" data-id="ckkj72zri0026f6vx7fwohh9d" data-title="PHP内核对字面量的优化" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHP内核</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-PHP内核对符号的处理" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/11/01/PHP%E5%86%85%E6%A0%B8%E5%AF%B9%E7%AC%A6%E5%8F%B7%E7%9A%84%E5%A4%84%E7%90%86/" class="article-date">
  <time class="dt-published" datetime="2020-11-01T07:14:03.000Z" itemprop="datePublished">2020-11-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/11/01/PHP%E5%86%85%E6%A0%B8%E5%AF%B9%E7%AC%A6%E5%8F%B7%E7%9A%84%E5%A4%84%E7%90%86/">PHP内核对符号的处理</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p><code>PHP</code>内核在编译<code>PHP</code>脚本的过程中，会把符号的名字转化为符号对应的数据存储空间的地址（注意，不是符号的地址，而是符号对应的数据存储空间的地址）。</p>
</blockquote>
<p>我们知道，<code>opline</code>的结构如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> _znode_op &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span>      constant;</span><br><span class="line">    <span class="keyword">uint32_t</span>      var;</span><br><span class="line">    <span class="keyword">uint32_t</span>      num;</span><br><span class="line">&#125; znode_op;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_op</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">void</span> *handler;</span><br><span class="line">    znode_op op1;</span><br><span class="line">    znode_op op2;</span><br><span class="line">    znode_op result;</span><br><span class="line">    <span class="keyword">uint32_t</span> extended_value;</span><br><span class="line">    <span class="keyword">uint32_t</span> lineno;</span><br><span class="line">    zend_uchar opcode;</span><br><span class="line">    zend_uchar op1_type;</span><br><span class="line">    zend_uchar op2_type;</span><br><span class="line">    zend_uchar result_type;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>znode_op</code>这个结构，它是一个<code>uint32_t</code>类型的数字，可以用来存放和操作数地址有关的东西。这也就意味着，编译完<code>PHP</code>脚本之后，可以丢弃这些符号的名字，都转换成地址即可。</p>
<p>而名字到地址的转换，核心函数是<code>lookup_cv</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">lookup_cv</span><span class="params">(zend_string *name)</span> <span class="comment">/* &#123;&#123;&#123; */</span></span>&#123;</span><br><span class="line">    zend_op_array *op_array = CG(active_op_array);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    zend_ulong hash_value = zend_string_hash_val(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (i &lt; op_array-&gt;last_var) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ZSTR_H(op_array-&gt;vars[i]) == hash_value</span><br><span class="line">        &amp;&amp; zend_string_equals(op_array-&gt;vars[i], name)) &#123;</span><br><span class="line">            <span class="keyword">return</span> EX_NUM_TO_VAR(i);</span><br><span class="line">        &#125;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    i = op_array-&gt;last_var;</span><br><span class="line">    op_array-&gt;last_var++;</span><br><span class="line">    <span class="keyword">if</span> (op_array-&gt;last_var &gt; CG(context).vars_size) &#123;</span><br><span class="line">        CG(context).vars_size += <span class="number">16</span>; <span class="comment">/* FIXME */</span></span><br><span class="line">        op_array-&gt;vars = erealloc(op_array-&gt;vars, CG(context).vars_size * <span class="keyword">sizeof</span>(zend_string*));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    op_array-&gt;vars[i] = zend_string_copy(name);</span><br><span class="line">    <span class="keyword">return</span> EX_NUM_TO_VAR(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码，就是用来确定一个个<code>CV</code>变量在栈中的存储地址。也就意味着，栈的大小，在编译期间就确定好了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/11/01/PHP%E5%86%85%E6%A0%B8%E5%AF%B9%E7%AC%A6%E5%8F%B7%E7%9A%84%E5%A4%84%E7%90%86/" data-id="ckkj72zri0028f6vx4ogr3fql" data-title="PHP内核对符号的处理" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHP内核</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-PHP内核的op-array由编译时转化为运行时" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/31/PHP%E5%86%85%E6%A0%B8%E7%9A%84op-array%E7%94%B1%E7%BC%96%E8%AF%91%E6%97%B6%E8%BD%AC%E5%8C%96%E4%B8%BA%E8%BF%90%E8%A1%8C%E6%97%B6/" class="article-date">
  <time class="dt-published" datetime="2020-10-31T15:00:46.000Z" itemprop="datePublished">2020-10-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/31/PHP%E5%86%85%E6%A0%B8%E7%9A%84op-array%E7%94%B1%E7%BC%96%E8%AF%91%E6%97%B6%E8%BD%AC%E5%8C%96%E4%B8%BA%E8%BF%90%E8%A1%8C%E6%97%B6/">PHP内核的op_array由编译时转化为运行时</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><code>PHP</code>内核在<code>pass_two</code>这个函数里面，会对<code>op_array</code>进行一个编译时到运行时的转化。</p>
<p>主要体现在以下几个地方：</p>
<h2 id="重新分配literals"><a href="#重新分配literals" class="headerlink" title="重新分配literals"></a>重新分配literals</h2><p>让<code>literals</code>和<code>opcodes</code>由原来分散存储的内存合并为连续的一块内存。这么做除了内存连续带来的性能提升之外，另一个好处是，在执行<code>opline</code>的时候，直接通过偏移量就可以拿到对应的字面量了，不需要传递<code>op_array</code>，相当于少传递了一个参数（之前需要通过<code>op_array-&gt;literals</code>的方式来获取）。</p>
<h2 id="重新设置常量的constant值"><a href="#重新设置常量的constant值" class="headerlink" title="重新设置常量的constant值"></a>重新设置常量的constant值</h2><blockquote>
<p>znode_op::constant最终是要存储这个常量相对这条<code>opline</code>的偏移量</p>
</blockquote>
<p>在编译完<code>AST</code>生成完<code>opcode</code>之后，<code>znode_op::constant</code>存储的是这个常量在<code>literals</code>数组的索引。</p>
<p><code>znode_op::constant</code>在从编译期转运行期之后，变成了相对这条<code>opline</code>的偏移量。</p>
<h2 id="重新设置临时变量的var值"><a href="#重新设置临时变量的var值" class="headerlink" title="重新设置临时变量的var值"></a>重新设置临时变量的var值</h2><blockquote>
<p>znode_op::var最终是要存储这个变量相对<code>execute_data</code>的偏移量</p>
</blockquote>
<p>我们知道，<code>IS_CV</code>变量它相对<code>execute_data</code>的偏移量在编译这个变量的时候就已经通过<code>EX_NUM_TO_VAR</code>确定了。但是，<code>IS_TMP</code>类型的变量，它的<code>znode_op::var</code>里面只存了这个临时变量是第几个，还没有确定这个临时变量相对<code>execute_data</code>的偏移量。所以，在编译时转化为运行时的阶段，需要确定好。</p>
<p>那么为什么只有<code>IS_TMP</code>需要做转化呢？而<code>IS_CV</code>不需要呢？这是和<code>PHP</code>栈帧的设计有关的，<code>PHP</code>的栈帧结构如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Stack Frame Layout (the whole stack frame is allocated at once)</span><br><span class="line"> * ==================</span><br><span class="line"> *</span><br><span class="line"> *                             +========================================+</span><br><span class="line"> * EG(current_execute_data) -&gt; | zend_execute_data                      |</span><br><span class="line"> *                             +----------------------------------------+</span><br><span class="line"> *     EX_VAR_NUM(0) --------&gt; | VAR[0] = ARG[1]                        |</span><br><span class="line"> *                             | ...                                    |</span><br><span class="line"> *                             | VAR[op_array-&gt;num_args-1] = ARG[N]     |</span><br><span class="line"> *                             | ...                                    |</span><br><span class="line"> *                             | VAR[op_array-&gt;last_var-1]              |</span><br><span class="line"> *                             | VAR[op_array-&gt;last_var] = TMP[0]       |</span><br><span class="line"> *                             | ...                                    |</span><br><span class="line"> *                             | VAR[op_array-&gt;last_var+op_array-&gt;T-1]  |</span><br><span class="line"> *                             | ARG[N+1] (extra_args)                  |</span><br><span class="line"> *                             | ...                                    |</span><br><span class="line"> *                             +----------------------------------------+</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>

<p>可以发现，前面是<code>IS_CV</code>类型的变量，<code>IS_TMP</code>类型的变量在<code>IS_CV</code>变量的后面。所以，我们在编译出<code>IS_TMP</code>的时候，还无法确定<code>IS_CV</code>变量的个数，所以，也就无法确定<code>IS_TMP</code>相对于<code>execute_data</code>的偏移量。所以，得把<code>IS_TMP</code>的转化放在后面进行。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/10/31/PHP%E5%86%85%E6%A0%B8%E7%9A%84op-array%E7%94%B1%E7%BC%96%E8%AF%91%E6%97%B6%E8%BD%AC%E5%8C%96%E4%B8%BA%E8%BF%90%E8%A1%8C%E6%97%B6/" data-id="ckkj72zrj002bf6vxdvgo7a5d" data-title="PHP内核的op_array由编译时转化为运行时" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHP内核</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-PHP内核如何确定一个opcode有几个操作数" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/31/PHP%E5%86%85%E6%A0%B8%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%E4%B8%80%E4%B8%AAopcode%E6%9C%89%E5%87%A0%E4%B8%AA%E6%93%8D%E4%BD%9C%E6%95%B0/" class="article-date">
  <time class="dt-published" datetime="2020-10-31T14:44:12.000Z" itemprop="datePublished">2020-10-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/31/PHP%E5%86%85%E6%A0%B8%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%E4%B8%80%E4%B8%AAopcode%E6%9C%89%E5%87%A0%E4%B8%AA%E6%93%8D%E4%BD%9C%E6%95%B0/">PHP内核如何确定一个opcode有几个操作数</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>首先，<code>PHP</code>内核包含的所有<code>zend_ast</code>节点类型在文件<code>zend_ast.h</code>里面：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_AST_SPECIAL_SHIFT      6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_AST_IS_LIST_SHIFT      7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_AST_NUM_CHILDREN_SHIFT 8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> _zend_ast_kind &#123;</span><br><span class="line">    <span class="comment">// 省略其他的节点类型</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 0 child nodes */</span></span><br><span class="line">    ZEND_AST_MAGIC_CONST = <span class="number">0</span> &lt;&lt; ZEND_AST_NUM_CHILDREN_SHIFT,</span><br><span class="line">    ZEND_AST_TYPE,</span><br><span class="line">    ZEND_AST_CONSTANT_CLASS,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1 child node */</span></span><br><span class="line">    ZEND_AST_VAR = <span class="number">1</span> &lt;&lt; ZEND_AST_NUM_CHILDREN_SHIFT,</span><br><span class="line">    ZEND_AST_CONST,</span><br><span class="line">    ZEND_AST_UNPACK,</span><br><span class="line">    ZEND_AST_UNARY_PLUS,</span><br><span class="line">    ZEND_AST_UNARY_MINUS,</span><br><span class="line">    ZEND_AST_CAST,</span><br><span class="line">    ZEND_AST_EMPTY,</span><br><span class="line">    ZEND_AST_ISSET,</span><br><span class="line">    ZEND_AST_SILENCE,</span><br><span class="line">    ZEND_AST_SHELL_EXEC,</span><br><span class="line">    ZEND_AST_CLONE,</span><br><span class="line">    ZEND_AST_EXIT,</span><br><span class="line">    ZEND_AST_PRINT,</span><br><span class="line">    ZEND_AST_INCLUDE_OR_EVAL,</span><br><span class="line">    ZEND_AST_UNARY_OP,</span><br><span class="line">    ZEND_AST_PRE_INC,</span><br><span class="line">    ZEND_AST_PRE_DEC,</span><br><span class="line">    ZEND_AST_POST_INC,</span><br><span class="line">    ZEND_AST_POST_DEC,</span><br><span class="line">    ZEND_AST_YIELD_FROM,</span><br><span class="line">    ZEND_AST_CLASS_NAME,</span><br><span class="line"></span><br><span class="line">    ZEND_AST_GLOBAL,</span><br><span class="line">    ZEND_AST_UNSET,</span><br><span class="line">    ZEND_AST_RETURN,</span><br><span class="line">    ZEND_AST_LABEL,</span><br><span class="line">    ZEND_AST_REF,</span><br><span class="line">    ZEND_AST_HALT_COMPILER,</span><br><span class="line">    ZEND_AST_ECHO,</span><br><span class="line">    ZEND_AST_THROW,</span><br><span class="line">    ZEND_AST_GOTO,</span><br><span class="line">    ZEND_AST_BREAK,</span><br><span class="line">    ZEND_AST_CONTINUE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 2 child nodes */</span></span><br><span class="line">    ZEND_AST_DIM = <span class="number">2</span> &lt;&lt; ZEND_AST_NUM_CHILDREN_SHIFT,</span><br><span class="line">    ZEND_AST_PROP,</span><br><span class="line">    ZEND_AST_NULLSAFE_PROP,</span><br><span class="line">    ZEND_AST_STATIC_PROP,</span><br><span class="line">    ZEND_AST_CALL,</span><br><span class="line">    ZEND_AST_CLASS_CONST,</span><br><span class="line">    ZEND_AST_ASSIGN,</span><br><span class="line">    ZEND_AST_ASSIGN_REF,</span><br><span class="line">    ZEND_AST_ASSIGN_OP,</span><br><span class="line">    ZEND_AST_BINARY_OP,</span><br><span class="line">    ZEND_AST_GREATER,</span><br><span class="line">    ZEND_AST_GREATER_EQUAL,</span><br><span class="line">    ZEND_AST_AND,</span><br><span class="line">    ZEND_AST_OR,</span><br><span class="line">    ZEND_AST_ARRAY_ELEM,</span><br><span class="line">    ZEND_AST_NEW,</span><br><span class="line">    ZEND_AST_INSTANCEOF,</span><br><span class="line">    ZEND_AST_YIELD,</span><br><span class="line">    ZEND_AST_COALESCE,</span><br><span class="line">    ZEND_AST_ASSIGN_COALESCE,</span><br><span class="line"></span><br><span class="line">    ZEND_AST_STATIC,</span><br><span class="line">    ZEND_AST_WHILE,</span><br><span class="line">    ZEND_AST_DO_WHILE,</span><br><span class="line">    ZEND_AST_IF_ELEM,</span><br><span class="line">    ZEND_AST_SWITCH,</span><br><span class="line">    ZEND_AST_SWITCH_CASE,</span><br><span class="line">    ZEND_AST_DECLARE,</span><br><span class="line">    ZEND_AST_USE_TRAIT,</span><br><span class="line">    ZEND_AST_TRAIT_PRECEDENCE,</span><br><span class="line">    ZEND_AST_METHOD_REFERENCE,</span><br><span class="line">    ZEND_AST_NAMESPACE,</span><br><span class="line">    ZEND_AST_USE_ELEM,</span><br><span class="line">    ZEND_AST_TRAIT_ALIAS,</span><br><span class="line">    ZEND_AST_GROUP_USE,</span><br><span class="line">    ZEND_AST_CLASS_CONST_GROUP,</span><br><span class="line">    ZEND_AST_ATTRIBUTE,</span><br><span class="line">    ZEND_AST_MATCH,</span><br><span class="line">    ZEND_AST_MATCH_ARM,</span><br><span class="line">    ZEND_AST_NAMED_ARG,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 3 child nodes */</span></span><br><span class="line">    ZEND_AST_METHOD_CALL = <span class="number">3</span> &lt;&lt; ZEND_AST_NUM_CHILDREN_SHIFT,</span><br><span class="line">    ZEND_AST_NULLSAFE_METHOD_CALL,</span><br><span class="line">    ZEND_AST_STATIC_CALL,</span><br><span class="line">    ZEND_AST_CONDITIONAL,</span><br><span class="line"></span><br><span class="line">    ZEND_AST_TRY,</span><br><span class="line">    ZEND_AST_CATCH,</span><br><span class="line">    ZEND_AST_PROP_GROUP,</span><br><span class="line">    ZEND_AST_PROP_ELEM,</span><br><span class="line">    ZEND_AST_CONST_ELEM,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 4 child nodes */</span></span><br><span class="line">    ZEND_AST_FOR = <span class="number">4</span> &lt;&lt; ZEND_AST_NUM_CHILDREN_SHIFT,</span><br><span class="line">    ZEND_AST_FOREACH,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 5 child nodes */</span></span><br><span class="line">    ZEND_AST_PARAM = <span class="number">5</span> &lt;&lt; ZEND_AST_NUM_CHILDREN_SHIFT,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>我们发现，有几个子节点，那么就从<code>子节点个数 &lt;&lt; ZEND_AST_NUM_CHILDREN_SHIFT</code>开始。所以，对应的，我们可以通过反过来拿到子节点的个数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zend_ast_kind &gt;&gt; ZEND_AST_NUM_CHILDREN_SHIFT</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/10/31/PHP%E5%86%85%E6%A0%B8%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%E4%B8%80%E4%B8%AAopcode%E6%9C%89%E5%87%A0%E4%B8%AA%E6%93%8D%E4%BD%9C%E6%95%B0/" data-id="ckkj72zrh0024f6vx58yv5giy" data-title="PHP内核如何确定一个opcode有几个操作数" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHP内核</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-移进规约冲突" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/29/%E7%A7%BB%E8%BF%9B%E8%A7%84%E7%BA%A6%E5%86%B2%E7%AA%81/" class="article-date">
  <time class="dt-published" datetime="2020-10-29T15:12:58.000Z" itemprop="datePublished">2020-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/29/%E7%A7%BB%E8%BF%9B%E8%A7%84%E7%BA%A6%E5%86%B2%E7%AA%81/">移进规约冲突</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>今天写了一个移进规约冲突的文法。文法规则如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &quot;zend_compile.h&quot;</span><br><span class="line">#include &quot;zend_opcode.h&quot;</span><br><span class="line">#include &quot;zend_vm.h&quot;</span><br><span class="line"></span><br><span class="line">#define YYDEBUG 1</span><br><span class="line"></span><br><span class="line">#define zendparse yyparse</span><br><span class="line"></span><br><span class="line">extern int yylex(void);</span><br><span class="line">extern int yyparse(void);</span><br><span class="line">extern FILE *yyin;</span><br><span class="line">extern int yylineno;</span><br><span class="line"></span><br><span class="line">int yywrap()</span><br><span class="line">&#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void yyerror(const char *s)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;[error] %s, in line %d\n&quot;, s, yylineno);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char const *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%left &#39;+&#39; &#39;-&#39;</span><br><span class="line">%left &#39;*&#39; &#39;&#x2F;&#39;</span><br><span class="line">%left &#39;(&#39; &#39;)&#39;</span><br><span class="line"></span><br><span class="line">%token &lt;ident&gt; T_ECHO    &quot;&#39;echo&#39;&quot;</span><br><span class="line">%token &lt;ast&gt; T_LNUMBER   &quot;integer&quot;</span><br><span class="line">%token &lt;ast&gt; T_VARIABLE  &quot;variable&quot;</span><br><span class="line"></span><br><span class="line">%union &#123;</span><br><span class="line">    zend_ast *ast;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">%type &lt;ast&gt; top_statement statement</span><br><span class="line">%type &lt;ast&gt; expr</span><br><span class="line">%type &lt;ast&gt; echo_expr</span><br><span class="line">%type &lt;ast&gt; scalar</span><br><span class="line">%type &lt;ast&gt; top_statement_list</span><br><span class="line">%type &lt;ast&gt; variable</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">start:</span><br><span class="line">    top_statement_list  &#123; CG(ast) &#x3D; $1; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">top_statement_list:</span><br><span class="line">        top_statement_list top_statement &#123; $$ &#x3D; zend_ast_list_add($1, $2); &#125;</span><br><span class="line">    |   %empty &#123; $$ &#x3D; zend_ast_create_list(0, ZEND_AST_STMT_LIST); &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">top_statement:</span><br><span class="line">    statement                       &#123; $$ &#x3D; $1; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">statement:</span><br><span class="line">    T_ECHO echo_expr &#39;;&#39;     &#123; $$ &#x3D; $2; &#125;</span><br><span class="line">|   expr &#39;;&#39; &#123; $$ &#x3D; $1; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">echo_expr:</span><br><span class="line">    expr &#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;create echo zend_ast&quot; &lt;&lt; std::endl;</span><br><span class="line">        $$ &#x3D; zend_ast_create_1(ZEND_AST_ECHO, 0, $1);</span><br><span class="line">    &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">expr:</span><br><span class="line">    variable &#39;&#x3D;&#39; expr &#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;create assign zend_ast&quot; &lt;&lt; std::endl;</span><br><span class="line">        $$ &#x3D; zend_ast_create_2(ZEND_AST_ASSIGN, 0, $1, $3);</span><br><span class="line">    &#125;</span><br><span class="line">|</span><br><span class="line">    expr &#39;+&#39; expr   &#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;create + zend_ast&quot; &lt;&lt; std::endl;</span><br><span class="line">        $$ &#x3D; zend_ast_create_binary_op(ZEND_ADD, $1, $3);</span><br><span class="line">    &#125;</span><br><span class="line">|	expr &#39;-&#39; expr   &#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;create - zend_ast&quot; &lt;&lt; std::endl;</span><br><span class="line">        $$ &#x3D; zend_ast_create_binary_op(ZEND_SUB, $1, $3);</span><br><span class="line">    &#125;</span><br><span class="line">|	expr &#39;*&#39; expr   &#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;create * zend_ast&quot; &lt;&lt; std::endl;</span><br><span class="line">        $$ &#x3D; zend_ast_create_binary_op(ZEND_MUL, $1, $3);</span><br><span class="line">    &#125;</span><br><span class="line">|	expr &#39;&#x2F;&#39; expr   &#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;create &#x2F; zend_ast&quot; &lt;&lt; std::endl;</span><br><span class="line">        $$ &#x3D; zend_ast_create_binary_op(ZEND_DIV, $1, $3);</span><br><span class="line">    &#125;</span><br><span class="line">|	&#39;(&#39; expr &#39;)&#39;    &#123; $$ &#x3D; $2; &#125;</span><br><span class="line">|	scalar &#123; $$ &#x3D; $1; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">scalar:</span><br><span class="line">    T_LNUMBER   &#123; $$ &#x3D; $1; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">variable:</span><br><span class="line">    T_VARIABLE  &#123; $$ &#x3D; $1; &#125;</span><br><span class="line"></span><br><span class="line">%%</span><br></pre></td></tr></table></figure>

<p>执行生成代码的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bison -d -Wcounterexamples zend_language_parser.y</span><br><span class="line"></span><br><span class="line">zend_language_parser.y: warning: 4 <span class="built_in">shift</span>/reduce conflicts [-Wconflicts-sr]</span><br><span class="line">zend_language_parser.y: warning: <span class="built_in">shift</span>/reduce conflict on token <span class="string">&#x27;+&#x27;</span> [-Wcounterexamples]</span><br><span class="line">  Example: variable <span class="string">&#x27;=&#x27;</span> expr • <span class="string">&#x27;+&#x27;</span> expr</span><br><span class="line">  Shift derivation</span><br><span class="line">    expr</span><br><span class="line">    ↳ variable <span class="string">&#x27;=&#x27;</span> expr</span><br><span class="line">                   ↳ expr • <span class="string">&#x27;+&#x27;</span> expr</span><br><span class="line">  Reduce derivation</span><br><span class="line">    expr</span><br><span class="line">    ↳ expr                  <span class="string">&#x27;+&#x27;</span> expr</span><br><span class="line">      ↳ variable <span class="string">&#x27;=&#x27;</span> expr •</span><br><span class="line"></span><br><span class="line"><span class="comment"># 省略其他的警告</span></span><br></pre></td></tr></table></figure>

<p>可以看到，警告说是有<code>4</code>个地方有移进规约的冲突。</p>
<p>那么，什么是移进规约冲突呢？意思就是说，当我们预读了词素的时候，既可以对分析栈里面已有的词素进行规约也可以对预读的词素进行移进，这就是已经规约冲突。</p>
<p><code>OK</code>，我们来看看上面的报错。可以看到，当有字符串：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = 1 + 1</span><br></pre></td></tr></table></figure>

<p>输入时，会发生移进规约的冲突。</p>
<p>我们来看看如果是优先移进的话，状态是如何变化的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">|                                  |   |init |   |            <span class="variable">$a</span> = 1 + 1            |</span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">|                <span class="variable">$a</span>                |   |<span class="built_in">shift</span>|   |             = 1 + 1              |</span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">|               <span class="variable">$a</span> =               |   |<span class="built_in">shift</span>|   |              1 + 1               |</span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">|              <span class="variable">$a</span> = 1              |   |<span class="built_in">shift</span>|   |               + 1                |</span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">|             <span class="variable">$a</span> = 1 +             |   |<span class="built_in">shift</span>|   |                1                 |</span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">|            <span class="variable">$a</span> = 1 + 1            |   |<span class="built_in">shift</span>|   |                                  |</span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +------+  +----------------------------------+</span><br><span class="line">|            <span class="variable">$a</span> = expr             |   |reduce|  |                                  |</span><br><span class="line">+----------------------------------+   +------+  +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +------+  +----------------------------------+</span><br><span class="line">|               expr               |   |reduce|  |                                  |</span><br><span class="line">+----------------------------------+   +------+  +----------------------------------+</span><br></pre></td></tr></table></figure>

<p>对应的<code>AST</code>如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">               +------------+                             </span><br><span class="line">               |ZEND_ASSIGN |                             </span><br><span class="line">               |            |                             </span><br><span class="line">               +------------+                             </span><br><span class="line">                      |                                   </span><br><span class="line">                      |                                   </span><br><span class="line">       +--------------+--------------+                    </span><br><span class="line">       |                             |                    </span><br><span class="line">       |                             |                    </span><br><span class="line">       v                             v                    </span><br><span class="line">+------------+                +------------+              </span><br><span class="line">|     <span class="variable">$a</span>     |                |  ZEND_ADD  |              </span><br><span class="line">|            |                |            |              </span><br><span class="line">+------------+                +------------+              </span><br><span class="line">                                     |                    </span><br><span class="line">                                     |                    </span><br><span class="line">                                     |                    </span><br><span class="line">                     +---------------+-------------+      </span><br><span class="line">                     |                             |      </span><br><span class="line">                     |                             |      </span><br><span class="line">                     v                             v      </span><br><span class="line">              +------------+                +------------+</span><br><span class="line">              |     1      |                |     1      |</span><br><span class="line">              |            |                |            |</span><br><span class="line">              +------------+                +------------+</span><br></pre></td></tr></table></figure>

<p>计算这个<code>AST</code>，我们会得到<code>$a</code>的最终值为<code>2</code>。这是符合主流语言的预期的。</p>
<p>我们来看看如果是优先规约的话，状态是如何变化的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">|                                  |   |init |   |            <span class="variable">$a</span> = 1 + 1            |</span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">|                <span class="variable">$a</span>                |   |<span class="built_in">shift</span>|   |             = 1 + 1              |</span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">|               <span class="variable">$a</span> =               |   |<span class="built_in">shift</span>|   |              1 + 1               |</span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">|              <span class="variable">$a</span> = 1              |   |<span class="built_in">shift</span>|   |               + 1                |</span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +------+  +----------------------------------+</span><br><span class="line">|               expr               |   |reduce|  |               + 1                |</span><br><span class="line">+----------------------------------+   +------+  +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">|              expr +              |   |<span class="built_in">shift</span>|   |                1                 |</span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +------+  +----------------------------------+</span><br><span class="line">|             expr + 1             |   |<span class="built_in">shift</span> |  |                                  |</span><br><span class="line">+----------------------------------+   +------+  +----------------------------------+</span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">                                                                                     </span><br><span class="line">+----------------------------------+   +------+  +----------------------------------+</span><br><span class="line">|               expr               |   |reduce|  |                                  |</span><br><span class="line">+----------------------------------+   +------+  +----------------------------------+</span><br></pre></td></tr></table></figure>

<p>对应的<code>AST</code>如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">                                  +-----------------+                 </span><br><span class="line">                                  |                 |                 </span><br><span class="line">                                  |    ZEND_ADD     |                 </span><br><span class="line">                                  |                 |                 </span><br><span class="line">                                  +-----------------+                 </span><br><span class="line">                                           |                          </span><br><span class="line">                                           |                          </span><br><span class="line">                           +---------------+----------------+         </span><br><span class="line">                           |                                |         </span><br><span class="line">                           |                                |         </span><br><span class="line">                           v                                v         </span><br><span class="line">                  +-----------------+              +-----------------+</span><br><span class="line">                  |                 |              |                 |</span><br><span class="line">                  |   ZEND_ASSIGN   |              |        1        |</span><br><span class="line">                  |                 |              |                 |</span><br><span class="line">                  +-----------------+              +-----------------+</span><br><span class="line">                           |                                          </span><br><span class="line">                           |                                          </span><br><span class="line">                           |                                          </span><br><span class="line">         +-----------------+----------------+                         </span><br><span class="line">         |                                  |                         </span><br><span class="line">         |                                  |                         </span><br><span class="line">         v                                  v                         </span><br><span class="line">+-----------------+                +-----------------+                </span><br><span class="line">|                 |                |                 |                </span><br><span class="line">|       <span class="variable">$a</span>        |                |        1        |                </span><br><span class="line">|                 |                |                 |                </span><br><span class="line">+-----------------+                +-----------------+                </span><br></pre></td></tr></table></figure>

<p>计算这个<code>AST</code>，我们会得到<code>$a</code>的最终值为<code>1</code>。这和我们想的不太一样。</p>
<p>所以，移进规约的冲突，会导致一些执行的顺序不一致。如果我们学习过<code>bison</code>官方文档经典的<code>if ... else</code>的移进规约冲突问题的话，我们知道，解决它的办法是修改文法，进而避免冲突（因为这个例子有一点绕，所以我没有用那个例子）。那我们这种情况呢，就可以通过设置词素的优先级来解决掉，我们设置<code>=</code>的优先级低于<code>+</code>即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%left &#39;&#x3D;&#39;</span><br><span class="line">%left &#39;+&#39; &#39;-&#39;</span><br><span class="line">%left &#39;*&#39; &#39;&#x2F;&#39;</span><br><span class="line">%left &#39;(&#39; &#39;)&#39;</span><br></pre></td></tr></table></figure>

<p>这样的话，当我们的分析栈为如下情况的时候：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br><span class="line">|              <span class="variable">$a</span> = 1              |   |<span class="built_in">shift</span>|   |               + 1                |</span><br><span class="line">+----------------------------------+   +-----+   +----------------------------------+</span><br></pre></td></tr></table></figure>

<p>我们预读一个<code>+</code>，因为<code>+</code>号的优先级更高一点，所以，此时不会选择规约，而是把<code>+</code>移进。这样，我们可以保证在后续规约的时候，先规约<code>1 + 1</code>，进而也保证了运算符的优先级。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/10/29/%E7%A7%BB%E8%BF%9B%E8%A7%84%E7%BA%A6%E5%86%B2%E7%AA%81/" data-id="ckkj72zuu00bbf6vxb8207l9q" data-title="移进规约冲突" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《手把手教你编写PHP编译器》-执行opcode" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/29/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E6%89%A7%E8%A1%8Copcode/" class="article-date">
  <time class="dt-published" datetime="2020-10-29T11:41:39.000Z" itemprop="datePublished">2020-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/29/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E6%89%A7%E8%A1%8Copcode/">《手把手教你编写PHP编译器》-执行opcode</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>上一篇文章，我们成功的把<code>AST</code>翻译成了<code>opcode</code>，这样有一个好处，就是它是线性的，连续的，这和我们的<code>CPU</code>去一条一条的执行机器指令是保持一致的，非常便于人类理解。但是，我们还没有去设置这些<code>opcode</code>对应的<code>handler</code>。</p>
<p>这篇文章，我们来实现对这些<code>opcode</code>的执行，这一节还是比较难的。</p>
<p>首先，我们来捋一捋<code>opcode</code>和<code>handler</code>的关系。我们参考<code>PHP</code>的实现。首先是我们的<code>_zend_op</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_op</span> &#123;</span></span><br><span class="line">    znode_op op1;</span><br><span class="line">    znode_op op2;</span><br><span class="line">    znode_op result;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> opcode;</span><br><span class="line">    <span class="keyword">char</span> op1_type;</span><br><span class="line">    <span class="keyword">char</span> op2_type;</span><br><span class="line">    <span class="keyword">char</span> result_type;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这种结构实际上是一种三地址码的组织形式，这种结构可以方便我们后续进行数据流分析。</p>
<p>我们知道，变量和字面量等等是有类型的，既然有类型，我们的操作数<code>1</code>和操作数<code>2</code>就可能多种组合。所以，这实际上就是一种笛卡尔积的表现形式了。再加上<code>opcode</code>的种类也不止一种，所以，我们有如下笛卡尔积：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opcode × op1 × op2</span><br></pre></td></tr></table></figure>

<p>举个例子画个图：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">+----------------------+              +----------------------+        +----------------------+</span><br><span class="line">|                      |              |                      |        |                      |</span><br><span class="line">|       ZEND_ADD       |              |       IS_CONST       |        |       IS_CONST       |</span><br><span class="line">|                      |              |                      |        |                      |</span><br><span class="line">+----------------------+              +----------------------+        +----------------------+</span><br><span class="line">                                                                                              </span><br><span class="line">                                                                                              </span><br><span class="line">                                                                                              </span><br><span class="line">                                                                                              </span><br><span class="line">+----------------------+             +----------------------+         +----------------------+</span><br><span class="line">|                      |             |                      |         |                      |</span><br><span class="line">|       ZEND_SUB       |             |      IS_TMP_VAR      |         |      IS_TMP_VAR      |</span><br><span class="line">|                      |             |                      |         |                      |</span><br><span class="line">+----------------------+             +----------------------+         +----------------------+</span><br><span class="line">                                                                                              </span><br><span class="line">                                                                                              </span><br><span class="line">                                                                                              </span><br><span class="line">                                                                                              </span><br><span class="line">                                                                                              </span><br><span class="line">+----------------------+                                                                      </span><br><span class="line">|                      |                                                                      </span><br><span class="line">|       ZEND_MUL       |                                                                      </span><br><span class="line">|                      |                                                                      </span><br><span class="line">+----------------------+                                                                      </span><br><span class="line">                                                                                              </span><br><span class="line">                                                                                              </span><br><span class="line">                                                                                              </span><br><span class="line">                                                                                              </span><br><span class="line">+----------------------+                                                                      </span><br><span class="line">|                      |                                                                      </span><br><span class="line">|       ZEND_DIV       |                                                                      </span><br><span class="line">|                      |                                                                      </span><br><span class="line">+----------------------+                                                                      </span><br></pre></td></tr></table></figure>

<p>那么，我们就会有<code>4 * 2 * 2</code>种<code>spec handler</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ZEND_ADD_IS_CONST_IS_CONST</span><br><span class="line">ZEND_ADD_IS_CONST_IS_TMP_VAR</span><br><span class="line">ZEND_ADD_IS_TMP_VAR_IS_CONST</span><br><span class="line">ZEND_ADD_IS_TMP_VAR_IS_TMP_VAR</span><br><span class="line"><span class="comment"># 以此类推</span></span><br></pre></td></tr></table></figure>

<p>假设，我们的<code>opcode</code>是按照顺序从<code>0</code>开始编号的，并且操作数的类型也是从<code>0</code>开始进行编号，并且，我们的<code>spec handler</code>也是严格按照顺序在内存中进行排序的。那我，我们就可以通过<code>opcode</code>、<code>op1_type</code>、<code>op2_type</code>找到<code>spec handler</code>的位置了，这个有点像一个三维的数组。对应的算法如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opcode * op1_type的数量 * op2_type的数量 + opt_type的编号 * op2_type的数量 + op2_type的编号</span><br></pre></td></tr></table></figure>

<p>我们的实现都是围绕着这个算法来进行的。</p>
<p>首先，我们来定义一下操作数的类型：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OP_TYPE_MAP(XX)                                                                                                \</span></span><br><span class="line">    XX(IS_UNUSED, <span class="number">0</span>)                                                                                                   \</span><br><span class="line">    XX(IS_CONST, <span class="number">1</span> &lt;&lt; <span class="number">0</span>)                                                                                               \</span><br><span class="line">    XX(IS_TMP_VAR, <span class="number">1</span> &lt;&lt; <span class="number">1</span>)                                                                                             \</span><br><span class="line">    XX(IS_VAR, <span class="number">1</span> &lt;&lt; <span class="number">2</span>)                                                                                                 \</span><br><span class="line">    XX(IS_CV, <span class="number">1</span> &lt;&lt; <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> op_type_e &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OP_TYPE_GEN(name, value) name = value,</span></span><br><span class="line">    OP_TYPE_MAP(OP_TYPE_GEN)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> OP_TYPE_GEN</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> op_type_code_e &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> OP_TYPE_CODE_GEN(name, value) _##name##_CODE,</span></span><br><span class="line">    OP_TYPE_MAP(OP_TYPE_CODE_GEN)</span><br><span class="line"><span class="meta">#<span class="meta-keyword">undef</span> OP_TYPE_CODE_GEN</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接着，我们可以来编写我们的<code>spec handler</code>了。从上面可以看出，我们的操作数有好几个。但是，实际上，对于同一个<code>opcode</code>，它要执行的动作是一样的，只不过操作数的类型不同，获取操作数的方式需要改变。如果我们手写每一种<code>opcode</code>对应的所有<code>handler</code>，那么这个维护成本是非常的高的，所以，我们应该是有一个代码生成的机制，写好通用的模板代码，然后直接生成即可。</p>
<p>下面，我们来给出模板代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">ZEND_VM_HANDLER(<span class="number">0</span>, ZEND_NOP, CONST|TMPVAR, CONST|TMPVAR)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ZEND_VM_HANDLER(<span class="number">1</span>, ZEND_ADD, CONST|TMPVAR, CONST|TMPVAR)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int64_t</span> op1, op2;</span><br><span class="line"></span><br><span class="line">    op1 = GET_OP1();</span><br><span class="line">    op2 = GET_OP2();</span><br><span class="line">    op_array-&gt;literals[opline-&gt;result.var] = op1 + op2;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ZEND_VM_HANDLER(<span class="number">2</span>, ZEND_SUB, CONST|TMPVAR, CONST|TMPVAR)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int64_t</span> op1, op2;</span><br><span class="line"></span><br><span class="line">    op1 = GET_OP1();</span><br><span class="line">    op2 = GET_OP2();</span><br><span class="line">    op_array-&gt;literals[opline-&gt;result.var] = op1 - op2;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ZEND_VM_HANDLER(<span class="number">3</span>, ZEND_MUL, CONST|TMPVAR, CONST|TMPVAR)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int64_t</span> op1, op2;</span><br><span class="line"></span><br><span class="line">    op1 = GET_OP1();</span><br><span class="line">    op2 = GET_OP2();</span><br><span class="line">    op_array-&gt;literals[opline-&gt;result.var] = op1 * op2;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ZEND_VM_HANDLER(<span class="number">4</span>, ZEND_DIV, CONST|TMPVAR, CONST|TMPVAR)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int64_t</span> op1, op2;</span><br><span class="line"></span><br><span class="line">    op1 = GET_OP1();</span><br><span class="line">    op2 = GET_OP2();</span><br><span class="line">    op_array-&gt;literals[opline-&gt;result.var] = op1 / op2;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ZEND_VM_HANDLER(<span class="number">136</span>, ZEND_ECHO, CONST|TMPVAR, UNUSED)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int64_t</span> op1;</span><br><span class="line"></span><br><span class="line">    op1 = GET_OP1();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lld&quot;</span>, op1);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，非常的简单。其中，这里的数字<code>0, 1, 2, 3, 4, 136</code>是这个<code>opcode</code>的编号。</p>
<p>接着，我们来用<code>PHP</code>代码来完成这个代码生成的脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define IS_UNUSED 0 /* Unused operand */</span></span><br><span class="line"><span class="comment">#define IS_CONST (1 &lt;&lt; 0)</span></span><br><span class="line"><span class="comment">#define IS_TMP_VAR (1 &lt;&lt; 1)</span></span><br><span class="line"><span class="comment">#define IS_VAR (1 &lt;&lt; 2)</span></span><br><span class="line"><span class="comment">#define IS_CV (1 &lt;&lt; 3) /* Compiled variable */</span></span><br><span class="line"></span><br><span class="line">define(<span class="string">&#x27;ZEND_VM_OP_UNUSED&#x27;</span>, <span class="number">1</span> &lt;&lt; <span class="number">0</span>);</span><br><span class="line">define(<span class="string">&#x27;ZEND_VM_OP_CONST&#x27;</span>, <span class="number">1</span> &lt;&lt; <span class="number">1</span>);</span><br><span class="line">define(<span class="string">&#x27;ZEND_VM_OP_TMPVAR&#x27;</span>, <span class="number">1</span> &lt;&lt; <span class="number">2</span>);</span><br><span class="line">define(<span class="string">&#x27;ZEND_VM_OP_VAR&#x27;</span>, <span class="number">1</span> &lt;&lt; <span class="number">3</span>);</span><br><span class="line">define(<span class="string">&#x27;ZEND_VM_OP_CV&#x27;</span>, <span class="number">1</span> &lt;&lt; <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">$op_types_map = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&quot;UNUSED&quot;</span>               =&gt; ZEND_VM_OP_UNUSED,</span><br><span class="line">    <span class="string">&quot;CONST&quot;</span>                =&gt; ZEND_VM_OP_CONST,</span><br><span class="line">    <span class="string">&quot;TMPVAR&quot;</span>               =&gt; ZEND_VM_OP_TMPVAR,</span><br><span class="line">    <span class="string">&quot;VAR&quot;</span>                  =&gt; ZEND_VM_OP_VAR,</span><br><span class="line">    <span class="string">&quot;CV&quot;</span>                   =&gt; ZEND_VM_OP_CV,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$op1_get = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&quot;UNUSED&quot;</span>   =&gt; <span class="string">&quot;nullptr&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CONST&quot;</span>    =&gt; <span class="string">&quot;opline-&gt;op1.num&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TMPVAR&quot;</span>   =&gt; <span class="string">&quot;op_array-&gt;literals[opline-&gt;op1.var]&quot;</span>,</span><br><span class="line">    <span class="string">&quot;VAR&quot;</span>      =&gt; <span class="string">&quot;nullptr&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CV&quot;</span>       =&gt; <span class="string">&quot;nullptr&quot;</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$op2_get = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&quot;UNUSED&quot;</span>   =&gt; <span class="string">&quot;nullptr&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CONST&quot;</span>    =&gt; <span class="string">&quot;opline-&gt;op2.num&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TMPVAR&quot;</span>   =&gt; <span class="string">&quot;op_array-&gt;literals[opline-&gt;op2.var]&quot;</span>,</span><br><span class="line">    <span class="string">&quot;VAR&quot;</span>      =&gt; <span class="string">&quot;nullptr&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CV&quot;</span>       =&gt; <span class="string">&quot;nullptr&quot;</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$opcodes = [];</span><br><span class="line">$max_opcode = <span class="number">0</span>;</span><br><span class="line">$spec_names = [];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parse_operand_spec</span>(<span class="params">$def, $lineno, $str, &amp;$flags</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $op_types_map;</span><br><span class="line"></span><br><span class="line">    $flags = <span class="number">0</span>;</span><br><span class="line">    $a = explode(<span class="string">&quot;|&quot;</span>, $str);</span><br><span class="line">    <span class="keyword">foreach</span> ($a <span class="keyword">as</span> $val) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($op_types_map[$val])) &#123;</span><br><span class="line">            $flags |= $op_types_map[$val];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">&quot;ERROR (<span class="subst">$def</span>:<span class="subst">$lineno</span>): Wrong operand type &#x27;<span class="subst">$str</span>&#x27;\n&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> array_flip($a);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_handler</span>(<span class="params">$f, $opcode</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $op1_get, $op2_get, $spec_names, $op_types_map;</span><br><span class="line"></span><br><span class="line">    $opTypes = array_keys($op_types_map);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($opTypes <span class="keyword">as</span> $op1Type) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> ($opTypes <span class="keyword">as</span> $op2Type) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($opcode[<span class="string">&#x27;op1&#x27;</span>][$op1Type]) &amp;&amp; <span class="keyword">isset</span>($opcode[<span class="string">&#x27;op2&#x27;</span>][$op2Type])) &#123;</span><br><span class="line">                $specialized_replacements = [</span><br><span class="line">                    <span class="string">&quot;/GET_OP1\(([^)]*)\)/&quot;</span> =&gt; $op1_get[$op1Type],</span><br><span class="line">                    <span class="string">&quot;/GET_OP2\(([^)]*)\)/&quot;</span> =&gt; $op2_get[$op2Type],</span><br><span class="line">                ];</span><br><span class="line"></span><br><span class="line">                $name = $opcode[<span class="string">&#x27;op&#x27;</span>];</span><br><span class="line">                $templateCode = $opcode[<span class="string">&#x27;code&#x27;</span>];</span><br><span class="line"></span><br><span class="line">                $spec_name = $name.<span class="string">&quot;_SPEC&quot;</span>.<span class="string">&quot;_&quot;</span>.$op1Type.<span class="string">&quot;_&quot;</span>.$op2Type;</span><br><span class="line">                $spec_names[] = $spec_name;</span><br><span class="line">                fputs($f, <span class="string">&quot;static int <span class="subst">$spec_name</span>(zend_op_array *op_array, zend_op *opline) &quot;</span>);</span><br><span class="line">                $code = preg_replace(array_keys($specialized_replacements), array_values($specialized_replacements), $templateCode);</span><br><span class="line">                fputs($f, $code);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                $spec_names[] = <span class="string">&#x27;nullptr&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_spec_handlers</span>(<span class="params">$f</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $spec_names;</span><br><span class="line"></span><br><span class="line">    fputs($f, <span class="string">&quot;\tstatic const void * const spec_handlers[] = &#123;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">foreach</span> ($spec_names <span class="keyword">as</span> $spec_name) &#123;</span><br><span class="line">        fputs($f, <span class="string">&quot;\t\t(void *) <span class="subst">$spec_name</span>,\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fputs($f, <span class="string">&quot;\t&#125;;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fputs($f, <span class="string">&quot;\tzend_spec_handlers = spec_handlers;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_vm_execute_code</span>(<span class="params">$f</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fputs($f, <span class="string">&quot;void zend_execute(zend_op_array *op_array) &#123;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\tfor (size_t i = 0; i &lt; op_array-&gt;last; i++) &#123;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\t\tzend_op *opline = &amp;(op_array-&gt;opcodes[i]);\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\t\t((opcode_handler_t)opline-&gt;handler)(op_array, opline);\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\t&#125;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_vm_init_code</span>(<span class="params">$f</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    fputs($f, <span class="string">&quot;void zend_vm_init() &#123;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gen_spec_handlers($f);</span><br><span class="line"></span><br><span class="line">    fputs($f, <span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_executor_code</span>(<span class="params">$f</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $opcodes, $max_opcode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// define</span></span><br><span class="line">    fputs($f, <span class="string">&quot;const void * const *zend_spec_handlers;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;typedef int (*opcode_handler_t) (zend_op_array *op_array, const zend_op *opline);\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate zend_vm_get_opcode_handler() function</span></span><br><span class="line"></span><br><span class="line">    fputs($f, <span class="string">&quot;static uint32_t zend_vm_get_opcode_handler_idx(const zend_op *opline)\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\tstatic int zend_vm_decode[IS_CV + 1] = &#123;0&#125;;\n\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\t#define OP_TYPE_CODE_GEN(name, value) zend_vm_decode[name] = _##name##_CODE;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\t\tOP_TYPE_MAP(OP_TYPE_CODE_GEN)\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\t#undef OP_TYPE_CODE_GEN\n\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\tuint32_t offset = 0;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\toffset += opline-&gt;opcode * 5 * 5;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\toffset += zend_vm_decode[(int) opline-&gt;op1_type] * 5;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\toffset += zend_vm_decode[(int) opline-&gt;op2_type];\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\treturn offset;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fputs($f, <span class="string">&quot;const void *zend_vm_get_opcode_handler(const zend_op *opline)\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\tuint32_t offset = zend_vm_get_opcode_handler_idx(opline);\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\treturn zend_spec_handlers[offset];\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fputs($f, <span class="string">&quot;void zend_vm_set_opcode_handler(zend_op *opline)\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;&#123;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\topline-&gt;handler = zend_vm_get_opcode_handler(opline);\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    $num = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt;= $max_opcode; $i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($opcodes[$num])) &#123;</span><br><span class="line">            gen_handler($f, $opcodes[$num], $num);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            gen_handler($f, [], $num);</span><br><span class="line">        &#125;</span><br><span class="line">        $num++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    gen_vm_execute_code($f);</span><br><span class="line"></span><br><span class="line">    gen_vm_init_code($f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_vm</span>(<span class="params"><span class="keyword">string</span> $def</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $opcodes, $max_opcode;</span><br><span class="line"></span><br><span class="line">    $in = file($def);</span><br><span class="line"></span><br><span class="line">    $lineno = <span class="number">0</span>;</span><br><span class="line">    $handler = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($in <span class="keyword">as</span> $line) &#123;</span><br><span class="line">        <span class="keyword">if</span> (strpos($line, <span class="string">&quot;ZEND_VM_HANDLER(&quot;</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (preg_match(</span><br><span class="line">                <span class="string">&quot;/^ZEND_VM_HANDLER\(\s*([0-9]+)\s*,\s*([A-Z_]+)\s*,\s*([A-Z_|]+)\s*,\s*([A-Z_|]+)\s*(,\s*([A-Z_|]+)\s*)?(,\s*SPEC\(([A-Z_|=,]+)\)\s*)?\)/&quot;</span>,</span><br><span class="line">                $line,</span><br><span class="line">                $m</span><br><span class="line">            ) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;ERROR (<span class="subst">$def</span>:<span class="subst">$lineno</span>): Invalid ZEND_VM_HANDLER definition.\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            $code = (<span class="keyword">int</span>)$m[<span class="number">1</span>];</span><br><span class="line">            $op   = $m[<span class="number">2</span>];</span><br><span class="line">            $op1  = parse_operand_spec($def, $lineno, $m[<span class="number">3</span>], $flags1);</span><br><span class="line">            $op2  = parse_operand_spec($def, $lineno, $m[<span class="number">4</span>], $flags2);</span><br><span class="line">            $flags = $flags1 | ($flags2 &lt;&lt; <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ($code &gt; $max_opcode) &#123;</span><br><span class="line">                $max_opcode = $code;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($opcodes[$code])) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;ERROR (<span class="subst">$def</span>:<span class="subst">$lineno</span>): Opcode with code &#x27;<span class="subst">$code</span>&#x27; is already defined.\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($opnames[$op])) &#123;</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;ERROR (<span class="subst">$def</span>:<span class="subst">$lineno</span>): Opcode with name &#x27;<span class="subst">$op</span>&#x27; is already defined.\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $handler = $code;</span><br><span class="line"></span><br><span class="line">            $opcodes[$code] = <span class="keyword">array</span>(<span class="string">&quot;op&quot;</span>=&gt;$op,<span class="string">&quot;op1&quot;</span>=&gt;$op1,<span class="string">&quot;op2&quot;</span>=&gt;$op2,<span class="string">&quot;code&quot;</span>=&gt;<span class="string">&quot;&quot;</span>,<span class="string">&quot;flags&quot;</span>=&gt;$flags);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $opcodes[$handler][<span class="string">&#x27;code&#x27;</span>] .= $line;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ksort($opcodes);</span><br><span class="line"></span><br><span class="line">    $f = fopen(<span class="keyword">__DIR__</span> . <span class="string">&quot;/zend_vm_opcodes.h&quot;</span>, <span class="string">&quot;w+&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;ERROR: Cannot create zend_vm_opcodes.h\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;#pragma once\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> ($opcodes <span class="keyword">as</span> $code =&gt; $dsc) &#123;</span><br><span class="line">        $op = str_pad($dsc[<span class="string">&quot;op&quot;</span>], <span class="number">20</span>);</span><br><span class="line">        fputs($f, <span class="string">&quot;#define <span class="subst">$op</span> <span class="subst">$code</span>\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fclose($f);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;zend_vm_opcodes.h generated successfully.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    $f = fopen(<span class="keyword">__DIR__</span> . <span class="string">&quot;/zend_vm_opcodes.cc&quot;</span>, <span class="string">&quot;w+&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;ERROR: Cannot create zend_vm_opcodes.c\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;#include \&quot;zend_vm_opcodes.h\&quot;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fputs($f, <span class="string">&quot;static const char *zend_vm_opcodes_names[&quot;</span>.($max_opcode + <span class="number">1</span>).<span class="string">&quot;] = &#123;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt;= $max_opcode; $i++) &#123;</span><br><span class="line">        fputs($f, <span class="string">&quot;\t&quot;</span>.(<span class="keyword">isset</span>($opcodes[$i][<span class="string">&quot;op&quot;</span>])?<span class="string">&#x27;&quot;&#x27;</span>.$opcodes[$i][<span class="string">&quot;op&quot;</span>].<span class="string">&#x27;&quot;&#x27;</span>:<span class="string">&quot;nullptr&quot;</span>).<span class="string">&quot;,\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    fputs($f, <span class="string">&quot;&#125;;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fputs($f, <span class="string">&quot;const char* zend_get_opcode_name(char opcode) &#123;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;\treturn zend_vm_opcodes_names[opcode];\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;&#125;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fclose($f);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;zend_vm_opcodes.cc generated successfully.\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">    $f = fopen(<span class="keyword">__DIR__</span> . <span class="string">&quot;/zend_vm_execute.h&quot;</span>, <span class="string">&quot;w+&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;ERROR: Cannot create zend_vm_execute.h\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;#pragma once\n\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;#include &lt;stdint.h&gt;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;#include &lt;stddef.h&gt;\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;#include \&quot;zend_compile.h\&quot;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    gen_executor_code($f);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;zend_vm_execute.h generated successfully.\n&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gen_vm(<span class="keyword">__DIR__</span> . <span class="string">&quot;/zend_vm_def.h&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>接着，我们执行这个脚本，就会生成文件<code>zend_vm_opcodes.h</code>、<code>zend_vm_opcodes.cc</code>、<code>zend_vm_execute.h</code>。</p>
<p>这里面有两个核心的函数<code>zend_vm_init</code>、<code>zend_execute</code>。</p>
<p>其中<code>zend_vm_init</code>会用一块内存来存放我们的<code>spec handler</code>的地址，这样，我们就可以通过上面所说的算法，来找到<code>spec handler</code>了。</p>
<p><code>zend_execute</code>就非常的简单了，执行<code>opline</code>就好了。</p>
<p>接下来，我们只需要设置好每一个<code>opline</code>对应的<code>handler</code>即可。代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// set opcode spec handler</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pass_two</span><span class="params">(zend_op_array *op_array)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; op_array-&gt;last; i++) &#123;</span><br><span class="line">        zend_op *opline = &amp;(op_array-&gt;opcodes[i]);</span><br><span class="line">        zend_vm_set_opcode_handler(opline);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，我们在文件<code>zend_language_parser.y</code>里面调用<code>zend_vm_init</code>、<code>pass_two</code>、<code>zend_execute</code>即可。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/10/29/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E6%89%A7%E8%A1%8Copcode/" data-id="ckkj72zx600mef6vxeobibzby" data-title="《手把手教你编写PHP编译器》-执行opcode" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-如何准确的查看opline对应的handler名字" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/27/%E5%A6%82%E4%BD%95%E5%87%86%E7%A1%AE%E7%9A%84%E6%9F%A5%E7%9C%8Bopline%E5%AF%B9%E5%BA%94%E7%9A%84handler%E5%90%8D%E5%AD%97/" class="article-date">
  <time class="dt-published" datetime="2020-10-27T04:50:25.000Z" itemprop="datePublished">2020-10-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/27/%E5%A6%82%E4%BD%95%E5%87%86%E7%A1%AE%E7%9A%84%E6%9F%A5%E7%9C%8Bopline%E5%AF%B9%E5%BA%94%E7%9A%84handler%E5%90%8D%E5%AD%97/">如何准确的查看opline对应的handler名字</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>我们在分析<code>opcode</code>对应的<code>handler</code>的时候，往往会根据<code>opcode</code>的命名规则来推断具体的<code>handler</code>。然而，如果我们使用<code>PHP8</code>的话，我们可以利用<code>jit</code>的<code>debug</code>功能来快速的看到<code>opcode</code>对应的<code>handler</code>。我举个例子：</p>
<p>有如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>];</span><br><span class="line">$a[<span class="number">2</span>];</span><br></pre></td></tr></table></figure>

<p>像这个<code>$a[2]</code>对应的<code>handler</code>还是非常的长的，我们很难一口气推断出来。我们只需要配置一下<code>php.ini</code>就可以方便的拿到<code>handler</code>：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">zend_extension</span>=opcache.so</span><br><span class="line"><span class="attr">opcache.enable</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">opcache.enable_cli</span>=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">opcache.jit</span>=<span class="number">1201</span></span><br><span class="line"><span class="attr">opcache.jit_buffer_size</span>=<span class="number">64</span>M</span><br><span class="line"><span class="attr">opcache.jit_debug</span>=<span class="number">0</span>x01</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">JIT$/Users/hantaohuang/codeDir/cCode/php-src/test.php: ; (/Users/hantaohuang/codeDir/cCode/php-src/test.php)</span><br><span class="line">    <span class="comment"># 省略其他的汇编代码</span></span><br><span class="line">    mov <span class="variable">$ZEND_ASSIGN_SPEC_CV_CONST_RETVAL_UNUSED_HANDLER</span>, %rax</span><br><span class="line">    <span class="comment"># 省略其他的汇编代码</span></span><br><span class="line">    mov <span class="variable">$ZEND_FETCH_DIM_R_INDEX_SPEC_CV_CONST_HANDLER</span>, %rax</span><br><span class="line">    <span class="comment"># 省略其他的汇编代码</span></span><br></pre></td></tr></table></figure>

<p>可以看到，<code>handler</code>是<code>ZEND_FETCH_DIM_R_INDEX_SPEC_CV_CONST_HANDLER</code>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/10/27/%E5%A6%82%E4%BD%95%E5%87%86%E7%A1%AE%E7%9A%84%E6%9F%A5%E7%9C%8Bopline%E5%AF%B9%E5%BA%94%E7%9A%84handler%E5%90%8D%E5%AD%97/" data-id="ckkj72zu3009ef6vxgv7z591n" data-title="如何准确的查看opline对应的handler名字" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHP内核</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-PHP内核生成zend-vm-opcodes-h" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/21/PHP%E5%86%85%E6%A0%B8%E7%94%9F%E6%88%90zend-vm-opcodes-h/" class="article-date">
  <time class="dt-published" datetime="2020-10-21T15:44:53.000Z" itemprop="datePublished">2020-10-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/21/PHP%E5%86%85%E6%A0%B8%E7%94%9F%E6%88%90zend-vm-opcodes-h/">PHP内核生成zend_vm_opcodes.h</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本文基于的PHP8 commit为：14806e0824ecd598df74cac855868422e44aea53</p>
</blockquote>
<p>首先，<code>zend_vm_opcodes.h</code>这个文件是通过脚本<code>Zend/zend_vm_gen.php</code>来生成的。而<code>zend_vm_gen.php</code>这个脚本依赖<code>zend_vm_def.h</code>和<code>zend_vm_execute.skl</code>来生成文件<code>zend_vm_execute.h</code>和<code>zend_vm_opcodes.h</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> +--------------------+                +--------------------+ </span><br><span class="line"> |                    |                |                    | </span><br><span class="line"> |   zend_vm_def.h    |                |zend_vm_execute.skl | </span><br><span class="line"> |                    |                |                    | </span><br><span class="line"> +--------------------+                +--------------------+ </span><br><span class="line">            |                                     |           </span><br><span class="line">            +------------------+------------------+           </span><br><span class="line">                               |                              </span><br><span class="line">                               v                              </span><br><span class="line">                    +--------------------+                    </span><br><span class="line">                    |                    |                    </span><br><span class="line">                    |  zend_vm_gen.php   |                    </span><br><span class="line">                    |                    |                    </span><br><span class="line">                    +--------------------+                    </span><br><span class="line">                               |                              </span><br><span class="line">           +-------------------+-------------------+          </span><br><span class="line">           |                                       |          </span><br><span class="line">           v                                       v          </span><br><span class="line">+--------------------+                  +--------------------+</span><br><span class="line">|                    |                  |                    |</span><br><span class="line">| zend_vm_opcodes.h  |                  | zend_vm_execute.h  |</span><br><span class="line">|                    |                  |                    |</span><br><span class="line">+--------------------+                  +--------------------+</span><br></pre></td></tr></table></figure>

<p>我们以文件<code>zend_vm_gen.php</code>分析的起点，来看看生成<code>zend_vm_opcodes.h</code>的<code>zend_vm_execute.h</code>的关键步骤。</p>
<p>首先，是函数<code>gen_vm</code>。这个函数会逐行扫描<code>zend_vm_def.h</code>里面的代码。</p>
<p>当扫描到<code>ZEND_VM_HELPER</code>的时候，就会执行下面的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (strpos($line,<span class="string">&quot;ZEND_VM_HELPER(&quot;</span>) === <span class="number">0</span> ||</span><br><span class="line">            strpos($line,<span class="string">&quot;ZEND_VM_INLINE_HELPER(&quot;</span>) === <span class="number">0</span> ||</span><br><span class="line">            strpos($line,<span class="string">&quot;ZEND_VM_COLD_HELPER(&quot;</span>) === <span class="number">0</span> ||</span><br><span class="line">            strpos($line,<span class="string">&quot;ZEND_VM_HOT_HELPER(&quot;</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Parsing helper&#x27;s definition</span></span><br><span class="line">    <span class="keyword">if</span> (preg_match(</span><br><span class="line">            <span class="string">&quot;/^ZEND_VM(_INLINE|_COLD|_HOT)?_HELPER\(\s*([A-Za-z_]+)\s*,\s*([A-Z_|]+)\s*,\s*([A-Z_|]+)\s*(?:,\s*SPEC\(([A-Z_|=,]+)\)\s*)?(?:,\s*([^)]*)\s*)?\)/&quot;</span>,</span><br><span class="line">            $line,</span><br><span class="line">            $m) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;ERROR (<span class="subst">$def</span>:<span class="subst">$lineno</span>): Invalid ZEND_VM_HELPER definition.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $inline = !<span class="keyword">empty</span>($m[<span class="number">1</span>]) &amp;&amp; $m[<span class="number">1</span>] === <span class="string">&quot;_INLINE&quot;</span>;</span><br><span class="line">    $cold   = !<span class="keyword">empty</span>($m[<span class="number">1</span>]) &amp;&amp; $m[<span class="number">1</span>] === <span class="string">&quot;_COLD&quot;</span>;</span><br><span class="line">    $hot    = !<span class="keyword">empty</span>($m[<span class="number">1</span>]) &amp;&amp; $m[<span class="number">1</span>] === <span class="string">&quot;_HOT&quot;</span>;</span><br><span class="line">    $helper = $m[<span class="number">2</span>];</span><br><span class="line">    $op1    = parse_operand_spec($def, $lineno, $m[<span class="number">3</span>], $flags1);</span><br><span class="line">    $op2    = parse_operand_spec($def, $lineno, $m[<span class="number">4</span>], $flags2);</span><br><span class="line">    $param  = <span class="keyword">isset</span>($m[<span class="number">6</span>]) ? $m[<span class="number">6</span>] : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($helpers[$helper])) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;ERROR (<span class="subst">$def</span>:<span class="subst">$lineno</span>): Helper with name &#x27;<span class="subst">$helper</span>&#x27; is already defined.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Store parameters</span></span><br><span class="line">    <span class="keyword">if</span> (ZEND_VM_KIND == ZEND_VM_KIND_GOTO</span><br><span class="line">        || ZEND_VM_KIND == ZEND_VM_KIND_SWITCH</span><br><span class="line">        || (ZEND_VM_KIND == ZEND_VM_KIND_HYBRID &amp;&amp; $hot)) &#123;</span><br><span class="line">        <span class="keyword">foreach</span> (explode(<span class="string">&quot;,&quot;</span>, $param) <span class="keyword">as</span> $p) &#123;</span><br><span class="line">            $p = trim($p);</span><br><span class="line">            <span class="keyword">if</span> ($p !== <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">                $params[$p] = <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $helpers[$helper] = <span class="keyword">array</span>(<span class="string">&quot;op1&quot;</span>=&gt;$op1,<span class="string">&quot;op2&quot;</span>=&gt;$op2,<span class="string">&quot;param&quot;</span>=&gt;$param,<span class="string">&quot;code&quot;</span>=&gt;<span class="string">&quot;&quot;</span>,<span class="string">&quot;inline&quot;</span>=&gt;$inline,<span class="string">&quot;cold&quot;</span>=&gt;$cold,<span class="string">&quot;hot&quot;</span>=&gt;$hot);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($m[<span class="number">5</span>])) &#123;</span><br><span class="line">        $helpers[$helper][<span class="string">&quot;spec&quot;</span>] = parse_spec_rules($def, $lineno, $m[<span class="number">5</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $handler = <span class="literal">null</span>;</span><br><span class="line">    $list[$lineno] = <span class="keyword">array</span>(<span class="string">&quot;helper&quot;</span>=&gt;$helper);</span><br></pre></td></tr></table></figure>

<p>这段代码具体的细节我们不去深究，总结起来就是去正则匹配<code>zend_vm_def.h</code>里面当前行的<code>ZEND_VM_HELPER</code>，然后把相关的信息存在全局变量<code>$helpers</code>里面。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ZEND_VM_HELPER(zend_add_helper, ANY, ANY, zval *op_1, zval *op_2)</span><br><span class="line">=&gt;</span><br><span class="line">[</span><br><span class="line">    <span class="string">&quot;zend_add_helper&quot;</span> =&gt;</span><br><span class="line">    [</span><br><span class="line">        <span class="string">&quot;op1&quot;</span> =&gt; [</span><br><span class="line">            ANY:0</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;op2&quot;</span> =&gt; [</span><br><span class="line">            ANY:0</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;param&quot;</span> =&gt; <span class="string">&quot;zval *op_1, zval *op_2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;code&quot;</span> =&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;inline&quot;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;cold&quot;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;hot&quot;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">    ]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>然后</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ($handler !== null) &#123;</span><br><span class="line">    <span class="comment">// Add line of code to current opcode handler</span></span><br><span class="line">    $opcodes[$handler][<span class="string">&quot;code&quot;</span>] .= $line;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> ($helper !== null) &#123;</span><br><span class="line">    <span class="comment">// Add line of code to current helper</span></span><br><span class="line">    $helpers[$helper][<span class="string">&quot;code&quot;</span>] .= $line;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是去拼接<code>zend_vm_def.h</code>里面的代码。如果是<code>ZEND_VM_HELPER</code>类型的代码，就执行<code>$helpers[$helper][&quot;code&quot;] .= $line;</code>。例如，当拼接完毕的时候，就会得到下面的信息：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">ZEND_VM_HELPER(zend_add_helper, ANY, ANY, zval *op_1, zval *op_2)</span><br><span class="line">&#123;</span><br><span class="line">    USE_OPLINE</span><br><span class="line"></span><br><span class="line">    SAVE_OPLINE();</span><br><span class="line">    <span class="keyword">if</span> (UNEXPECTED(Z_TYPE_INFO_P(op_1) == IS_UNDEF)) &#123;</span><br><span class="line">        op_1 = ZVAL_UNDEFINED_OP1();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (UNEXPECTED(Z_TYPE_INFO_P(op_2) == IS_UNDEF)) &#123;</span><br><span class="line">        op_2 = ZVAL_UNDEFINED_OP2();</span><br><span class="line">    &#125;</span><br><span class="line">    add_function(EX_VAR(opline-&gt;result.var), op_1, op_2);</span><br><span class="line">    <span class="keyword">if</span> (OP1_TYPE &amp; (IS_TMP_VAR|IS_VAR)) &#123;</span><br><span class="line">        zval_ptr_dtor_nogc(op_1);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (OP2_TYPE &amp; (IS_TMP_VAR|IS_VAR)) &#123;</span><br><span class="line">        zval_ptr_dtor_nogc(op_2);</span><br><span class="line">    &#125;</span><br><span class="line">    ZEND_VM_NEXT_OPCODE_CHECK_EXCEPTION();</span><br><span class="line">&#125;</span><br><span class="line">=&gt;</span><br><span class="line">[</span><br><span class="line">    <span class="string">&quot;zend_add_helper&quot;</span> =&gt;</span><br><span class="line">    [</span><br><span class="line">        <span class="string">&quot;op1&quot;</span> =&gt; [</span><br><span class="line">            ANY:0</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;op2&quot;</span> =&gt; [</span><br><span class="line">            ANY:0</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;param&quot;</span> =&gt; <span class="string">&quot;zval *op_1, zval *op_2&quot;</span>,</span><br><span class="line">        <span class="string">&quot;code&quot;</span> =&gt; <span class="string">&quot; USE_OPLINE</span></span><br><span class="line"><span class="string">                    SAVE_OPLINE();</span></span><br><span class="line"><span class="string">                    if (UNEXPECTED(Z_TYPE_INFO_P(op_1) == IS_UNDEF)) &#123;</span></span><br><span class="line"><span class="string">                        op_1 = ZVAL_UNDEFINED_OP1();</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                    if (UNEXPECTED(Z_TYPE_INFO_P(op_2) == IS_UNDEF)) &#123;</span></span><br><span class="line"><span class="string">                        op_2 = ZVAL_UNDEFINED_OP2();</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                    add_function(EX_VAR(opline-&gt;result.var), op_1, op_2);</span></span><br><span class="line"><span class="string">                    if (OP1_TYPE &amp; (IS_TMP_VAR|IS_VAR)) &#123;</span></span><br><span class="line"><span class="string">                        zval_ptr_dtor_nogc(op_1);</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                    if (OP2_TYPE &amp; (IS_TMP_VAR|IS_VAR)) &#123;</span></span><br><span class="line"><span class="string">                        zval_ptr_dtor_nogc(op_2);</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                    ZEND_VM_NEXT_OPCODE_CHECK_EXCEPTION();&quot;</span>,</span><br><span class="line">        <span class="string">&quot;inline&quot;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;cold&quot;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">        <span class="string">&quot;hot&quot;</span> =&gt; <span class="literal">false</span>,</span><br><span class="line">    ]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>当扫描到<code>ZEND_VM_HANDLER</code>的代码之后，就会执行下面的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (strpos($line,<span class="string">&quot;ZEND_VM_HANDLER(&quot;</span>) === <span class="number">0</span> ||</span><br><span class="line">    strpos($line,<span class="string">&quot;ZEND_VM_INLINE_HANDLER(&quot;</span>) === <span class="number">0</span> ||</span><br><span class="line">    strpos($line,<span class="string">&quot;ZEND_VM_HOT_HANDLER(&quot;</span>) === <span class="number">0</span> ||</span><br><span class="line">    strpos($line,<span class="string">&quot;ZEND_VM_HOT_NOCONST_HANDLER(&quot;</span>) === <span class="number">0</span> ||</span><br><span class="line">    strpos($line,<span class="string">&quot;ZEND_VM_HOT_NOCONSTCONST_HANDLER(&quot;</span>) === <span class="number">0</span> ||</span><br><span class="line">    strpos($line,<span class="string">&quot;ZEND_VM_HOT_SEND_HANDLER(&quot;</span>) === <span class="number">0</span> ||</span><br><span class="line">    strpos($line,<span class="string">&quot;ZEND_VM_HOT_OBJ_HANDLER(&quot;</span>) === <span class="number">0</span> ||</span><br><span class="line">    strpos($line,<span class="string">&quot;ZEND_VM_COLD_HANDLER(&quot;</span>) === <span class="number">0</span> ||</span><br><span class="line">    strpos($line,<span class="string">&quot;ZEND_VM_COLD_CONST_HANDLER(&quot;</span>) === <span class="number">0</span> ||</span><br><span class="line">    strpos($line,<span class="string">&quot;ZEND_VM_COLD_CONSTCONST_HANDLER(&quot;</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Parsing opcode handler&#x27;s definition</span></span><br><span class="line">    <span class="keyword">if</span> (preg_match(</span><br><span class="line">            <span class="string">&quot;/^ZEND_VM_(HOT_|INLINE_|HOT_OBJ_|HOT_SEND_|HOT_NOCONST_|HOT_NOCONSTCONST_|COLD_|COLD_CONST_|COLD_CONSTCONST_)?HANDLER\(\s*([0-9]+)\s*,\s*([A-Z_]+)\s*,\s*([A-Z_|]+)\s*,\s*([A-Z_|]+)\s*(,\s*([A-Z_|]+)\s*)?(,\s*SPEC\(([A-Z_|=,]+)\)\s*)?\)/&quot;</span>,</span><br><span class="line">            $line,</span><br><span class="line">            $m) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;ERROR (<span class="subst">$def</span>:<span class="subst">$lineno</span>): Invalid ZEND_VM_HANDLER definition.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $hot = !<span class="keyword">empty</span>($m[<span class="number">1</span>]) ? $m[<span class="number">1</span>] : <span class="literal">false</span>;</span><br><span class="line">    $code = (<span class="keyword">int</span>)$m[<span class="number">2</span>];</span><br><span class="line">    $op   = $m[<span class="number">3</span>];</span><br><span class="line">    $len  = strlen($op);</span><br><span class="line">    $op1  = parse_operand_spec($def, $lineno, $m[<span class="number">4</span>], $flags1);</span><br><span class="line">    $op2  = parse_operand_spec($def, $lineno, $m[<span class="number">5</span>], $flags2);</span><br><span class="line">    $flags = $flags1 | ($flags2 &lt;&lt; <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($m[<span class="number">7</span>])) &#123;</span><br><span class="line">        $flags |= parse_ext_spec($def, $lineno, $m[<span class="number">7</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($len &gt; $max_opcode_len) &#123;</span><br><span class="line">        $max_opcode_len = $len;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($code &gt; $max_opcode) &#123;</span><br><span class="line">        $max_opcode = $code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($opcodes[$code])) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;ERROR (<span class="subst">$def</span>:<span class="subst">$lineno</span>): Opcode with code &#x27;<span class="subst">$code</span>&#x27; is already defined.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($opnames[$op])) &#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&quot;ERROR (<span class="subst">$def</span>:<span class="subst">$lineno</span>): Opcode with name &#x27;<span class="subst">$op</span>&#x27; is already defined.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    $opcodes[$code] = <span class="keyword">array</span>(<span class="string">&quot;op&quot;</span>=&gt;$op,<span class="string">&quot;op1&quot;</span>=&gt;$op1,<span class="string">&quot;op2&quot;</span>=&gt;$op2,<span class="string">&quot;code&quot;</span>=&gt;<span class="string">&quot;&quot;</span>,<span class="string">&quot;flags&quot;</span>=&gt;$flags,<span class="string">&quot;hot&quot;</span>=&gt;$hot);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">isset</span>($m[<span class="number">9</span>])) &#123;</span><br><span class="line">        $opcodes[$code][<span class="string">&quot;spec&quot;</span>] = parse_spec_rules($def, $lineno, $m[<span class="number">9</span>]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($opcodes[$code][<span class="string">&quot;spec&quot;</span>][<span class="string">&quot;NO_CONST_CONST&quot;</span>])) &#123;</span><br><span class="line">            $opcodes[$code][<span class="string">&quot;flags&quot;</span>] |= $vm_op_flags[<span class="string">&quot;ZEND_VM_NO_CONST_CONST&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($opcodes[$code][<span class="string">&quot;spec&quot;</span>][<span class="string">&quot;COMMUTATIVE&quot;</span>])) &#123;</span><br><span class="line">            $opcodes[$code][<span class="string">&quot;flags&quot;</span>] |= $vm_op_flags[<span class="string">&quot;ZEND_VM_COMMUTATIVE&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $opnames[$op] = $code;</span><br><span class="line">    $handler = $code;</span><br><span class="line">    $helper = <span class="literal">null</span>;</span><br><span class="line">    $list[$lineno] = <span class="keyword">array</span>(<span class="string">&quot;handler&quot;</span>=&gt;$handler);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这段代码具体的细节我们不去深究，总结起来就是去正则匹配<code>zend_vm_def.h</code>里面当前行的<code>ZEND_VM_HANDLER</code>，然后把相关的信息存在全局变量<code>$opcodes</code>里面。例如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">ZEND_VM_HOT_NOCONSTCONST_HANDLER(1, ZEND_ADD, CONST|TMPVARCV, CONST|TMPVARCV)</span><br><span class="line">=&gt;</span><br><span class="line">[</span><br><span class="line">    1 =&gt;</span><br><span class="line">    [</span><br><span class="line">        <span class="string">&quot;op&quot;</span> =&gt; <span class="string">&quot;ZEND_ADD&quot;</span>,</span><br><span class="line">        <span class="string">&quot;op1&quot;</span> =&gt; [</span><br><span class="line">            <span class="string">&quot;CONST&quot;</span> =&gt; 0,</span><br><span class="line">            <span class="string">&quot;TMPVARCV&quot;</span> =&gt; 1</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;op2&quot;</span> =&gt; [</span><br><span class="line">            <span class="string">&quot;CONST&quot;</span> =&gt; 0,</span><br><span class="line">            <span class="string">&quot;TMPVARCV&quot;</span> =&gt; 1</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">&quot;code&quot;</span> =&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">        <span class="string">&quot;flags&quot;</span> =&gt; 2827,</span><br><span class="line">        <span class="string">&quot;hot&quot;</span> =&gt; <span class="string">&quot;HOT_NOCONSTCONST_&quot;</span></span><br><span class="line">    ]</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>其中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1 =&gt; [</span><br><span class="line">    <span class="string">&quot;op&quot;</span> =&gt; <span class="string">&quot;ZEND_ADD&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>实际上就是<code>ZEND_VM_HOT_NOCONSTCONST_HANDLER(1, ZEND_ADD, CONST|TMPVARCV, CONST|TMPVARCV)</code>里面的<code>1</code>和<code>ZEND_ADD</code>，这会用来定义<code>opcode</code>，对应<code>zend_vm_opcodes.h</code>文件里面的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_ADD 1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;CONST&quot;</span> =&gt; 0,</span><br><span class="line"><span class="string">&quot;TMPVARCV&quot;</span> =&gt; 1</span><br></pre></td></tr></table></figure>

<p>代表<code>CONST|TMPVARCV</code>的序号。实际上就是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">array_flip(explode(<span class="string">&quot;|&quot;</span>, <span class="keyword">CONST</span>|TMPVARCV))</span><br></pre></td></tr></table></figure>

<p>之后的结果。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;flags&quot;</span> =&gt; 2827</span><br></pre></td></tr></table></figure>

<p>计算方法是<code>(CONST|TMPVARCV) | ((CONST|TMPVARCV) &lt;&lt; 8)</code>。至于<code>CONST</code>和<code>TMPVARCV</code>的值，我们可以在文件<code>zend_vm_gen.php</code>的变量<code>$vm_op_decode</code>里面找到。</p>
<p>接着，对于<code>ZEND_VM_HANDLER</code>就会执行<code>$opcodes[$handler][&quot;code&quot;] .= $line;</code>了，和<code>ZEND_VM_HELPER</code>的类似。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generate opcode #defines (zend_vm_opcodes.h)</span></span><br><span class="line">$code_len = strlen((<span class="keyword">string</span>)$max_opcode);</span><br><span class="line">$f = fopen(<span class="keyword">__DIR__</span> . <span class="string">&quot;/zend_vm_opcodes.h&quot;</span>, <span class="string">&quot;w+&quot;</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">&quot;ERROR: Cannot create zend_vm_opcodes.h\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Insert header</span></span><br><span class="line">out($f, HEADER_TEXT);</span><br><span class="line">fputs($f, <span class="string">&quot;#ifndef ZEND_VM_OPCODES_H\n#define ZEND_VM_OPCODES_H\n\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;#define ZEND_VM_SPEC\t\t&quot;</span> . ZEND_VM_SPEC . <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;#define ZEND_VM_LINES\t\t&quot;</span> . ZEND_VM_LINES . <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;#define ZEND_VM_KIND_CALL\t&quot;</span> . ZEND_VM_KIND_CALL . <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;#define ZEND_VM_KIND_SWITCH\t&quot;</span> . ZEND_VM_KIND_SWITCH . <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;#define ZEND_VM_KIND_GOTO\t&quot;</span> . ZEND_VM_KIND_GOTO . <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;#define ZEND_VM_KIND_HYBRID\t&quot;</span> . ZEND_VM_KIND_HYBRID . <span class="string">&quot;\n&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ($GLOBALS[<span class="string">&quot;vm_kind_name&quot;</span>][ZEND_VM_KIND] === <span class="string">&quot;ZEND_VM_KIND_HYBRID&quot;</span>) &#123;</span><br><span class="line">    fputs($f, <span class="string">&quot;/* HYBRID requires support for computed GOTO and global register variables*/\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;#if (defined(__GNUC__) &amp;&amp; defined(HAVE_GCC_GLOBAL_REGS))\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;# define ZEND_VM_KIND\t\tZEND_VM_KIND_HYBRID\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;#else\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;# define ZEND_VM_KIND\t\tZEND_VM_KIND_CALL\n&quot;</span>);</span><br><span class="line">    fputs($f, <span class="string">&quot;#endif\n&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fputs($f, <span class="string">&quot;#define ZEND_VM_KIND\t\t&quot;</span> . $GLOBALS[<span class="string">&quot;vm_kind_name&quot;</span>][ZEND_VM_KIND] . <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">fputs($f, <span class="string">&quot;\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这段代码就很简单了，直接往<code>zend_vm_opcodes.h</code>文件里面写这些内容。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span>($vm_op_flags <span class="keyword">as</span> $name =&gt; $val) &#123;</span><br><span class="line">    fprintf($f, <span class="string">&quot;#define %-24s 0x%08x\n&quot;</span>, $name, $val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码是把<code>zend_vm_gen.php</code>文件里面的<code>$vm_op_flags</code>内容以<code>16</code>进制的格式写在<code>zend_vm_opcodes.h</code>文件里面：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$vm_op_flags = <span class="built_in">array</span>(</span><br><span class="line">    <span class="string">&quot;ZEND_VM_OP_SPEC&quot;</span>         =&gt; <span class="number">1</span>&lt;&lt;<span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;ZEND_VM_OP_CONST&quot;</span>        =&gt; <span class="number">1</span>&lt;&lt;<span class="number">1</span>,</span><br><span class="line">    <span class="comment">// 省略其他的</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">=&gt;</span><br><span class="line"></span><br><span class="line">#define ZEND_VM_OP_SPEC          <span class="number">0x00000001</span></span><br><span class="line">#define ZEND_VM_OP_CONST         <span class="number">0x00000002</span></span><br><span class="line"><span class="comment">// 省略其他的</span></span><br></pre></td></tr></table></figure>

<p>接着</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> ($opcodes <span class="keyword">as</span> $code =&gt; $dsc) &#123;</span><br><span class="line">    $code = str_pad((<span class="keyword">string</span>)$code,$code_len,<span class="string">&quot; &quot;</span>,STR_PAD_LEFT);</span><br><span class="line">    $op = str_pad($dsc[<span class="string">&quot;op&quot;</span>],$max_opcode_len);</span><br><span class="line">    <span class="keyword">if</span> ($code &lt;= $max_opcode) &#123;</span><br><span class="line">        fputs($f,<span class="string">&quot;#define <span class="subst">$op</span> <span class="subst">$code</span>\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会去用我们上面搜集好的<code>$opcodes</code>来定义我们的<code>opcode</code>，例如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_NOP                          0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_ADD                          1</span></span><br><span class="line"><span class="comment">// 省略其他的</span></span><br></pre></td></tr></table></figure>

<p>接着</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$code = str_pad((<span class="keyword">string</span>)$max_opcode,$code_len,<span class="string">&quot; &quot;</span>,STR_PAD_LEFT);</span><br><span class="line">$op = str_pad(<span class="string">&quot;ZEND_VM_LAST_OPCODE&quot;</span>,$max_opcode_len);</span><br><span class="line">fputs($f,<span class="string">&quot;\n#define <span class="subst">$op</span> <span class="subst">$code</span>\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">fputs($f, <span class="string">&quot;\n#endif\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>会去定义<code>PHP</code>内核一共有多少个<code>opcode</code>，例如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_VM_LAST_OPCODE             199</span></span><br></pre></td></tr></table></figure>

<p>至此，我们的<code>zend_vm_opcodes.h</code>文件生成完毕了。接着，开始生成<code>zend_vm_opcodes.c</code>文件。</p>
<p>其中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fputs($f,<span class="string">&quot;static const char *zend_vm_opcodes_names[&quot;</span>.($max_opcode + <span class="number">1</span>).<span class="string">&quot;] = &#123;\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt;= $max_opcode; $i++) &#123;</span><br><span class="line">    fputs($f,<span class="string">&quot;\t&quot;</span>.(<span class="keyword">isset</span>($opcodes[$i][<span class="string">&quot;op&quot;</span>])?<span class="string">&#x27;&quot;&#x27;</span>.$opcodes[$i][<span class="string">&quot;op&quot;</span>].<span class="string">&#x27;&quot;&#x27;</span>:<span class="string">&quot;NULL&quot;</span>).<span class="string">&quot;,\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">fputs($f, <span class="string">&quot;&#125;;\n\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>用来定义我们所有<code>opcode</code>对应的名字，例如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span> *zend_vm_opcodes_names[<span class="number">200</span>] = &#123;</span><br><span class="line">    <span class="string">&quot;ZEND_NOP&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ZEND_ADD&quot;</span>,</span><br><span class="line">    <span class="comment">// 省略其他的</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>这个<code>zend_vm_opcodes_names</code>数组的索引实际上就是<code>opcode</code>对应的<code>id</code>。所以，如果我们要得到一个<code>opcode</code>的名字，那么可以通过以下方式拿到：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zend_vm_opcodes_names[ZEND_ADD]</span><br><span class="line">=&gt;</span><br><span class="line"><span class="string">&quot;ZEND_ADD&quot;</span></span><br></pre></td></tr></table></figure>

<p>接着</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fputs($f,<span class="string">&quot;static uint32_t zend_vm_opcodes_flags[&quot;</span>.($max_opcode + <span class="number">1</span>).<span class="string">&quot;] = &#123;\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt;= $max_opcode; $i++) &#123;</span><br><span class="line">    fprintf($f, <span class="string">&quot;\t0x%08x,\n&quot;</span>, <span class="keyword">isset</span>($opcodes[$i][<span class="string">&quot;flags&quot;</span>]) ? $opcodes[$i][<span class="string">&quot;flags&quot;</span>] : <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">fputs($f, <span class="string">&quot;&#125;;\n\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>用来定义<code>opcode</code>对应的<code>flags</code>。例如：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">uint32_t</span> zend_vm_opcodes_flags[<span class="number">200</span>] = &#123;</span><br><span class="line">    <span class="number">0x00000000</span>,</span><br><span class="line">    <span class="number">0x00000b0b</span>,</span><br><span class="line">    <span class="comment">// 省略其他的</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>flags</code>的值的算法我们已经在上面介绍过了，这里再总结下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$flags = $flags1 | ($flags2 &lt;&lt; <span class="number">8</span>);</span><br></pre></td></tr></table></figure>

<p>接着：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fputs($f, <span class="string">&quot;ZEND_API const char* ZEND_FASTCALL zend_get_opcode_name(zend_uchar opcode) &#123;\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;\tif (UNEXPECTED(opcode &gt; ZEND_VM_LAST_OPCODE)) &#123;\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;\t\treturn NULL;\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;\t&#125;\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;\treturn zend_vm_opcodes_names[opcode];\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;&#125;\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>定义一个获取<code>opcode name</code>的函数。生成的结果如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ZEND_API <span class="keyword">const</span> <span class="keyword">char</span>* ZEND_FASTCALL <span class="title">zend_get_opcode_name</span><span class="params">(zend_uchar opcode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UNEXPECTED(opcode &gt; ZEND_VM_LAST_OPCODE)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> zend_vm_opcodes_names[opcode];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先是判断一下是否有这个<code>opcode</code>，有的话返回它的<code>name</code>，没有的话返回<code>NULL</code>。</p>
<p>接着：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">puts($f, <span class="string">&quot;ZEND_API uint32_t ZEND_FASTCALL zend_get_opcode_flags(zend_uchar opcode) &#123;\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;\tif (UNEXPECTED(opcode &gt; ZEND_VM_LAST_OPCODE)) &#123;\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;\t\topcode = ZEND_NOP;\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;\t&#125;\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;\treturn zend_vm_opcodes_flags[opcode];\n&quot;</span>);</span><br><span class="line">fputs($f, <span class="string">&quot;&#125;\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>定义一个获取<code>opcode flags</code>的函数。生成的结果如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ZEND_API <span class="keyword">uint32_t</span> ZEND_FASTCALL <span class="title">zend_get_opcode_flags</span><span class="params">(zend_uchar opcode)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (UNEXPECTED(opcode &gt; ZEND_VM_LAST_OPCODE)) &#123;</span><br><span class="line">        opcode = ZEND_NOP;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> zend_vm_opcodes_flags[opcode];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>首先是判断一下是否有这个<code>opcode</code>，有的话返回它的<code>flags</code>，没有的话返回<code>ZEND_NOP</code>的<code>flags</code>（也就是<code>0</code>）。</p>
<p>至此，我们的<code>zend_vm_opcodes.c</code>文件生成完毕了。接着，开始生成<code>zend_vm_execute.h</code>文件。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Support for ZEND_USER_OPCODE</span></span><br><span class="line">out($f, <span class="string">&quot;static user_opcode_handler_t zend_user_opcode_handlers[256] = &#123;\n&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">255</span>; ++$i) &#123;</span><br><span class="line">    out($f, <span class="string">&quot;\t(user_opcode_handler_t)NULL,\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">out($f, <span class="string">&quot;\t(user_opcode_handler_t)NULL\n&#125;;\n\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>用来定义一个<code>zend_user_opcode_handlers</code>数组，这个数组初始的时候全都是<code>NULL</code>。生成结果如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">user_opcode_handler_t</span> zend_user_opcode_handlers[<span class="number">256</span>] = &#123;</span><br><span class="line">    (<span class="keyword">user_opcode_handler_t</span>)<span class="literal">NULL</span>,</span><br><span class="line">    (<span class="keyword">user_opcode_handler_t</span>)<span class="literal">NULL</span>,</span><br><span class="line">    (<span class="keyword">user_opcode_handler_t</span>)<span class="literal">NULL</span>,</span><br><span class="line">    <span class="comment">// 省略其他的</span></span><br><span class="line">    (<span class="keyword">user_opcode_handler_t</span>)<span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>接着：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">out($f, <span class="string">&quot;static zend_uchar zend_user_opcodes[256] = &#123;&quot;</span>);</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; <span class="number">255</span>; ++$i) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($i % <span class="number">16</span> == <span class="number">1</span>) out($f, <span class="string">&quot;\n\t&quot;</span>);</span><br><span class="line">    out($f, <span class="string">&quot;<span class="subst">$i</span>,&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">out($f, <span class="string">&quot;255\n&#125;;\n\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>用来定义我们的<code>zend_user_opcodes</code>，生成结果如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> zend_uchar zend_user_opcodes[<span class="number">256</span>] = &#123;<span class="number">0</span>,</span><br><span class="line">    <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>,<span class="number">9</span>,<span class="number">10</span>,<span class="number">11</span>,<span class="number">12</span>,<span class="number">13</span>,<span class="number">14</span>,<span class="number">15</span>,<span class="number">16</span>,</span><br><span class="line">    <span class="number">17</span>,<span class="number">18</span>,<span class="number">19</span>,<span class="number">20</span>,<span class="number">21</span>,<span class="number">22</span>,<span class="number">23</span>,<span class="number">24</span>,<span class="number">25</span>,<span class="number">26</span>,<span class="number">27</span>,<span class="number">28</span>,<span class="number">29</span>,<span class="number">30</span>,<span class="number">31</span>,<span class="number">32</span>,</span><br><span class="line">    <span class="number">33</span>,<span class="number">34</span>,<span class="number">35</span>,<span class="number">36</span>,<span class="number">37</span>,<span class="number">38</span>,<span class="number">39</span>,<span class="number">40</span>,<span class="number">41</span>,<span class="number">42</span>,<span class="number">43</span>,<span class="number">44</span>,<span class="number">45</span>,<span class="number">46</span>,<span class="number">47</span>,<span class="number">48</span>,</span><br><span class="line">    <span class="number">49</span>,<span class="number">50</span>,<span class="number">51</span>,<span class="number">52</span>,<span class="number">53</span>,<span class="number">54</span>,<span class="number">55</span>,<span class="number">56</span>,<span class="number">57</span>,<span class="number">58</span>,<span class="number">59</span>,<span class="number">60</span>,<span class="number">61</span>,<span class="number">62</span>,<span class="number">63</span>,<span class="number">64</span>,</span><br><span class="line">    <span class="number">65</span>,<span class="number">66</span>,<span class="number">67</span>,<span class="number">68</span>,<span class="number">69</span>,<span class="number">70</span>,<span class="number">71</span>,<span class="number">72</span>,<span class="number">73</span>,<span class="number">74</span>,<span class="number">75</span>,<span class="number">76</span>,<span class="number">77</span>,<span class="number">78</span>,<span class="number">79</span>,<span class="number">80</span>,</span><br><span class="line">    <span class="number">81</span>,<span class="number">82</span>,<span class="number">83</span>,<span class="number">84</span>,<span class="number">85</span>,<span class="number">86</span>,<span class="number">87</span>,<span class="number">88</span>,<span class="number">89</span>,<span class="number">90</span>,<span class="number">91</span>,<span class="number">92</span>,<span class="number">93</span>,<span class="number">94</span>,<span class="number">95</span>,<span class="number">96</span>,</span><br><span class="line">    <span class="number">97</span>,<span class="number">98</span>,<span class="number">99</span>,<span class="number">100</span>,<span class="number">101</span>,<span class="number">102</span>,<span class="number">103</span>,<span class="number">104</span>,<span class="number">105</span>,<span class="number">106</span>,<span class="number">107</span>,<span class="number">108</span>,<span class="number">109</span>,<span class="number">110</span>,<span class="number">111</span>,<span class="number">112</span>,</span><br><span class="line">    <span class="number">113</span>,<span class="number">114</span>,<span class="number">115</span>,<span class="number">116</span>,<span class="number">117</span>,<span class="number">118</span>,<span class="number">119</span>,<span class="number">120</span>,<span class="number">121</span>,<span class="number">122</span>,<span class="number">123</span>,<span class="number">124</span>,<span class="number">125</span>,<span class="number">126</span>,<span class="number">127</span>,<span class="number">128</span>,</span><br><span class="line">    <span class="number">129</span>,<span class="number">130</span>,<span class="number">131</span>,<span class="number">132</span>,<span class="number">133</span>,<span class="number">134</span>,<span class="number">135</span>,<span class="number">136</span>,<span class="number">137</span>,<span class="number">138</span>,<span class="number">139</span>,<span class="number">140</span>,<span class="number">141</span>,<span class="number">142</span>,<span class="number">143</span>,<span class="number">144</span>,</span><br><span class="line">    <span class="number">145</span>,<span class="number">146</span>,<span class="number">147</span>,<span class="number">148</span>,<span class="number">149</span>,<span class="number">150</span>,<span class="number">151</span>,<span class="number">152</span>,<span class="number">153</span>,<span class="number">154</span>,<span class="number">155</span>,<span class="number">156</span>,<span class="number">157</span>,<span class="number">158</span>,<span class="number">159</span>,<span class="number">160</span>,</span><br><span class="line">    <span class="number">161</span>,<span class="number">162</span>,<span class="number">163</span>,<span class="number">164</span>,<span class="number">165</span>,<span class="number">166</span>,<span class="number">167</span>,<span class="number">168</span>,<span class="number">169</span>,<span class="number">170</span>,<span class="number">171</span>,<span class="number">172</span>,<span class="number">173</span>,<span class="number">174</span>,<span class="number">175</span>,<span class="number">176</span>,</span><br><span class="line">    <span class="number">177</span>,<span class="number">178</span>,<span class="number">179</span>,<span class="number">180</span>,<span class="number">181</span>,<span class="number">182</span>,<span class="number">183</span>,<span class="number">184</span>,<span class="number">185</span>,<span class="number">186</span>,<span class="number">187</span>,<span class="number">188</span>,<span class="number">189</span>,<span class="number">190</span>,<span class="number">191</span>,<span class="number">192</span>,</span><br><span class="line">    <span class="number">193</span>,<span class="number">194</span>,<span class="number">195</span>,<span class="number">196</span>,<span class="number">197</span>,<span class="number">198</span>,<span class="number">199</span>,<span class="number">200</span>,<span class="number">201</span>,<span class="number">202</span>,<span class="number">203</span>,<span class="number">204</span>,<span class="number">205</span>,<span class="number">206</span>,<span class="number">207</span>,<span class="number">208</span>,</span><br><span class="line">    <span class="number">209</span>,<span class="number">210</span>,<span class="number">211</span>,<span class="number">212</span>,<span class="number">213</span>,<span class="number">214</span>,<span class="number">215</span>,<span class="number">216</span>,<span class="number">217</span>,<span class="number">218</span>,<span class="number">219</span>,<span class="number">220</span>,<span class="number">221</span>,<span class="number">222</span>,<span class="number">223</span>,<span class="number">224</span>,</span><br><span class="line">    <span class="number">225</span>,<span class="number">226</span>,<span class="number">227</span>,<span class="number">228</span>,<span class="number">229</span>,<span class="number">230</span>,<span class="number">231</span>,<span class="number">232</span>,<span class="number">233</span>,<span class="number">234</span>,<span class="number">235</span>,<span class="number">236</span>,<span class="number">237</span>,<span class="number">238</span>,<span class="number">239</span>,<span class="number">240</span>,</span><br><span class="line">    <span class="number">241</span>,<span class="number">242</span>,<span class="number">243</span>,<span class="number">244</span>,<span class="number">245</span>,<span class="number">246</span>,<span class="number">247</span>,<span class="number">248</span>,<span class="number">249</span>,<span class="number">250</span>,<span class="number">251</span>,<span class="number">252</span>,<span class="number">253</span>,<span class="number">254</span>,<span class="number">255</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>说明一共支持<code>256</code>个<code>zend_user_opcodes</code>。</p>
<p>接着，开始调用<code>gen_executor</code>来按照模板文件<code>Zend/zend_vm_execute.skl</code>生成代码。这个函数也是逐行扫描<code>zend_vm_execute.skl</code>文件。</p>
<p>其中<code>zend_vm_execute.skl</code>文件的第一行是：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;%DEFINES%&#125;</span><br></pre></td></tr></table></figure>

<p>意味着我们在<code>zend_vm_execute.h</code>里面需要生成一些定义。具体的生成过程如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">out($f,<span class="string">&quot;#define SPEC_START_MASK        0x0000ffff\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;#define SPEC_EXTRA_MASK        0xfffc0000\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;#define SPEC_RULE_OP1          0x00010000\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;#define SPEC_RULE_OP2          0x00020000\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;#define SPEC_RULE_OP_DATA      0x00040000\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;#define SPEC_RULE_RETVAL       0x00080000\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;#define SPEC_RULE_QUICK_ARG    0x00100000\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;#define SPEC_RULE_SMART_BRANCH 0x00200000\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;#define SPEC_RULE_COMMUTATIVE  0x00800000\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;#define SPEC_RULE_ISSET        0x01000000\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;#define SPEC_RULE_OBSERVER     0x02000000\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这是一些<code>opcode</code>对应的操作数的规则，例如<code>SPEC_RULE_OP1</code>意味着需要用到操作数<code>1</code>，并且支持的类型至少是<code>2</code>种。对应的代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($dsc[<span class="string">&quot;op1&quot;</span>]) &amp;&amp; !<span class="keyword">isset</span>($dsc[<span class="string">&quot;op1&quot;</span>][<span class="string">&quot;ANY&quot;</span>])) &#123;</span><br><span class="line">    $count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">foreach</span> ($op_types_ex <span class="keyword">as</span> $t) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($dsc[<span class="string">&quot;op1&quot;</span>][$t])) &#123;</span><br><span class="line">            $def_op1_type = $t;</span><br><span class="line">            $count++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ($count &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        $spec_op1 = <span class="literal">true</span>;</span><br><span class="line">        $specs[$num] .= <span class="string">&quot; | SPEC_RULE_OP1&quot;</span>;</span><br><span class="line">        $def_op1_type = <span class="string">&quot;ANY&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">out($f,<span class="string">&quot;static const uint32_t *zend_spec_handlers;\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;static const void * const *zend_opcode_handlers;\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;static int zend_handlers_count;\n&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ($kind == ZEND_VM_KIND_HYBRID) &#123;</span><br><span class="line">    out($f,<span class="string">&quot;#if (ZEND_VM_KIND == ZEND_VM_KIND_HYBRID)\n&quot;</span>);</span><br><span class="line">    out($f,<span class="string">&quot;static const void * const * zend_opcode_handler_funcs;\n&quot;</span>);</span><br><span class="line">    out($f,<span class="string">&quot;static zend_op hybrid_halt_op;\n&quot;</span>);</span><br><span class="line">    out($f,<span class="string">&quot;#endif\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">out($f,<span class="string">&quot;#if (ZEND_VM_KIND != ZEND_VM_KIND_HYBRID) || !ZEND_VM_SPEC\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;static const void *zend_vm_get_opcode_handler(zend_uchar opcode, const zend_op* op);\n&quot;</span>);</span><br><span class="line">out($f,<span class="string">&quot;#endif\n\n&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ($kind == ZEND_VM_KIND_HYBRID) &#123;</span><br><span class="line">    out($f,<span class="string">&quot;#if (ZEND_VM_KIND == ZEND_VM_KIND_HYBRID)\n&quot;</span>);</span><br><span class="line">    out($f,<span class="string">&quot;static const void *zend_vm_get_opcode_handler_func(zend_uchar opcode, const zend_op* op);\n&quot;</span>);</span><br><span class="line">    out($f,<span class="string">&quot;#else\n&quot;</span>);</span><br><span class="line">    out($f,<span class="string">&quot;# define zend_vm_get_opcode_handler_func zend_vm_get_opcode_handler\n&quot;</span>);</span><br><span class="line">    out($f,<span class="string">&quot;#endif\n\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个是根据<code>ZEND_VM_KIND</code>来定义一些变量和函数，生成结果如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint32_t</span> *zend_spec_handlers;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">void</span> * <span class="keyword">const</span> *zend_opcode_handlers;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> zend_handlers_count;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (ZEND_VM_KIND == ZEND_VM_KIND_HYBRID)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">void</span> * <span class="keyword">const</span> * zend_opcode_handler_funcs;</span><br><span class="line"><span class="keyword">static</span> zend_op hybrid_halt_op;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (ZEND_VM_KIND != ZEND_VM_KIND_HYBRID) || !ZEND_VM_SPEC</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">void</span> *<span class="title">zend_vm_get_opcode_handler</span><span class="params">(zend_uchar opcode, <span class="keyword">const</span> zend_op* op)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> (ZEND_VM_KIND == ZEND_VM_KIND_HYBRID)</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">void</span> *<span class="title">zend_vm_get_opcode_handler_func</span><span class="params">(zend_uchar opcode, <span class="keyword">const</span> zend_op* op)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> zend_vm_get_opcode_handler_func zend_vm_get_opcode_handler</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p><code>zend_vm_gen.php</code>默认是<code>ZEND_VM_KIND_HYBRID</code>模式。</p>
<p>接着，会有一大段的代码来定义一些如下宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HYBRID_NEXT()</span><br><span class="line">HYBRID_SWITCH()</span><br><span class="line">HYBRID_CASE(op)</span><br><span class="line">HYBRID_BREAK()</span><br><span class="line">HYBRID_DEFAULT</span><br></pre></td></tr></table></figure>

<p>接着，会调用<code>gen_executor_code</code>来生成<code>opcode</code>的详细<code>handler</code>。例如，我们的操作数有如下类型：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$op_types_ex = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&quot;ANY&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CONST&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TMPVARCV&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TMPVAR&quot;</span>,</span><br><span class="line">    <span class="string">&quot;TMP&quot;</span>,</span><br><span class="line">    <span class="string">&quot;VAR&quot;</span>,</span><br><span class="line">    <span class="string">&quot;UNUSED&quot;</span>,</span><br><span class="line">    <span class="string">&quot;CV&quot;</span>,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>那么，就最大就会有<code>op1_type * op1_type</code>个<code>handler</code>。所以，就会有如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Produce specialized executor</span></span><br><span class="line">$op1t = $op_types_ex;</span><br><span class="line"><span class="comment">// for each op1.op_type</span></span><br><span class="line"><span class="keyword">foreach</span>($op1t <span class="keyword">as</span> $op1) &#123;</span><br><span class="line">    $op2t = $op_types_ex;</span><br><span class="line">    <span class="comment">// for each op2.op_type</span></span><br><span class="line">    <span class="keyword">foreach</span>($op2t <span class="keyword">as</span> $op2) &#123;</span><br><span class="line">        <span class="comment">// for each handlers in helpers in original order</span></span><br><span class="line">        <span class="keyword">foreach</span> ($list <span class="keyword">as</span> $lineno =&gt; $dsc) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">isset</span>($dsc[<span class="string">&quot;handler&quot;</span>])) &#123;</span><br><span class="line">                $num = $dsc[<span class="string">&quot;handler&quot;</span>];</span><br><span class="line">                <span class="keyword">foreach</span> (extra_spec_handler($opcodes[$num]) <span class="keyword">as</span> $extra_spec) &#123;</span><br><span class="line">                    <span class="comment">// Check if handler accepts such types of operands (op1 and op2)</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">isset</span>($opcodes[$num][<span class="string">&quot;op1&quot;</span>][$op1]) &amp;&amp;</span><br><span class="line">                        <span class="keyword">isset</span>($opcodes[$num][<span class="string">&quot;op2&quot;</span>][$op2])) &#123;</span><br><span class="line">                        <span class="comment">// Generate handler code</span></span><br><span class="line">                        gen_handler($f, <span class="number">1</span>, $kind, $opcodes[$num][<span class="string">&quot;op&quot;</span>], $op1, $op2, <span class="keyword">isset</span>($opcodes[$num][<span class="string">&quot;use&quot;</span>]), $opcodes[$num][<span class="string">&quot;code&quot;</span>], $lineno, $opcodes[$num], $extra_spec, $switch_labels);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">isset</span>($dsc[<span class="string">&quot;helper&quot;</span>])) &#123;</span><br><span class="line">                $num = $dsc[<span class="string">&quot;helper&quot;</span>];</span><br><span class="line">                <span class="keyword">foreach</span> (extra_spec_handler($helpers[$num]) <span class="keyword">as</span> $extra_spec) &#123;</span><br><span class="line">                    <span class="comment">// Check if handler accepts such types of operands (op1 and op2)</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">isset</span>($helpers[$num][<span class="string">&quot;op1&quot;</span>][$op1]) &amp;&amp;</span><br><span class="line">                        <span class="keyword">isset</span>($helpers[$num][<span class="string">&quot;op2&quot;</span>][$op2])) &#123;</span><br><span class="line">                        <span class="comment">// Generate helper code</span></span><br><span class="line">                        gen_helper($f, <span class="number">1</span>, $kind, $num, $op1, $op2, $helpers[$num][<span class="string">&quot;param&quot;</span>], $helpers[$num][<span class="string">&quot;code&quot;</span>], $lineno, $helpers[$num][<span class="string">&quot;inline&quot;</span>], $helpers[$num][<span class="string">&quot;cold&quot;</span>], $helpers[$num][<span class="string">&quot;hot&quot;</span>], $extra_spec);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                var_dump($dsc);</span><br><span class="line">                <span class="keyword">die</span>(<span class="string">&quot;??? <span class="subst">$kind</span>:<span class="subst">$num</span>\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于这段代码，<code>$list</code>里面存放了所有的<code>helper</code>的名字和<code>opcode</code>的值，例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;helper&quot;</span> =&gt; <span class="string">&quot;zend_add_helper&quot;</span>,</span><br><span class="line"><span class="string">&quot;handler&quot;</span> =&gt; <span class="number">1</span>,</span><br><span class="line"><span class="string">&quot;helper&quot;</span> =&gt; <span class="string">&quot;zend_sub_helper&quot;</span>,</span><br><span class="line"><span class="string">&quot;handler&quot;</span> =&gt; <span class="number">2</span>,</span><br><span class="line"><span class="comment">// 省略其他的内容</span></span><br></pre></td></tr></table></figure>

<p>如果是<code>helper</code>，那么我们从<code>$helpers</code>里面获取到这个<code>helper</code>函数的信息。</p>
<p>如果是<code>handler</code>，那么我们从<code>$opcodes</code>里面获取到这个<code>opcode</code>的信息。</p>
<p>其中：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$opcodes[$num][<span class="string">&quot;op1&quot;</span>]</span><br><span class="line">$opcodes[$num][<span class="string">&quot;op2&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>里面存放的就是这个<code>opcode</code>对应的操作数<code>1</code>和操作数<code>2</code>支持的所有类型，我们在前面解析的时候就拿到了这些信息。</p>
<p>无论是是<code>helper</code>还是<code>opcode</code>类型的<code>handler</code>，都会调用<code>extra_spec_handler</code>来生成<code>spec</code>函数。在生成<code>spec</code>的时候，会将<code>zend_vm_def.h</code>里面对应的<code>handler</code>的<code>code</code>进行替换，替换的规则在函数<code>gen_code</code>里面。</p>
<p>生成了<code>handler</code>对应的<code>specs</code>之后，就完成了模板文件里面<code>&#123;%DEFINES%&#125;</code>的替换了。</p>
<p>接着，开始替换模板文件里面的<code>&#123;%EXECUTOR_NAME%&#125;</code>，也就是开始生成我们的<code>zend_execute</code>函数了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;EXECUTOR_NAME&quot;</span>:</span><br><span class="line">    out($f, $m[<span class="number">1</span>].$executor_name.$m[<span class="number">3</span>].<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>这里是名字是<code>execute</code>。</p>
<p>接着替换模板文件的<code>&#123;%HELPER_VARS%&#125;</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&quot;HELPER_VARS&quot;</span>:</span><br><span class="line">    <span class="comment">// 省略代码</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>生成结果如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ZEND_VM_IP_GLOBAL_REG</span></span><br><span class="line">    <span class="keyword">const</span> zend_op *orig_opline = opline;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> ZEND_VM_FP_GLOBAL_REG</span></span><br><span class="line">    zend_execute_data *orig_execute_data = execute_data;</span><br><span class="line">    execute_data = ex;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    zend_execute_data *execute_data = ex;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>接着替换模板文件的<code>&#123;%INTERNAL_LABELS%&#125;</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">out($f,$prolog.<span class="string">&quot;if (UNEXPECTED(execute_data == NULL)) &#123;\n&quot;</span>);</span><br><span class="line">out($f,$prolog.<span class="string">&quot;\tstatic const void * const labels[] = &#123;\n&quot;</span>);</span><br><span class="line">gen_labels($f, $spec, ($kind == ZEND_VM_KIND_HYBRID) ? ZEND_VM_KIND_GOTO : $kind, $prolog.<span class="string">&quot;\t\t&quot;</span>, $specs);</span><br><span class="line">out($f,$prolog.<span class="string">&quot;\t&#125;;\n&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这里定义了一个名字叫做<code>labels</code>的静态变量，也就意味着每次调用<code>zend_execute</code>是共享的。生成的代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (UNEXPECTED(execute_data == <span class="literal">NULL</span>)) &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">void</span> * <span class="keyword">const</span> labels[] = &#123;</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_NOP_SPEC_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_CONST_CONST_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_CONST_TMPVARCV_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_CONST_TMPVARCV_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_NULL_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_CONST_TMPVARCV_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_TMPVARCV_CONST_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_TMPVARCV_TMPVARCV_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_TMPVARCV_TMPVARCV_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_NULL_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_TMPVARCV_TMPVARCV_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_TMPVARCV_CONST_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_TMPVARCV_TMPVARCV_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_TMPVARCV_TMPVARCV_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_NULL_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_TMPVARCV_TMPVARCV_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_NULL_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_NULL_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_NULL_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_NULL_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_NULL_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_TMPVARCV_CONST_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_TMPVARCV_TMPVARCV_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_TMPVARCV_TMPVARCV_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_NULL_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_ADD_SPEC_TMPVARCV_TMPVARCV_LABEL,</span><br><span class="line">        (<span class="keyword">void</span>*)&amp;&amp;ZEND_NULL_LABEL</span><br><span class="line">        <span class="comment">// 省略其他的内容</span></span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>

<p>也就意味着，当第一次调用<code>zend_execute</code>的时候，会初始化这个<code>labels</code>变量。</p>
<p>接着，我们会生成一堆的<code>HYBRID_SWITCH</code>和<code>HYBRID_CASE</code>。这个和<code>labels</code>变量里面的指针是对应的，并且和我们生成的<code>handler</code>是对应的。我们后面会写一个小<code>demo</code>来解释下这个<code>switch ... case</code>的原理。</p>
<p>接着，会生成<code>$specs</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">uint32_t</span> specs[] = &#123;</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    <span class="number">1</span> | SPEC_RULE_OP1 | SPEC_RULE_OP2,</span><br><span class="line">    <span class="number">26</span> | SPEC_RULE_OP1 | SPEC_RULE_OP2,</span><br><span class="line">    <span class="number">51</span> | SPEC_RULE_OP1 | SPEC_RULE_OP2 | SPEC_RULE_COMMUTATIVE,</span><br><span class="line">    <span class="comment">// 省略其他的</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中，<code>SPEC_RULE_OP1</code>和<code>SPEC_RULE_OP2</code>解释过了。那么它们前面的数字是什么呢？实际上，前面的数字是第一个当前<code>opcode</code>的第一个<code>spec handler</code>在<code>labels</code>变量的索引。这么说比较抽象，我用下面的图来解释一下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">  +-------------+                                   +-------------+          </span><br><span class="line">  |    specs    |                                   |   labels    |          </span><br><span class="line">  +-------------+                                   +-------------+          </span><br><span class="line">                                                                             </span><br><span class="line">                                                                             </span><br><span class="line">+------+----+------+                       +--------------------------------+</span><br><span class="line">|      | 0  |      |----------------------&gt;|      ZEND_NOP_SPEC_LABEL       |</span><br><span class="line">+------+----+------+                       +--------------------------------+</span><br><span class="line">|      | 1  |      |----------------------&gt;|ZEND_ADD_SPEC_CONST_CONST_LABEL |</span><br><span class="line">+------+----+------+                       +--------------------------------+</span><br><span class="line">|      | 26 |      |-----------+           |ZEND_ADD_SPEC_CONST_TMPVARCV_LAB|</span><br><span class="line">+------+----+------+           |           +--------------------------------+</span><br><span class="line">|      | 51 |      |           |           |              ...               |</span><br><span class="line">+------+----+------+           |           +--------------------------------+</span><br><span class="line">|                  |           +----------&gt;|ZEND_SUB_SPEC_CONST_CONST_LABEL |</span><br><span class="line">|                  |                       +--------------------------------+</span><br><span class="line">|       ...        |                       |ZEND_SUB_SPEC_CONST_TMPVARCV_LAB|</span><br><span class="line">|                  |                       +--------------------------------+</span><br><span class="line">|                  |                       |              ...               |</span><br><span class="line">|                  |                       |                                |</span><br><span class="line">+------------------+                       +--------------------------------+</span><br></pre></td></tr></table></figure>

<p>至此，<code>zend_vm_gen.php</code>生成代码的过程结束了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/10/21/PHP%E5%86%85%E6%A0%B8%E7%94%9F%E6%88%90zend-vm-opcodes-h/" data-id="ckkj72zx200m2f6vx4wgacuca" data-title="PHP内核生成zend_vm_opcodes.h" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHP内核</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-PHP内核pass-two源码分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/21/PHP%E5%86%85%E6%A0%B8pass-two%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2020-10-21T04:34:42.000Z" itemprop="datePublished">2020-10-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/21/PHP%E5%86%85%E6%A0%B8pass-two%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">PHP内核pass_two源码分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本文基于的PHP8 commit为：14806e0824ecd598df74cac855868422e44aea53</p>
</blockquote>
<p>我们先来看一下<code>PHP</code>脚本到<code>opcode</code>的生成流程，在函数<code>zend_compile</code>里面：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 删除了部分代码</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> zend_op_array *<span class="title">zend_compile</span><span class="params">(<span class="keyword">int</span> type)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!zendparse()) &#123;</span><br><span class="line">        init_op_array(op_array, type, INITIAL_OP_ARRAY_SIZE);</span><br><span class="line"></span><br><span class="line">        zend_compile_top_stmt(CG(ast));</span><br><span class="line">        pass_two(op_array);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> op_array;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结起来如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 调用zendparse完成词法分析、语法分析从而生成AST。</span><br><span class="line"><span class="number">2.</span> 调用init_op_array, zend_compile_top_stmt来完成AST到opcode的转化，此时还没有设置opcode对应的handler，以及有一部分东西是编译时的。</span><br><span class="line"><span class="number">3.</span> 调用pass_two完成编译时到运行时信息的转化、设置opcode对应的handler。</span><br></pre></td></tr></table></figure>

<p>我们来看看具体的代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ZEND_API <span class="keyword">void</span> <span class="title">pass_two</span><span class="params">(zend_op_array *op_array)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    zend_op *opline, *end;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!ZEND_USER_CODE(op_array-&gt;type)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_USE_ABS_CONST_ADDR</span></span><br><span class="line">    <span class="keyword">if</span> (CG(context).opcodes_size != op_array-&gt;last) &#123;</span><br><span class="line">        op_array-&gt;opcodes = (zend_op *) erealloc(op_array-&gt;opcodes, <span class="keyword">sizeof</span>(zend_op)*op_array-&gt;last);</span><br><span class="line">        CG(context).opcodes_size = op_array-&gt;last;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (CG(context).literals_size != op_array-&gt;last_literal) &#123;</span><br><span class="line">        op_array-&gt;literals = (zval*)erealloc(op_array-&gt;literals, <span class="keyword">sizeof</span>(zval) * op_array-&gt;last_literal);</span><br><span class="line">        CG(context).literals_size = op_array-&gt;last_literal;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    op_array-&gt;opcodes = (zend_op *) erealloc(op_array-&gt;opcodes,</span><br><span class="line">        ZEND_MM_ALIGNED_SIZE_EX(<span class="keyword">sizeof</span>(zend_op) * op_array-&gt;last, <span class="number">16</span>) +</span><br><span class="line">        <span class="keyword">sizeof</span>(zval) * op_array-&gt;last_literal);</span><br><span class="line">    <span class="keyword">if</span> (op_array-&gt;literals) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(((<span class="keyword">char</span>*)op_array-&gt;opcodes) + ZEND_MM_ALIGNED_SIZE_EX(<span class="keyword">sizeof</span>(zend_op) * op_array-&gt;last, <span class="number">16</span>),</span><br><span class="line">            op_array-&gt;literals, <span class="keyword">sizeof</span>(zval) * op_array-&gt;last_literal);</span><br><span class="line">        efree(op_array-&gt;literals);</span><br><span class="line">        op_array-&gt;literals = (zval*)(((<span class="keyword">char</span>*)op_array-&gt;opcodes) + ZEND_MM_ALIGNED_SIZE_EX(<span class="keyword">sizeof</span>(zend_op) * op_array-&gt;last, <span class="number">16</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    CG(context).opcodes_size = op_array-&gt;last;</span><br><span class="line">    CG(context).literals_size = op_array-&gt;last_literal;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Needs to be set directly after the opcode/literal reallocation, to ensure destruction</span></span><br><span class="line"><span class="comment">    * happens correctly if any of the following fixups generate a fatal error. */</span></span><br><span class="line">    op_array-&gt;fn_flags |= ZEND_ACC_DONE_PASS_TWO;</span><br><span class="line"></span><br><span class="line">    opline = op_array-&gt;opcodes;</span><br><span class="line">    end = opline + op_array-&gt;last;</span><br><span class="line">    <span class="keyword">while</span> (opline &lt; end) &#123;</span><br><span class="line">        <span class="keyword">if</span> (opline-&gt;op1_type == IS_CONST) &#123;</span><br><span class="line">            ZEND_PASS_TWO_UPDATE_CONSTANT(op_array, opline, opline-&gt;op1);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opline-&gt;op1_type &amp; (IS_VAR|IS_TMP_VAR)) &#123;</span><br><span class="line">            opline-&gt;op1.var = EX_NUM_TO_VAR(op_array-&gt;last_var + opline-&gt;op1.var);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (opline-&gt;op2_type == IS_CONST) &#123;</span><br><span class="line">            ZEND_PASS_TWO_UPDATE_CONSTANT(op_array, opline, opline-&gt;op2);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opline-&gt;op2_type &amp; (IS_VAR|IS_TMP_VAR)) &#123;</span><br><span class="line">            opline-&gt;op2.var = EX_NUM_TO_VAR(op_array-&gt;last_var + opline-&gt;op2.var);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (opline-&gt;result_type &amp; (IS_VAR|IS_TMP_VAR)) &#123;</span><br><span class="line">            opline-&gt;result.var = EX_NUM_TO_VAR(op_array-&gt;last_var + opline-&gt;result.var);</span><br><span class="line">        &#125;</span><br><span class="line">        ZEND_VM_SET_OPCODE_HANDLER(opline);</span><br><span class="line">        opline++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_USE_ABS_CONST_ADDR</span></span><br><span class="line">    <span class="keyword">if</span> (CG(context).opcodes_size != op_array-&gt;last) &#123;</span><br><span class="line">        op_array-&gt;opcodes = (zend_op *) erealloc(op_array-&gt;opcodes, <span class="keyword">sizeof</span>(zend_op)*op_array-&gt;last);</span><br><span class="line">        CG(context).opcodes_size = op_array-&gt;last;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (CG(context).literals_size != op_array-&gt;last_literal) &#123;</span><br><span class="line">        op_array-&gt;literals = (zval*)erealloc(op_array-&gt;literals, <span class="keyword">sizeof</span>(zval) * op_array-&gt;last_literal);</span><br><span class="line">        CG(context).literals_size = op_array-&gt;last_literal;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br></pre></td></tr></table></figure>

<p>是在<code>32</code>位的机器上面进行设置的，此时，会重新分配<code>opcodes</code>和<code>literals</code>，可以避免内存的浪费。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">    op_array-&gt;opcodes = (zend_op *) erealloc(op_array-&gt;opcodes,</span><br><span class="line">        ZEND_MM_ALIGNED_SIZE_EX(<span class="keyword">sizeof</span>(zend_op) * op_array-&gt;last, <span class="number">16</span>) +</span><br><span class="line">        <span class="keyword">sizeof</span>(zval) * op_array-&gt;last_literal);</span><br><span class="line">    <span class="keyword">if</span> (op_array-&gt;literals) &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>(((<span class="keyword">char</span>*)op_array-&gt;opcodes) + ZEND_MM_ALIGNED_SIZE_EX(<span class="keyword">sizeof</span>(zend_op) * op_array-&gt;last, <span class="number">16</span>),</span><br><span class="line">            op_array-&gt;literals, <span class="keyword">sizeof</span>(zval) * op_array-&gt;last_literal);</span><br><span class="line">        efree(op_array-&gt;literals);</span><br><span class="line">        op_array-&gt;literals = (zval*)(((<span class="keyword">char</span>*)op_array-&gt;opcodes) + ZEND_MM_ALIGNED_SIZE_EX(<span class="keyword">sizeof</span>(zend_op) * op_array-&gt;last, <span class="number">16</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    CG(context).opcodes_size = op_array-&gt;last;</span><br><span class="line">    CG(context).literals_size = op_array-&gt;last_literal;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>是在<code>64</code>位的机器上面进行设置的，此时，会重新分配<code>opcodes</code>，大小是<code>opline</code>的条数加上字面量的个数，然后把<code>literals</code>拷贝到<code>opcodes</code>的最后面。这样，使得<code>opcodes</code>和<code>literals</code>是在一块连续的内存上面。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (opline &lt; end) &#123;</span><br><span class="line">        <span class="keyword">if</span> (opline-&gt;op1_type == IS_CONST) &#123;</span><br><span class="line">            c(op_array, opline, opline-&gt;op1);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opline-&gt;op1_type &amp; (IS_VAR|IS_TMP_VAR)) &#123;</span><br><span class="line">            opline-&gt;op1.var = EX_NUM_TO_VAR(op_array-&gt;last_var + opline-&gt;op1.var);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (opline-&gt;op2_type == IS_CONST) &#123;</span><br><span class="line">            ZEND_PASS_TWO_UPDATE_CONSTANT(op_array, opline, opline-&gt;op2);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (opline-&gt;op2_type &amp; (IS_VAR|IS_TMP_VAR)) &#123;</span><br><span class="line">            opline-&gt;op2.var = EX_NUM_TO_VAR(op_array-&gt;last_var + opline-&gt;op2.var);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (opline-&gt;result_type &amp; (IS_VAR|IS_TMP_VAR)) &#123;</span><br><span class="line">            opline-&gt;result.var = EX_NUM_TO_VAR(op_array-&gt;last_var + opline-&gt;result.var);</span><br><span class="line">        &#125;</span><br><span class="line">        ZEND_VM_SET_OPCODE_HANDLER(opline);</span><br><span class="line">        opline++;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>调用<code>ZEND_PASS_TWO_UPDATE_CONSTANT</code>来完成常量编译时到运行时的转换。我们来看看这个宏：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* constant-time constant */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> CT_CONSTANT_EX(op_array, num) \</span></span><br><span class="line">    ((op_array)-&gt;literals + (num))</span><br><span class="line"></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> CT_CONSTANT(node) \</span></span><br><span class="line">    CT_CONSTANT_EX(CG(active_op_array), (node).constant)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> ZEND_USE_ABS_CONST_ADDR</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* run-time constant */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> RT_CONSTANT(opline, node) \</span></span><br><span class="line">    (node).zv</span><br><span class="line"></span><br><span class="line"><span class="comment">/* convert constant from compile-time to run-time */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> ZEND_PASS_TWO_UPDATE_CONSTANT(op_array, opline, node) do &#123; \</span></span><br><span class="line">        (node).zv = CT_CONSTANT_EX(op_array, (node).constant); \</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* At run-time, constants are allocated together with op_array-&gt;opcodes</span></span><br><span class="line"><span class="comment">* and addressed relatively to current opline.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* run-time constant */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> RT_CONSTANT(opline, node) \</span></span><br><span class="line">    ((zval*)(((<span class="keyword">char</span>*)(opline)) + (<span class="keyword">int32_t</span>)(node).constant))</span><br><span class="line"></span><br><span class="line"><span class="comment">/* convert constant from compile-time to run-time */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> ZEND_PASS_TWO_UPDATE_CONSTANT(op_array, opline, node) do &#123; \</span></span><br><span class="line">        (node).constant = \</span><br><span class="line">            (((<span class="keyword">char</span>*)CT_CONSTANT_EX(op_array, (node).constant)) - \</span><br><span class="line">            ((<span class="keyword">char</span>*)opline)); \</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>在<code>32</code>位的机器上，走的逻辑是：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> CT_CONSTANT_EX(op_array, num) \</span></span><br><span class="line">    ((op_array)-&gt;literals + (num))</span><br><span class="line"></span><br><span class="line"><span class="comment">/* run-time constant */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> RT_CONSTANT(opline, node) \</span></span><br><span class="line">    (node).zv</span><br><span class="line"></span><br><span class="line"><span class="comment">/* convert constant from compile-time to run-time */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> ZEND_PASS_TWO_UPDATE_CONSTANT(op_array, opline, node) do &#123; \</span></span><br><span class="line">        (node).zv = CT_CONSTANT_EX(op_array, (node).constant); \</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>我们知道，在编译的时候，<code>(node).constant</code>存的是字面量在<code>(op_array)-&gt;literals</code>的索引，也就是<code>1</code>，<code>2</code>，<code>3</code>等等。</p>
<p>而进行编译时到运行时的转换后，<code>(node).constant</code>存的就是字面量在<code>(op_array)-&gt;literals</code>的绝对地址了。</p>
<p>我们再来看看<code>64</code>位的机器上，走的逻辑是：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> CT_CONSTANT_EX(op_array, num) \</span></span><br><span class="line">    ((op_array)-&gt;literals + (num))</span><br><span class="line"></span><br><span class="line"><span class="comment">/* run-time constant */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> RT_CONSTANT(opline, node) \</span></span><br><span class="line">    ((zval*)(((<span class="keyword">char</span>*)(opline)) + (<span class="keyword">int32_t</span>)(node).constant))</span><br><span class="line"></span><br><span class="line"><span class="comment">/* convert constant from compile-time to run-time */</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> ZEND_PASS_TWO_UPDATE_CONSTANT(op_array, opline, node) do &#123; \</span></span><br><span class="line">        (node).constant = \</span><br><span class="line">            (((<span class="keyword">char</span>*)CT_CONSTANT_EX(op_array, (node).constant)) - \</span><br><span class="line">            ((<span class="keyword">char</span>*)opline)); \</span><br><span class="line">    &#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>我们发现，进行编译时到运行时的转换后，<code>(node).constant</code>存的就是字面量相对当前<code>opline</code>的相对地址了。因为在<code>64</code>位的机器上，<code>opcodes</code>和<code>literals</code>是在一块连续的内存上面，所以可以存一个相对地址。如下图：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">+----------------------------+   </span><br><span class="line">|          opcodes           |   </span><br><span class="line">+----------------------------+   </span><br><span class="line">                                 </span><br><span class="line">+----------------------------+   </span><br><span class="line">|          opline1           |--+</span><br><span class="line">+----------------------------+  |</span><br><span class="line">|          opline2           |  |</span><br><span class="line">+----------------------------+  |</span><br><span class="line">|          opline3           |  |</span><br><span class="line">+----------------------------+  |</span><br><span class="line">|                            |  |</span><br><span class="line">|           ......           |  |</span><br><span class="line">|     Continuous memory      |  |</span><br><span class="line">|                            |  |</span><br><span class="line">|                            |  |</span><br><span class="line">+----------------------------+  |</span><br><span class="line">|          literal1          |&lt;-+</span><br><span class="line">+----------------------------+   </span><br><span class="line">|          literal2          |   </span><br><span class="line">+----------------------------+   </span><br><span class="line">|          literal3          |   </span><br><span class="line">+----------------------------+   </span><br><span class="line">|                            |   </span><br><span class="line">|           ......           |   </span><br><span class="line">|                            |   </span><br><span class="line">+----------------------------+   </span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZEND_VM_SET_OPCODE_HANDLER(opline);</span><br></pre></td></tr></table></figure>

<p>这一步就是设置我们<code>opcode</code>对应的<code>handler</code>了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/10/21/PHP%E5%86%85%E6%A0%B8pass-two%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" data-id="ckkj72zre001yf6vxet6tg6ei" data-title="PHP内核pass_two源码分析" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHP内核</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《手把手教你编写PHP编译器》-echo-expr生成opcode" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/21/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-echo-expr%E7%94%9F%E6%88%90opcode/" class="article-date">
  <time class="dt-published" datetime="2020-10-20T16:29:17.000Z" itemprop="datePublished">2020-10-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/21/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-echo-expr%E7%94%9F%E6%88%90opcode/">《手把手教你编写PHP编译器》-echo_expr生成opcode</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>上篇文章，我们讲解了如何从<code>yaphp</code>源代码生成<code>AST</code>。这篇文章，我们来讲解如何从<code>AST</code>生成<code>opcode</code>。</p>
<p>一句话总结起来就是，我们对<code>AST</code>进行深度遍历，然后以每一个子<code>AST</code>来生成一条<code>opline</code>，最终得到<code>op_array</code>。我们来看一下具体如何去实现它。</p>
<p>首先，我们需要定义一下和<code>op_array</code>相关的数据结构：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_UNUSED 0 <span class="comment">/* Unused operand */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_CONST (1 &lt;&lt; 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_TMP_VAR (1 &lt;&lt; 1)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_VAR (1 &lt;&lt; 2)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_CV (1 &lt;&lt; 3) <span class="comment">/* Compiled variable */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INITIAL_OP_ARRAY_SIZE 64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_op_array</span> <span class="title">zend_op_array</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_oparray_context</span> <span class="title">zend_oparray_context</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_op</span> <span class="title">zend_op</span>;</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> _znode_op znode_op;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">znode</span> <span class="title">znode</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">union</span> _znode_op &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> num;</span><br><span class="line">    <span class="keyword">uint32_t</span> var;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">znode</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> op_type;</span><br><span class="line">    znode_op op;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_op</span> &#123;</span></span><br><span class="line">    znode_op op1;</span><br><span class="line">    znode_op op2;</span><br><span class="line">    znode_op result;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> opcode;</span><br><span class="line">    <span class="keyword">char</span> op1_type;</span><br><span class="line">    <span class="keyword">char</span> op2_type;</span><br><span class="line">    <span class="keyword">char</span> result_type;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_op_array</span> &#123;</span></span><br><span class="line">    zend_op *opcodes;</span><br><span class="line">    <span class="keyword">uint32_t</span> last; <span class="comment">/* number of opcodes */</span></span><br><span class="line">    <span class="keyword">uint32_t</span> T;    <span class="comment">/* number of temporary variables */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_oparray_context</span> &#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> opcodes_size;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中，<code>_zend_op_array</code>是核心结构，其他的结构都是以它为中心展开的。这些结构的具体含义我们可以在很多<code>PHP</code>源码分析的文章里面找到，所以我们不过多介绍。</p>
<p>这里，我们来看看<code>_zend_op</code>结构，我们发现，这个结构本质上是一种三地址码格式。有一个指令类型的<code>opcode</code>，有两个操作数 <code>op1</code>和<code>op2</code>和一个结果<code>result</code>。</p>
<p>现在，让我们来实现一下对<code>AST</code>的处理流程，在文件<code>zend_language_parser.y</code>里面：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">op_array &#x3D; (zend_op_array *) malloc(sizeof(zend_op_array));</span><br><span class="line">init_op_array(op_array, INITIAL_OP_ARRAY_SIZE);</span><br><span class="line">CG(active_op_array) &#x3D; op_array;</span><br><span class="line"></span><br><span class="line">zend_oparray_context_begin();</span><br><span class="line">zend_compile_top_stmt(CG(ast));</span><br></pre></td></tr></table></figure>

<p>这就是我们的核心了，这里的步骤可以总结为：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 初始化op_array，并且赋值给CG(active_op_array)</span><br><span class="line">2. 调用zend_oparray_context_begin初始化CG(context)</span><br><span class="line">3. 调用zend_compile_top_stmt生成opcode</span><br></pre></td></tr></table></figure>

<p><code>OK</code>，以这个为思路，我们来看看具体如何实现的。</p>
<p>首先是函数<code>init_op_array</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_op_array</span><span class="params">(zend_op_array *op_array, <span class="keyword">int</span> initial_ops_size)</span> </span>&#123;</span><br><span class="line">    op_array-&gt;opcodes = (zend_op *) <span class="built_in">malloc</span>(initial_ops_size * <span class="keyword">sizeof</span>(zend_op));</span><br><span class="line">    op_array-&gt;last = <span class="number">0</span>;</span><br><span class="line">    op_array-&gt;T = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数非常的简单，首先为<code>op_array</code>里面保存的<code>opcodes</code>分配初始化的内存；然后设置<code>last</code>（即<code>opline</code>的条数）为<code>0</code>；然后设置<code>T</code>（即临时变量的个数为<code>0</code>，后面，我们的临时变量的名字是按照<code>T</code>来递增命名的，例如第一个临时变量叫做<code>1</code>，第二个临时变量叫做<code>2</code>，依次类推）为0。</p>
<p>然后是<code>zend_oparray_context_begin</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zend_oparray_context_begin</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CG(context).opcodes_size = INITIAL_OP_ARRAY_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个<code>CG(context)</code>会与我们的<code>CG(active_op_array)</code>挂钩，例如这里的<code>CG(context).opcodes_size</code>表示，我们的<code>CG(active_op_array)</code>总容量。可想而知，当我们编译的<code>opline</code>条数达到<code>CG(context).opcodes_size</code>的时候，需要进行<code>CG(active_op_array)</code>的扩容。</p>
<p>最后就是我们的核心函数<code>zend_compile_top_stmt</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zend_compile_top_stmt</span><span class="params">(zend_ast *ast)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ast) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ast-&gt;kind == ZEND_AST_STMT_LIST) &#123;</span><br><span class="line">        zend_ast_list *<span class="built_in">list</span> = zend_ast_get_list(ast);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">uint32_t</span> i = <span class="number">0</span>; i &lt; <span class="built_in">list</span>-&gt;children; ++i) &#123;</span><br><span class="line">            zend_compile_top_stmt(<span class="built_in">list</span>-&gt;child[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    zend_compile_stmt(ast);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数是用来编译我们的<code>ZEND_AST_STMT_LIST</code>的。然后，每一条语句，我们会调用<code>zend_compile_stmt</code>来进行编译。</p>
<p>我们来看看<code>zend_compile_stmt</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zend_compile_stmt</span><span class="params">(zend_ast *ast)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ast) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (ast-&gt;kind) &#123;</span><br><span class="line">    <span class="keyword">case</span> ZEND_AST_ECHO:</span><br><span class="line">        zend_compile_echo(ast);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为我们目前只实现了<code>echo</code>语句，所以，我们这里只有一个<code>ZEND_AST_ECHO</code>的类型。我们来看看我们是如何编译<code>echo</code>语句的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zend_compile_echo</span><span class="params">(zend_ast *ast)</span> </span>&#123;</span><br><span class="line">    zend_ast *expr_ast = ast-&gt;child[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    znode expr_node;</span><br><span class="line">    zend_compile_expr(&amp;expr_node, expr_ast);</span><br><span class="line"></span><br><span class="line">    zend_emit_op(ZEND_ECHO, &amp;expr_node, <span class="literal">nullptr</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数做了两件事情，第一件事情是编译<code>echo</code>节点使用的<code>expr ast</code>，第二件事情为<code>echo ast</code>（也就是我们的<code>echo</code>语句）生成一条<code>opline</code>。</p>
<p>我们来看看我们是如何编译<code>expr_ast</code>的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zend_compile_expr</span><span class="params">(znode *result, zend_ast *ast)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ast-&gt;kind) &#123;</span><br><span class="line">    <span class="keyword">case</span> ZEND_AST_LNUM:</span><br><span class="line">        result-&gt;op.num = zend_ast_get_lnum(ast)-&gt;lnum;</span><br><span class="line">        result-&gt;op_type = IS_CONST;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ZEND_AST_BINARY_OP:</span><br><span class="line">        zend_compile_binary_op(result, ast);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，如果是一个<code>ZEND_AST_LNUM</code>类型的节点（也就是一个数字），那么我们直接返回它作为编译<code>ast</code>后的结果；如果是一个<code>ZEND_AST_BINARY_OP</code>类型的节点（也就是操作符），那么我们需要继续编译。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">zend_compile_binary_op</span><span class="params">(znode *result, zend_ast *ast)</span> </span>&#123;</span><br><span class="line">    zend_ast *left_ast = ast-&gt;child[<span class="number">0</span>];</span><br><span class="line">    zend_ast *right_ast = ast-&gt;child[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">uint32_t</span> opcode = ast-&gt;attr;</span><br><span class="line"></span><br><span class="line">    znode left_node, right_node;</span><br><span class="line"></span><br><span class="line">    zend_compile_expr(&amp;left_node, left_ast);</span><br><span class="line">    zend_compile_expr(&amp;right_node, right_ast);</span><br><span class="line"></span><br><span class="line">    zend_emit_op_tmp(result, opcode, &amp;left_node, &amp;right_node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，对<code>ZEND_AST_BINARY_OP</code>类型的编译实际上就是一个递归的函数。我们发现，只有在<code>AST</code>的子节点都是终结符的时候，我们才会调用<code>zend_emit_op_tmp</code>生成一条<code>opline</code>。我们看看<code>zend_emit_op_tmp</code>的实现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * generate an opline</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> zend_op *<span class="title">zend_emit_op</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> opcode, znode *op1, znode *op2)</span> </span>&#123;</span><br><span class="line">    zend_op *opline = get_next_op();</span><br><span class="line">    opline-&gt;opcode = opcode;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (op1 != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        opline-&gt;op1_type = op1-&gt;op_type;</span><br><span class="line">        opline-&gt;op1 = op1-&gt;op;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (op2 != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        opline-&gt;op2_type = op2-&gt;op_type;</span><br><span class="line">        opline-&gt;op2 = op2-&gt;op;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> opline;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">uint32_t</span> <span class="title">get_temporary_variable</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ++CG(active_op_array)-&gt;T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> zend_op *<span class="title">zend_emit_op_tmp</span><span class="params">(znode *result, <span class="keyword">unsigned</span> <span class="keyword">char</span> opcode, znode *op1, znode *op2)</span> </span>&#123;</span><br><span class="line">    zend_op *opline = zend_emit_op(opcode, op1, op2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        zend_make_tmp_result(result, opline);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> opline;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这几个函数就非常的简单了，设置<code>opline</code>的<code>op1</code>和<code>op2</code>，然后<code>opline</code>的<code>result</code>我们都用一个临时变量。因为我们的<code>_zend_op</code>是一个三地址码，所以，我们一条表达式里面，如果出现了多个操作符和多个操作数，那么我们就需要拆解出来，因此，我们就需要临时变量来作为中间结果了。例如<code>1 + 2 + 3</code>对应的过程如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">+----------------------+</span><br><span class="line">|      <span class="number">1</span> + <span class="number">2</span> + <span class="number">3</span>       |</span><br><span class="line">+----------------------+</span><br><span class="line">            |           </span><br><span class="line">            |           </span><br><span class="line">            v           </span><br><span class="line">+----------------------+</span><br><span class="line">|      T1 = <span class="number">1</span> + <span class="number">2</span>      |</span><br><span class="line">+----------------------+</span><br><span class="line">            |           </span><br><span class="line">            |           </span><br><span class="line">            |           </span><br><span class="line">            v           </span><br><span class="line">+----------------------+</span><br><span class="line">|     T2 = T1 + <span class="number">3</span>      |</span><br><span class="line">+----------------------+</span><br></pre></td></tr></table></figure>

<p>这样，我们就实现了<code>AST</code>到<code>opcode</code>的转化，我们来编写一个测试脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="number">1</span> + <span class="number">2</span> * <span class="number">3</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="number">1</span> + <span class="number">2</span> + <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">*********************gennerate opcode*********************</span><br><span class="line"><span class="comment">#0		ZEND_MUL		2		3		~1</span></span><br><span class="line"><span class="comment">#1		ZEND_ADD		1		~1		~2</span></span><br><span class="line"><span class="comment">#2		ZEND_ECHO		~2</span></span><br><span class="line"><span class="comment">#3		ZEND_ADD		1		2		~3</span></span><br><span class="line"><span class="comment">#4		ZEND_ADD		~3		3		~4</span></span><br><span class="line"><span class="comment">#5		ZEND_ECHO		~4</span></span><br></pre></td></tr></table></figure>

<p>可以看到，是符合我们的预期的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/10/21/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-echo-expr%E7%94%9F%E6%88%90opcode/" data-id="ckkj72zt8006lf6vxciq0ghan" data-title="《手把手教你编写PHP编译器》-echo_expr生成opcode" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/4/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost/" rel="tag">Boost</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Composer/" rel="tag">Composer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C%E8%AF%AD%E8%A8%80/" rel="tag">C语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dockerfile/" rel="tag">Dockerfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GRPC/" rel="tag">GRPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GraphQL/" rel="tag">GraphQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hyperf/" rel="tag">Hyperf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" rel="tag">I/O多路复用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JIT/" rel="tag">JIT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JWT/" rel="tag">JWT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Laravel/" rel="tag">Laravel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MacOS/" rel="tag">MacOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/" rel="tag">Mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OPcache/" rel="tag">OPcache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHP 扩展开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP7/" rel="tag">PHP7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHP内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95/" rel="tag">PHP扩展</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHP扩展开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/" rel="tag">PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Protobuf/" rel="tag">Protobuf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swoole%E5%BE%AE%E8%AF%BE%E7%A8%8B/" rel="tag">Swoole微课程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vscode/" rel="tag">Vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xdebug/" rel="tag">Xdebug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/composer/" rel="tag">composer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c%E8%AF%AD%E8%A8%80/" rel="tag">c语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-compose/" rel="tag">docker-compose</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/epoll/" rel="tag">epoll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fpm/" rel="tag">fpm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gqlgen/" rel="tag">gqlgen</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/migrate/" rel="tag">migrate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swoole/" rel="tag">swoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swore/" rel="tag">swore</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tinyswoole/" rel="tag">tinyswoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unique-lock/" rel="tag">unique_lock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-js/" rel="tag">vue.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%B6%E4%BB%96/" rel="tag">其他</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%8F%E7%A8%8B/" rel="tag">协程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%96%E9%83%A8%E6%8E%92%E5%BA%8F/" rel="tag">外部排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" rel="tag">多线程编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/" rel="tag">引用计数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD/" rel="tag">性能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" rel="tag">性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" rel="tag">性能分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" rel="tag">服务器开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" rel="tag">服务器编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" rel="tag">汇编语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" rel="tag">秒杀系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B/" rel="tag">线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A0%81/" rel="tag">编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" rel="tag">编译器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag">网络编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag">虚拟机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" rel="tag">计算机基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" rel="tag">计算机系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E8%AF%BB%E4%BB%A3%E7%A0%81/" rel="tag">读读代码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B0%83%E8%AF%95/" rel="tag">调试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%92%E5%BD%92/" rel="tag">递归</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%94%81/" rel="tag">锁</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Boost/" style="font-size: 10px;">Boost</a> <a href="/tags/C/" style="font-size: 11.43px;">C</a> <a href="/tags/C/" style="font-size: 16.43px;">C++</a> <a href="/tags/Composer/" style="font-size: 10px;">Composer</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 15px;">C语言</a> <a href="/tags/Docker/" style="font-size: 11.43px;">Docker</a> <a href="/tags/Dockerfile/" style="font-size: 10px;">Dockerfile</a> <a href="/tags/GRPC/" style="font-size: 10.71px;">GRPC</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/GraphQL/" style="font-size: 10px;">GraphQL</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Hyperf/" style="font-size: 10.71px;">Hyperf</a> <a href="/tags/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" style="font-size: 10.71px;">I/O多路复用</a> <a href="/tags/JIT/" style="font-size: 10px;">JIT</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Laravel/" style="font-size: 10px;">Laravel</a> <a href="/tags/Linux/" style="font-size: 17.14px;">Linux</a> <a href="/tags/MacOS/" style="font-size: 10px;">MacOS</a> <a href="/tags/MySQL/" style="font-size: 10.71px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/OPcache/" style="font-size: 10px;">OPcache</a> <a href="/tags/PHP/" style="font-size: 20px;">PHP</a> <a href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size: 10.71px;">PHP 扩展开发</a> <a href="/tags/PHP7/" style="font-size: 10px;">PHP7</a> <a href="/tags/PHP%E5%86%85%E6%A0%B8/" style="font-size: 17.86px;">PHP内核</a> <a href="/tags/PHP%E6%89%A9%E5%B1%95/" style="font-size: 13.57px;">PHP扩展</a> <a href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size: 12.14px;">PHP扩展开发</a> <a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="/tags/Protobuf/" style="font-size: 10.71px;">Protobuf</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/Swoole/" style="font-size: 19.29px;">Swoole</a> <a href="/tags/Swoole%E5%BE%AE%E8%AF%BE%E7%A8%8B/" style="font-size: 10px;">Swoole微课程</a> <a href="/tags/Vscode/" style="font-size: 10px;">Vscode</a> <a href="/tags/Xdebug/" style="font-size: 10.71px;">Xdebug</a> <a href="/tags/c/" style="font-size: 10.71px;">c++</a> <a href="/tags/composer/" style="font-size: 10px;">composer</a> <a href="/tags/c%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">c语言</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/docker-compose/" style="font-size: 10px;">docker-compose</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/fpm/" style="font-size: 10px;">fpm</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/gqlgen/" style="font-size: 10px;">gqlgen</a> <a href="/tags/leetcode/" style="font-size: 12.14px;">leetcode</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/migrate/" style="font-size: 10px;">migrate</a> <a href="/tags/nginx/" style="font-size: 10.71px;">nginx</a> <a href="/tags/php/" style="font-size: 15.71px;">php</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/swoole/" style="font-size: 15.71px;">swoole</a> <a href="/tags/swore/" style="font-size: 10px;">swore</a> <a href="/tags/tinyswoole/" style="font-size: 10px;">tinyswoole</a> <a href="/tags/unique-lock/" style="font-size: 10px;">unique_lock</a> <a href="/tags/vue-js/" style="font-size: 10.71px;">vue.js</a> <a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 12.14px;">其他</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">前端</a> <a href="/tags/%E5%8D%8F%E7%A8%8B/" style="font-size: 15.71px;">协程</a> <a href="/tags/%E5%A4%96%E9%83%A8%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">外部排序</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">多线程编程</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">并发</a> <a href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/" style="font-size: 10px;">引用计数</a> <a href="/tags/%E6%80%A7%E8%83%BD/" style="font-size: 10px;">性能</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 10px;">性能优化</a> <a href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" style="font-size: 10px;">性能分析</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 13.57px;">操作系统</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 10.71px;">数据结构</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" style="font-size: 12.86px;">服务器开发</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">服务器编程</a> <a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">汇编语言</a> <a href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">秒杀系统</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">算法</a> <a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 10px;">线程</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 10px;">线程池</a> <a href="/tags/%E7%BC%96%E7%A0%81/" style="font-size: 10px;">编码</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" style="font-size: 18.57px;">编译原理</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" style="font-size: 10px;">编译器</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" style="font-size: 14.29px;">网络编程</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 10px;">虚拟机</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">计算机基础</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">计算机系统</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 10.71px;">计算机网络</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10.71px;">设计模式</a> <a href="/tags/%E8%AF%BB%E8%AF%BB%E4%BB%A3%E7%A0%81/" style="font-size: 10.71px;">读读代码</a> <a href="/tags/%E8%B0%83%E8%AF%95/" style="font-size: 10px;">调试</a> <a href="/tags/%E9%80%92%E5%BD%92/" style="font-size: 10px;">递归</a> <a href="/tags/%E9%94%81/" style="font-size: 10px;">锁</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/03/03/PHP%E5%86%85%E6%A0%B8%E4%B8%AD%E4%B8%8E%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%89%E5%85%B3%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93/">PHP内核中与异常处理有关的结构体</a>
          </li>
        
          <li>
            <a href="/2021/03/01/Swoole-reload-async%E6%9C%BA%E5%88%B6/">Swoole reload_async机制</a>
          </li>
        
          <li>
            <a href="/2021/02/24/PHP%E4%B8%AD%E7%9A%84if%E8%AF%AD%E5%8F%A5%E5%92%8Cswitch%E8%AF%AD%E5%8F%A5%E7%94%9F%E6%88%90%E7%9A%84opcode%E5%AF%B9%E6%AF%94/">PHP中的if语句和switch语句生成的opcode对比</a>
          </li>
        
          <li>
            <a href="/2021/02/02/ptrace%E4%BD%BF%E7%94%A8/">ptrace使用</a>
          </li>
        
          <li>
            <a href="/2021/01/30/PHP%E5%87%BD%E6%95%B0%E7%BC%96%E8%AF%91%E4%B9%8B%E5%90%8E%E7%9A%84%E5%86%85%E5%AD%98%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/">PHP函数编译之后的内存存储结构</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 codinghuang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>