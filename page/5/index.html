<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>codinghuang的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="比PHP多一些">
<meta property="og:type" content="website">
<meta property="og:title" content="codinghuang的个人博客">
<meta property="og:url" content="http://huanghantao.github.io/page/5/index.html">
<meta property="og:site_name" content="codinghuang的个人博客">
<meta property="og:description" content="比PHP多一些">
<meta property="og:locale">
<meta property="article:author" content="codinghuang">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="codinghuang的个人博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">codinghuang的个人博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">简洁些、干净些、直接些...</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://huanghantao.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-CPU占用过高分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/09/07/CPU%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2020-09-07T10:42:17.000Z" itemprop="datePublished">2020-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/09/07/CPU%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E5%88%86%E6%9E%90/">CPU占用过高分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>今天遇到了一个<code>hyperf</code>死循环的<code>bug</code>，排查了很久，没有思路。后来峰哥指导，立马定位出了问题。</p>
<p>定位步骤，首先，通过<code>perf top</code>命令来查看系统的<code>cpu</code>占用情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">perf top -p 19732</span><br><span class="line"></span><br><span class="line">Samples: 16K of event <span class="string">&#x27;cpu-clock&#x27;</span>, 4000 Hz, Event count (approx.): 3364648111 lost: 0/0 drop: 0/0</span><br><span class="line">Overhead  Shared Object        Symbol</span><br><span class="line">   9.02%  [kernel]             [k] _raw_spin_unlock_irqrestore</span><br><span class="line">   7.96%  php                  [.] execute_ex</span><br><span class="line">   6.85%  [kernel]             [k] finish_task_switch</span><br><span class="line">   2.82%  php                  [.] ZEND_FETCH_OBJ_R_SPEC_UNUSED_CONST_HANDLER</span><br><span class="line">   2.05%  libpthread-2.17.so   [.] __libc_recv</span><br><span class="line">   1.93%  php                  [.] ZEND_INIT_METHOD_CALL_SPEC_UNUSED_CONST_HANDLER</span><br><span class="line">   1.55%  libc-2.17.so         [.] __memmove_ssse3_back</span><br><span class="line">   1.43%  [vdso]               [.] __vdso_gettimeofday</span><br><span class="line">   1.35%  libc-2.17.so         [.] __memcpy_ssse3_back</span><br><span class="line">   1.31%  php                  [.] zend_leave_helper_SPEC</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>execute_ex</code>这个函数的<code>Overhead</code>非常的高。所以，可以大改猜测是<code>PHP</code>代码的问题。然后，我们找到<code>PHP</code>的进程，用<code>strace</code>看一下进程在做啥事情：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">strace -p 19732</span><br><span class="line"></span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>hyperf</code>应该是没有去判断<code>redis</code>是否崩溃，即使<code>redis</code>崩溃了，也在一直循环的读取<code>redis</code>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/09/07/CPU%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E5%88%86%E6%9E%90/" data-id="ckkj72zqm000gf6vx4ho55xj6" data-title="CPU占用过高分析" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" rel="tag">性能分析</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-面向对象的语义特征" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/09/07/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E8%AF%AD%E4%B9%89%E7%89%B9%E5%BE%81/" class="article-date">
  <time class="dt-published" datetime="2020-09-06T16:54:05.000Z" itemprop="datePublished">2020-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/09/07/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E8%AF%AD%E4%B9%89%E7%89%B9%E5%BE%81/">面向对象的语义特征</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>我们知道，编程语言是用来对这个世界建模的，而面向对象则是建模方式中比较推崇的一种方法。我们来说一说面向对象的语义特征，进而让我们理解编程语言的本质。</p>
</blockquote>
<h2 id="类型角度"><a href="#类型角度" class="headerlink" title="类型角度"></a>类型角度</h2><p>在汇编语言里面，是只支持简单类型的，例如整型。如果我们要实现稍微复杂一点的类型，例如字符串，那么，我们就需要一块内存，然后往这块内存里面挨个的放入字符，然后，我们把这块内存存储的内容，叫做字符串。同样的道理，类也是一种复杂的类型。</p>
<h2 id="作用域角度"><a href="#作用域角度" class="headerlink" title="作用域角度"></a>作用域角度</h2><p>分为类的作用域和对象成员的作用域。</p>
<p>对于类来说，如果没有声明命名空间，那么，类的作用域就是根命名空间；如果有命名空间，那么类的作用域就是这个命名空间。</p>
<p>对于对象成员来说，成员的作用域则是这个对象。我们是通过这个对象来找到这个成员的（当然，如果你是静态成员，那么，也可以通过类来找到）。</p>
<p>所以，<strong>我们在实现面向对象的时候，必定会把这个对象放入栈帧里面</strong>，例如<code>PHP</code>里面的<code>execute_data::This</code>。而我们在方法里面使用的<code>$this</code>，实际上就是当前栈帧的<code>execute_data::This</code>。例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$a, $b</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = $a;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = $b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在构造函数里面，通过<code>$this</code>来访问成员<code>a</code>。那么，我们就是在构造函数的这个栈帧里面，找到<code>$this</code>变量，然后，再查找这个对象的<code>a</code>属性。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/09/07/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E8%AF%AD%E4%B9%89%E7%89%B9%E5%BE%81/" data-id="ckkj72zva00crf6vxfmb8f8td" data-title="面向对象的语义特征" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-使用Visitor模式来解析抽象语法树" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/30/%E4%BD%BF%E7%94%A8Visitor%E6%A8%A1%E5%BC%8F%E6%9D%A5%E8%A7%A3%E6%9E%90%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91/" class="article-date">
  <time class="dt-published" datetime="2020-08-30T09:19:47.000Z" itemprop="datePublished">2020-08-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/30/%E4%BD%BF%E7%94%A8Visitor%E6%A8%A1%E5%BC%8F%E6%9D%A5%E8%A7%A3%E6%9E%90%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91/">使用Visitor模式来解析抽象语法树</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>我们在生成了<code>AST</code>之后，要做的事情就是去解析它。我们可以对它做很多的操作，比如修改<code>AST</code>的某些节点；对<code>AST</code>执行我们的语义操作，比如碰到<code>+</code>号，表示我们要做加法运算了，这样，我们就可以实现我们自己的语言了。</p>
<p>而<code>visitor</code>模式的思想就是，当我们遍历<code>AST</code>上的每一个节点的时候，都去执行我们注册的所有<code>visitor</code>。这样，我们可以让代码更加的优雅，我们只需要专注于实现当前<code>visitor</code>的功能即可，让<code>AST</code>的结构和对<code>AST</code>的操作解耦。</p>
<p>我以<code>PHP</code>为例，大致介绍下如何通过<code>visitor</code>模式来用<code>PHP</code>实现<code>PHP</code>。我们给我们的这门语言命名为<code>yaphp</code>（实际上，这正是我现在开发的语言，还未开源）。</p>
<p>我们有如下<code>yaphp</code>的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$a = <span class="number">1</span> + <span class="number">2</span> + <span class="number">3</span> - <span class="number">4</span>;</span><br><span class="line">$b = <span class="number">2</span> * <span class="number">3</span>;</span><br><span class="line">$c = $a + $b;</span><br><span class="line">var_dump($c);</span><br></pre></td></tr></table></figure>

<p>我们可以得到它的抽象语法树：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(</span><br><span class="line">    <span class="number">0</span>: Stmt_Expression(</span><br><span class="line">        expr: Expr_Assign(</span><br><span class="line">            <span class="keyword">var</span>: Expr_Variable(</span><br><span class="line">                name: a</span><br><span class="line">            )</span><br><span class="line">            expr: Expr_BinaryOp_Minus(</span><br><span class="line">                left: Expr_BinaryOp_Plus(</span><br><span class="line">                    left: Expr_BinaryOp_Plus(</span><br><span class="line">                        left: Scalar_LNumber(</span><br><span class="line">                            value: <span class="number">1</span></span><br><span class="line">                        )</span><br><span class="line">                        right: Scalar_LNumber(</span><br><span class="line">                            value: <span class="number">2</span></span><br><span class="line">                        )</span><br><span class="line">                    )</span><br><span class="line">                    right: Scalar_LNumber(</span><br><span class="line">                        value: <span class="number">3</span></span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">                right: Scalar_LNumber(</span><br><span class="line">                    value: <span class="number">4</span></span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">    <span class="number">1</span>: Stmt_Expression(</span><br><span class="line">        expr: Expr_Assign(</span><br><span class="line">            <span class="keyword">var</span>: Expr_Variable(</span><br><span class="line">                name: b</span><br><span class="line">            )</span><br><span class="line">            expr: Expr_BinaryOp_Mul(</span><br><span class="line">                left: Scalar_LNumber(</span><br><span class="line">                    value: <span class="number">2</span></span><br><span class="line">                )</span><br><span class="line">                right: Scalar_LNumber(</span><br><span class="line">                    value: <span class="number">3</span></span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">    <span class="number">2</span>: Stmt_Expression(</span><br><span class="line">        expr: Expr_Assign(</span><br><span class="line">            <span class="keyword">var</span>: Expr_Variable(</span><br><span class="line">                name: c</span><br><span class="line">            )</span><br><span class="line">            expr: Expr_BinaryOp_Plus(</span><br><span class="line">                left: Expr_Variable(</span><br><span class="line">                    name: a</span><br><span class="line">                )</span><br><span class="line">                right: Expr_Variable(</span><br><span class="line">                    name: b</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">    <span class="number">3</span>: Stmt_Expression(</span><br><span class="line">        expr: Expr_FuncCall(</span><br><span class="line">            name: Name(</span><br><span class="line">                parts: <span class="keyword">array</span>(</span><br><span class="line">                    <span class="number">0</span>: var_dump</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            args: <span class="keyword">array</span>(</span><br><span class="line">                <span class="number">0</span>: Arg(</span><br><span class="line">                    name: <span class="literal">null</span></span><br><span class="line">                    value: Expr_Variable(</span><br><span class="line">                        name: c</span><br><span class="line">                    )</span><br><span class="line">                    byRef: <span class="literal">false</span></span><br><span class="line">                    unpack: <span class="literal">false</span></span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这个抽象语法树还是比较简单的。我们大致可以看到，有<code>4</code>条表达式语句。我们逐个来看。</p>
<p>第一条表达式语句：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">0: Stmt_Expression(</span><br><span class="line">    expr: Expr_Assign(</span><br><span class="line">        var: Expr_Variable(</span><br><span class="line">            name: a</span><br><span class="line">        )</span><br><span class="line">        expr: Expr_BinaryOp_Minus(</span><br><span class="line">            left: Expr_BinaryOp_Plus(</span><br><span class="line">                left: Expr_BinaryOp_Plus(</span><br><span class="line">                    left: Scalar_LNumber(</span><br><span class="line">                        value: 1</span><br><span class="line">                    )</span><br><span class="line">                    right: Scalar_LNumber(</span><br><span class="line">                        value: 2</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">                right: Scalar_LNumber(</span><br><span class="line">                    value: 3</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            right: Scalar_LNumber(</span><br><span class="line">                value: 4</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这是一个赋值语句，我们通过这个结构得出，这个<code>AST</code>是右结合的。也就意味着，我们的赋值语句是右结合的。<code>Expr_Assign</code>它的左子树是一个变量的名字，<code>Expr_Assign</code>它的右子树是一个算数表达式。通过这个算数表达式的<code>AST</code>结构，我们可以看成，它是左结合的。</p>
<p><code>OK</code>，我们可以根据这些节点的类型，写出对应的<code>visitor</code>。</p>
<p>首先是<code>AdditiveExpressionVisitor</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This file is part of Yaphp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@contact</span>  codinghuang<span class="doctag">@qq</span>.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Yaphp</span>\<span class="title">NodeVisitor</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">BinaryOp</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">BinaryOp</span>\<span class="title">Minus</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">BinaryOp</span>\<span class="title">Plus</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">Variable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Scalar</span>\<span class="title">LNumber</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeVisitorAbstract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Yaphp</span>\<span class="title">HandWritten</span>\<span class="title">CompilerGlobals</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdditiveExpressionVisitor</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">enterNode</span>(<span class="params">Node $node</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! ($node <span class="keyword">instanceof</span> Plus) &amp;&amp; ! ($node <span class="keyword">instanceof</span> Minus)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (get_class($node)) &#123;</span><br><span class="line">            <span class="keyword">case</span> Plus::class:</span><br><span class="line">            <span class="keyword">case</span> Minus::class:</span><br><span class="line">                $result = <span class="keyword">$this</span>-&gt;additiveExpression($node);</span><br><span class="line">                $resultNode = <span class="keyword">new</span> Node\Scalar\LNumber($result);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $resultNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">additiveExpression</span>(<span class="params">Expr $expr</span>): <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($expr-&gt;left)) &#123;</span><br><span class="line">            $leftValue = <span class="keyword">$this</span>-&gt;additiveExpression($expr-&gt;left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($expr-&gt;right)) &#123;</span><br><span class="line">            $rightValue = <span class="keyword">$this</span>-&gt;additiveExpression($expr-&gt;right);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (get_class($expr)) &#123;</span><br><span class="line">            <span class="keyword">case</span> Plus::class:</span><br><span class="line">                <span class="keyword">return</span> $leftValue + $rightValue;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Minus::class:</span><br><span class="line">                <span class="keyword">return</span> $leftValue - $rightValue;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Variable::class:</span><br><span class="line">                <span class="keyword">return</span> CompilerGlobals::getSymbol($expr-&gt;name);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LNumber::class:</span><br><span class="line">                <span class="keyword">return</span> $expr-&gt;value;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">echo</span> sprintf(<span class="string">&quot;Don&#x27;t support expression %s&quot;</span>, $expr-&gt;getType());</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $leftValue + $rightValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为，加法和减法我们认为是同一类操作，所以，我们可以把加法和减法写在一个<code>visitor</code>里面。</p>
<p>接着就是<code>AssignVistor</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This file is part of Yaphp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@contact</span>  codinghuang<span class="doctag">@qq</span>.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Yaphp</span>\<span class="title">NodeVisitor</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">Assign</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">BinaryOp</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Scalar</span>\<span class="title">LNumber</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeVisitorAbstract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Yaphp</span>\<span class="title">HandWritten</span>\<span class="title">CompilerGlobals</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AssignVistor</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span>(<span class="params">Node $node</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $value = -INF;</span><br><span class="line">        <span class="keyword">if</span> (! ($node <span class="keyword">instanceof</span> Assign)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($node-&gt;expr <span class="keyword">instanceof</span> LNumber) &#123;</span><br><span class="line">            $value = $node-&gt;expr-&gt;value;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ($node-&gt;expr <span class="keyword">instanceof</span> BinaryOp) &#123;</span><br><span class="line">            $return = (<span class="keyword">new</span> AdditiveExpressionVisitor)-&gt;enterNode($node-&gt;expr);</span><br><span class="line">            $value = $return-&gt;value;</span><br><span class="line">        &#125;</span><br><span class="line">        CompilerGlobals::setSymbol($node-&gt;var-&gt;name, $value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，实现变量就是一个字典，把变量的名字和对应的值存起来即可。目前我们这篇文章不考虑变量的作用域，所以我们把所有的变量通通存在了一个全局变量里面。</p>
<p>第二条表达式语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: Stmt_Expression(</span><br><span class="line">    expr: Expr_Assign(</span><br><span class="line">        <span class="keyword">var</span>: Expr_Variable(</span><br><span class="line">            name: b</span><br><span class="line">        )</span><br><span class="line">        expr: Expr_BinaryOp_Mul(</span><br><span class="line">            left: Scalar_LNumber(</span><br><span class="line">                value: <span class="number">2</span></span><br><span class="line">            )</span><br><span class="line">            right: Scalar_LNumber(</span><br><span class="line">                value: <span class="number">3</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>可以看到，这个结构和加法的算数表达式几乎是一样的。但是，我们认为加法和乘法还是有一定的区别的，所以我们单独给乘法写一个<code>visitor</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This file is part of Yaphp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@contact</span>  codinghuang<span class="doctag">@qq</span>.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Yaphp</span>\<span class="title">NodeVisitor</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">BinaryOp</span>\<span class="title">Div</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">BinaryOp</span>\<span class="title">Mul</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeVisitorAbstract</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiplicativeExpressionVisitor</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">enterNode</span>(<span class="params">Node $node</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! ($node <span class="keyword">instanceof</span> Mul) &amp;&amp; ! ($node <span class="keyword">instanceof</span> Div)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (get_class($node)) &#123;</span><br><span class="line">            <span class="keyword">case</span> Mul::class:</span><br><span class="line">            <span class="keyword">case</span> Div::class:</span><br><span class="line">                $result = <span class="keyword">$this</span>-&gt;multiplicativeExpression($node);</span><br><span class="line">                $resultNode = <span class="keyword">new</span> Node\Scalar\LNumber($result);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $resultNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">multiplicativeExpression</span>(<span class="params">Expr $expr</span>): <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($expr-&gt;left)) &#123;</span><br><span class="line">            $leftValue = <span class="keyword">$this</span>-&gt;multiplicativeExpression($expr-&gt;left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($expr-&gt;right)) &#123;</span><br><span class="line">            $rightValue = <span class="keyword">$this</span>-&gt;multiplicativeExpression($expr-&gt;right);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (get_class($expr)) &#123;</span><br><span class="line">            <span class="keyword">case</span> Mul::class:</span><br><span class="line">                <span class="keyword">return</span> $leftValue * $rightValue;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Div::class:</span><br><span class="line">                <span class="keyword">return</span> $leftValue / $rightValue;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> $expr-&gt;value;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $leftValue * $rightValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三条表达式语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>: Stmt_Expression(</span><br><span class="line">    expr: Expr_Assign(</span><br><span class="line">        <span class="keyword">var</span>: Expr_Variable(</span><br><span class="line">            name: c</span><br><span class="line">        )</span><br><span class="line">        expr: Expr_BinaryOp_Plus(</span><br><span class="line">            left: Expr_Variable(</span><br><span class="line">                name: a</span><br><span class="line">            )</span><br><span class="line">            right: Expr_Variable(</span><br><span class="line">                name: b</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这是两个变量相加，然后把表达式的结果赋值给一个新的变量。因为，我们把两个变量相加，也放在了<code>AdditiveExpressionVisitor</code>，所以，这里我们无须再实现一个新的<code>visitor</code>了。</p>
<p>我们来看最后一个表达式语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span>: Stmt_Expression(</span><br><span class="line">    expr: Expr_FuncCall(</span><br><span class="line">        name: Name(</span><br><span class="line">            parts: <span class="keyword">array</span>(</span><br><span class="line">                <span class="number">0</span>: var_dump</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        args: <span class="keyword">array</span>(</span><br><span class="line">            <span class="number">0</span>: Arg(</span><br><span class="line">                name: <span class="literal">null</span></span><br><span class="line">                value: Expr_Variable(</span><br><span class="line">                    name: c</span><br><span class="line">                )</span><br><span class="line">                byRef: <span class="literal">false</span></span><br><span class="line">                unpack: <span class="literal">false</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这是一个函数调用了，所以，我们需要实现一个新的<code>FuncCallExpressionVisitor</code>。因为，函数也是可以求值的，所以我们把函数调用<code>visitor</code>归类为<code>expression</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This file is part of Yaphp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@contact</span>  codinghuang<span class="doctag">@qq</span>.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Yaphp</span>\<span class="title">NodeVisitor</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">FuncCall</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeVisitorAbstract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Yaphp</span>\<span class="title">HandWritten</span>\<span class="title">CompilerGlobals</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FuncCallExpressionVisitor</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span>(<span class="params">Node $node</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! ($node <span class="keyword">instanceof</span> FuncCall)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $functionName = $node-&gt;name-&gt;parts[<span class="number">0</span>];</span><br><span class="line">        $symbol = $node-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! CompilerGlobals::hasSymbol($symbol)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">Exception</span>(sprintf(<span class="string">&#x27;not define symbol %s&#x27;</span>, $symbol), <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($functionName === <span class="string">&#x27;var_dump&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;varDumpHandler(CompilerGlobals::getSymbol($symbol));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">varDumpHandler</span>(<span class="params">$symbol</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        var_dump($symbol);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，我们实现<code>var_dump</code>的方式就非常的简单了。当我们发现，这是一个<code>var_dump</code>函数的时候，我们直接调用<code>var_dump</code>函数即可。</p>
<p>至此，我们就算是实现了我们所有的<code>visitor</code>了。只要我们对<code>AST</code>使用上我们的<code>visitor</code>，我们就可以很愉快的去解析它了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/08/30/%E4%BD%BF%E7%94%A8Visitor%E6%A8%A1%E5%BC%8F%E6%9D%A5%E8%A7%A3%E6%9E%90%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91/" data-id="ckkj72ztp007yf6vxbui5d2dx" data-title="使用Visitor模式来解析抽象语法树" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-为什么一定要写注释和测试" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/26/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%80%E5%AE%9A%E8%A6%81%E5%86%99%E6%B3%A8%E9%87%8A%E5%92%8C%E6%B5%8B%E8%AF%95/" class="article-date">
  <time class="dt-published" datetime="2020-08-26T09:19:32.000Z" itemprop="datePublished">2020-08-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/26/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%80%E5%AE%9A%E8%A6%81%E5%86%99%E6%B3%A8%E9%87%8A%E5%92%8C%E6%B5%8B%E8%AF%95/">为什么一定要写注释和测试</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近在公司用<code>PHP</code>重写之前的<code>Lua</code>代码，这份<code>Lua</code>代码量不多，<code>3000</code>行左右。但是，我花了不少时间重写。感触非常大，所以想分享一下。</p>
<p>首先，我说一下这份需要重写的代码问题：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 没有一个测试。</span><br><span class="line">2. 因为功能不断的在增加，加上对代码质量的不重视，复制粘贴的地方太多了。可能只是改了几个传参而已，但是，却复制了整个函数。</span><br><span class="line">3. 多个地方，本来可以用几句话写完的逻辑，可能是因为当时没想到，逻辑写的非常复杂。并且这段复杂的代码没有注释。</span><br><span class="line">4. 整个项目的注释占比太少了，可以说几乎没有。</span><br></pre></td></tr></table></figure>

<p>我针对这几点来说一下。</p>
<p>第一点，没有一个测试。</p>
<p>这是我认为最严重的问题。我个人认为，一个没有测试的项目，经过无数迭代和多人接手之后，必定是屎山。你代码可以写的不好，但是，你必须要尽可能的写足够的测试，来保证你目前的功能都是正常的。</p>
<p>那么，没有测试的话，会导致什么问题呢？</p>
<p>很明显，你不敢去修改一个你不太熟悉的地方，你不知道这么改对不对，会不会影响其他的代码。所以，你可能就会自己去写一遍。甚至来说，你非常熟悉这份代码了，但是，你没有测试，你也不敢去改，因为你改完之后，你确定不了改完后代码后，整个系统正不正常。毕竟，你怕背锅。久而久之，这份代码极其丑陋。后面，你想改也没动力了。</p>
<p>并且，没有测试的话，你完全不敢去升级你使用的框架，除非你头铁。你知道这个框架有<code>bug</code>了，但是，你不知道升级之后，是否会有<code>api</code>不兼容的问题，导致你的项目出其他的<code>bug</code>。</p>
<p>所以，没有测试，团队的代码会越来越丑陋。（如果是个人的项目，可能你还能撑得住）</p>
<p>你可能有千万个理由说自己没时间写测试。然而，写一个测试其实要不了多少时间，可能比你在<code>postman</code>等工具手动填充参数要的时间还少。我个人觉得，不写测试，是不热爱编程，没有享受敲击键盘的快感，你是一个喜欢手动完成一些任务的人。</p>
<p>第二点，代码质量问题。</p>
<p>我重写的时候，旧代码有太多的复制粘贴了。但是，我在完全重写之前，我是不敢对代码进行优化的。那么，我是怎么做的，我先按照<code>Lua</code>的代码，一字一句的完全翻译完，旧代码复制了几遍，我就重写几遍。然后，我给我重写后的代码编写足够的测试，然后我才敢进行优化。</p>
<p>那么，如果旧代码有测试会怎么样？我完全可以对旧代码进行重构，然后跑一遍测试，看一看测试是否通过。然后，我再按照优化后的代码进行重写。这样，重写的错误率会大大降低。</p>
<p>第三点，简单的逻辑落地在代码上，就变复杂了。</p>
<p>其实，把简单的逻辑写复杂了还能接收，但是，如果没有对这段复杂的代码进行解释，以后就没多少人能够读懂，写代码的人过久了估计也读不懂。所以，我建议，如果代码被你写复杂了，你一定要在旁边写上注释，解释一下这段代码做了什么。以后，就好按照注释进行代码优化。</p>
<p>第四点，没有注释。</p>
<p>很多人可能说，代码就可以表达意思，实际上我觉得并不可以。就算你有一个好的函数名字，你依然会去点开这个函数来看看，看它到底怎么写的。一旦你点进去 ，那么，很可能你就会被里面的代码给整懵了。你不懂这段代码为什么要这么做，即使你有了更好的点子，你也不敢去改。你怕你的想法和这段代码并不完全一致，一些细节，你可能没有考虑到。</p>
<p>还有一些特殊的<code>if</code>条件，我建议也最好注释一下。因为它可能只在某些特殊的场景才会出现，但是随着我们系统的变化，这个场景可能就不会出现了，那么，我们以后完全可以把这个特殊的代码分支给删了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/08/26/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%80%E5%AE%9A%E8%A6%81%E5%86%99%E6%B3%A8%E9%87%8A%E5%92%8C%E6%B5%8B%E8%AF%95/" data-id="ckkj72ztg0079f6vxdq1o6b71" data-title="为什么一定要写注释和测试" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-优化递归下降算法的尾递归" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/25/%E4%BC%98%E5%8C%96%E9%80%92%E5%BD%92%E4%B8%8B%E9%99%8D%E7%AE%97%E6%B3%95%E7%9A%84%E5%B0%BE%E9%80%92%E5%BD%92/" class="article-date">
  <time class="dt-published" datetime="2020-08-24T17:22:48.000Z" itemprop="datePublished">2020-08-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/25/%E4%BC%98%E5%8C%96%E9%80%92%E5%BD%92%E4%B8%8B%E9%99%8D%E7%AE%97%E6%B3%95%E7%9A%84%E5%B0%BE%E9%80%92%E5%BD%92/">优化递归下降算法的尾递归</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>我们在文章<a href="https://huanghantao.github.io/2020/08/23/%E9%80%92%E5%BD%92%E4%B8%8B%E9%99%8D%E7%AE%97%E6%B3%95%E5%B7%A6%E9%80%92%E5%BD%92%E9%97%AE%E9%A2%98/">递归下降算法左递归问题</a>这篇文章里面，介绍了如何消除左递归。总结起来，就是把非终结符放到终结符的右边，使得我们在推导的过程中，可以消耗掉下一个<code>token</code>。</p>
<p>但是，这种方法有一个问题。还是以<code>1 + 2 + 3</code>这个表达式为例来讲解一下优化手段。</p>
<p>首先，我们的文法规则如下：</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">additive -&gt; intLiteral | intLiteral + additive</span><br></pre></td></tr></table></figure>

<p>按照这个文法，我们将会构造出如下抽象语法树：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    +</span><br><span class="line">1       +</span><br><span class="line">    2       3</span><br></pre></td></tr></table></figure>

<p>我们发现，这棵树是向右倾斜的，那么，我们在解析这个抽象语法树的时候，就必然是先计算<code>2 + 3</code>，得到<code>5</code>之后 ，再计算<code>1 + 5</code>。所以，这是右结合的（注意，结合性和优先级的区别，优先级指的是，无论什么时候，都是先计算，而结合性指的是一种普遍的计算顺序，从哪边到哪边。顺带一提的是，优先级我们可以通过层级嵌套来实现，把优先级高的放在子级，那么，它必然就先计算了）。但是，一般来说，我们的加法表达式都是左结合的。（也有右结合的例子，例如<code>$a = 1 + 2</code>，先计算<code>1 + 2</code>，然后再计算<code>$a = 3</code>）。所以 ，我们需要调整一下这个抽象语法树的结构，我们打算让这棵树向左倾斜，这样的话，就会先计算左边的子树，然后再计算左边的子树。所以，我们期望的结构如下 ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">        +</span><br><span class="line">    +       3</span><br><span class="line">1       2</span><br></pre></td></tr></table></figure>

<p>这样，我们在遍历这棵树的时候，就会先计算<code>1 + 2</code>，然后再计算<code>3 + 3</code>。这是符合我们的预期的。</p>
<p>那么，为什么文法：</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">additive -&gt; intLiteral | intLiteral + additive</span><br></pre></td></tr></table></figure>

<p>生成的<code>AST</code>它是右结合的呢？因为我们的非终结符是在右边，终结符在左边，所以，在一棵子树里面，左节点必然是终结符，右子树必然是一棵递归的树，直到右子树碰到终结符，才停止右子树的生成。</p>
<p>所以，如果我们要让一棵树变成左结合的，我们可以调整一下文法，把非终结符放到左边，终结符放到右边。如下：</p>
<figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">additive -&gt; intLiteral | additive + intLiteral</span><br></pre></td></tr></table></figure>

<p>当时，我们之前说过了，左递归会造成无限递归。但是，无限循环的前提是，我们使用的是递归下降算法来生成<code>AST</code>。如果我们不用递归下降算法来构造<code>AST</code>，那么我们是可以避免无限递归的。并且，不是所有的算法都不能处理左递归，例如<code>LR</code>算法是可以处理左递归的。</p>
<p>好了，我们现在使用<code>ebnf</code>来改造下这个文法：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">additiveExpression -&gt; intLiteral | additiveExpression + intLiteral</span><br><span class="line">-&gt;</span><br><span class="line">additiveExpression: intLiteral | intLiteral (+ intLiteral)*</span><br></pre></td></tr></table></figure>

<p>（需要注意的一点事，这里的<code>+</code>不是正则的元符号<code>+</code>的含义，它仅仅是字符串<code>+</code>）</p>
<p>可能这个过程大家会看不懂，我多讲一点推导过程：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">additiveExpression: intLiteral | additiveExpression + intLiteral + intLiteral + intLiteral ....</span><br><span class="line">-&gt;</span><br><span class="line">因为，“+ intLiteral + intLiteral + intLiteral ....” 这部分必须终止，所以，additiveExpression最后一次推导必然是得到intLiteral，因此，additiveExpression -&gt; intLiteral additiveExpression&#x27;：</span><br><span class="line"></span><br><span class="line">additiveExpression: intLiteral | intLiteral additiveExpression&#x27;</span><br><span class="line"></span><br><span class="line">所以，我们现在需要解决的问题就是如何用additiveExpression&#x27;去推导“+ intLiteral + intLiteral + intLiteral ....”。通过归纳法，我们可以很轻易的得到如下结果：</span><br><span class="line"></span><br><span class="line">additiveExpression&#x27;: + intLiteral additiveExpression&#x27; | ε</span><br><span class="line"></span><br><span class="line">其中，ε表示空集。这在递归的时候，作为结束条件。我们发现，这是一个尾递归了，那么，我们就可以想到尾递归的优化，我们可以写成一个循环：</span><br><span class="line">-&gt;</span><br><span class="line">additiveExpression: intLiteral | intLiteral (+ intLiteral)*</span><br></pre></td></tr></table></figure>

<p>因此，最终，我们把一个左递归的文法转化成了一个没有左递归的文法。</p>
<p>然后，我们可以轻易的写出这个文法的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">additiveUnRecursiveMode</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> AstNode */</span></span><br><span class="line">    $child1 = <span class="keyword">$this</span>-&gt;scanner-&gt;primary();</span><br><span class="line">    $node = $child1;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        $token = <span class="keyword">$this</span>-&gt;scanner-&gt;peekToken();</span><br><span class="line">        <span class="keyword">if</span> ($token == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 没有token了，所以我们需要终止循环</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($token != Token::ADD) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> TokenException(sprintf(<span class="string">&#x27;Token [%s] that are not expected, need a [%s].&#x27;</span>, $token, Token::ADD), Errno::UN_EXPECTED_TOKEN);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;scanner-&gt;readToken();</span><br><span class="line">        $child2 = <span class="keyword">$this</span>-&gt;scanner-&gt;primary();</span><br><span class="line">        $node = <span class="keyword">new</span> AstNode(AstNodeType::ADD_NODE, <span class="string">&#x27;+&#x27;</span>);</span><br><span class="line">        $node-&gt;addChildNode($child1);</span><br><span class="line">        $node-&gt;addChildNode($child2);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 因为我们希望这棵AST是左结合的，所以，我们把生成的子树作为父节点的左子树</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        $child1 = $node;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 此处的node是AST的根结点</span></span><br><span class="line">    <span class="keyword">return</span> $node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/08/25/%E4%BC%98%E5%8C%96%E9%80%92%E5%BD%92%E4%B8%8B%E9%99%8D%E7%AE%97%E6%B3%95%E7%9A%84%E5%B0%BE%E9%80%92%E5%BD%92/" data-id="ckkj72ztm007rf6vxb8rt91nh" data-title="优化递归下降算法的尾递归" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-递归下降算法左递归问题" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/23/%E9%80%92%E5%BD%92%E4%B8%8B%E9%99%8D%E7%AE%97%E6%B3%95%E5%B7%A6%E9%80%92%E5%BD%92%E9%97%AE%E9%A2%98/" class="article-date">
  <time class="dt-published" datetime="2020-08-22T17:06:58.000Z" itemprop="datePublished">2020-08-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/23/%E9%80%92%E5%BD%92%E4%B8%8B%E9%99%8D%E7%AE%97%E6%B3%95%E5%B7%A6%E9%80%92%E5%BD%92%E9%97%AE%E9%A2%98/">递归下降算法左递归问题</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>我们在学习编译原理的过程中，一定会学习到递归下降的算法来进行语法分析。</p>
<p>首先，我们需要去理解“下降”的含义。我们可以这么去理解：</p>
<blockquote>
<p>上级文法嵌套下级文法，上级的算法调用下级的算法。表现在生成 AST 中，上级算法生成上级节点，下级算法生成下级节点</p>
</blockquote>
<p>好的，现在，我们来通过一个计算器的程序来学习一下递归下降算法。</p>
<p>首先，我们有一个问题。我们能否用正则表达式来表达算数表达式？答案是不能。</p>
<p>假设我们想要用正则表达式去表达所有的算数表达式，那么这一定是一个体力活，并且计算能力是有限的。例如，我们可以有如下的算数表达式：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> + <span class="number">2</span></span><br><span class="line"><span class="number">1</span> + <span class="number">2</span> + <span class="number">3</span></span><br><span class="line"><span class="number">1</span> * <span class="number">2</span> + <span class="number">3</span></span><br><span class="line"><span class="number">1</span> + <span class="number">2</span> * <span class="number">3</span></span><br><span class="line">......  等等</span><br></pre></td></tr></table></figure>

<p>那么，我们是没有办法找到一个或者有限个正则表达式来表达所有的算数表达式。</p>
<p>好的，现在，我们尝试着用递归下降算法来解决算数表达式的问题。为了简单讨论，这里，我们只有加法，并且只包含整数。所以，我们有如下的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">additive</span><br><span class="line">: int</span><br><span class="line">| additive int</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>意思是，我们的加法表达式可以只是一个整数，也可以是加法表达式加上一个整数。而加法表达式加上一个整数，这个就是我们递归下降算法中“递归”的含义了。但是，上面的程序，是会造成左递归的。</p>
<p>比如说我们要计算这个算数表达式：1 + 2</p>
<p>我们可以来模拟计算过程：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">首先匹配是不是整型字面量，发现是，但是后面还有token，所以匹配失败；</span><br><span class="line">然后匹配是不是加法表达式，这里是递归调用；</span><br><span class="line">会重复上面两步，无穷无尽。</span><br></pre></td></tr></table></figure>

<p>所以，左递归是递归下降算法无法处理的（因为左递归的情况下，我们是无法消耗<code>token</code>的，因此造成了无限递归）。但是，我们有如下的解决办法，我们把递归的加法表达式移到右边，那么就有了如下的语法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">additive</span><br><span class="line">: int</span><br><span class="line">| int additive</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>我们可以来模拟计算过程：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">首先匹配是不是整型字面量，发现是，但是后面还有token，所以匹配失败；</span><br><span class="line">然后匹配是不是整型字面量，发现是，然后消耗一个加号，然后递归的再次匹配加法表达式；</span><br><span class="line">然后匹配是不是整形字面量，发现是。</span><br><span class="line">匹配完成！</span><br></pre></td></tr></table></figure>

<p>我们发现，这个语法可以解决左递归问题。因为这个方法可以消耗掉一个<code>int token</code>和一个<code>加号 token</code>之后，再递归的执行加法表达式。</p>
<p>我们可以编写如下代码来描述这个过程：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * additive</span></span><br><span class="line"><span class="comment"> * : int</span></span><br><span class="line"><span class="comment"> * | additive int</span></span><br><span class="line"><span class="comment"> * ;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">define(<span class="string">&#x27;UNKNOW&#x27;</span>, <span class="number">0</span>);</span><br><span class="line">define(<span class="string">&#x27;INT_NODE&#x27;</span>, <span class="number">1</span>);</span><br><span class="line">define(<span class="string">&#x27;ADD_NODE&#x27;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array[Node]</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $children;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $nodeType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">int</span> $nodeType = UNKNOW, ?<span class="keyword">int</span> $value = <span class="literal">null</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nodeType = $nodeType;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;value = $value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">addChildNode</span>(<span class="params">Node $node</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;children[] = $node;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">primary</span>(<span class="params"><span class="built_in">SplQueue</span> $queue</span>): <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> int */</span></span><br><span class="line">    $token = $queue-&gt;dequeue();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Node(INT_NODE, $token);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">peekToken</span>(<span class="params"><span class="built_in">SplQueue</span> $queue</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($queue-&gt;isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $queue-&gt;bottom();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readToken</span>(<span class="params"><span class="built_in">SplQueue</span> $queue</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $queue-&gt;dequeue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">additive</span>(<span class="params"><span class="built_in">SplQueue</span> $queue</span>): <span class="title">Node</span> </span>&#123;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Node */</span></span><br><span class="line">    $child1 = primary($queue);</span><br><span class="line">    $node = $child1;</span><br><span class="line">    $token = peekToken($queue);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($child1-&gt;nodeType === INT_NODE &amp;&amp; $token != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($token == <span class="string">&#x27;+&#x27;</span>) &#123;</span><br><span class="line">            readToken($queue);</span><br><span class="line">            $child2 = additive($queue);</span><br><span class="line">            $node = <span class="keyword">new</span> Node(ADD_NODE);</span><br><span class="line">            $node-&gt;addChildNode($child1);</span><br><span class="line">            $node-&gt;addChildNode($child2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $node;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$queue = <span class="keyword">new</span> <span class="built_in">SplQueue</span>;</span><br><span class="line"></span><br><span class="line">$queue-&gt;enqueue(<span class="number">1</span>);</span><br><span class="line">$queue-&gt;enqueue(<span class="string">&#x27;+&#x27;</span>);</span><br><span class="line">$queue-&gt;enqueue(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">$node = additive($queue);</span><br></pre></td></tr></table></figure>

<p>最后，我们将会得到一个<code>ADD_NODE</code>类型的根结点。其中第一个子节点是值为<code>1</code>的<code>Node</code>，第二个节点是值为<code>2</code>的<code>Node</code>。然后，我们对这个<code>AST</code>进行遍历，就可以得到算数表达式的结果了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/08/23/%E9%80%92%E5%BD%92%E4%B8%8B%E9%99%8D%E7%AE%97%E6%B3%95%E5%B7%A6%E9%80%92%E5%BD%92%E9%97%AE%E9%A2%98/" data-id="ckkj72zv600c7f6vxeeczdlb4" data-title="递归下降算法左递归问题" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-通过责任链模式设计多级缓存" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/22/%E9%80%9A%E8%BF%87%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E8%AE%BE%E8%AE%A1%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/" class="article-date">
  <time class="dt-published" datetime="2020-08-22T05:48:33.000Z" itemprop="datePublished">2020-08-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/22/%E9%80%9A%E8%BF%87%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E8%AE%BE%E8%AE%A1%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/">通过责任链模式设计多级缓存</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>背景：最近业务上面有一个多级缓存的需求，也很简单，内存 -&gt; 文件 -&gt; MySQL。开始的时候，我只做了 文件 -&gt; MySQL 的缓存，但是，后面我又加了一个内存作为缓存，并且，我在测试的时候，发现我忘了在读取到下一级的文件缓存数据之后，更新到上一级的内存缓存。于是我就发现了这很容易造成缓存没更新的问题，所以调研了一下，发现责任链设计模式可以很好的解决这个问题。</p>
</blockquote>
<p>我们可以先来看一看不用责任链模式，我的代码是如何写的。首先是只有 文件 -&gt; MySQL 的缓存：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="keyword">string</span> $configKey</span>): <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $filePath = $configKey . DIRECTORY_SEPARATOR . <span class="string">&#x27;cache.json&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先查看文件里面有没有缓存配置信息</span></span><br><span class="line">    $result = <span class="keyword">$this</span>-&gt;readFromCachedFile($filePath);</span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($result)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;logger-&gt;debug(<span class="string">&#x27;read config from cached file&#x27;</span>, [<span class="string">&#x27;path&#x27;</span> =&gt; $filePath]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Config */</span></span><br><span class="line">    $config = Config::query()-&gt;where(<span class="string">&#x27;id&#x27;</span>, $configKey)-&gt;first();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger-&gt;debug(<span class="string">&#x27;query config from mysql&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    $payload = json_decode($config, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    $result[<span class="string">&#x27;gslb&#x27;</span>] = $payload[<span class="string">&#x27;gslb&#x27;</span>];</span><br><span class="line">    $result[<span class="string">&#x27;sdkconfig&#x27;</span>] = $payload[<span class="string">&#x27;sdkconfig&#x27;</span>][$role] ?? [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;writeToCachedFile($filePath, json_encode($result));</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger-&gt;debug(<span class="string">&#x27;write config to cached file&#x27;</span>, [<span class="string">&#x27;filePath&#x27;</span> =&gt; $filePath]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，代码可读性还是不错的。先查找文件，然后再查找数据库，然后更新文件。一路下来，没有任何难题。</p>
<p>但是，当我变成了 内存 -&gt; 文件 -&gt; MySQL 缓存之后，问题开始凸显出来了。我的第一版代码是这样的：s</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="keyword">string</span> $configKey</span>): <span class="title">array</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 先查看内存里面有没有缓存配置信息</span></span><br><span class="line">    $result = <span class="keyword">$this</span>-&gt;readFromCachedMemory($configKey);</span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($result)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;logger-&gt;debug(<span class="string">&#x27;read config from cached memory&#x27;</span>, [<span class="string">&#x27;path&#x27;</span> =&gt; $configKey]);</span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $filePath = $configKey . DIRECTORY_SEPARATOR . <span class="string">&#x27;cache.json&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 先查看文件里面有没有缓存配置信息</span></span><br><span class="line">    $result = <span class="keyword">$this</span>-&gt;readFromCachedFile($filePath);</span><br><span class="line">    <span class="keyword">if</span> (! <span class="keyword">empty</span>($result)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;logger-&gt;debug(<span class="string">&#x27;read config from cached file&#x27;</span>, [<span class="string">&#x27;path&#x27;</span> =&gt; $filePath]);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> Config */</span></span><br><span class="line">    $config = Config::query()-&gt;where(<span class="string">&#x27;id&#x27;</span>, $configKey)-&gt;first();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger-&gt;debug(<span class="string">&#x27;query config from mysql&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    $payload = json_decode($config, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    $result[<span class="string">&#x27;gslb&#x27;</span>] = $payload[<span class="string">&#x27;gslb&#x27;</span>];</span><br><span class="line">    $result[<span class="string">&#x27;sdkconfig&#x27;</span>] = $payload[<span class="string">&#x27;sdkconfig&#x27;</span>][$role] ?? [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;writeToCachedMemory($configKey, json_encode($result));</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger-&gt;debug(<span class="string">&#x27;write config to cached memory&#x27;</span>, [<span class="string">&#x27;path&#x27;</span> =&gt; $configKey]);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;writeToCachedFile($filePath, json_encode($result));</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger-&gt;debug(<span class="string">&#x27;write config to cached file&#x27;</span>, [<span class="string">&#x27;filePath&#x27;</span> =&gt; $filePath]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>咋眼一看，可能还真看不出啥问题。但是编写完足够的单元测试之后，问题就凸显出来了。我发现，这段代码有问题：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 先查看文件里面有没有缓存配置信息</span></span><br><span class="line">$result = <span class="keyword">$this</span>-&gt;readFromCachedFile($filePath);</span><br><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>($result)) &#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;logger-&gt;debug(<span class="string">&#x27;read config from cached file&#x27;</span>, [<span class="string">&#x27;path&#x27;</span> =&gt; $filePath]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里在文件里面找到了数据之后，我忘记去更新数据到内存里面了。当我发现这个问题之后，我意识到了问题的严重性，这简直就是一个维护成本极高的代码。因为我想到，我仅仅是加了一个内存缓存，就出现了忘记保存缓存数据的问题，那以后要是又加了几个缓存，那代码写起来几乎就是灾难了吧。每一次下一级缓存找到之后，我们都要更新所有的上一级缓存，这代码大概会变成这样子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 查看一级缓存</span></span><br><span class="line">$result = <span class="keyword">$this</span>-&gt;readFromFirstCache($configKey);</span><br><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>($result)) &#123;</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看二级缓存</span></span><br><span class="line">$result = <span class="keyword">$this</span>-&gt;readFromSecondCache($configKey);</span><br><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>($result)) &#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;writeToFirstCache($configKey, $result);</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看三级缓存</span></span><br><span class="line">$result = <span class="keyword">$this</span>-&gt;readFromThreeCache($configKey);</span><br><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>($result)) &#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;writeToSecondCache($configKey);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;writeToFirstCache($configKey, $result);</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 查看数据库</span></span><br><span class="line">$result = <span class="keyword">$this</span>-&gt;readFromMySQL($configKey);</span><br><span class="line"><span class="keyword">if</span> (! <span class="keyword">empty</span>($result)) &#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;writeToThreeCache($configKey);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;writeToSecondCache($configKey);</span><br><span class="line">    <span class="keyword">$this</span>-&gt;writeToFirstCache($configKey, $result);</span><br><span class="line">    <span class="keyword">return</span> $result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我是觉得这个代码维护起来极其困难了。</p>
<p>然后，责任链设计模式就可以用上了。其实说白了，责任链设计模式就是一个考察你的递归基本功的设计模式。原理很简单，当上一级执行某种操作失败之后，就找下一级，一直递归的执行这个操作，直到找了数据之后，我们开始回溯，并且更新上一级的数据。</p>
<p>我们可以用这份代码进行表达：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CachedChain</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> MEMORY = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> FILE = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">const</span> MYSQL = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> int</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $level;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> CachedChain</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> $nextCache;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> string</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> $data = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="keyword">array</span> $param</span>): <span class="title">string</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setNextCache</span>(<span class="params">CachedChain $nextCache</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;nextCache = $nextCache;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">readContent</span>(<span class="params"><span class="keyword">int</span> $level, <span class="keyword">array</span> $param</span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $content = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;level &gt;= $level) &#123;</span><br><span class="line">            $content = <span class="keyword">$this</span>-&gt;read($param);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">empty</span>($content)) &#123;</span><br><span class="line">            <span class="keyword">return</span> $content;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $content = <span class="keyword">$this</span>-&gt;nextCache-&gt;readContent($level, $param);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = $content;</span><br><span class="line">        <span class="keyword">return</span> $content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CachedMemory</span> <span class="keyword">extends</span> <span class="title">CachedChain</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $level = <span class="built_in">self</span>::MEMORY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="keyword">array</span> $param</span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CachedFile</span> <span class="keyword">extends</span> <span class="title">CachedChain</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $level = <span class="built_in">self</span>::FILE;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="keyword">array</span> $param</span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CachedDB</span> <span class="keyword">extends</span> <span class="title">CachedChain</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $level = <span class="built_in">self</span>::MYSQL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"><span class="keyword">array</span> $param</span>): <span class="title">string</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$memory = <span class="keyword">new</span> CachedMemory;</span><br><span class="line">$file = <span class="keyword">new</span> CachedFile;</span><br><span class="line">$db = <span class="keyword">new</span> CachedDB;</span><br><span class="line">$db-&gt;data = <span class="string">&#x27;hello world&#x27;</span>;</span><br><span class="line"></span><br><span class="line">$memory-&gt;setNextCache($file);</span><br><span class="line">$file-&gt;setNextCache($db);</span><br><span class="line"></span><br><span class="line">$data = $memory-&gt;readContent(CachedChain::MEMORY, []);</span><br><span class="line">var_dump($data);</span><br><span class="line">$data = $memory-&gt;readContent(CachedChain::MEMORY, []);</span><br><span class="line">var_dump($data);</span><br></pre></td></tr></table></figure>

<p>这个代码运行结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">string(11) <span class="string">&quot;hello world&quot;</span></span><br><span class="line">string(11) <span class="string">&quot;hello world&quot;</span></span><br></pre></td></tr></table></figure>

<p>感兴趣的小伙伴可以调试一下。然后稍加修改，就可以做成一个通用的组件了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/08/22/%E9%80%9A%E8%BF%87%E8%B4%A3%E4%BB%BB%E9%93%BE%E6%A8%A1%E5%BC%8F%E8%AE%BE%E8%AE%A1%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98/" data-id="ckkj72zv800cjf6vx48f61dr1" data-title="通过责任链模式设计多级缓存" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-尽可能不要在PHP的C扩展里面把重要的字段存成对象的属性" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/18/%E5%B0%BD%E5%8F%AF%E8%83%BD%E4%B8%8D%E8%A6%81%E5%9C%A8PHP%E7%9A%84C%E6%89%A9%E5%B1%95%E9%87%8C%E9%9D%A2%E6%8A%8A%E9%87%8D%E8%A6%81%E7%9A%84%E5%AD%97%E6%AE%B5%E5%AD%98%E6%88%90%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7/" class="article-date">
  <time class="dt-published" datetime="2020-08-18T12:58:09.000Z" itemprop="datePublished">2020-08-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/18/%E5%B0%BD%E5%8F%AF%E8%83%BD%E4%B8%8D%E8%A6%81%E5%9C%A8PHP%E7%9A%84C%E6%89%A9%E5%B1%95%E9%87%8C%E9%9D%A2%E6%8A%8A%E9%87%8D%E8%A6%81%E7%9A%84%E5%AD%97%E6%AE%B5%E5%AD%98%E6%88%90%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7/">尽可能不要在PHP的C扩展里面把重要的字段存成对象的属性</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>我们有如下例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Server</span>;</span><br><span class="line"></span><br><span class="line">$serv = <span class="keyword">new</span> Server(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9580</span>);</span><br><span class="line"></span><br><span class="line">$serv-&gt;on(<span class="string">&#x27;Receive&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd, $reactorId, $data</span>) </span>&#123;</span><br><span class="line">    array_walk($serv, <span class="function"><span class="keyword">function</span> (<span class="params">&amp;$property</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($property[<span class="number">0</span>]) &amp;&amp; $property[<span class="number">0</span>] <span class="keyword">instanceof</span> Swoole\Server\Port) &#123;</span><br><span class="line">            $primaryPort = $property[<span class="number">0</span>];</span><br><span class="line">            array_walk($primaryPort, <span class="function"><span class="keyword">function</span> (<span class="params">&amp;$callback</span>) </span>&#123;</span><br><span class="line">                $callback = <span class="literal">null</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$serv-&gt;start();</span><br></pre></td></tr></table></figure>

<p>这个代码看起来会非常的绕，但是，为了解释我们的问题，这个写法还是很具有代表性的。</p>
<p>因为<code>PHP</code>的设计问题，我们可以在类的外面通过<code>array_walk</code>来访问一个对象的私有属性，并且修改它。我们来看一下<code>Swoole\Server</code>底层是如何存成<code>port</code>的：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">zend_declare_property_null(swoole_server_port_ce, ZEND_STRL(<span class="string">&quot;onConnect&quot;</span>), ZEND_ACC_PRIVATE);</span><br><span class="line">zend_declare_property_null(swoole_server_port_ce, ZEND_STRL(<span class="string">&quot;onReceive&quot;</span>), ZEND_ACC_PRIVATE);</span><br><span class="line">zend_declare_property_null(swoole_server_port_ce, ZEND_STRL(<span class="string">&quot;onClose&quot;</span>), ZEND_ACC_PRIVATE);</span><br><span class="line">zend_declare_property_null(swoole_server_port_ce, ZEND_STRL(<span class="string">&quot;onPacket&quot;</span>), ZEND_ACC_PRIVATE);</span><br><span class="line">zend_declare_property_null(swoole_server_port_ce, ZEND_STRL(<span class="string">&quot;onBufferFull&quot;</span>), ZEND_ACC_PRIVATE);</span><br><span class="line">zend_declare_property_null(swoole_server_port_ce, ZEND_STRL(<span class="string">&quot;onBufferEmpty&quot;</span>), ZEND_ACC_PRIVATE);</span><br><span class="line">zend_declare_property_null(swoole_server_port_ce, ZEND_STRL(<span class="string">&quot;onRequest&quot;</span>), ZEND_ACC_PRIVATE);</span><br><span class="line">zend_declare_property_null(swoole_server_port_ce, ZEND_STRL(<span class="string">&quot;onHandShake&quot;</span>), ZEND_ACC_PRIVATE);</span><br><span class="line">zend_declare_property_null(swoole_server_port_ce, ZEND_STRL(<span class="string">&quot;onOpen&quot;</span>), ZEND_ACC_PRIVATE);</span><br><span class="line">zend_declare_property_null(swoole_server_port_ce, ZEND_STRL(<span class="string">&quot;onMessage&quot;</span>), ZEND_ACC_PRIVATE);</span><br></pre></td></tr></table></figure>

<p>我们发现，这里把回调函数设置成了<code>private</code>属性，但是终究是无法避免被修改的下场。</p>
<p>只要我们跑这个服务器，并且给这个服务器发送数据。那么，我们就可以让这个<code>Server coredump</code>。这是我的测试结果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PHP Fatal error:  Uncaught Error: Cannot use object of <span class="built_in">type</span> Swoole\Server as array <span class="keyword">in</span> /Users/hantaohuang/codeDir/phpCode/library/test.php:10</span><br><span class="line">Stack trace:</span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br><span class="line">  thrown <span class="keyword">in</span> /Users/hantaohuang/codeDir/phpCode/library/test.php on line 10</span><br><span class="line"></span><br><span class="line">Fatal error: Uncaught Error: Cannot use object of <span class="built_in">type</span> Swoole\Server as array <span class="keyword">in</span> /Users/hantaohuang/codeDir/phpCode/library/test.php:10</span><br><span class="line">Stack trace:</span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br><span class="line">  thrown <span class="keyword">in</span> /Users/hantaohuang/codeDir/phpCode/library/test.php on line 10</span><br><span class="line">[2020-08-18 21:16:56 *13285.3]  ERROR   php_swoole_server_rshutdown (ERRNO 503): Fatal error: Uncaught Error: Cannot use object of <span class="built_in">type</span> Swoole\Server as array <span class="keyword">in</span> /Users/hantaohuang/codeDir/phpCode/library/test.php:10</span><br><span class="line">Stack trace:</span><br><span class="line"><span class="comment">#0 &#123;main&#125;</span></span><br><span class="line">  thrown <span class="keyword">in</span> /Users/hantaohuang/codeDir/phpCode/library/test.php on line 10</span><br><span class="line">[2020-08-18 21:16:56 <span class="variable">$12938</span>.0]  WARNING check_worker_exit_status: worker<span class="comment">#3[pid=13285] abnormal exit, status=255, signal=0</span></span><br></pre></td></tr></table></figure>

<p>我们可以看到，<code>worker</code>进程挂了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/08/18/%E5%B0%BD%E5%8F%AF%E8%83%BD%E4%B8%8D%E8%A6%81%E5%9C%A8PHP%E7%9A%84C%E6%89%A9%E5%B1%95%E9%87%8C%E9%9D%A2%E6%8A%8A%E9%87%8D%E8%A6%81%E7%9A%84%E5%AD%97%E6%AE%B5%E5%AD%98%E6%88%90%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%B1%9E%E6%80%A7/" data-id="ckkj72zu9009tf6vxgi4d88br" data-title="尽可能不要在PHP的C扩展里面把重要的字段存成对象的属性" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Swoole的多个线程如何处理信号" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/18/Swoole%E7%9A%84%E5%A4%9A%E4%B8%AA%E7%BA%BF%E7%A8%8B%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E4%BF%A1%E5%8F%B7/" class="article-date">
  <time class="dt-published" datetime="2020-08-18T10:02:14.000Z" itemprop="datePublished">2020-08-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/18/Swoole%E7%9A%84%E5%A4%9A%E4%B8%AA%E7%BA%BF%E7%A8%8B%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E4%BF%A1%E5%8F%B7/">Swoole的多个线程如何处理信号</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>在<code>Swoole</code>内核里面，有多种线程。比如说心跳线程（心跳线程我们会在未来的版本进行移除），<code>reactor</code>线程，中断检查线程等等。</p>
<p>那么，在信号的管理方面，<code>Swoole</code>又是怎么做的呢？我们又如下规则：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 如果是异常产生的信号（比如程序错误，像SIGPIPE、SIGEGV这些），则只有产生异常的线程收到并处理。</span><br><span class="line">2. 如果是用pthread_kill产生的内部信号，则只有pthread_kill参数中指定的目标线程收到并处理。</span><br><span class="line">3. 如果是外部使用kill命令产生的信号，通常是SIGINT、SIGHUP等job control信号，则会遍历所有线程，直到找到一个不阻塞该信号的线程，然后调用它来处理。注意只有一个线程能收到。</span><br></pre></td></tr></table></figure>

<p>那么<code>Swoole</code>是如何实现阻塞信号的呢？它提供了一个叫做<code>swSignal_none</code>的函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swSignal_none</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">sigset_t</span> mask;</span><br><span class="line">    sigfillset(&amp;mask);</span><br><span class="line">    <span class="keyword">int</span> ret = pthread_sigmask(SIG_BLOCK, &amp;mask, <span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        swSysWarn(<span class="string">&quot;pthread_sigmask() failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sigfillset(&amp;mask);</span><br></pre></td></tr></table></figure>

<p>表示设置所有的信号。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> ret = pthread_sigmask(SIG_BLOCK, &amp;mask, <span class="literal">nullptr</span>);</span><br></pre></td></tr></table></figure>

<p>表示对所有的信号进行阻塞。</p>
<p>我们发现，<code>Swoole</code>对心跳线程、中断检查线程等线程调用了<code>swSignal_none</code>。因为<code>Swoole</code>不希望这些线程去处理信号以及被这些信号打扰。具体哪些地方调用了<code>swSignal_none</code>，感兴趣的小伙伴可以看一看源码。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/08/18/Swoole%E7%9A%84%E5%A4%9A%E4%B8%AA%E7%BA%BF%E7%A8%8B%E5%A6%82%E4%BD%95%E5%A4%84%E7%90%86%E4%BF%A1%E5%8F%B7/" data-id="ckkj72zsc0044f6vxfcrkabrg" data-title="Swoole的多个线程如何处理信号" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-PHP数组系列函数源码分析-end" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/16/PHP%E6%95%B0%E7%BB%84%E7%B3%BB%E5%88%97%E5%87%BD%E6%95%B0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-end/" class="article-date">
  <time class="dt-published" datetime="2020-08-16T12:15:42.000Z" itemprop="datePublished">2020-08-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/16/PHP%E6%95%B0%E7%BB%84%E7%B3%BB%E5%88%97%E5%87%BD%E6%95%B0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-end/">PHP数组系列函数源码分析--end</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>本文基于PHP的commit: d92229d8c78aac25925284e23aa7903dca9ed005</p>
</blockquote>
<p>如果我们要获取数组的最后一个元素，我们很可能会这么写：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">$arr = [</span><br><span class="line">    <span class="string">&#x27;one&#x27;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;two&#x27;</span> =&gt; <span class="number">2</span>,</span><br><span class="line">    <span class="string">&#x27;three&#x27;</span> =&gt; <span class="number">3</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">var_dump(end($arr));</span><br></pre></td></tr></table></figure>

<p>输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int(3)</span><br></pre></td></tr></table></figure>

<p>我们来看一下<code>end</code>对应的<code>PHP</code>层代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(end)</span><br><span class="line">&#123;</span><br><span class="line">    HashTable *<span class="built_in">array</span>;</span><br><span class="line">    zval *entry;</span><br><span class="line"></span><br><span class="line">    ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">        Z_PARAM_ARRAY_OR_OBJECT_HT_EX(<span class="built_in">array</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    ZEND_PARSE_PARAMETERS_END();</span><br><span class="line"></span><br><span class="line">    zend_hash_internal_pointer_end(<span class="built_in">array</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (USED_RET()) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((entry = zend_hash_get_current_data(<span class="built_in">array</span>)) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            RETURN_FALSE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Z_TYPE_P(entry) == IS_INDIRECT) &#123;</span><br><span class="line">            entry = Z_INDIRECT_P(entry);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ZVAL_COPY_DEREF(return_value, entry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，核心代码就是<code>zend_hash_internal_pointer_end</code>，它负责找到数组的最后一个元素：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> zend_hash_internal_pointer_end(ht) \</span></span><br><span class="line">    zend_hash_internal_pointer_end_ex(ht, &amp;(ht)-&gt;nInternalPointer)</span><br><span class="line"></span><br><span class="line"><span class="comment">/* This function will be extremely optimized by remembering</span></span><br><span class="line"><span class="comment">* the end of the list</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function">ZEND_API <span class="keyword">void</span> ZEND_FASTCALL <span class="title">zend_hash_internal_pointer_end_ex</span><span class="params">(HashTable *ht, HashPosition *pos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> idx;</span><br><span class="line"></span><br><span class="line">    IS_CONSISTENT(ht);</span><br><span class="line">    HT_ASSERT(ht, &amp;ht-&gt;nInternalPointer != pos || GC_REFCOUNT(ht) == <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    idx = ht-&gt;nNumUsed;</span><br><span class="line">    <span class="keyword">while</span> (idx &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        idx--;</span><br><span class="line">        <span class="keyword">if</span> (Z_TYPE(ht-&gt;arData[idx].val) != IS_UNDEF) &#123;</span><br><span class="line">            *pos = idx;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *pos = ht-&gt;nNumUsed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这个函数的注释，我们可以明白。如果我们能够大概记住数组的末尾的元素，那么，这个函数的性能是非常高的。</p>
<p>这个代码也是很简单的，首先，通过：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">idx = ht-&gt;nNumUsed;</span><br><span class="line">idx--;</span><br></pre></td></tr></table></figure>

<p>来找到最后一个<code>bucket</code>的位置。然后，判断<code>bucket</code>里面的变量是否是<code>IS_UNDEF</code>。如果不是，那么就找到了数组的最后一个元素；否则，一直往前找。</p>
<p>所以，如果这个数组的末尾都是<code>IS_UNDEF</code>，那么这个函数的性能会非常的差劲。极端情况下，只有数组的第一个元素不是<code>IS_UNDEF</code>，其他的都是<code>IS_UNDEF</code>，那么这个函数的时间复杂度就是<code>O(n)</code>了。</p>
<p>这里，我们有一个需要非常注意的点，这个<code>end</code>函数会去设置<code>nInternalPointer</code>指针。如果我们调用<code>end</code>函数后，紧接着调用<code>current</code>函数，那么我们就会得到数组的最后一个元素：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">$arr = [</span><br><span class="line">    <span class="string">&#x27;one&#x27;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">    <span class="string">&#x27;two&#x27;</span> =&gt; <span class="number">2</span>,</span><br><span class="line">    <span class="string">&#x27;three&#x27;</span> =&gt; <span class="number">3</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line">var_dump(current($arr));</span><br><span class="line">var_dump(end($arr));</span><br><span class="line">var_dump(current($arr));</span><br></pre></td></tr></table></figure>

<p>输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int(1)</span><br><span class="line">int(3)</span><br><span class="line">int(3)</span><br></pre></td></tr></table></figure>

<p>但是，并不是说<code>nInternalPointer</code>就代表最后一个元素的位置。<code>nInternalPointer</code>表示数组里面有这么一个指针，它指向了<code>PHP</code>数组里面的一个元素，仅此而已。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/08/16/PHP%E6%95%B0%E7%BB%84%E7%B3%BB%E5%88%97%E5%87%BD%E6%95%B0%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-end/" data-id="ckkj72zrt0032f6vx74wegcm7" data-title="PHP数组系列函数源码分析--end" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHP内核</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/6/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost/" rel="tag">Boost</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Composer/" rel="tag">Composer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C%E8%AF%AD%E8%A8%80/" rel="tag">C语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dockerfile/" rel="tag">Dockerfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GRPC/" rel="tag">GRPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GraphQL/" rel="tag">GraphQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hyperf/" rel="tag">Hyperf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" rel="tag">I/O多路复用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JIT/" rel="tag">JIT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JWT/" rel="tag">JWT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Laravel/" rel="tag">Laravel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MacOS/" rel="tag">MacOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/" rel="tag">Mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OPcache/" rel="tag">OPcache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHP 扩展开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP7/" rel="tag">PHP7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHP内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95/" rel="tag">PHP扩展</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHP扩展开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/" rel="tag">PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Protobuf/" rel="tag">Protobuf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swoole%E5%BE%AE%E8%AF%BE%E7%A8%8B/" rel="tag">Swoole微课程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vscode/" rel="tag">Vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xdebug/" rel="tag">Xdebug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/composer/" rel="tag">composer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c%E8%AF%AD%E8%A8%80/" rel="tag">c语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-compose/" rel="tag">docker-compose</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/epoll/" rel="tag">epoll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fpm/" rel="tag">fpm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gqlgen/" rel="tag">gqlgen</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/migrate/" rel="tag">migrate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swoole/" rel="tag">swoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swore/" rel="tag">swore</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tinyswoole/" rel="tag">tinyswoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unique-lock/" rel="tag">unique_lock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-js/" rel="tag">vue.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%B6%E4%BB%96/" rel="tag">其他</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%8F%E7%A8%8B/" rel="tag">协程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%96%E9%83%A8%E6%8E%92%E5%BA%8F/" rel="tag">外部排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" rel="tag">多线程编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/" rel="tag">引用计数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD/" rel="tag">性能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" rel="tag">性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" rel="tag">性能分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" rel="tag">服务器开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" rel="tag">服务器编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" rel="tag">汇编语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" rel="tag">秒杀系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B/" rel="tag">线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A0%81/" rel="tag">编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" rel="tag">编译器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag">网络编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag">虚拟机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" rel="tag">计算机基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" rel="tag">计算机系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E8%AF%BB%E4%BB%A3%E7%A0%81/" rel="tag">读读代码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B0%83%E8%AF%95/" rel="tag">调试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%92%E5%BD%92/" rel="tag">递归</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%94%81/" rel="tag">锁</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Boost/" style="font-size: 10px;">Boost</a> <a href="/tags/C/" style="font-size: 11.43px;">C</a> <a href="/tags/C/" style="font-size: 16.43px;">C++</a> <a href="/tags/Composer/" style="font-size: 10px;">Composer</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 15px;">C语言</a> <a href="/tags/Docker/" style="font-size: 11.43px;">Docker</a> <a href="/tags/Dockerfile/" style="font-size: 10px;">Dockerfile</a> <a href="/tags/GRPC/" style="font-size: 10.71px;">GRPC</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/GraphQL/" style="font-size: 10px;">GraphQL</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Hyperf/" style="font-size: 10.71px;">Hyperf</a> <a href="/tags/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" style="font-size: 10.71px;">I/O多路复用</a> <a href="/tags/JIT/" style="font-size: 10px;">JIT</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Laravel/" style="font-size: 10px;">Laravel</a> <a href="/tags/Linux/" style="font-size: 17.14px;">Linux</a> <a href="/tags/MacOS/" style="font-size: 10px;">MacOS</a> <a href="/tags/MySQL/" style="font-size: 10.71px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/OPcache/" style="font-size: 10px;">OPcache</a> <a href="/tags/PHP/" style="font-size: 20px;">PHP</a> <a href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size: 10.71px;">PHP 扩展开发</a> <a href="/tags/PHP7/" style="font-size: 10px;">PHP7</a> <a href="/tags/PHP%E5%86%85%E6%A0%B8/" style="font-size: 17.86px;">PHP内核</a> <a href="/tags/PHP%E6%89%A9%E5%B1%95/" style="font-size: 13.57px;">PHP扩展</a> <a href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size: 12.14px;">PHP扩展开发</a> <a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="/tags/Protobuf/" style="font-size: 10.71px;">Protobuf</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/Swoole/" style="font-size: 19.29px;">Swoole</a> <a href="/tags/Swoole%E5%BE%AE%E8%AF%BE%E7%A8%8B/" style="font-size: 10px;">Swoole微课程</a> <a href="/tags/Vscode/" style="font-size: 10px;">Vscode</a> <a href="/tags/Xdebug/" style="font-size: 10.71px;">Xdebug</a> <a href="/tags/c/" style="font-size: 10.71px;">c++</a> <a href="/tags/composer/" style="font-size: 10px;">composer</a> <a href="/tags/c%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">c语言</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/docker-compose/" style="font-size: 10px;">docker-compose</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/fpm/" style="font-size: 10px;">fpm</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/gqlgen/" style="font-size: 10px;">gqlgen</a> <a href="/tags/leetcode/" style="font-size: 12.14px;">leetcode</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/migrate/" style="font-size: 10px;">migrate</a> <a href="/tags/nginx/" style="font-size: 10.71px;">nginx</a> <a href="/tags/php/" style="font-size: 15.71px;">php</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/swoole/" style="font-size: 15.71px;">swoole</a> <a href="/tags/swore/" style="font-size: 10px;">swore</a> <a href="/tags/tinyswoole/" style="font-size: 10px;">tinyswoole</a> <a href="/tags/unique-lock/" style="font-size: 10px;">unique_lock</a> <a href="/tags/vue-js/" style="font-size: 10.71px;">vue.js</a> <a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 12.14px;">其他</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">前端</a> <a href="/tags/%E5%8D%8F%E7%A8%8B/" style="font-size: 15.71px;">协程</a> <a href="/tags/%E5%A4%96%E9%83%A8%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">外部排序</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">多线程编程</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">并发</a> <a href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/" style="font-size: 10px;">引用计数</a> <a href="/tags/%E6%80%A7%E8%83%BD/" style="font-size: 10px;">性能</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 10px;">性能优化</a> <a href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" style="font-size: 10px;">性能分析</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 13.57px;">操作系统</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 10.71px;">数据结构</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" style="font-size: 12.86px;">服务器开发</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">服务器编程</a> <a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">汇编语言</a> <a href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">秒杀系统</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">算法</a> <a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 10px;">线程</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 10px;">线程池</a> <a href="/tags/%E7%BC%96%E7%A0%81/" style="font-size: 10px;">编码</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" style="font-size: 18.57px;">编译原理</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" style="font-size: 10px;">编译器</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" style="font-size: 14.29px;">网络编程</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 10px;">虚拟机</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">计算机基础</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">计算机系统</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 10.71px;">计算机网络</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10.71px;">设计模式</a> <a href="/tags/%E8%AF%BB%E8%AF%BB%E4%BB%A3%E7%A0%81/" style="font-size: 10.71px;">读读代码</a> <a href="/tags/%E8%B0%83%E8%AF%95/" style="font-size: 10px;">调试</a> <a href="/tags/%E9%80%92%E5%BD%92/" style="font-size: 10px;">递归</a> <a href="/tags/%E9%94%81/" style="font-size: 10px;">锁</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/03/01/Swoole-reload-async%E6%9C%BA%E5%88%B6/">Swoole reload_async机制</a>
          </li>
        
          <li>
            <a href="/2021/02/24/PHP%E4%B8%AD%E7%9A%84if%E8%AF%AD%E5%8F%A5%E5%92%8Cswitch%E8%AF%AD%E5%8F%A5%E7%94%9F%E6%88%90%E7%9A%84opcode%E5%AF%B9%E6%AF%94/">PHP中的if语句和switch语句生成的opcode对比</a>
          </li>
        
          <li>
            <a href="/2021/02/02/ptrace%E4%BD%BF%E7%94%A8/">ptrace使用</a>
          </li>
        
          <li>
            <a href="/2021/01/30/PHP%E5%87%BD%E6%95%B0%E7%BC%96%E8%AF%91%E4%B9%8B%E5%90%8E%E7%9A%84%E5%86%85%E5%AD%98%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/">PHP函数编译之后的内存存储结构</a>
          </li>
        
          <li>
            <a href="/2021/01/07/%E5%9C%A8PHP-RSHUTDOWN%E9%98%B6%E6%AE%B5%E8%B0%83%E7%94%A8zend-bailout%E5%AF%BC%E8%87%B4zend-mm-heap-corrupted%E9%97%AE%E9%A2%98/">在PHP RSHUTDOWN阶段调用zend_bailout导致zend_mm_heap corrupted问题</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 codinghuang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>