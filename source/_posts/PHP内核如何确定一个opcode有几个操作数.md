---
title: PHP内核如何确定一个opcode有几个操作数
date: 2020-10-31 22:44:12
tags:
- PHP
- PHP内核
---

首先，`PHP`内核包含的所有`zend_ast`节点类型在文件`zend_ast.h`里面：

```cpp
#define ZEND_AST_SPECIAL_SHIFT      6
#define ZEND_AST_IS_LIST_SHIFT      7
#define ZEND_AST_NUM_CHILDREN_SHIFT 8

enum _zend_ast_kind {
    // 省略其他的节点类型

    /* 0 child nodes */
    ZEND_AST_MAGIC_CONST = 0 << ZEND_AST_NUM_CHILDREN_SHIFT,
    ZEND_AST_TYPE,
    ZEND_AST_CONSTANT_CLASS,

    /* 1 child node */
    ZEND_AST_VAR = 1 << ZEND_AST_NUM_CHILDREN_SHIFT,
    ZEND_AST_CONST,
    ZEND_AST_UNPACK,
    ZEND_AST_UNARY_PLUS,
    ZEND_AST_UNARY_MINUS,
    ZEND_AST_CAST,
    ZEND_AST_EMPTY,
    ZEND_AST_ISSET,
    ZEND_AST_SILENCE,
    ZEND_AST_SHELL_EXEC,
    ZEND_AST_CLONE,
    ZEND_AST_EXIT,
    ZEND_AST_PRINT,
    ZEND_AST_INCLUDE_OR_EVAL,
    ZEND_AST_UNARY_OP,
    ZEND_AST_PRE_INC,
    ZEND_AST_PRE_DEC,
    ZEND_AST_POST_INC,
    ZEND_AST_POST_DEC,
    ZEND_AST_YIELD_FROM,
    ZEND_AST_CLASS_NAME,

    ZEND_AST_GLOBAL,
    ZEND_AST_UNSET,
    ZEND_AST_RETURN,
    ZEND_AST_LABEL,
    ZEND_AST_REF,
    ZEND_AST_HALT_COMPILER,
    ZEND_AST_ECHO,
    ZEND_AST_THROW,
    ZEND_AST_GOTO,
    ZEND_AST_BREAK,
    ZEND_AST_CONTINUE,

    /* 2 child nodes */
    ZEND_AST_DIM = 2 << ZEND_AST_NUM_CHILDREN_SHIFT,
    ZEND_AST_PROP,
    ZEND_AST_NULLSAFE_PROP,
    ZEND_AST_STATIC_PROP,
    ZEND_AST_CALL,
    ZEND_AST_CLASS_CONST,
    ZEND_AST_ASSIGN,
    ZEND_AST_ASSIGN_REF,
    ZEND_AST_ASSIGN_OP,
    ZEND_AST_BINARY_OP,
    ZEND_AST_GREATER,
    ZEND_AST_GREATER_EQUAL,
    ZEND_AST_AND,
    ZEND_AST_OR,
    ZEND_AST_ARRAY_ELEM,
    ZEND_AST_NEW,
    ZEND_AST_INSTANCEOF,
    ZEND_AST_YIELD,
    ZEND_AST_COALESCE,
    ZEND_AST_ASSIGN_COALESCE,

    ZEND_AST_STATIC,
    ZEND_AST_WHILE,
    ZEND_AST_DO_WHILE,
    ZEND_AST_IF_ELEM,
    ZEND_AST_SWITCH,
    ZEND_AST_SWITCH_CASE,
    ZEND_AST_DECLARE,
    ZEND_AST_USE_TRAIT,
    ZEND_AST_TRAIT_PRECEDENCE,
    ZEND_AST_METHOD_REFERENCE,
    ZEND_AST_NAMESPACE,
    ZEND_AST_USE_ELEM,
    ZEND_AST_TRAIT_ALIAS,
    ZEND_AST_GROUP_USE,
    ZEND_AST_CLASS_CONST_GROUP,
    ZEND_AST_ATTRIBUTE,
    ZEND_AST_MATCH,
    ZEND_AST_MATCH_ARM,
    ZEND_AST_NAMED_ARG,

    /* 3 child nodes */
    ZEND_AST_METHOD_CALL = 3 << ZEND_AST_NUM_CHILDREN_SHIFT,
    ZEND_AST_NULLSAFE_METHOD_CALL,
    ZEND_AST_STATIC_CALL,
    ZEND_AST_CONDITIONAL,

    ZEND_AST_TRY,
    ZEND_AST_CATCH,
    ZEND_AST_PROP_GROUP,
    ZEND_AST_PROP_ELEM,
    ZEND_AST_CONST_ELEM,

    /* 4 child nodes */
    ZEND_AST_FOR = 4 << ZEND_AST_NUM_CHILDREN_SHIFT,
    ZEND_AST_FOREACH,

    /* 5 child nodes */
    ZEND_AST_PARAM = 5 << ZEND_AST_NUM_CHILDREN_SHIFT,
};
```

我们发现，有几个子节点，那么就从`子节点个数 << ZEND_AST_NUM_CHILDREN_SHIFT`开始。所以，对应的，我们可以通过反过来拿到子节点的个数：

```cpp
zend_ast_kind >> ZEND_AST_NUM_CHILDREN_SHIFT
```
