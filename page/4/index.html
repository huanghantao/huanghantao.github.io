<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>codinghuang的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="比PHP多一些">
<meta property="og:type" content="website">
<meta property="og:title" content="codinghuang的个人博客">
<meta property="og:url" content="http://huanghantao.github.io/page/4/index.html">
<meta property="og:site_name" content="codinghuang的个人博客">
<meta property="og:description" content="比PHP多一些">
<meta property="og:locale">
<meta property="article:author" content="codinghuang">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="codinghuang的个人博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">codinghuang的个人博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">简洁些、干净些、直接些...</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://huanghantao.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-《手把手教你编写PHP编译器》-实现echo-expr" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/10/02/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%AE%9E%E7%8E%B0echo-expr/" class="article-date">
  <time class="dt-published" datetime="2020-10-02T03:09:30.000Z" itemprop="datePublished">2020-10-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/10/02/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%AE%9E%E7%8E%B0echo-expr/">《手把手教你编写PHP编译器》-实现echo_expr</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>到目前为止，我们已经实现了<code>yaphp</code>源代码到<code>AST</code>的生成工作。但是，我们对<code>echo</code>语句的实现还是简单处理了，之前的实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">statement:</span><br><span class="line">    T_ECHO expr &#39;;&#39;     &#123; $$ &#x3D; $2; &#125;</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>可以看到，这里实际上我们没有体现出<code>T_ECHO</code>的功能，我们仅仅处理了<code>expr</code>。所以，这里我们需要去处理一下。</p>
<p>有了前面的基础之后，我们可以非常轻松的来实现这个<code>AST</code>的生成。</p>
<p>我们修改后的规则如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">statement:</span><br><span class="line">    T_ECHO echo_expr &#39;;&#39;     &#123; $$ &#x3D; $2; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">echo_expr:</span><br><span class="line">    expr &#123;</span><br><span class="line">        std::cout &lt;&lt; &quot;create echo zend_ast&quot; &lt;&lt; std::endl;</span><br><span class="line">        $$ &#x3D; zend_ast_create_1(ZEND_AST_ECHO, 0, $1);</span><br><span class="line">    &#125;</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>可以看到，我们加了一个<code>echo_expr</code>，用来创建一个<code>ZEND_AST_ECHO</code>类型的<code>AST</code>。这里，我们的语法和<code>php-src</code>的有点不同，<code>php-src</code>的语法功能更加的丰富一点，它支持<code>echo</code>后面跟一个<code>ZEND_AST_STMT_LIST</code>，这个的实现也是比较简单的，和我们之前创建<code>top_statement_list</code>的思路是一致的。这里小伙伴们可以自己去实现一下，我们的<code>yaphp</code>就不支持这种可有可无的语法了。</p>
<p>其中，<code>zend_ast_create_1</code>的实现如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">zend_ast *<span class="title">zend_ast_create_1</span><span class="params">(zend_ast_kind kind, zend_ast_attr attr, zend_ast *child)</span> </span>&#123;</span><br><span class="line">    zend_ast *ast;</span><br><span class="line"></span><br><span class="line">    ast = (zend_ast *) <span class="built_in">malloc</span>(zend_ast_size(<span class="number">1</span>));</span><br><span class="line">    ast-&gt;kind = kind;</span><br><span class="line">    ast-&gt;attr = attr;</span><br><span class="line">    ast-&gt;child[<span class="number">0</span>] = child;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ast;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们需要在<code>_zend_ast_kind</code>中增加一个<code>ZEND_AST_ECHO</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 1 child node */</span></span><br><span class="line">ZEND_AST_ECHO,</span><br></pre></td></tr></table></figure>

<p>最后，我们再修改一下我们的<code>dump_compiler_globals</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (ast-&gt;kind &gt; ZEND_AST_0_NODE_END &amp;&amp; ast-&gt;kind &lt; ZEND_AST_1_NODE_END) &#123;</span><br><span class="line">    <span class="built_in">queue</span>.push_back(ast-&gt;child[<span class="number">0</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (ast-&gt;kind &gt; ZEND_AST_1_NODE_END &amp;&amp; ast-&gt;kind &lt; ZEND_AST_2_NODE_END) &#123;</span><br><span class="line">    <span class="built_in">queue</span>.push_back(ast-&gt;child[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">queue</span>.push_back(ast-&gt;child[<span class="number">1</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中，<code>ZEND_AST_0_NODE_END</code>, <code>ZEND_AST_1_NODE_END</code>, <code>ZEND_AST_2_NODE_END</code>这三个<code>zend_ast</code>节点类型<code>php-src</code>是没有的，这里是为了方便调试给加上的，否则，我们每次增加一个<code>zend_ast</code>节点类型，就需要写一个<code>if</code>语句。</p>
<p>现在，让我们来编译一下<code>yaphp</code>，并且运行，结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">create * zend_ast</span><br><span class="line">create + zend_ast</span><br><span class="line">create <span class="built_in">echo</span> zend_ast</span><br><span class="line">kind: 129, attr: 0</span><br><span class="line">kind: 131, attr: 0</span><br><span class="line">kind: 515, attr: 1</span><br><span class="line">kind: 65, attr: 0, value: 1</span><br><span class="line">kind: 515, attr: 3</span><br><span class="line">kind: 65, attr: 0, value: 2</span><br><span class="line">kind: 65, attr: 0, value: 3</span><br></pre></td></tr></table></figure>

<p>符合我们的预期。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/10/02/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%AE%9E%E7%8E%B0echo-expr/" data-id="ckkj72zt9006pf6vxar4gdbl5" data-title="《手把手教你编写PHP编译器》-实现echo_expr" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《手把手教你编写PHP编译器》-引入zend-ast" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/09/22/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%BC%95%E5%85%A5zend-ast/" class="article-date">
  <time class="dt-published" datetime="2020-09-22T15:08:33.000Z" itemprop="datePublished">2020-09-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/09/22/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%BC%95%E5%85%A5zend-ast/">《手把手教你编写PHP编译器》-引入zend_ast</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>细心的小伙伴会发现，在我们实现算数表达式的时候，直接在语法分析的过程（也就是调用<code>bison</code>的阶段）对表达式进行了求值。现在，我们来引入抽象语法树的概念。在<code>php-src</code>里面，对应的就是<code>zend_ast</code>结构了。</p>
<p>我们先来编写一下<code>zend_language_parser.y</code>文件，以让我们对整个过程有一个清晰的认识。</p>
<p>首先，我们需要定义一个<code>union</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%union &#123;</span><br><span class="line">    zend_ast *ast;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个是什么呢？实际上，这个是<code>YYSTYPE</code>，也就是<code>yylval</code>。而<code>yylval</code>我们会在词法分析的时候用到。如果我们不定义这个<code>union</code>的话，那么<code>YYSTYPE</code>默认是<code>int</code>类型。那么，我们在词法分析的时候，就只能够使用<code>yylval</code>去接收<code>int</code>类型的<code>token</code>了。但是，我们现在在词法分析的时候，会去为<code>T_LNUMBER</code>生成一个<code>zend_ast</code>，并且赋值给<code>yylval</code>，以便在语法分析的阶段，直接使用这个这个<code>zend_ast</code>。（实际上，我们也可以把这一步放到语法分析来做，但是，没有必要。）</p>
<p>我们需要对<code>token</code>定义做一些修改：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">%token &lt;ident&gt; T_ECHO    &quot;&#39;echo&#39;&quot;</span><br><span class="line">%token &lt;ast&gt; T_LNUMBER   &quot;integer&quot;</span><br></pre></td></tr></table></figure>

<p>这里<code>%token &lt;ast&gt; T_LNUMBER</code>里面的<code>ast</code>就是说明了我们的<code>T_LNUMBER</code>这个<code>token</code>的值类型是<code>ast</code>。</p>
<p><code>OK</code>，除了声明<code>token</code>的类型之外，我们还需要对文法里面的非终结符进行声明：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%type &lt;ast&gt; top_statement statement</span><br><span class="line">%type &lt;ast&gt; expr</span><br><span class="line">%type &lt;ast&gt; scalar</span><br><span class="line">%type &lt;ast&gt; top_statement_list</span><br></pre></td></tr></table></figure>

<p>现在，让我们看看我们的语法规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">start:</span><br><span class="line">    top_statement_list  &#123; CG(ast) &#x3D; $1; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">top_statement_list:</span><br><span class="line">        top_statement_list top_statement &#123; $$ &#x3D; zend_ast_list_add($1, $2); &#125;</span><br><span class="line">    |   %empty &#123; $$ &#x3D; zend_ast_create_list(0, ZEND_AST_STMT_LIST); &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">top_statement:</span><br><span class="line">    statement                       &#123; $$ &#x3D; $1; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">statement:</span><br><span class="line">    T_ECHO expr &#39;;&#39;     &#123; $$ &#x3D; $2; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">expr:</span><br><span class="line">    expr &#39;+&#39; expr   &#123; $$ &#x3D; zend_ast_create_binary_op(ZEND_ADD, $1, $3); &#125;</span><br><span class="line">|   expr &#39;-&#39; expr   &#123; $$ &#x3D; zend_ast_create_binary_op(ZEND_SUB, $1, $3); &#125;</span><br><span class="line">|   expr &#39;*&#39; expr   &#123; $$ &#x3D; zend_ast_create_binary_op(ZEND_MUL, $1, $3); &#125;</span><br><span class="line">|   expr &#39;&#x2F;&#39; expr   &#123; $$ &#x3D; zend_ast_create_binary_op(ZEND_DIV, $1, $3); &#125;</span><br><span class="line">|   &#39;(&#39; expr &#39;)&#39;    &#123; $$ &#x3D; $2; &#125;</span><br><span class="line">|   scalar &#123; $$ &#x3D; $1; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">scalar:</span><br><span class="line">    T_LNUMBER   &#123; $$ &#x3D; $1; &#125;</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>这里的规则和<code>php-src</code>是保持一致的，但是可能会有一点不同（一些目前没有必要的东西被我删了）。</p>
<p>可以看到，我们在最顶层，也即是非终结符<code>start</code>的那条规则里，它的动作是把<code>ast</code>赋值给<code>CG(ast)</code>。熟悉<code>PHP</code>内核的小伙伴应该是能够立马知道这个<code>CG(ast)</code>是做什么的。这个<code>CG(ast)</code>保存的是，在编译<code>PHP</code>代码阶段的所有<code>zend_ast</code>。</p>
<p>我们接着看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">top_statement_list:</span><br><span class="line">        top_statement_list top_statement &#123; $$ &#x3D; zend_ast_list_add($1, $2); &#125;</span><br><span class="line">    |   %empty &#123; $$ &#x3D; zend_ast_create_list(0, ZEND_AST_STMT_LIST); &#125;</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>它表达的含义一句话来总结就是，定义了一个<code>ZEND_AST_STMT_LIST</code>类型的<code>zend_ast</code>，然后这个<code>zend_ast</code>下面有多个子<code>zend_ast</code>，这些一个个的子<code>zend_ast</code>对应的就是我们<code>PHP</code>代码里的一条条语句（其实也不一定是一条条，例如<code>for</code>循环啥的，这种我们就不太好形容为条。反正大概就是一个语句的意思）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">statement:</span><br><span class="line">    T_ECHO expr &#39;;&#39;     &#123; $$ &#x3D; $2; &#125;</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>表示我们的语句包含<code>echo</code>语句。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">expr:</span><br><span class="line">    expr &#39;+&#39; expr   &#123; $$ &#x3D; zend_ast_create_binary_op(ZEND_ADD, $1, $3); &#125;</span><br><span class="line">|   expr &#39;-&#39; expr   &#123; $$ &#x3D; zend_ast_create_binary_op(ZEND_SUB, $1, $3); &#125;</span><br><span class="line">|   expr &#39;*&#39; expr   &#123; $$ &#x3D; zend_ast_create_binary_op(ZEND_MUL, $1, $3); &#125;</span><br><span class="line">|   expr &#39;&#x2F;&#39; expr   &#123; $$ &#x3D; zend_ast_create_binary_op(ZEND_DIV, $1, $3); &#125;</span><br><span class="line">|   &#39;(&#39; expr &#39;)&#39;    &#123; $$ &#x3D; $2; &#125;</span><br><span class="line">|   scalar &#123; $$ &#x3D; $1; &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">scalar:</span><br><span class="line">    T_LNUMBER   &#123; $$ &#x3D; $1; &#125;</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>这一段和我们前面的文章类似，但是，不同的地方在规则对应的动作，之前因为<code>token</code>的值都是<code>int</code>类型，所以，我们可以直接进行表达式的运算，但是，现在由于我们的<code>token</code>变成了<code>ast</code>类型，所以，我们就不能直接进行四则运算了（实际上，因为我们的语言是<code>C++</code>，所以我们可以对运算符进行重载，然而，这已经超出了我们教程的范围，所以我们就不去支持重载了，留给小伙伴们当作练习吧）。我们现在改为调用<code>zend_ast_create_binary_op</code>函数，而这个函数就是通过两个子<code>zend_ast</code>节点来生成一个四则运算的<code>zend_ast</code>，具体的函数实现我们后面会说。</p>
<p>改完了语法文件之后，我们就业需要改改词法文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[0-9]+ &#123;</span><br><span class="line">    int64_t lnum &#x3D; atoi(yytext);</span><br><span class="line">    yylval.ast &#x3D; zend_ast_create_lnum(lnum);</span><br><span class="line">    return T_LNUMBER;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们上面说了，<code>yylval</code>是一个<code>union</code>类型的了，所以，我们得使用<code>yylval.ast</code>来接收<code>token</code>的值。而<code>zend_ast_create_lnum</code>函数就是用来把数字变成<code>zend_ast</code>的。</p>
<p><code>OK</code>，我们现在可以来看具体的函数实现了。不过在这之前，我们需要先设计好我们的<code>zend_ast</code>结构，我们和<code>php-src</code>的保持一致：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint16_t</span> zend_ast_kind;</span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint16_t</span> zend_ast_attr;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_ast</span> &#123;</span></span><br><span class="line">    zend_ast_kind kind;</span><br><span class="line">    zend_ast_attr attr;</span><br><span class="line">    zend_ast *child[<span class="number">1</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_ast_list</span> &#123;</span></span><br><span class="line">    zend_ast_kind kind;</span><br><span class="line">    zend_ast_attr attr;</span><br><span class="line">    <span class="keyword">uint32_t</span> children;</span><br><span class="line">    zend_ast *child[<span class="number">1</span>];</span><br><span class="line">&#125; zend_ast_list;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_ast_lnum</span> &#123;</span></span><br><span class="line">    zend_ast_kind kind;</span><br><span class="line">    zend_ast_attr attr;</span><br><span class="line">    <span class="keyword">int64_t</span> lnum;</span><br><span class="line">&#125; zend_ast_lnum;</span><br></pre></td></tr></table></figure>

<p>前面的<code>_zend_ast</code>和<code>_zend_ast_list</code>是<code>php-src</code>里面的，小伙伴们可以在网上找到它们的区别。而<code>_zend_ast_lnum</code>是我自己引入的，表示这个<code>zend_ast</code>存了一个<code>lnum</code>的整数值。在<code>php-src</code>里面，这一块应该是<code>zend_ast_zval</code>，也就是存了一个<code>zval</code>。因为我们这篇文章还不想引入<code>zval</code>这个东西（因为我们的表达式都是整形值，所以没必要搞一个<code>zval</code>），所以我先简单处理了。</p>
<p>现在，让我们来看看函数实现了。</p>
<p>首先是<code>zend_ast_create_list</code>，我们在文件<code>Zend/zend_ast.cc</code>里面来进行定义：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">zend_ast *<span class="title">zend_ast_create_list</span><span class="params">(<span class="keyword">uint32_t</span> init_children, zend_ast_kind kind)</span> </span>&#123;</span><br><span class="line">    zend_ast *ast;</span><br><span class="line">    zend_ast_list *<span class="built_in">list</span>;</span><br><span class="line"></span><br><span class="line">    ast = (zend_ast *) <span class="built_in">malloc</span>(zend_ast_list_size(<span class="number">4</span>));</span><br><span class="line">    <span class="built_in">list</span> = (zend_ast_list *) ast;</span><br><span class="line">    <span class="built_in">list</span>-&gt;kind = kind;</span><br><span class="line">    <span class="built_in">list</span>-&gt;children = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ast;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数实现非常简单，首先，<code>malloc</code>出一块<code>zend_ast</code>的内存，然后，设置它的<code>kind</code>和<code>children</code>。其中<code>kind</code>对应这个<code>zend_ast</code>的类型，<code>children</code>表示这个<code>zend_ast</code>有一个子<code>zend_ast</code>。</p>
<p>然后是<code>zend_ast_list_add</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">zend_ast *<span class="title">zend_ast_list_add</span><span class="params">(zend_ast *ast, zend_ast *op)</span> </span>&#123;</span><br><span class="line">    zend_ast_list *<span class="built_in">list</span> = zend_ast_get_list(ast);</span><br><span class="line">    <span class="built_in">list</span>-&gt;child[<span class="built_in">list</span>-&gt;children++] = op;</span><br><span class="line">    <span class="keyword">return</span> (zend_ast *) <span class="built_in">list</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数就是设置<code>zend_ast_create_list</code>函数创建出来的<code>zend_ast</code>的<code>child</code>。设置一个<code>children</code>加一。所以，有几条语句，我们的这个<code>children</code>就是几了。</p>
<p>最后，是我们的<code>zend_ast_create_binary_op</code>函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> zend_ast *<span class="title">zend_ast_create_binary_op</span><span class="params">(<span class="keyword">uint32_t</span> opcode, zend_ast *op0, zend_ast *op1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (opcode)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> ZEND_ADD:</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;create + zend_ast&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ZEND_SUB:</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;create - zend_ast&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ZEND_MUL:</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;create * zend_ast&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> ZEND_DIV:</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;create / zend_ast&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;unknow operator&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> zend_ast_create_2(ZEND_AST_BINARY_OP, opcode, op0, op1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">zend_ast *<span class="title">zend_ast_create_2</span><span class="params">(zend_ast_kind kind, zend_ast_attr attr, zend_ast *child1, zend_ast *child2)</span> </span>&#123;</span><br><span class="line">    zend_ast *ast;</span><br><span class="line"></span><br><span class="line">    ast = (zend_ast *) <span class="built_in">malloc</span>(zend_ast_size(<span class="number">2</span>));</span><br><span class="line">    ast-&gt;kind = kind;</span><br><span class="line">    ast-&gt;attr = attr;</span><br><span class="line">    ast-&gt;child[<span class="number">0</span>] = child1;</span><br><span class="line">    ast-&gt;child[<span class="number">1</span>] = child2;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ast;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个<code>zend_ast_create_binary_op</code>实际上做的一件事情就是创建一个包含两个子<code>ast</code>的<code>zend_ast</code>，然后设置<code>zend_ast</code>的<code>kind</code>为<code>ZEND_AST_BINARY_OP</code>，并且设置对应的运算类型（即加、减、乘、除），最后设置运算符操作的两个子<code>ast</code>。</p>
<p>最后，我们编写一个打印<code>ast</code>的函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dump_ast</span><span class="params">(zend_ast *ast)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ast-&gt;kind == ZEND_AST_LNUM) &#123;</span><br><span class="line">        zend_ast_lnum *ast_lnum = (zend_ast_lnum *) ast;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;kind: &quot;</span> &lt;&lt; ast_lnum-&gt;kind &lt;&lt; <span class="string">&quot;, attr: &quot;</span> &lt;&lt; ast_lnum-&gt;attr &lt;&lt; <span class="string">&quot;, value: &quot;</span> &lt;&lt; ast_lnum-&gt;lnum &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;kind: &quot;</span> &lt;&lt; ast-&gt;kind &lt;&lt; <span class="string">&quot;, attr: &quot;</span> &lt;&lt; ast-&gt;attr &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">dump_compiler_globals</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    zend_ast *ast;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">deque</span>&lt;zend_ast *&gt; <span class="built_in">queue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">queue</span>.push_back(CG(ast));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!<span class="built_in">queue</span>.empty())</span><br><span class="line">    &#123;</span><br><span class="line">        ast = <span class="built_in">queue</span>.front();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ast-&gt;kind == ZEND_AST_STMT_LIST) &#123;</span><br><span class="line">            zend_ast_list *ast_list = (zend_ast_list *) ast;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; ast_list-&gt;children; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">queue</span>.push_back(ast_list-&gt;child[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ast-&gt;kind == ZEND_AST_BINARY_OP) &#123;</span><br><span class="line">            <span class="built_in">queue</span>.push_back(ast-&gt;child[<span class="number">0</span>]);</span><br><span class="line">            <span class="built_in">queue</span>.push_back(ast-&gt;child[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        dump_ast(ast);</span><br><span class="line">        <span class="built_in">queue</span>.pop_front();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个也很简单，实际上就是一个树的层次遍历。</p>
<p><code>OK</code>，做完了这些工作之后，我们重新编译我们的<code>yaphp</code>（记得修改我们的<code>CMakeLists</code>）。</p>
<p>然后编写如下<code>yaphp</code>代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="number">1</span> + <span class="number">2</span> * <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p>输出结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">create * zend_ast</span><br><span class="line">create + zend_ast</span><br><span class="line">kind: 129, attr: 0</span><br><span class="line">kind: 515, attr: 1</span><br><span class="line">kind: 65, attr: 0, value: 1</span><br><span class="line">kind: 515, attr: 3</span><br><span class="line">kind: 65, attr: 0, value: 2</span><br><span class="line">kind: 65, attr: 0, value: 3</span><br></pre></td></tr></table></figure>

<p>这个<code>ast</code>的输出大概如下图：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">        stmt_list</span><br><span class="line">    +</span><br><span class="line">1       *</span><br><span class="line">    2       3</span><br></pre></td></tr></table></figure>

<p>符合我们的预期。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/09/22/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%BC%95%E5%85%A5zend-ast/" data-id="ckkj72ztb006xf6vxf794af95" data-title="《手把手教你编写PHP编译器》-引入zend_ast" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《手把手教你编写PHP编译器》-实现算数表达式" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/09/19/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%AE%9E%E7%8E%B0%E7%AE%97%E6%95%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="article-date">
  <time class="dt-published" datetime="2020-09-19T08:43:44.000Z" itemprop="datePublished">2020-09-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/09/19/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%AE%9E%E7%8E%B0%E7%AE%97%E6%95%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F/">《手把手教你编写PHP编译器》--实现算数表达式</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="实现算数表达式"><a href="#实现算数表达式" class="headerlink" title="实现算数表达式"></a>实现算数表达式</h1><p>这篇文章，我们来用<code>flex</code>和<code>bison</code>实现算数表达式。</p>
<p>几乎所有的编译原理教程都会以这个为例子进行讲解，因为算数表达式的例子是比较复杂一点的，主要是因为它的语法会比其他语法难一点，这其中会涉及到递归，优先级等问题。而关于优先级问题，我们可以使用<code>bison</code>自带的功能来解决，但是，我们也会去讲如何自己手动来实现优先级。</p>
<p>首先，我们来写一下<code>zend_language_scanner.l</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">%option noyywrap</span><br><span class="line">%option nounput</span><br><span class="line">%option noinput</span><br><span class="line">%&#123;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &quot;zend_language_parser.h&quot;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line">echo &#123;</span><br><span class="line">    return T_ECHO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[;(),+*&#x2F;-] &#123;</span><br><span class="line">    return *yytext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[0-9]+ &#123;</span><br><span class="line">    yylval &#x3D; atoi(yytext);</span><br><span class="line">    return T_LNUMBER;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[#].* &#x2F;* ignore comment *&#x2F;</span><br><span class="line"></span><br><span class="line">[\t\n ]+  &#x2F;* ignore \t, \n, whitespace *&#x2F;</span><br><span class="line"></span><br><span class="line">. &#123;</span><br><span class="line">    std::cerr &lt;&lt; &quot;Lexical error. Unrecognized character: &#39;&quot; &lt;&lt; *yytext &lt;&lt; &quot;&#39;&quot; &lt;&lt; std::endl;</span><br><span class="line">    exit(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line">%%</span><br></pre></td></tr></table></figure>

<p>我们逐一进行分析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line">#include &quot;zend_language_parser.h&quot;</span><br><span class="line">%&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现，这里有一对：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"></span><br><span class="line">%&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以在这个地方去引入一些头文件。这里的重点是<code>zend_language_parser.h</code>这个文件，我们在之前的文章已经发现，<code>zend_language_parser.h</code>是由<code>zend_language_parser.y</code>通过<code>bison</code>生成的。那么我们为什么要引入这个头文件呢？因为我们会去使用<code>zend_language_parser.h</code>的一些东西（至于是什么，我们后面会讲）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">%%</span><br><span class="line">echo &#123;</span><br><span class="line">    return T_ECHO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[;(),+*&#x2F;-] &#123;</span><br><span class="line">    return *yytext;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[0-9]+ &#123;</span><br><span class="line">    yylval &#x3D; atoi(yytext);</span><br><span class="line">    return T_LNUMBER;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[#].* &#x2F;* ignore comment *&#x2F;</span><br><span class="line"></span><br><span class="line">[\t\n ]+  &#x2F;* ignore \t, \n, whitespace *&#x2F;</span><br><span class="line"></span><br><span class="line">. &#123;</span><br><span class="line">    std::cerr &lt;&lt; &quot;Lexical error. Unrecognized character: &#39;&quot; &lt;&lt; *yytext &lt;&lt; &quot;&#39;&quot; &lt;&lt; std::endl;</span><br><span class="line">    exit(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line">%%</span><br></pre></td></tr></table></figure>

<p>我们发现，这里有一对：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%%</span><br><span class="line"></span><br><span class="line">%%</span><br></pre></td></tr></table></figure>

<p>我们可以在这里面去定义我们需要解析的<code>token</code>。那么<code>token</code>是什么呢？我们来看这么一个例子。我们有如下<code>php</code>文件：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$tokens = token_get_all(<span class="string">&#x27;&lt;?php 1 + 2 + 3;&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($tokens <span class="keyword">as</span> $token) &#123;</span><br><span class="line">    <span class="keyword">if</span> (is_array($token)) &#123;</span><br><span class="line">        <span class="keyword">echo</span> token_name($token[<span class="number">0</span>]), <span class="string">&quot; (&#x27;<span class="subst">&#123;$token[1]&#125;</span>&#x27;)&quot;</span>, PHP_EOL;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> $token, PHP_EOL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">T_OPEN_TAG (<span class="string">&#x27;&lt;?php &#x27;</span>)</span><br><span class="line">T_LNUMBER (<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">T_WHITESPACE (<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">+</span><br><span class="line">T_WHITESPACE (<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">T_LNUMBER (<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">T_WHITESPACE (<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">+</span><br><span class="line">T_WHITESPACE (<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">T_LNUMBER (<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">;</span><br></pre></td></tr></table></figure>

<p>可以发现，从</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="number">1</span> + <span class="number">2</span> + <span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<p>代码里面得到的<code>token</code>包括了<code>T_OPEN_TAG</code>、<code>T_LNUMBER</code>、<code>T_WHITESPACE</code>、<code>+</code>、<code>T_LNUMBER</code>、<code>;</code>。</p>
<p>所以，我们的<code>%% %%</code>里面的一些列正则，实际上做的事情就和<code>PHP</code>类似了。它会根据这些正则表达式，对输入的代码（也就是字符串）进行解析，如果匹配到了某条正则，那么就拿到对应的<code>token</code>。</p>
<p>其中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[;(),+*&#x2F;-] &#123;</span><br><span class="line">    return *yytext;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>表示，如果当前输入的是字符是<code>;(),+*/-</code>里面的某一个，那么，我们直接返回这个字符作为它的<code>token</code>。这和我们上面的<code>PHP</code>代码行为一致，<code>PHP</code>没有为它们单独写一个<code>T_*</code>。</p>
<p>接着，我们来写一下我们的<code>zend_language_parser.y</code>文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">extern int yylex(void);</span><br><span class="line">extern int yyparse(void);</span><br><span class="line">extern FILE *yyin;</span><br><span class="line">extern int yylineno;</span><br><span class="line"></span><br><span class="line">int yywrap()</span><br><span class="line">&#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void yyerror(const char *s)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;[error] %s, in %d\n&quot;, s, yylineno);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char const *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    const char *file &#x3D; argv[1];</span><br><span class="line">    FILE *fp &#x3D; fopen(file, &quot;r&quot;);</span><br><span class="line"></span><br><span class="line">    if(fp &#x3D;&#x3D; NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;cannot open %s\n&quot;, file);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    yyin &#x3D; fp;</span><br><span class="line">    yyparse();</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%token T_ECHO T_LNUMBER</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">statement: %empty</span><br><span class="line">|   T_ECHO additive_expr    &#123; printf(&quot;%d\n&quot;, $2); &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">additive_expr: %empty</span><br><span class="line">|   multiplicative_expr                                 &#123;$$ &#x3D; $1;&#125;</span><br><span class="line">|   additive_expr &#39;+&#39; multiplicative_expr                 &#123;$$ &#x3D; $1 + $3;&#125;</span><br><span class="line">|   additive_expr &#39;-&#39; multiplicative_expr                 &#123;$$ &#x3D; $1 - $3;&#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">multiplicative_expr: %empty</span><br><span class="line">|   primary                             &#123;$$ &#x3D; $1;&#125;</span><br><span class="line">|   multiplicative_expr &#39;*&#39; primary   &#123;$$ &#x3D; $1 * $3;&#125;</span><br><span class="line">|   multiplicative_expr &#39;&#x2F;&#39; primary   &#123;$$ &#x3D; $1 &#x2F; $3;&#125;</span><br><span class="line"></span><br><span class="line">primary: %empty</span><br><span class="line">|   T_LNUMBER    &#123;$$ &#x3D; $1;&#125;</span><br><span class="line">|   &#39;(&#39; additive_expr &#39;)&#39;    &#123;$$ &#x3D; $2;&#125;</span><br><span class="line"></span><br><span class="line">%%</span><br></pre></td></tr></table></figure>

<p>我们发现，这个文件的结构和<code>zend_language_scanner.l</code>极其相似。在<code>%&#123; %&#125;</code>中写一点<code>cpp</code>的东西。在<code>%%  %%</code>中写一点语法（只不过<code>zend_language_scanner.l</code>是写一些词法）。我们逐一来看。</p>
<p>首先是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int yywrap()</span><br><span class="line">&#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这在多文件解析的时候会用到。如果返回<code>1</code>，表示我们解析文件完毕。如果返回<code>0</code>，说明我们还有文件需要解析。简单起见，我们先只支持单个文件的解析。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void yyerror(const char *s)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;[error] %s, in %d\n&quot;, s, yylineno);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当语法分析出错的时候，会调用这个函数。其中<code>yylineno</code>表示哪一行解析失败了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char const *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    const char *file &#x3D; argv[1];</span><br><span class="line">    FILE *fp &#x3D; fopen(file, &quot;r&quot;);</span><br><span class="line"></span><br><span class="line">    if(fp &#x3D;&#x3D; NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;cannot open %s\n&quot;, file);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    yyin &#x3D; fp;</span><br><span class="line">    yyparse();</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>表示我们输入一个<code>yaphp</code>文件，然后对这个文件进行解析。<code>yyin</code>里面存了当前要解析的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%token T_ECHO T_LNUMBER</span><br></pre></td></tr></table></figure>

<p>定义了两个<code>token</code>。这是提供给<code>zend_language_scanner.l</code>文件使用的。我们可以在文件<code>zend_language_parser.h</code>里面找到这两个<code>token</code>具体会被生成什么：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Token kinds.  */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> YYTOKENTYPE</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> YYTOKENTYPE</span></span><br><span class="line">  <span class="keyword">enum</span> yytokentype</span><br><span class="line">  &#123;</span><br><span class="line">    YYEMPTY = <span class="number">-2</span>,</span><br><span class="line">    YYEOF = <span class="number">0</span>,                     <span class="comment">/* &quot;end of file&quot;  */</span></span><br><span class="line">    YYerror = <span class="number">256</span>,                 <span class="comment">/* error  */</span></span><br><span class="line">    YYUNDEF = <span class="number">257</span>,                 <span class="comment">/* &quot;invalid token&quot;  */</span></span><br><span class="line">    T_ECHO = <span class="number">258</span>,                  <span class="comment">/* T_ECHO  */</span></span><br><span class="line">    T_LNUMBER = <span class="number">259</span>                <span class="comment">/* T_LNUMBER  */</span></span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">typedef</span> <span class="keyword">enum</span> yytokentype <span class="keyword">yytoken_kind_t</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>可以发现，实际上，我们在文件<code>zend_language_parser.y</code>里面定义的<code>token</code>，最终会被生成一个枚举类型的值。这也很好的解释了为什么我们需要在<code>zend_language_scanner.l</code>里面引入头文件<code>zend_language_parser.h</code>。</p>
<p>接着，就是我们的重点了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">statement: %empty</span><br><span class="line">|   T_ECHO additive_expr    &#123; printf(&quot;%d\n&quot;, $2); &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">additive_expr: %empty</span><br><span class="line">|   multiplicative_expr                                 &#123;$$ &#x3D; $1;&#125;</span><br><span class="line">|   additive_expr &#39;+&#39; multiplicative_expr                 &#123;$$ &#x3D; $1 + $3;&#125;</span><br><span class="line">|   additive_expr &#39;-&#39; multiplicative_expr                 &#123;$$ &#x3D; $1 - $3;&#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">multiplicative_expr: %empty</span><br><span class="line">|   primary                             &#123;$$ &#x3D; $1;&#125;</span><br><span class="line">|   multiplicative_expr &#39;*&#39; primary   &#123;$$ &#x3D; $1 * $3;&#125;</span><br><span class="line">|   multiplicative_expr &#39;&#x2F;&#39; primary   &#123;$$ &#x3D; $1 &#x2F; $3;&#125;</span><br><span class="line"></span><br><span class="line">primary: %empty</span><br><span class="line">|   T_LNUMBER    &#123;$$ &#x3D; $1;&#125;</span><br><span class="line">|   &#39;(&#39; additive_expr &#39;)&#39;    &#123;$$ &#x3D; $2;&#125;</span><br></pre></td></tr></table></figure>

<p>这就是我们算数表达式的语法了。这里，我们实现了优先级。其中括号<code>()</code>的优先级最高，乘法和除法的优先级其次，加法和减法的优先级最低。</p>
<p>那么，这个优先级是如何去实现的呢？我们可以看到，我们的加法表达式语法嵌套了乘法表达式语法；乘法表达式语法嵌套了我们的括号。</p>
<p>所以，我们通过文法的一个嵌套，实现了优先级。最下面的语法，它的优先级最高，最上面的语法，它的优先级最低。（如果对优先级这一块不太清楚的小伙伴，我建议自己去手写一遍优先级，然后就能够理解为什么了。我始终觉得，虽然我们是使用了<code>bison</code>做语法分析，但是，我们一定要具备没有这类工具，也可以去实现这些语法的能力，因为这是基本功）</p>
<p>好的，现在，让我们来运行一下我们的编译脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./rebuild.sh</span><br></pre></td></tr></table></figure>

<p>然后编写测试文件<code>test1.php</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="number">2</span> + <span class="number">2</span> * <span class="number">3</span> / <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>执行我们的<code>yaphp</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./build/yaphp tests/test1.php</span><br><span class="line">5</span><br></pre></td></tr></table></figure>

<p>我们发现，这里先计算了<code>2 * 3 / 2</code>，得到<code>3</code>之后，在进行<code>2 + 3</code>的运算，得到<code>5</code>。</p>
<p>我们再来一个例子：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> (<span class="number">2</span> + <span class="number">2</span>) * <span class="number">3</span> / <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>执行我们的<code>yaphp</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./build/yaphp tests/test1.php</span><br><span class="line">6</span><br></pre></td></tr></table></figure>

<p>我们发现，这里先计算了<code>(2 + 2)</code>得到<code>4</code>之后，在进行<code>4 * 3 / 2</code>的运算，得到<code>6</code>。</p>
<p><code>OK</code>，我们算是实现了优先级。但是，这么去写语法规则是非常的难看的，一点也不优雅。</p>
<p>我们来借助<code>bison</code>的能力，实现一下优先级。我们修改一下我们的语法文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">extern int yylex(void);</span><br><span class="line">extern int yyparse(void);</span><br><span class="line">extern FILE *yyin;</span><br><span class="line">extern int yylineno;</span><br><span class="line"></span><br><span class="line">int yywrap()</span><br><span class="line">&#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void yyerror(const char *s)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;[error] %s, in line %d\n&quot;, s, yylineno);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char const *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    const char *file &#x3D; argv[1];</span><br><span class="line">    FILE *fp &#x3D; fopen(file, &quot;r&quot;);</span><br><span class="line"></span><br><span class="line">    if(fp &#x3D;&#x3D; NULL)</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;cannot open %s\n&quot;, file);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    yyin &#x3D; fp;</span><br><span class="line">    yyparse();</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%token T_ECHO T_LNUMBER</span><br><span class="line"></span><br><span class="line">%left &#39;+&#39; &#39;-&#39;</span><br><span class="line">%left &#39;*&#39; &#39;&#x2F;&#39;</span><br><span class="line">%left &#39;(&#39; &#39;)&#39;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">statement: %empty</span><br><span class="line">|   T_ECHO expr    &#123; printf(&quot;%d\n&quot;, $2); &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">expr: %empty</span><br><span class="line">|   expr &#39;+&#39; expr                 &#123;$$ &#x3D; $1 + $3;&#125;</span><br><span class="line">|   expr &#39;-&#39; expr                 &#123;$$ &#x3D; $1 - $3;&#125;</span><br><span class="line">|   expr &#39;*&#39; expr                 &#123;$$ &#x3D; $1 * $3;&#125;</span><br><span class="line">|   expr &#39;&#x2F;&#39; expr                 &#123;$$ &#x3D; $1 &#x2F; $3;&#125;</span><br><span class="line">|   &#39;(&#39; expr &#39;)&#39;                  &#123;$$ &#x3D; $2;&#125;</span><br><span class="line">|   T_LNUMBER                      &#123;$$ &#x3D; $1;&#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">%%</span><br></pre></td></tr></table></figure>

<p>可以发现，我们这里多了一部分东西：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">%left &#39;+&#39; &#39;-&#39;</span><br><span class="line">%left &#39;*&#39; &#39;&#x2F;&#39;</span><br><span class="line">%left &#39;(&#39; &#39;)&#39;</span><br></pre></td></tr></table></figure>

<p>这实际上就是我们的优先级定义了。自上而下，它的优先级越来越高。我们现在重新编译一下我们的<code>yaphp</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./rebuild.sh</span><br></pre></td></tr></table></figure>

<p>然后执行上面的两个例子，我们就可以得到和我们首先优先级一样的结果了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/09/19/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%AE%9E%E7%8E%B0%E7%AE%97%E6%95%B0%E8%A1%A8%E8%BE%BE%E5%BC%8F/" data-id="ckkj72zta006sf6vx6q231ctm" data-title="《手把手教你编写PHP编译器》--实现算数表达式" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《手把手教你编写PHP编译器》-准备工作" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/09/19/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C/" class="article-date">
  <time class="dt-published" datetime="2020-09-19T08:39:35.000Z" itemprop="datePublished">2020-09-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/09/19/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C/">《手把手教你编写PHP编译器》--准备工作</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><p>在写代码之前，我们很有必要先把编译<code>C++</code>代码的工作做好。主要涉及到以下几个方面：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 编写CMakeLists</span><br><span class="line">2. 编写一个编译的脚本</span><br></pre></td></tr></table></figure>

<h2 id="编写CMakeLists"><a href="#编写CMakeLists" class="headerlink" title="编写CMakeLists"></a>编写CMakeLists</h2><p>因为<code>CMakeLists.txt</code>的内容比较简单，所以我直接贴出我们的<code>CMakeLists.txt</code>文件的内容：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.4</span>)</span><br><span class="line"><span class="keyword">project</span>(yaphp)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_STANDARD <span class="number">11</span>)</span><br><span class="line"><span class="keyword">set</span>(CMAKE_CXX_COMPILER clang++)</span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(FLEX REQUIRED)</span><br><span class="line"><span class="keyword">set</span>(FlexOutput <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/src/Zend/zend_language_scanner.cc)</span><br><span class="line"><span class="keyword">if</span>(FLEX_FOUND)</span><br><span class="line">    <span class="keyword">add_custom_command</span>(</span><br><span class="line">      OUTPUT <span class="variable">$&#123;FlexOutput&#125;</span></span><br><span class="line">      <span class="keyword">COMMAND</span> <span class="variable">$&#123;FLEX_EXECUTABLE&#125;</span></span><br><span class="line">              --outfile=<span class="variable">$&#123;FlexOutput&#125;</span></span><br><span class="line">              <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/src/Zend/zend_language_scanner.l</span><br><span class="line">      COMMENT <span class="string">&quot;Generating zend_language_scanner.cc&quot;</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(BISON REQUIRED)</span><br><span class="line"><span class="keyword">set</span>(BisonOutput <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/src/Zend/zend_language_parser.cc)</span><br><span class="line"><span class="keyword">if</span>(BISON_FOUND)</span><br><span class="line">    <span class="keyword">add_custom_command</span>(</span><br><span class="line">      OUTPUT <span class="variable">$&#123;BisonOutput&#125;</span></span><br><span class="line">      <span class="keyword">COMMAND</span> <span class="variable">$&#123;BISON_EXECUTABLE&#125;</span></span><br><span class="line">              --defines=<span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/src/Zend/zend_language_parser.h</span><br><span class="line">              --output=<span class="variable">$&#123;BisonOutput&#125;</span></span><br><span class="line">              <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/src/Zend/zend_language_parser.y</span><br><span class="line">      COMMENT <span class="string">&quot;Generating zend_language_parser.cc&quot;</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_executable</span>(yaphp</span><br><span class="line">    <span class="variable">$&#123;FlexOutput&#125;</span></span><br><span class="line">    <span class="variable">$&#123;BisonOutput&#125;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">include_directories</span>(BEFORE <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span>)</span><br><span class="line"><span class="keyword">target_compile_options</span>(yaphp PUBLIC <span class="variable">$&#123;CMAKE_CXX_FLAGS&#125;</span> -Wall -Wno-deprecated-register -O0 -g)</span><br><span class="line"></span><br><span class="line"><span class="keyword">message</span>(STATUS <span class="string">&quot;summary of build options:</span></span><br><span class="line"><span class="string">    Install prefix:  $&#123;CMAKE_INSTALL_PREFIX&#125;</span></span><br><span class="line"><span class="string">    Target system:   $&#123;CMAKE_SYSTEM_NAME&#125;</span></span><br><span class="line"><span class="string">    Compiler:</span></span><br><span class="line"><span class="string">      CXX compiler:    $&#123;CMAKE_CXX_COMPILER&#125;</span></span><br><span class="line"><span class="string">&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>我们来讲一下核心的东西，其他不清楚的地方，可以网上搜一下。</p>
<p>首先来看这段代码：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">project</span>(yaphp)</span><br></pre></td></tr></table></figure>

<p>我们把我们的这个项目叫做<code>yaphp</code>，即表示<code>Yet another php</code>。</p>
<p>然后是这段代码：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(FLEX REQUIRED)</span><br><span class="line"><span class="keyword">set</span>(FlexOutput <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/src/Zend/zend_language_scanner.cc)</span><br><span class="line"><span class="keyword">if</span>(FLEX_FOUND)</span><br><span class="line">    <span class="keyword">add_custom_command</span>(</span><br><span class="line">      OUTPUT <span class="variable">$&#123;FlexOutput&#125;</span></span><br><span class="line">      <span class="keyword">COMMAND</span> <span class="variable">$&#123;FLEX_EXECUTABLE&#125;</span></span><br><span class="line">              --outfile=<span class="variable">$&#123;FlexOutput&#125;</span></span><br><span class="line">              <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/src/Zend/zend_language_scanner.l</span><br><span class="line">      COMMENT <span class="string">&quot;Generating zend_language_scanner.cc&quot;</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>

<p>这段代码做的事情是，通过<code>flex</code>，让<code>zend_language_scanner.l</code>文件生成<code>zend_language_scanner.cc</code>文件（如果不清楚<code>zend_language_scanner.l</code>的小伙伴不用着急，我们后面会讲）。并且，我们可以看到，我们把<code>zend_language_scanner.l</code>文件放在了<code>Zend</code>目录下，这实际上是和<code>php-src</code>（即<code>php</code>解释器）的一致的。</p>
<p>然后是这段代码：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_package</span>(BISON REQUIRED)</span><br><span class="line"><span class="keyword">set</span>(BisonOutput <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/src/Zend/zend_language_parser.cc)</span><br><span class="line"><span class="keyword">if</span>(BISON_FOUND)</span><br><span class="line">    <span class="keyword">add_custom_command</span>(</span><br><span class="line">      OUTPUT <span class="variable">$&#123;BisonOutput&#125;</span></span><br><span class="line">      <span class="keyword">COMMAND</span> <span class="variable">$&#123;BISON_EXECUTABLE&#125;</span></span><br><span class="line">              --defines=<span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/src/Zend/zend_language_parser.h</span><br><span class="line">              --output=<span class="variable">$&#123;BisonOutput&#125;</span></span><br><span class="line">              <span class="variable">$&#123;CMAKE_SOURCE_DIR&#125;</span>/src/Zend/zend_language_parser.y</span><br><span class="line">      COMMENT <span class="string">&quot;Generating zend_language_parser.cc&quot;</span></span><br><span class="line">    )</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>

<p>这段代码做的事情是，通过<code>bison</code>，让<code>zend_language_parser.y</code>文件生成<code>zend_language_parser.cc</code>文件和<code>zend_language_parser.h</code>文件（如果不清楚<code>zend_language_parser.y</code>的小伙伴不用着急，我们后面会讲）。</p>
<p>然后是这段代码：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_executable</span>(yaphp</span><br><span class="line">    <span class="variable">$&#123;FlexOutput&#125;</span></span><br><span class="line">    <span class="variable">$&#123;BisonOutput&#125;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>表示，我们要把<code>$&#123;FlexOutput&#125;</code>和<code>$&#123;BisonOutput&#125;</code>编译成<code>yaphp</code>可执行文件。</p>
<p><code>OK</code>，按照这个<code>CMakeLists.txt</code>的意思，我们来创建对应的文件。首先是文件<code>src/Zend/zend_language_scanner.l</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">%option noyywrap</span><br><span class="line">%option nounput</span><br><span class="line">%option noinput</span><br><span class="line">%&#123;</span><br><span class="line">#include &quot;zend_language_parser.h&quot;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line">echo &#123;</span><br><span class="line">    return T_ECHO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[;(),+*&#x2F;-] return *yytext;</span><br><span class="line"></span><br><span class="line">[0-9]+ &#123;</span><br><span class="line">    yylval &#x3D; atoi(yytext);</span><br><span class="line">    return T_NUMBER;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[\t\n ]+  &#x2F;* ignore \t, \n, whitespace *&#x2F;</span><br><span class="line"></span><br><span class="line">%%</span><br></pre></td></tr></table></figure>

<p>然后是文件<code>src/Zend/zend_language_parser.y</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line"></span><br><span class="line">extern int yylex(void);</span><br><span class="line">extern int yyparse(void);</span><br><span class="line">extern FILE *yyin;</span><br><span class="line">extern int yylineno;</span><br><span class="line"></span><br><span class="line">int yywrap()</span><br><span class="line">&#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void yyerror(const char *s)</span><br><span class="line">&#123;</span><br><span class="line">    printf(&quot;[error] %s, in line %d\n&quot;, s, yylineno);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, char const *argv[])</span><br><span class="line">&#123;</span><br><span class="line">    const char *file &#x3D; argv[1];</span><br><span class="line">    FILE *fp &#x3D; fopen(file, &quot;r&quot;);</span><br><span class="line"></span><br><span class="line">    if(fp &#x3D;&#x3D; nullptr)</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;cannot open %s\n&quot;, file);</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    yyin &#x3D; fp;</span><br><span class="line">    yyparse();</span><br><span class="line"></span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%token T_ECHO T_NUMBER</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">statement: %empty</span><br><span class="line">|   T_ECHO expr    &#123; printf(&quot;%d\n&quot;, $2); &#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">expr: %empty</span><br><span class="line">|   T_NUMBER                      &#123;$$ &#x3D; $1;&#125;</span><br><span class="line">;</span><br><span class="line"></span><br><span class="line">%%</span><br></pre></td></tr></table></figure>

<p>然后，我们创建文件<code>tests/test1.php</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="编写编译的脚本"><a href="#编写编译的脚本" class="headerlink" title="编写编译的脚本"></a>编写编译的脚本</h2><p>我们创建文件<code>rebuild.sh</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">__DIR__=$(<span class="built_in">cd</span> <span class="string">&quot;<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)</span>&quot;</span> || <span class="built_in">exit</span> 1; <span class="built_in">pwd</span>); [ -z <span class="string">&quot;<span class="variable">$&#123;__DIR__&#125;</span>&quot;</span> ] &amp;&amp; <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$&#123;__DIR__&#125;</span>&quot;</span> &amp;&amp; ./clean.sh &amp;&amp; mkdir -p build &amp;&amp; <span class="built_in">cd</span> build &amp;&amp; cmake .. &amp;&amp; make</span><br></pre></td></tr></table></figure>

<p>这段代码很简单，就是先调用<code>clean.sh</code>脚本做一些清理工作，然后调用<code>cmake</code>来生成<code>Makefile</code>，然后调用<code>make</code>来编译代码，生成<code>yaphp</code>。</p>
<p>然后创建文件<code>tools/cleaner.sh</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">__DIR__=$(<span class="built_in">cd</span> <span class="string">&quot;<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)</span>&quot;</span> || <span class="built_in">exit</span> 1; <span class="built_in">pwd</span>); [ -z <span class="string">&quot;<span class="variable">$&#123;__DIR__&#125;</span>&quot;</span> ] &amp;&amp; <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">error</span></span>()&#123; <span class="built_in">echo</span> <span class="string">&quot;[ERROR] <span class="variable">$1</span>&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"><span class="function"><span class="title">success</span></span>()&#123; <span class="built_in">echo</span> <span class="string">&quot;[SUCCESS] <span class="variable">$1</span>&quot;</span>; <span class="built_in">exit</span> 0; &#125;</span><br><span class="line"><span class="function"><span class="title">info</span></span>()&#123; <span class="built_in">echo</span> <span class="string">&quot;[INFO] <span class="variable">$1</span>&quot;</span>;&#125;</span><br><span class="line"></span><br><span class="line">workdir=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$&#123;workdir&#125;</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">  error <span class="string">&quot;Cd to <span class="variable">$&#123;workdir&#125;</span> failed&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">info <span class="string">&quot;Scanning dir \&quot;<span class="variable">$&#123;workdir&#125;</span>\&quot; ...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;./Makefile&quot;</span> ] &amp;&amp; [ ! -f <span class="string">&quot;./CMakeLists.txt&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  error <span class="string">&quot;Non-project dir <span class="variable">$&#123;workdir&#125;</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">info <span class="string">&quot;CMake build dir will be removed:&quot;</span></span><br><span class="line"></span><br><span class="line">rm -rf -v ./build</span><br><span class="line"></span><br><span class="line">info <span class="string">&quot;Following files will be removed:&quot;</span></span><br><span class="line"></span><br><span class="line">find <span class="variable">$&#123;workdir&#125;</span>/src/Zend -name zend_language_scanner.cc -print0 | xargs -0 rm -f -v</span><br><span class="line">find <span class="variable">$&#123;workdir&#125;</span>/src/Zend -name zend_language_parser.h -print0 | xargs -0 rm -f -v</span><br><span class="line">find <span class="variable">$&#123;workdir&#125;</span>/src/Zend -name zend_language_parser.cc -print0 | xargs -0 rm -f -v</span><br><span class="line"></span><br><span class="line">success <span class="string">&quot;Clean &#x27;<span class="variable">$&#123;workdir&#125;</span>&#x27; done&quot;</span></span><br></pre></td></tr></table></figure>

<p>这个脚本会清理掉<code>cmake</code>生成的一系列文件。</p>
<p>然后创建文件<code>clean.sh</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">__DIR__=$(<span class="built_in">cd</span> <span class="string">&quot;<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$0</span>&quot;</span>)</span>&quot;</span> || <span class="built_in">exit</span> 1; <span class="built_in">pwd</span>); [ -z <span class="string">&quot;<span class="variable">$&#123;__DIR__&#125;</span>&quot;</span> ] &amp;&amp; <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;<span class="variable">$&#123;__DIR__&#125;</span>&quot;</span>/tools/cleaner.sh <span class="string">&quot;<span class="variable">$&#123;__DIR__&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<p><code>OK</code>，现在，所以的事情都做好了，我们只需要执行脚本<code>rebuild.sh</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">./rebuild.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 省略其他的输出</span></span><br><span class="line">[100%] Linking CXX executable yaphp</span><br><span class="line">[100%] Built target yaphp</span><br></pre></td></tr></table></figure>

<p>现在，你将会在目录<code>build</code>下面看到编译好的<code>yaphp</code>。并且，细心的话，你会发现，在目录<code>src/Zend</code>下面，生成了文件<code>zend_language_scanner.cc</code>、<code>zend_language_parser.h</code>、<code>zend_language_parser.cc</code>。</p>
<p>现在，让我们执行这个<code>yaphp</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./build/yaphp tests/test1.php</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>我们将会看到，<code>1</code>被打印了出来。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/09/19/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C/" data-id="ckkj72zt9006nf6vx35hphm3r" data-title="《手把手教你编写PHP编译器》--准备工作" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Linux下Mutex的所有者线程先死亡造成其他线程获取锁阻塞的问题" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/09/16/Linux%E4%B8%8BMutex%E7%9A%84%E6%89%80%E6%9C%89%E8%80%85%E7%BA%BF%E7%A8%8B%E5%85%88%E6%AD%BB%E4%BA%A1%E9%80%A0%E6%88%90%E5%85%B6%E4%BB%96%E7%BA%BF%E7%A8%8B%E8%8E%B7%E5%8F%96%E9%94%81%E9%98%BB%E5%A1%9E%E7%9A%84%E9%97%AE%E9%A2%98/" class="article-date">
  <time class="dt-published" datetime="2020-09-16T10:48:38.000Z" itemprop="datePublished">2020-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/09/16/Linux%E4%B8%8BMutex%E7%9A%84%E6%89%80%E6%9C%89%E8%80%85%E7%BA%BF%E7%A8%8B%E5%85%88%E6%AD%BB%E4%BA%A1%E9%80%A0%E6%88%90%E5%85%B6%E4%BB%96%E7%BA%BF%E7%A8%8B%E8%8E%B7%E5%8F%96%E9%94%81%E9%98%BB%E5%A1%9E%E7%9A%84%E9%97%AE%E9%A2%98/">Linux下Mutex的所有者线程先死亡造成其他线程获取锁阻塞的问题</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><code>Swoole</code>最近有一个<code>BUG</code>，大概就是<code>Mutex</code>的所有者线程先死亡，造成其他线程获取锁阻塞的问题。具体的<a target="_blank" rel="noopener" href="https://github.com/swoole/swoole-src/issues/3644"><code>iseue</code>在这里</a>。</p>
<p>我们可以用如下代码来对这个问题进行复现：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_mutex_t</span> mutex;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">handler</span><span class="params">(<span class="keyword">void</span> *)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;child thread&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">int</span> ret = pthread_mutex_lock(&amp;mutex);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;child ret: &quot;</span> &lt;&lt; ret &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> tid;</span><br><span class="line">    <span class="keyword">pthread_mutexattr_t</span> attr;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    pthread_mutexattr_init(&amp;attr);</span><br><span class="line">    pthread_mutexattr_settype(&amp;attr, PTHREAD_MUTEX_ERRORCHECK);</span><br><span class="line"></span><br><span class="line">    pthread_mutex_init(&amp;mutex, &amp;attr);</span><br><span class="line">    pthread_mutexattr_destroy(&amp;attr);</span><br><span class="line"></span><br><span class="line">    pthread_create(&amp;tid, <span class="literal">NULL</span>, handler, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;father awake&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    ret = pthread_mutex_lock(&amp;mutex);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;father ret: &quot;</span> &lt;&lt; ret &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这段代码的意思是，主线程创建了子线程之后，立马调用<code>sleep</code>阻塞住。然后子线程去获取锁，然后子线程立马退出，导致锁没有被解开。然后当主线程<code>sleep</code>结束后，尝试获取锁的时候，就会阻塞住。（导致这个现象的原因是，子线程退出后，操作系统并不会把锁解开）</p>
<p>我们可以执行下上面这段代码，执行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">g++ lock.cc -lpthread</span><br><span class="line">./a.out</span><br><span class="line"></span><br><span class="line">child thread</span><br><span class="line">child ret: 0</span><br><span class="line">father awake</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>解决方式如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_mutex_t</span> lock;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">dropped_thread</span><span class="params">(<span class="keyword">void</span>*)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Setting lock...&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    pthread_mutex_lock(&amp;lock);</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Lock set, now exiting without unlocking...&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    pthread_exit(<span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">pthread_t</span> lock_getter;</span><br><span class="line">    <span class="keyword">pthread_mutexattr_t</span> attr;</span><br><span class="line"></span><br><span class="line">    pthread_mutexattr_init(&amp;attr);</span><br><span class="line">    pthread_mutexattr_setrobust(&amp;attr, PTHREAD_MUTEX_ROBUST);</span><br><span class="line">    pthread_mutex_init(&amp;lock, &amp;attr);</span><br><span class="line">    pthread_mutexattr_destroy(&amp;attr);</span><br><span class="line">    pthread_create(&amp;lock_getter, <span class="literal">NULL</span>, dropped_thread, <span class="literal">NULL</span>);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Inside main&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Attempting to acquire mutex?&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">    ret = pthread_mutex_lock(&amp;lock);</span><br><span class="line">    <span class="keyword">if</span> (ret == EOWNERDEAD) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;errno: &quot;</span> &lt;&lt; ret &lt;&lt; <span class="string">&quot;, error: &quot;</span> &lt;&lt; strerror(ret) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;consistent mutex&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        pthread_mutex_consistent(&amp;lock);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;unlock mutex&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        pthread_mutex_unlock(&amp;lock);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;errno: &quot;</span> &lt;&lt; ret &lt;&lt; <span class="string">&quot;, error: &quot;</span> &lt;&lt; strerror(ret) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Attempting to acquire mutex?&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    ret = pthread_mutex_lock(&amp;lock);</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;errno: &quot;</span> &lt;&lt; ret &lt;&lt; <span class="string">&quot;, error: &quot;</span> &lt;&lt; strerror(ret) &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">&quot;Successfully acquired lock!&quot;</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        pthread_mutex_destroy(&amp;lock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">g++ lock.cc -lpthread</span><br><span class="line">./a.out</span><br><span class="line"></span><br><span class="line">Setting lock...</span><br><span class="line">Lock <span class="built_in">set</span>, now exiting without unlocking...</span><br><span class="line">Inside main</span><br><span class="line">Attempting to acquire mutex?</span><br><span class="line">errno: 130, error: Owner died</span><br><span class="line">consistent mutex</span><br><span class="line">unlock mutex</span><br><span class="line">Attempting to acquire mutex?</span><br><span class="line">Successfully acquired lock!</span><br></pre></td></tr></table></figure>

<p>这里的核心是，我们对这个锁设置了<code>PTHREAD_MUTEX_ROBUST</code>。这样的话，锁的拥有者退出后，其他线程去获取锁的时候，就不会阻塞住了，而是返回错误码<code>EOWNERDEAD</code>。并且，这里还有一个细节就是，在获得了错误码之后，我们需要设置锁的状态为<code>consistent</code>。这样，其他线程就能解开锁了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/09/16/Linux%E4%B8%8BMutex%E7%9A%84%E6%89%80%E6%9C%89%E8%80%85%E7%BA%BF%E7%A8%8B%E5%85%88%E6%AD%BB%E4%BA%A1%E9%80%A0%E6%88%90%E5%85%B6%E4%BB%96%E7%BA%BF%E7%A8%8B%E8%8E%B7%E5%8F%96%E9%94%81%E9%98%BB%E5%A1%9E%E7%9A%84%E9%97%AE%E9%A2%98/" data-id="ckkj72zqt000vf6vx9axh96tq" data-title="Linux下Mutex的所有者线程先死亡造成其他线程获取锁阻塞的问题" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%94%81/" rel="tag">锁</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《手把手教你编写PHP编译器》-开篇" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/09/16/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%BC%80%E7%AF%87/" class="article-date">
  <time class="dt-published" datetime="2020-09-15T22:24:18.000Z" itemprop="datePublished">2020-09-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/09/16/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%BC%80%E7%AF%87/">《手把手教你编写PHP编译器》--开篇</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>从今天开始，我打算写一个全新的教程，手把手去实现一个五脏俱全的<code>PHP</code>，教程风格类似于去年我写的手把手编写<code>PHP</code>协程扩展那样，但是会有一点不同，这个教程可能就不会那么直接上那么多代码了，重点是讲解实现的思路。</p>
<p>这个编译器语法会尽可能的和<code>PHP</code>保持一致。并且我希望它是一门静态强类型的语言，你可以在定义一个变量的时候，不声明类型，但是我们会进行类型推导。</p>
<p>教程的知识点我希望和龙书的尽可能吻合，但是也不会和它完全一样，毕竟这本书前面有太多讲解编译器前端的东西了，很多手写解析源代码的，这有一些算法，一旦拿出来讲，估计会起到劝退的效果。这门教程我希望更多的是讲解编译器的后端优化，这一点也和大多数的<code>PHP</code>源码分析教程不同，目前来看，因为<code>PHP</code>的原因，编译器后端的优化除了<code>JIT</code>似乎就没了，而且大多数是去讲解<code>AST</code>生成的。</p>
<p>至于后端的优化，会讲解原理，但是，真正的去实现的时候，我们不会自己去手写，这太费劲了，我们直接使用<code>LLVM</code>，然后开优化，读<code>IR</code>，来验证优化的思路。所以，这门教程，会讲解<code>LLVM</code>的中间表示。但是我们不会去手写<code>LLVM</code>的<code>IR</code>，而是使用<code>LLVM</code>的<code>API</code>来自动生成中间表示。</p>
<p>这门教程是使用<code>C++</code>来开发的，构建工具是<code>CMake</code>，编译器前端工具是<code>flex</code>和<code>bison</code>，编译器后端工具是<code>LLVM</code>。</p>
<p>之前我打算使用<code>PHP</code>来写这门教程。试坑之后，我发现有以下几点问题：</p>
<p>1、如果直接使用<code>PHP-Parser</code>来生成<code>AST</code>，那么我们实现的语法就会受很大的限制了</p>
<p>2、<code>PHP</code>对<code>LLVM</code>的绑定没有看到比较好的。我有想过去写扩展对<code>LLVM</code>包一层，但是这工作量太大了。也想过用FFI来直接搞，但是怕PHP的FFI有问题。所以就干脆直接用C++来完成我们的这门教程了。</p>
<p>我不是一个专门研究编译器的人，这个教程主要是对自己的一个阶段性学习的总结。就和<code>PHP</code>协程扩展开发教程一样，边写边学习，算是对自己这一年的一个总结吧。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/09/16/%E3%80%8A%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E7%BC%96%E5%86%99PHP%E7%BC%96%E8%AF%91%E5%99%A8%E3%80%8B-%E5%BC%80%E7%AF%87/" data-id="ckkj72ztb006uf6vx10wn348n" data-title="《手把手教你编写PHP编译器》--开篇" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-CPU占用过高分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/09/07/CPU%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2020-09-07T10:42:17.000Z" itemprop="datePublished">2020-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/09/07/CPU%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E5%88%86%E6%9E%90/">CPU占用过高分析</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>今天遇到了一个<code>hyperf</code>死循环的<code>bug</code>，排查了很久，没有思路。后来峰哥指导，立马定位出了问题。</p>
<p>定位步骤，首先，通过<code>perf top</code>命令来查看系统的<code>cpu</code>占用情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">perf top -p 19732</span><br><span class="line"></span><br><span class="line">Samples: 16K of event <span class="string">&#x27;cpu-clock&#x27;</span>, 4000 Hz, Event count (approx.): 3364648111 lost: 0/0 drop: 0/0</span><br><span class="line">Overhead  Shared Object        Symbol</span><br><span class="line">   9.02%  [kernel]             [k] _raw_spin_unlock_irqrestore</span><br><span class="line">   7.96%  php                  [.] execute_ex</span><br><span class="line">   6.85%  [kernel]             [k] finish_task_switch</span><br><span class="line">   2.82%  php                  [.] ZEND_FETCH_OBJ_R_SPEC_UNUSED_CONST_HANDLER</span><br><span class="line">   2.05%  libpthread-2.17.so   [.] __libc_recv</span><br><span class="line">   1.93%  php                  [.] ZEND_INIT_METHOD_CALL_SPEC_UNUSED_CONST_HANDLER</span><br><span class="line">   1.55%  libc-2.17.so         [.] __memmove_ssse3_back</span><br><span class="line">   1.43%  [vdso]               [.] __vdso_gettimeofday</span><br><span class="line">   1.35%  libc-2.17.so         [.] __memcpy_ssse3_back</span><br><span class="line">   1.31%  php                  [.] zend_leave_helper_SPEC</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>execute_ex</code>这个函数的<code>Overhead</code>非常的高。所以，可以大改猜测是<code>PHP</code>代码的问题。然后，我们找到<code>PHP</code>的进程，用<code>strace</code>看一下进程在做啥事情：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">strace -p 19732</span><br><span class="line"></span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br><span class="line">recvfrom(20, <span class="string">&quot;-&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;-MISCONF Redis is configured to save RDB snapshots, but it is currently not able to persist on disk. Commandsthat may modify the data set are disabled, because this instance is configured to report errors during writes if RDB snapshotting fails (stop-writes-on-bgsave-error option). Please check the Redis logs for details about the RDB error.\r\n&quot;</span>, 8192, 0, NULL, NULL) = 346</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$13</span>\r\nqueue:delayed\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 101, 0, NULL, 0) = 101</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*7\r\n<span class="variable">$16</span>\r\nZREVRANGEBYSCORE\r\n<span class="variable">$14</span>\r\nqueue:reserved\r\n<span class="variable">$10</span>\r\n1599474415\r\n<span class="variable">$4</span>\r\n-inf\r\n<span class="variable">$5</span>\r\nLIMIT\r\n<span class="variable">$1</span>\r\n0\r\n<span class="variable">$3</span>\r\n100\r\n&quot;</span>, 102, 0, NULL, 0) = 102</span><br><span class="line">recvfrom(20, <span class="string">&quot;*&quot;</span>, 1, MSG_PEEK, NULL, NULL) = 1</span><br><span class="line">recvfrom(20, <span class="string">&quot;*0\r\n&quot;</span>, 8192, 0, NULL, NULL) = 4</span><br><span class="line">recvfrom(20, 0x7f08526509e0, 1, MSG_PEEK, NULL, NULL) = -1 EAGAIN (Resource temporarily unavailable)</span><br><span class="line">sendto(20, <span class="string">&quot;*3\r\n<span class="variable">$5</span>\r\nBRPOP\r\n<span class="variable">$13</span>\r\nqueue:waiting\r\n<span class="variable">$1</span>\r\n2\r\n&quot;</span>, 42, 0, NULL, 0) = 42</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>hyperf</code>应该是没有去判断<code>redis</code>是否崩溃，即使<code>redis</code>崩溃了，也在一直循环的读取<code>redis</code>。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/09/07/CPU%E5%8D%A0%E7%94%A8%E8%BF%87%E9%AB%98%E5%88%86%E6%9E%90/" data-id="ckkj72zqm000gf6vx4ho55xj6" data-title="CPU占用过高分析" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" rel="tag">性能分析</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-面向对象的语义特征" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/09/07/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E8%AF%AD%E4%B9%89%E7%89%B9%E5%BE%81/" class="article-date">
  <time class="dt-published" datetime="2020-09-06T16:54:05.000Z" itemprop="datePublished">2020-09-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/09/07/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E8%AF%AD%E4%B9%89%E7%89%B9%E5%BE%81/">面向对象的语义特征</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>我们知道，编程语言是用来对这个世界建模的，而面向对象则是建模方式中比较推崇的一种方法。我们来说一说面向对象的语义特征，进而让我们理解编程语言的本质。</p>
</blockquote>
<h2 id="类型角度"><a href="#类型角度" class="headerlink" title="类型角度"></a>类型角度</h2><p>在汇编语言里面，是只支持简单类型的，例如整型。如果我们要实现稍微复杂一点的类型，例如字符串，那么，我们就需要一块内存，然后往这块内存里面挨个的放入字符，然后，我们把这块内存存储的内容，叫做字符串。同样的道理，类也是一种复杂的类型。</p>
<h2 id="作用域角度"><a href="#作用域角度" class="headerlink" title="作用域角度"></a>作用域角度</h2><p>分为类的作用域和对象成员的作用域。</p>
<p>对于类来说，如果没有声明命名空间，那么，类的作用域就是根命名空间；如果有命名空间，那么类的作用域就是这个命名空间。</p>
<p>对于对象成员来说，成员的作用域则是这个对象。我们是通过这个对象来找到这个成员的（当然，如果你是静态成员，那么，也可以通过类来找到）。</p>
<p>所以，<strong>我们在实现面向对象的时候，必定会把这个对象放入栈帧里面</strong>，例如<code>PHP</code>里面的<code>execute_data::This</code>。而我们在方法里面使用的<code>$this</code>，实际上就是当前栈帧的<code>execute_data::This</code>。例如：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $a;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $b;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">$a, $b</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a = $a;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;b = $b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在构造函数里面，通过<code>$this</code>来访问成员<code>a</code>。那么，我们就是在构造函数的这个栈帧里面，找到<code>$this</code>变量，然后，再查找这个对象的<code>a</code>属性。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/09/07/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%9A%84%E8%AF%AD%E4%B9%89%E7%89%B9%E5%BE%81/" data-id="ckkj72zva00crf6vxfmb8f8td" data-title="面向对象的语义特征" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-使用Visitor模式来解析抽象语法树" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/30/%E4%BD%BF%E7%94%A8Visitor%E6%A8%A1%E5%BC%8F%E6%9D%A5%E8%A7%A3%E6%9E%90%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91/" class="article-date">
  <time class="dt-published" datetime="2020-08-30T09:19:47.000Z" itemprop="datePublished">2020-08-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/30/%E4%BD%BF%E7%94%A8Visitor%E6%A8%A1%E5%BC%8F%E6%9D%A5%E8%A7%A3%E6%9E%90%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91/">使用Visitor模式来解析抽象语法树</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>我们在生成了<code>AST</code>之后，要做的事情就是去解析它。我们可以对它做很多的操作，比如修改<code>AST</code>的某些节点；对<code>AST</code>执行我们的语义操作，比如碰到<code>+</code>号，表示我们要做加法运算了，这样，我们就可以实现我们自己的语言了。</p>
<p>而<code>visitor</code>模式的思想就是，当我们遍历<code>AST</code>上的每一个节点的时候，都去执行我们注册的所有<code>visitor</code>。这样，我们可以让代码更加的优雅，我们只需要专注于实现当前<code>visitor</code>的功能即可，让<code>AST</code>的结构和对<code>AST</code>的操作解耦。</p>
<p>我以<code>PHP</code>为例，大致介绍下如何通过<code>visitor</code>模式来用<code>PHP</code>实现<code>PHP</code>。我们给我们的这门语言命名为<code>yaphp</code>（实际上，这正是我现在开发的语言，还未开源）。</p>
<p>我们有如下<code>yaphp</code>的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$a = <span class="number">1</span> + <span class="number">2</span> + <span class="number">3</span> - <span class="number">4</span>;</span><br><span class="line">$b = <span class="number">2</span> * <span class="number">3</span>;</span><br><span class="line">$c = $a + $b;</span><br><span class="line">var_dump($c);</span><br></pre></td></tr></table></figure>

<p>我们可以得到它的抽象语法树：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">array</span>(</span><br><span class="line">    <span class="number">0</span>: Stmt_Expression(</span><br><span class="line">        expr: Expr_Assign(</span><br><span class="line">            <span class="keyword">var</span>: Expr_Variable(</span><br><span class="line">                name: a</span><br><span class="line">            )</span><br><span class="line">            expr: Expr_BinaryOp_Minus(</span><br><span class="line">                left: Expr_BinaryOp_Plus(</span><br><span class="line">                    left: Expr_BinaryOp_Plus(</span><br><span class="line">                        left: Scalar_LNumber(</span><br><span class="line">                            value: <span class="number">1</span></span><br><span class="line">                        )</span><br><span class="line">                        right: Scalar_LNumber(</span><br><span class="line">                            value: <span class="number">2</span></span><br><span class="line">                        )</span><br><span class="line">                    )</span><br><span class="line">                    right: Scalar_LNumber(</span><br><span class="line">                        value: <span class="number">3</span></span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">                right: Scalar_LNumber(</span><br><span class="line">                    value: <span class="number">4</span></span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">    <span class="number">1</span>: Stmt_Expression(</span><br><span class="line">        expr: Expr_Assign(</span><br><span class="line">            <span class="keyword">var</span>: Expr_Variable(</span><br><span class="line">                name: b</span><br><span class="line">            )</span><br><span class="line">            expr: Expr_BinaryOp_Mul(</span><br><span class="line">                left: Scalar_LNumber(</span><br><span class="line">                    value: <span class="number">2</span></span><br><span class="line">                )</span><br><span class="line">                right: Scalar_LNumber(</span><br><span class="line">                    value: <span class="number">3</span></span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">    <span class="number">2</span>: Stmt_Expression(</span><br><span class="line">        expr: Expr_Assign(</span><br><span class="line">            <span class="keyword">var</span>: Expr_Variable(</span><br><span class="line">                name: c</span><br><span class="line">            )</span><br><span class="line">            expr: Expr_BinaryOp_Plus(</span><br><span class="line">                left: Expr_Variable(</span><br><span class="line">                    name: a</span><br><span class="line">                )</span><br><span class="line">                right: Expr_Variable(</span><br><span class="line">                    name: b</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">    <span class="number">3</span>: Stmt_Expression(</span><br><span class="line">        expr: Expr_FuncCall(</span><br><span class="line">            name: Name(</span><br><span class="line">                parts: <span class="keyword">array</span>(</span><br><span class="line">                    <span class="number">0</span>: var_dump</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            args: <span class="keyword">array</span>(</span><br><span class="line">                <span class="number">0</span>: Arg(</span><br><span class="line">                    name: <span class="literal">null</span></span><br><span class="line">                    value: Expr_Variable(</span><br><span class="line">                        name: c</span><br><span class="line">                    )</span><br><span class="line">                    byRef: <span class="literal">false</span></span><br><span class="line">                    unpack: <span class="literal">false</span></span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这个抽象语法树还是比较简单的。我们大致可以看到，有<code>4</code>条表达式语句。我们逐个来看。</p>
<p>第一条表达式语句：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">0: Stmt_Expression(</span><br><span class="line">    expr: Expr_Assign(</span><br><span class="line">        var: Expr_Variable(</span><br><span class="line">            name: a</span><br><span class="line">        )</span><br><span class="line">        expr: Expr_BinaryOp_Minus(</span><br><span class="line">            left: Expr_BinaryOp_Plus(</span><br><span class="line">                left: Expr_BinaryOp_Plus(</span><br><span class="line">                    left: Scalar_LNumber(</span><br><span class="line">                        value: 1</span><br><span class="line">                    )</span><br><span class="line">                    right: Scalar_LNumber(</span><br><span class="line">                        value: 2</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">                right: Scalar_LNumber(</span><br><span class="line">                    value: 3</span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            right: Scalar_LNumber(</span><br><span class="line">                value: 4</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这是一个赋值语句，我们通过这个结构得出，这个<code>AST</code>是右结合的。也就意味着，我们的赋值语句是右结合的。<code>Expr_Assign</code>它的左子树是一个变量的名字，<code>Expr_Assign</code>它的右子树是一个算数表达式。通过这个算数表达式的<code>AST</code>结构，我们可以看成，它是左结合的。</p>
<p><code>OK</code>，我们可以根据这些节点的类型，写出对应的<code>visitor</code>。</p>
<p>首先是<code>AdditiveExpressionVisitor</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This file is part of Yaphp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@contact</span>  codinghuang<span class="doctag">@qq</span>.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Yaphp</span>\<span class="title">NodeVisitor</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">BinaryOp</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">BinaryOp</span>\<span class="title">Minus</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">BinaryOp</span>\<span class="title">Plus</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">Variable</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Scalar</span>\<span class="title">LNumber</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeVisitorAbstract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Yaphp</span>\<span class="title">HandWritten</span>\<span class="title">CompilerGlobals</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdditiveExpressionVisitor</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">enterNode</span>(<span class="params">Node $node</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! ($node <span class="keyword">instanceof</span> Plus) &amp;&amp; ! ($node <span class="keyword">instanceof</span> Minus)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (get_class($node)) &#123;</span><br><span class="line">            <span class="keyword">case</span> Plus::class:</span><br><span class="line">            <span class="keyword">case</span> Minus::class:</span><br><span class="line">                $result = <span class="keyword">$this</span>-&gt;additiveExpression($node);</span><br><span class="line">                $resultNode = <span class="keyword">new</span> Node\Scalar\LNumber($result);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $resultNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">additiveExpression</span>(<span class="params">Expr $expr</span>): <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($expr-&gt;left)) &#123;</span><br><span class="line">            $leftValue = <span class="keyword">$this</span>-&gt;additiveExpression($expr-&gt;left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($expr-&gt;right)) &#123;</span><br><span class="line">            $rightValue = <span class="keyword">$this</span>-&gt;additiveExpression($expr-&gt;right);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (get_class($expr)) &#123;</span><br><span class="line">            <span class="keyword">case</span> Plus::class:</span><br><span class="line">                <span class="keyword">return</span> $leftValue + $rightValue;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Minus::class:</span><br><span class="line">                <span class="keyword">return</span> $leftValue - $rightValue;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Variable::class:</span><br><span class="line">                <span class="keyword">return</span> CompilerGlobals::getSymbol($expr-&gt;name);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> LNumber::class:</span><br><span class="line">                <span class="keyword">return</span> $expr-&gt;value;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">echo</span> sprintf(<span class="string">&quot;Don&#x27;t support expression %s&quot;</span>, $expr-&gt;getType());</span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $leftValue + $rightValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为，加法和减法我们认为是同一类操作，所以，我们可以把加法和减法写在一个<code>visitor</code>里面。</p>
<p>接着就是<code>AssignVistor</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This file is part of Yaphp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@contact</span>  codinghuang<span class="doctag">@qq</span>.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Yaphp</span>\<span class="title">NodeVisitor</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">Assign</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">BinaryOp</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Scalar</span>\<span class="title">LNumber</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeVisitorAbstract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Yaphp</span>\<span class="title">HandWritten</span>\<span class="title">CompilerGlobals</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AssignVistor</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span>(<span class="params">Node $node</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        $value = -INF;</span><br><span class="line">        <span class="keyword">if</span> (! ($node <span class="keyword">instanceof</span> Assign)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ($node-&gt;expr <span class="keyword">instanceof</span> LNumber) &#123;</span><br><span class="line">            $value = $node-&gt;expr-&gt;value;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ($node-&gt;expr <span class="keyword">instanceof</span> BinaryOp) &#123;</span><br><span class="line">            $return = (<span class="keyword">new</span> AdditiveExpressionVisitor)-&gt;enterNode($node-&gt;expr);</span><br><span class="line">            $value = $return-&gt;value;</span><br><span class="line">        &#125;</span><br><span class="line">        CompilerGlobals::setSymbol($node-&gt;var-&gt;name, $value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，实现变量就是一个字典，把变量的名字和对应的值存起来即可。目前我们这篇文章不考虑变量的作用域，所以我们把所有的变量通通存在了一个全局变量里面。</p>
<p>第二条表达式语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>: Stmt_Expression(</span><br><span class="line">    expr: Expr_Assign(</span><br><span class="line">        <span class="keyword">var</span>: Expr_Variable(</span><br><span class="line">            name: b</span><br><span class="line">        )</span><br><span class="line">        expr: Expr_BinaryOp_Mul(</span><br><span class="line">            left: Scalar_LNumber(</span><br><span class="line">                value: <span class="number">2</span></span><br><span class="line">            )</span><br><span class="line">            right: Scalar_LNumber(</span><br><span class="line">                value: <span class="number">3</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>可以看到，这个结构和加法的算数表达式几乎是一样的。但是，我们认为加法和乘法还是有一定的区别的，所以我们单独给乘法写一个<code>visitor</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This file is part of Yaphp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@contact</span>  codinghuang<span class="doctag">@qq</span>.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Yaphp</span>\<span class="title">NodeVisitor</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">BinaryOp</span>\<span class="title">Div</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">BinaryOp</span>\<span class="title">Mul</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeVisitorAbstract</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MultiplicativeExpressionVisitor</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">enterNode</span>(<span class="params">Node $node</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! ($node <span class="keyword">instanceof</span> Mul) &amp;&amp; ! ($node <span class="keyword">instanceof</span> Div)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">switch</span> (get_class($node)) &#123;</span><br><span class="line">            <span class="keyword">case</span> Mul::class:</span><br><span class="line">            <span class="keyword">case</span> Div::class:</span><br><span class="line">                $result = <span class="keyword">$this</span>-&gt;multiplicativeExpression($node);</span><br><span class="line">                $resultNode = <span class="keyword">new</span> Node\Scalar\LNumber($result);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $resultNode;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">multiplicativeExpression</span>(<span class="params">Expr $expr</span>): <span class="title">int</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($expr-&gt;left)) &#123;</span><br><span class="line">            $leftValue = <span class="keyword">$this</span>-&gt;multiplicativeExpression($expr-&gt;left);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($expr-&gt;right)) &#123;</span><br><span class="line">            $rightValue = <span class="keyword">$this</span>-&gt;multiplicativeExpression($expr-&gt;right);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (get_class($expr)) &#123;</span><br><span class="line">            <span class="keyword">case</span> Mul::class:</span><br><span class="line">                <span class="keyword">return</span> $leftValue * $rightValue;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Div::class:</span><br><span class="line">                <span class="keyword">return</span> $leftValue / $rightValue;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> $expr-&gt;value;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $leftValue * $rightValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三条表达式语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2</span>: Stmt_Expression(</span><br><span class="line">    expr: Expr_Assign(</span><br><span class="line">        <span class="keyword">var</span>: Expr_Variable(</span><br><span class="line">            name: c</span><br><span class="line">        )</span><br><span class="line">        expr: Expr_BinaryOp_Plus(</span><br><span class="line">            left: Expr_Variable(</span><br><span class="line">                name: a</span><br><span class="line">            )</span><br><span class="line">            right: Expr_Variable(</span><br><span class="line">                name: b</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这是两个变量相加，然后把表达式的结果赋值给一个新的变量。因为，我们把两个变量相加，也放在了<code>AdditiveExpressionVisitor</code>，所以，这里我们无须再实现一个新的<code>visitor</code>了。</p>
<p>我们来看最后一个表达式语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3</span>: Stmt_Expression(</span><br><span class="line">    expr: Expr_FuncCall(</span><br><span class="line">        name: Name(</span><br><span class="line">            parts: <span class="keyword">array</span>(</span><br><span class="line">                <span class="number">0</span>: var_dump</span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        args: <span class="keyword">array</span>(</span><br><span class="line">            <span class="number">0</span>: Arg(</span><br><span class="line">                name: <span class="literal">null</span></span><br><span class="line">                value: Expr_Variable(</span><br><span class="line">                    name: c</span><br><span class="line">                )</span><br><span class="line">                byRef: <span class="literal">false</span></span><br><span class="line">                unpack: <span class="literal">false</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>这是一个函数调用了，所以，我们需要实现一个新的<code>FuncCallExpressionVisitor</code>。因为，函数也是可以求值的，所以我们把函数调用<code>visitor</code>归类为<code>expression</code>：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This file is part of Yaphp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@contact</span>  codinghuang<span class="doctag">@qq</span>.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Yaphp</span>\<span class="title">NodeVisitor</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">Node</span>\<span class="title">Expr</span>\<span class="title">FuncCall</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">PhpParser</span>\<span class="title">NodeVisitorAbstract</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Yaphp</span>\<span class="title">HandWritten</span>\<span class="title">CompilerGlobals</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FuncCallExpressionVisitor</span> <span class="keyword">extends</span> <span class="title">NodeVisitorAbstract</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">leaveNode</span>(<span class="params">Node $node</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (! ($node <span class="keyword">instanceof</span> FuncCall)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $functionName = $node-&gt;name-&gt;parts[<span class="number">0</span>];</span><br><span class="line">        $symbol = $node-&gt;args[<span class="number">0</span>]-&gt;value-&gt;name;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (! CompilerGlobals::hasSymbol($symbol)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> \<span class="built_in">Exception</span>(sprintf(<span class="string">&#x27;not define symbol %s&#x27;</span>, $symbol), <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ($functionName === <span class="string">&#x27;var_dump&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;varDumpHandler(CompilerGlobals::getSymbol($symbol));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">varDumpHandler</span>(<span class="params">$symbol</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        var_dump($symbol);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里，我们实现<code>var_dump</code>的方式就非常的简单了。当我们发现，这是一个<code>var_dump</code>函数的时候，我们直接调用<code>var_dump</code>函数即可。</p>
<p>至此，我们就算是实现了我们所有的<code>visitor</code>了。只要我们对<code>AST</code>使用上我们的<code>visitor</code>，我们就可以很愉快的去解析它了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/08/30/%E4%BD%BF%E7%94%A8Visitor%E6%A8%A1%E5%BC%8F%E6%9D%A5%E8%A7%A3%E6%9E%90%E6%8A%BD%E8%B1%A1%E8%AF%AD%E6%B3%95%E6%A0%91/" data-id="ckkj72ztp007yf6vxbui5d2dx" data-title="使用Visitor模式来解析抽象语法树" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-为什么一定要写注释和测试" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/08/26/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%80%E5%AE%9A%E8%A6%81%E5%86%99%E6%B3%A8%E9%87%8A%E5%92%8C%E6%B5%8B%E8%AF%95/" class="article-date">
  <time class="dt-published" datetime="2020-08-26T09:19:32.000Z" itemprop="datePublished">2020-08-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/08/26/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%80%E5%AE%9A%E8%A6%81%E5%86%99%E6%B3%A8%E9%87%8A%E5%92%8C%E6%B5%8B%E8%AF%95/">为什么一定要写注释和测试</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>最近在公司用<code>PHP</code>重写之前的<code>Lua</code>代码，这份<code>Lua</code>代码量不多，<code>3000</code>行左右。但是，我花了不少时间重写。感触非常大，所以想分享一下。</p>
<p>首先，我说一下这份需要重写的代码问题：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. 没有一个测试。</span><br><span class="line">2. 因为功能不断的在增加，加上对代码质量的不重视，复制粘贴的地方太多了。可能只是改了几个传参而已，但是，却复制了整个函数。</span><br><span class="line">3. 多个地方，本来可以用几句话写完的逻辑，可能是因为当时没想到，逻辑写的非常复杂。并且这段复杂的代码没有注释。</span><br><span class="line">4. 整个项目的注释占比太少了，可以说几乎没有。</span><br></pre></td></tr></table></figure>

<p>我针对这几点来说一下。</p>
<p>第一点，没有一个测试。</p>
<p>这是我认为最严重的问题。我个人认为，一个没有测试的项目，经过无数迭代和多人接手之后，必定是屎山。你代码可以写的不好，但是，你必须要尽可能的写足够的测试，来保证你目前的功能都是正常的。</p>
<p>那么，没有测试的话，会导致什么问题呢？</p>
<p>很明显，你不敢去修改一个你不太熟悉的地方，你不知道这么改对不对，会不会影响其他的代码。所以，你可能就会自己去写一遍。甚至来说，你非常熟悉这份代码了，但是，你没有测试，你也不敢去改，因为你改完之后，你确定不了改完后代码后，整个系统正不正常。毕竟，你怕背锅。久而久之，这份代码极其丑陋。后面，你想改也没动力了。</p>
<p>并且，没有测试的话，你完全不敢去升级你使用的框架，除非你头铁。你知道这个框架有<code>bug</code>了，但是，你不知道升级之后，是否会有<code>api</code>不兼容的问题，导致你的项目出其他的<code>bug</code>。</p>
<p>所以，没有测试，团队的代码会越来越丑陋。（如果是个人的项目，可能你还能撑得住）</p>
<p>你可能有千万个理由说自己没时间写测试。然而，写一个测试其实要不了多少时间，可能比你在<code>postman</code>等工具手动填充参数要的时间还少。我个人觉得，不写测试，是不热爱编程，没有享受敲击键盘的快感，你是一个喜欢手动完成一些任务的人。</p>
<p>第二点，代码质量问题。</p>
<p>我重写的时候，旧代码有太多的复制粘贴了。但是，我在完全重写之前，我是不敢对代码进行优化的。那么，我是怎么做的，我先按照<code>Lua</code>的代码，一字一句的完全翻译完，旧代码复制了几遍，我就重写几遍。然后，我给我重写后的代码编写足够的测试，然后我才敢进行优化。</p>
<p>那么，如果旧代码有测试会怎么样？我完全可以对旧代码进行重构，然后跑一遍测试，看一看测试是否通过。然后，我再按照优化后的代码进行重写。这样，重写的错误率会大大降低。</p>
<p>第三点，简单的逻辑落地在代码上，就变复杂了。</p>
<p>其实，把简单的逻辑写复杂了还能接收，但是，如果没有对这段复杂的代码进行解释，以后就没多少人能够读懂，写代码的人过久了估计也读不懂。所以，我建议，如果代码被你写复杂了，你一定要在旁边写上注释，解释一下这段代码做了什么。以后，就好按照注释进行代码优化。</p>
<p>第四点，没有注释。</p>
<p>很多人可能说，代码就可以表达意思，实际上我觉得并不可以。就算你有一个好的函数名字，你依然会去点开这个函数来看看，看它到底怎么写的。一旦你点进去 ，那么，很可能你就会被里面的代码给整懵了。你不懂这段代码为什么要这么做，即使你有了更好的点子，你也不敢去改。你怕你的想法和这段代码并不完全一致，一些细节，你可能没有考虑到。</p>
<p>还有一些特殊的<code>if</code>条件，我建议也最好注释一下。因为它可能只在某些特殊的场景才会出现，但是随着我们系统的变化，这个场景可能就不会出现了，那么，我们以后完全可以把这个特殊的代码分支给删了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/08/26/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%B8%80%E5%AE%9A%E8%A6%81%E5%86%99%E6%B3%A8%E9%87%8A%E5%92%8C%E6%B5%8B%E8%AF%95/" data-id="ckkj72ztg0079f6vxdq1o6b71" data-title="为什么一定要写注释和测试" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost/" rel="tag">Boost</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Composer/" rel="tag">Composer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C%E8%AF%AD%E8%A8%80/" rel="tag">C语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dockerfile/" rel="tag">Dockerfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GRPC/" rel="tag">GRPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GraphQL/" rel="tag">GraphQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hyperf/" rel="tag">Hyperf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" rel="tag">I/O多路复用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JIT/" rel="tag">JIT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JWT/" rel="tag">JWT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Laravel/" rel="tag">Laravel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MacOS/" rel="tag">MacOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/" rel="tag">Mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OPcache/" rel="tag">OPcache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHP 扩展开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP7/" rel="tag">PHP7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHP内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95/" rel="tag">PHP扩展</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHP扩展开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/" rel="tag">PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Protobuf/" rel="tag">Protobuf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swoole%E5%BE%AE%E8%AF%BE%E7%A8%8B/" rel="tag">Swoole微课程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vscode/" rel="tag">Vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xdebug/" rel="tag">Xdebug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/composer/" rel="tag">composer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c%E8%AF%AD%E8%A8%80/" rel="tag">c语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-compose/" rel="tag">docker-compose</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/epoll/" rel="tag">epoll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fpm/" rel="tag">fpm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gqlgen/" rel="tag">gqlgen</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/migrate/" rel="tag">migrate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swoole/" rel="tag">swoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swore/" rel="tag">swore</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tinyswoole/" rel="tag">tinyswoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unique-lock/" rel="tag">unique_lock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-js/" rel="tag">vue.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%B6%E4%BB%96/" rel="tag">其他</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%8F%E7%A8%8B/" rel="tag">协程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%96%E9%83%A8%E6%8E%92%E5%BA%8F/" rel="tag">外部排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" rel="tag">多线程编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/" rel="tag">引用计数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD/" rel="tag">性能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" rel="tag">性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" rel="tag">性能分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" rel="tag">服务器开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" rel="tag">服务器编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" rel="tag">汇编语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" rel="tag">秒杀系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B/" rel="tag">线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A0%81/" rel="tag">编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" rel="tag">编译器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag">网络编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag">虚拟机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" rel="tag">计算机基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" rel="tag">计算机系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E8%AF%BB%E4%BB%A3%E7%A0%81/" rel="tag">读读代码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B0%83%E8%AF%95/" rel="tag">调试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%92%E5%BD%92/" rel="tag">递归</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%94%81/" rel="tag">锁</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Boost/" style="font-size: 10px;">Boost</a> <a href="/tags/C/" style="font-size: 11.54px;">C</a> <a href="/tags/C/" style="font-size: 16.92px;">C++</a> <a href="/tags/Composer/" style="font-size: 10px;">Composer</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 15.38px;">C语言</a> <a href="/tags/Docker/" style="font-size: 11.54px;">Docker</a> <a href="/tags/Dockerfile/" style="font-size: 10px;">Dockerfile</a> <a href="/tags/GRPC/" style="font-size: 10.77px;">GRPC</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/GraphQL/" style="font-size: 10px;">GraphQL</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Hyperf/" style="font-size: 10.77px;">Hyperf</a> <a href="/tags/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" style="font-size: 10.77px;">I/O多路复用</a> <a href="/tags/JIT/" style="font-size: 10px;">JIT</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Laravel/" style="font-size: 10px;">Laravel</a> <a href="/tags/Linux/" style="font-size: 17.69px;">Linux</a> <a href="/tags/MacOS/" style="font-size: 10px;">MacOS</a> <a href="/tags/MySQL/" style="font-size: 10.77px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/OPcache/" style="font-size: 10px;">OPcache</a> <a href="/tags/PHP/" style="font-size: 20px;">PHP</a> <a href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size: 10.77px;">PHP 扩展开发</a> <a href="/tags/PHP7/" style="font-size: 10px;">PHP7</a> <a href="/tags/PHP%E5%86%85%E6%A0%B8/" style="font-size: 17.69px;">PHP内核</a> <a href="/tags/PHP%E6%89%A9%E5%B1%95/" style="font-size: 13.85px;">PHP扩展</a> <a href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size: 12.31px;">PHP扩展开发</a> <a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="/tags/Protobuf/" style="font-size: 10.77px;">Protobuf</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/Swoole/" style="font-size: 19.23px;">Swoole</a> <a href="/tags/Swoole%E5%BE%AE%E8%AF%BE%E7%A8%8B/" style="font-size: 10px;">Swoole微课程</a> <a href="/tags/Vscode/" style="font-size: 10px;">Vscode</a> <a href="/tags/Xdebug/" style="font-size: 10.77px;">Xdebug</a> <a href="/tags/c/" style="font-size: 10.77px;">c++</a> <a href="/tags/composer/" style="font-size: 10px;">composer</a> <a href="/tags/c%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">c语言</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/docker-compose/" style="font-size: 10px;">docker-compose</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/fpm/" style="font-size: 10px;">fpm</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/gqlgen/" style="font-size: 10px;">gqlgen</a> <a href="/tags/leetcode/" style="font-size: 12.31px;">leetcode</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/migrate/" style="font-size: 10px;">migrate</a> <a href="/tags/nginx/" style="font-size: 10.77px;">nginx</a> <a href="/tags/php/" style="font-size: 16.15px;">php</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/swoole/" style="font-size: 16.15px;">swoole</a> <a href="/tags/swore/" style="font-size: 10px;">swore</a> <a href="/tags/tinyswoole/" style="font-size: 10px;">tinyswoole</a> <a href="/tags/unique-lock/" style="font-size: 10px;">unique_lock</a> <a href="/tags/vue-js/" style="font-size: 10.77px;">vue.js</a> <a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 12.31px;">其他</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">前端</a> <a href="/tags/%E5%8D%8F%E7%A8%8B/" style="font-size: 16.15px;">协程</a> <a href="/tags/%E5%A4%96%E9%83%A8%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">外部排序</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">多线程编程</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">并发</a> <a href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/" style="font-size: 10px;">引用计数</a> <a href="/tags/%E6%80%A7%E8%83%BD/" style="font-size: 10px;">性能</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 10px;">性能优化</a> <a href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" style="font-size: 10px;">性能分析</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 13.85px;">操作系统</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 10.77px;">数据结构</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" style="font-size: 13.08px;">服务器开发</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">服务器编程</a> <a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">汇编语言</a> <a href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">秒杀系统</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15.38px;">算法</a> <a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 10px;">线程</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 10px;">线程池</a> <a href="/tags/%E7%BC%96%E7%A0%81/" style="font-size: 10px;">编码</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" style="font-size: 18.46px;">编译原理</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" style="font-size: 10px;">编译器</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" style="font-size: 14.62px;">网络编程</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 10px;">虚拟机</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">计算机基础</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">计算机系统</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 10.77px;">计算机网络</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10.77px;">设计模式</a> <a href="/tags/%E8%AF%BB%E8%AF%BB%E4%BB%A3%E7%A0%81/" style="font-size: 10.77px;">读读代码</a> <a href="/tags/%E8%B0%83%E8%AF%95/" style="font-size: 10px;">调试</a> <a href="/tags/%E9%80%92%E5%BD%92/" style="font-size: 10px;">递归</a> <a href="/tags/%E9%94%81/" style="font-size: 10px;">锁</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/07/%E5%9C%A8PHP-RSHUTDOWN%E9%98%B6%E6%AE%B5%E8%B0%83%E7%94%A8zend-bailout%E5%AF%BC%E8%87%B4zend-mm-heap-corrupted%E9%97%AE%E9%A2%98/">在PHP RSHUTDOWN阶段调用zend_bailout导致zend_mm_heap corrupted问题</a>
          </li>
        
          <li>
            <a href="/2021/01/07/PHP%E6%89%A9%E5%B1%95%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E7%A7%81%E6%9C%89%E5%B1%9E%E6%80%A7%E7%9A%84%E5%90%8D%E5%AD%97/">PHP扩展如何获取私有属性的名字</a>
          </li>
        
          <li>
            <a href="/2020/12/16/PHP%E6%89%A9%E5%B1%95%E5%A6%82%E4%BD%95%E5%8E%BB%E6%A3%80%E6%9F%A5%E4%BE%9D%E8%B5%96%E7%9A%84C-%E5%BA%93%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8/">PHP扩展如何去检查依赖的C++库是否存在</a>
          </li>
        
          <li>
            <a href="/2020/11/24/Swoole-native-curl%E5%8D%8F%E7%A8%8B%E5%8C%96%E6%80%9D%E8%B7%AF/">Swoole native curl协程化思路</a>
          </li>
        
          <li>
            <a href="/2020/11/22/%E6%9A%B4%E5%8A%9B%E7%94%9F%E6%88%90%E6%94%AF%E9%85%8D%E6%A0%91/">暴力生成支配树</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 codinghuang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>