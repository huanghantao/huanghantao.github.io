---
title: 初识Redis
date: 2017-12-30 20:00:01
tags:
- redis
---

Redis这个技术我很久之前就已经听过了，一直想要尝试一下，但是那时候我还是一个很菜很菜的新手，看不懂，在大学里面也没有人带我，只能自学了，各种谷歌、百度。很累但很有成就感，自学能力得到锻炼......

没关系，今天我学了一下这个东西，主要是我想要实现一个秒杀系统。里面需要用到这个技术，所以临时学了一下这个技术。我只说一说我想说的地方，其他那些概念呀、用法呀之类的我就不说了。而且我所提到的Redis都指的是Redis服务器而不是Redis客户端。（Redis客户端没啥好讲的，各种实现都有。Redis服务器才是关键）

Redis是一个数据结构服务器。怎么说呢？它的数据类型有字符串(String)，哈希(Map)，列表(List)，集合(Sets)和有序集合(Sorted Sets)等类型。

而且Redis是直接把数据保存在内存中的。Redis不像我们平常使用的那些数据库，例如MySQL，它是把数据存在磁盘上的。我们在这里可以简单的对比一下Redis和MySQL：

Redis：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/1.PNG)

MySQL：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/2.PNG)

我们点开那个data目录：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/3.PNG)

这里，每一个文件夹都对应了一个数据库：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/4.PNG)

从目录结构我们就可以很直观的看出，Redis非常的轻量。而且它的目录里面大多只是一些配置文件和可执行文件。所以它没有花费大量的力气在运行的时候，让数据在内存和磁盘之间移动。真是因为对磁盘的操作少，所以**效率是非常的高的**。

说到这里，大家可能就会有一个疑问：Redis服务器被关闭的时候，那些原来的数据不就丢失了吗？额，这个问题我之后讲一下Redis是如何处理的。

然后呢，我说一说Redis另一个吸引我的地方：**发布订阅**功能。

为什么去这么一个名字呢？因为这个功能很符合我们现实生活。例如，许多人订阅了一个打王者荣耀的美女主播的频道。那么，当这个美女主播某个时间点要开始直播了，那么她就会发布一些消息告诉那些订阅了的人，本宝宝要开始打王者农药了、今天我用的英雄是阿珂。然后所有订阅了这个频道的人都会收到这两条消息。OK，我们来模拟一下这个过程：

首先

假设美女主播创建一个频道叫做 wangzherongyao。然后有三个人去订阅这个频道：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/5.PNG)

这个时候，美女主播发布了一条消息：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/6.PNG)

（打不粗中文啊，别介意......）

此时，那三个人就会受到这条消息：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/7.PNG)

注意，在这里美女主播和订阅了的人都属于Redis客户端。负责处理这些消息的是Redis服务器，Redis服务器负责把美女主播发送的这条消息广播给那三个人。那么在底层实现上面，就是Redis服务器读取美女主播连接这个socket文件描述符上的数据，然后往其他三个连接到这个服务器的表示连接的socket文件描述符里面写入这条消息（遍历一遍，然后分别推送）。

OK，然后我再说一说Redis服务器的基于事件的epoll模型。我再菜鸟教程上面看到了这么一句话：**Redis 在网络事件处理上采用的是非阻塞多路复用模型**。嗯，我简单的说一下为什么要采用非阻塞多路复用模型。首先，Redis服务器是基于epoll模型的，然后我猜它是设置成了边沿触发。那么为什么设置成了边沿触发就要把表示连接的socket文件描述符设置为非阻塞的呢？我先说说边沿触发的特点吧：如果某个文件描述符上面有事件没有处理的话，那么下次就不会返回这个文件描述符了（所以边沿触发的效率还是很高的，不会无脑返回我们不想处理的文件描述符）。那么，如果我们想要处理完这个文件描述符上面的数据，就需要去循环的处理完这些数据，直到不能再处理这个文件描述符了。所以我们需要设置为非阻塞的。OK，我再说一说为什么要循环的处理这个文件描述符：如果我们这次不处理完这个文件描述符，例如文件描述符本来可以读取‘a'、'b'、'c’三个字符，我们却只读了'a'、'b'，还剩字符'c'没有读，那么由于我们设置的是边沿触发，所以下次就不会返回这个文件描述符了，而是有其他数据往这个文件描述符里面写入时，才会返回这个文件描述符，而此时字符'c'还留在这个文件描述符里面。OK，当这个文件描述符里面又写入了'd'、'e'两个字符，另一端又可以读取这个文件描述符里面的内容了。但是它会先读出上次那个没有读完的字符'c'。然后才可能读取另外两个字符'd'、'e'。试想一下，如果是一个聊天系统，这肯定是无法接受的。

OK，在最后，我用PHP来举例使用一下Redis吧，顺便回答一下上面那个问题。

首先是PHP代码：

```php
<?php
//连接本地的 Redis 服务
$redis = new Redis();
$redis->connect('127.0.0.1', 6379);
echo "Connection to server sucessfully\n";
//存储数据到列表中
$redis->lpush("hehe", "Redis");
$redis->lpush("hehe", "Mongodb");
$redis->lpush("hehe", "Mysql");
// 获取存储的数据并输出
$arList = $redis->lrange("hehe", 0 ,100);
echo "Stored string in redis\n";
var_dump($arList);
```

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/8.PNG)

OK，我们知道，对于PHP的这个Cli SAPI，它的生命周期就是一次脚本的执行。所以，这个进程所使用的内存在进程结束的时候，就会被操作系统所回收。

好的，我们再次执行一下这个PHP脚本看看结果：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/9.PNG)

咦，很神奇吧，上次的那些结果还在耶。到这里，我们**或许**可以得出那些内存的分配实际上不是由PHP进程来管理的，可能是由Redis服务器这个进程来管理的。客户端需要什么数据，则请求服务器，由服务器来传回。这与数组很不一样，我们对比一下：

```php
<?php
$a = array(
'key1' => 'value1',
'key2' => 'value2',
'key3' => 'value3'
);

var_dump($a);
```

结果：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/10.PNG)

我们再次执行以下这个脚本：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/11.PNG)

依然还是只有那三个元素。所以，同样是保存在内存中的，但是对数据的处理方式却不同。这也很好理解为什么。

OK，我们这次把Redis服务器给关了：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/12.PNG)

然后再次执行原来那个和Redis有关PHP脚本：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/13.PNG)

发现连接不上Redis服务器。嗯嗯，Redis服务器没有开启，我们重新开启一下：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/14.PNG)

我们再次执行PHP脚本：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/15.PNG)

呵呵，这就很奇怪了对吧。不是说好了把数据存放在内存中的吗......欺骗咱们的感情。我开始想，难不成是操作系统拷贝了用户空间的数据？但是这明显不可能啊，操作系统又不可能只为Redis服务器服务，成百上千的服务需要操作系统来配合完成，所以这不可能。然后我就猜想是不是最终保存在了其他地方，或者是把这些东西都写成了日志，就像MySQL事务中保证持久性的那个重写日志一样......

果然，网上搜到了一个答案。这个文件就类似于重写日志：

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/16.PNG)

额，大概就是这样了的吧。今天学了2个小时的Redis，想法就这样了，有时间读一本讲解Redis原理的书籍。明天写一写秒杀系统。

happy ending......

对了，那个美女主播叫**LD-Un倪**。

加油。给自己十年时间......

![](http://oklbfi1yj.bkt.clouddn.com/%E5%88%9D%E8%AF%86Redis/17.jpg)