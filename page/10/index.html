<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>codinghuangçš„ä¸ªäººåšå®¢</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="æ¯”PHPå¤šä¸€äº›">
<meta property="og:type" content="website">
<meta property="og:title" content="codinghuangçš„ä¸ªäººåšå®¢">
<meta property="og:url" content="http://huanghantao.github.io/page/10/index.html">
<meta property="og:site_name" content="codinghuangçš„ä¸ªäººåšå®¢">
<meta property="og:description" content="æ¯”PHPå¤šä¸€äº›">
<meta property="og:locale">
<meta property="article:author" content="codinghuang">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="codinghuangçš„ä¸ªäººåšå®¢" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">codinghuangçš„ä¸ªäººåšå®¢</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">ç®€æ´äº›ã€å¹²å‡€äº›ã€ç›´æ¥äº›...</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://huanghantao.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-å¦‚ä½•åœ¨PHPè„šæœ¬å°†è¦é€€å‡ºå‰æ‰§è¡Œä»£ç " class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/02/22/%E5%A6%82%E4%BD%95%E5%9C%A8PHP%E8%84%9A%E6%9C%AC%E5%B0%86%E8%A6%81%E9%80%80%E5%87%BA%E5%89%8D%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81/" class="article-date">
  <time class="dt-published" datetime="2020-02-22T02:59:21.000Z" itemprop="datePublished">2020-02-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/02/22/%E5%A6%82%E4%BD%95%E5%9C%A8PHP%E8%84%9A%E6%9C%AC%E5%B0%86%E8%A6%81%E9%80%80%E5%87%BA%E5%89%8D%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81/">å¦‚ä½•åœ¨PHPè„šæœ¬å°†è¦é€€å‡ºå‰æ‰§è¡Œä»£ç </a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬æ¥ä»‹ç»ä¸‹å¦‚ä½•é€šè¿‡<code>PHP</code>æ‰©å±•åœ¨<code>PHP</code>è„šæœ¬å°†è¦é€€å‡ºå‰æ‰§è¡Œä»£ç ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸€æ®µ<code>Swoole</code>çš„åç¨‹ä»£ç ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Coroutine</span>;</span><br><span class="line"></span><br><span class="line">go(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    go(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Coroutine::sleep(<span class="number">2</span>);</span><br><span class="line">        var_dump(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    go(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Coroutine::sleep(<span class="number">2</span>);</span><br><span class="line">        var_dump(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    var_dump(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">var_dump(<span class="string">&quot;4&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">string(1) &quot;3&quot;</span><br><span class="line">string(1) &quot;4&quot;</span><br><span class="line">string(1) &quot;1&quot;</span><br><span class="line">string(1) &quot;2&quot;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œåœ¨æ‰“å°<code>4</code>ä¹‹åï¼Œ<code>PHP</code>è„šæœ¬ç®—æ˜¯æ‰§è¡Œå®Œäº†ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œ<code>PHP</code>è¿›ç¨‹ä¹Ÿå¿«è¦é€€å‡ºäº†ã€‚é‚£ä¸ºä»€ä¹ˆè¿˜ä¼šæ‰“å°å‡º<code>1</code>å’Œ<code>2</code>å‘¢ï¼Ÿ</p>
<p>å› ä¸º<code>PHP</code>æ˜¯ä¸€é—¨è§£é‡Šæ€§è¯­è¨€ï¼Œè™½ç„¶<code>PHP</code>è„šæœ¬çš„ä»£ç è·‘å®Œäº†ï¼Œä½†æ˜¯<code>PHP</code>å‘½ä»¤è§£é‡Šå™¨è¿˜æ²¡æœ‰è·‘å®Œï¼Œè‡ªç„¶å¯ä»¥è®©<code>PHP</code>ä»£ç ç»§ç»­è·‘ã€‚æ‰€ä»¥ï¼Œå®é™…ä¸Šï¼Œè¿™ä¸ªä»£ç ä¼šè¿™æ ·ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Coroutine</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Event</span>;</span><br><span class="line"></span><br><span class="line">go(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    go(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Coroutine::sleep(<span class="number">2</span>);</span><br><span class="line">        var_dump(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    go(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        Coroutine::sleep(<span class="number">2</span>);</span><br><span class="line">        var_dump(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    var_dump(<span class="string">&quot;3&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line">var_dump(<span class="string">&quot;4&quot;</span>);</span><br><span class="line"></span><br><span class="line">Event::wait();</span><br></pre></td></tr></table></figure>

<p>åœ¨è„šæœ¬çš„æœ€åä¼šè°ƒç”¨<code>Event::wait()</code>æ¥ç­‰å¾…äº‹ä»¶çš„ç»“æŸã€‚ï¼ˆè€Œè¿™é‡Œçš„äº‹ä»¶å°±æ˜¯å®šæ—¶å™¨çš„äº‹ä»¶ï¼‰</p>
<p>å¥½çš„ï¼Œæˆ‘ä»¬ç°åœ¨é€šè¿‡ä¸€ä¸ªå°<code>demo</code>æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»º<code>PHP</code>æ‰©å±•çš„åŸºç¡€éª¨æ¶ã€‚é€šè¿‡<code>ext_skel</code>å·¥å…·ç”Ÿæˆï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@64fa874bf7d4 ext]# php ext_skel.php --ext register</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿›å…¥<code>register</code>ç›®å½•ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@64fa874bf7d4 ext]# cd register/</span><br></pre></td></tr></table></figure>

<p>æ›¿æ¢<code>config.m4</code>ä¸ºå¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PHP_ARG_ENABLE(register, whether to enable register support,</span><br><span class="line">Make sure that the comment is aligned:</span><br><span class="line">[  --enable-register           Enable register support])</span><br><span class="line">â€‹</span><br><span class="line">if test &quot;$PHP_REGISTER&quot; != &quot;no&quot;; then</span><br><span class="line">  PHP_NEW_EXTENSION(register, register.c, $ext_shared,, -DZEND_ENABLE_STATIC_TSRMLS_CACHE=1)</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œæˆ‘ä»¬åˆ›å»ºå’Œç¼–å†™æµ‹è¯•è„šæœ¬ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@64fa874bf7d4 register]# touch test.php</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    var_dump(<span class="string">&quot;codinghuang&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µè„šæœ¬åªå®šä¹‰äº†ä¸€ä¸ª<code>test</code>å‡½æ•°ï¼Œå¹¶æ²¡æœ‰è°ƒç”¨ã€‚ç°åœ¨æˆ‘ä»¬çš„ä»»åŠ¡å°±æ˜¯å»è°ƒç”¨å®ƒã€‚</p>
<p>æˆ‘ä»¬å¼€å§‹ç¼–å†™<code>PHP</code>æ‰©å±•ã€‚åœ¨æ–‡ä»¶<code>register.c</code>çš„<code>PHP_RINIT_FUNCTION</code>é‡Œé¢æ³¨å†Œ<code>test</code>å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ext/standard/basic_functions.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;zend_API.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">PHP_RINIT_FUNCTION(<span class="keyword">register</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_REGISTER)</span></span><br><span class="line">	ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	php_shutdown_function_entry shutdown_function_entry;</span><br><span class="line">    shutdown_function_entry.arg_count = <span class="number">1</span>;</span><br><span class="line">    shutdown_function_entry.arguments = (zval *) safe_emalloc(<span class="keyword">sizeof</span>(zval), <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line">    ZVAL_STRING(&amp;shutdown_function_entry.arguments[<span class="number">0</span>], <span class="string">&quot;test&quot;</span>);</span><br><span class="line">    register_user_shutdown_function(<span class="string">&quot;test&quot;</span>, ZSTR_LEN(Z_STR(shutdown_function_entry.arguments[<span class="number">0</span>])), &amp;shutdown_function_entry);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆå¯¹<code>php_shutdown_function_entry</code>ç»“æ„è¿›è¡Œåˆå§‹åŒ–ï¼Œ<code>php_shutdown_function_entry.arguments</code>çš„ç¬¬ä¸€ä¸ªä½ç½®å¡«å‡½æ•°çš„åå­—ã€‚<code>shutdown_function_entry.arg_count</code>å¡«å†™1ï¼Œå› ä¸ºå‡½æ•°åå­—ä¹Ÿç®—åšæ˜¯<code>arguments</code>ã€‚åˆå§‹åŒ–å®Œ<code>php_shutdown_function_entry</code>ä¹‹åï¼Œæˆ‘ä»¬è°ƒç”¨<code>register_user_shutdown_function</code>å‡½æ•°å³å¯æ³¨å†Œ<code>test</code>å‡½æ•°äº†ã€‚è¿™æ ·ï¼Œå°±ä¼šåœ¨<code>php</code>è¯·æ±‚<code>shutdown</code>é˜¶æ®µè°ƒç”¨æˆ‘ä»¬æ³¨å†Œçš„å‡½æ•°äº†ã€‚</p>
<p>ç„¶åç¼–è¯‘ã€å®‰è£…æ‰©å±•ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@64fa874bf7d4 register]# phpize &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<p>ç„¶åæŠŠæ‰©å±•åœ¨<code>php.ini</code>æ–‡ä»¶é‡Œé¢è¿›è¡Œå¼€å¯ï¼š</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; Enable zlib extension module</span></span><br><span class="line"><span class="attr">extension</span>=register.so</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ‰§è¡Œè„šæœ¬ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@64fa874bf7d4 register]# php test.php</span><br><span class="line">string(11) &quot;codinghuang&quot;</span><br><span class="line">[root@64fa874bf7d4 register]#</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼ŒæˆåŠŸçš„è°ƒç”¨äº†<code>test</code>å‡½æ•°ã€‚</p>
<p>è¿™è®©æˆ‘æƒ³èµ·äº†æˆ‘ä¹‹å‰é¢è¯•è…¾è®¯çš„æ—¶å€™ï¼Œæœ‰ä¸€é“é¢˜ç›®ï¼Œè¯´æ˜¯å¦‚ä½•åœ¨æ¯ä¸€ä¸ª<code>PHP</code>å‡½æ•°è°ƒç”¨ä¹‹å‰ï¼Œéƒ½æ‰§è¡Œä¸€æ®µä»£ç ã€‚è¿™ä¸ªé—®é¢˜ä»¥åè¡¥ä¸Šã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/02/22/%E5%A6%82%E4%BD%95%E5%9C%A8PHP%E8%84%9A%E6%9C%AC%E5%B0%86%E8%A6%81%E9%80%80%E5%87%BA%E5%89%8D%E6%89%A7%E8%A1%8C%E4%BB%A3%E7%A0%81/" data-id="ckkj72zu3009hf6vx71uv43ot" data-title="å¦‚ä½•åœ¨PHPè„šæœ¬å°†è¦é€€å‡ºå‰æ‰§è¡Œä»£ç " class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHPæ‰©å±•å¼€å‘</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-PHP-explodeæºç åˆ†æ" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/02/10/PHP-explode%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2020-02-10T08:05:06.000Z" itemprop="datePublished">2020-02-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/02/10/PHP-explode%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">PHP explodeæºç åˆ†æ</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/02/10/PHP-explode%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" data-id="ckkj72zr00017f6vx8doe2fdh" data-title="PHP explodeæºç åˆ†æ" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Swoole-Libraryåˆ†æ" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/02/07/Swoole-Library%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2020-02-07T06:40:43.000Z" itemprop="datePublished">2020-02-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/02/07/Swoole-Library%E5%88%86%E6%9E%90/">Swoole Libraryåˆ†æ</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p><code>Swoole</code>åœ¨<code>v4</code>ç‰ˆæœ¬åå†…ç½®äº†<code>Library</code>æ¨¡å—ï¼Œä½¿ç”¨<code>PHP</code>ä»£ç ç¼–å†™å†…æ ¸åŠŸèƒ½ï¼Œä½¿å¾—åº•å±‚è®¾æ–½æ›´åŠ ç¨³å®šå¯é ã€‚</p>
</blockquote>
<p>è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹å¦‚ä½•ä½¿ç”¨ä»¥åŠç¼–å†™<code>Library</code>ã€‚</p>
<p>é¦–å…ˆï¼Œåœ¨<code>Swoole v4</code>çš„æ—©æœŸç‰ˆæœ¬ï¼Œ<code>swoole-src</code>ä¸‹é¢æ˜¯æœ‰ä¸€ä¸ª<code>library</code>ç›®å½•çš„ï¼Œé‡Œé¢å°±å­˜æ”¾äº†å¾ˆå¤šçš„<code>PHP</code>ä»£ç ï¼Œä¹Ÿå°±æ˜¯<code>Library</code>åº“çš„ä»£ç ã€‚åœ¨åç»­ç‰ˆæœ¬ï¼Œè¿™ä¸ª<code>library</code>å°±ç‹¬ç«‹å‡ºäº†ä¸€ä¸ª<a target="_blank" rel="noopener" href="https://github.com/swoole/library">ä»“åº“</a>ã€‚</p>
<p>ç®€å•ä»‹ç»äº†èƒŒæ™¯ä¹‹åï¼Œæˆ‘ä»¬å°±æ¥åˆ†æä¸‹è¿™ä¸ª<code>Library</code>å¦‚ä½•å·¥ä½œä»¥åŠå¦‚ä½•ä½¿ç”¨çš„ã€‚</p>
<h2 id="å¦‚ä½•æŠŠLibraryä½œä¸ºSwooleæ‰©å±•çš„å†…ç½®åº“"><a href="#å¦‚ä½•æŠŠLibraryä½œä¸ºSwooleæ‰©å±•çš„å†…ç½®åº“" class="headerlink" title="å¦‚ä½•æŠŠLibraryä½œä¸ºSwooleæ‰©å±•çš„å†…ç½®åº“"></a>å¦‚ä½•æŠŠLibraryä½œä¸ºSwooleæ‰©å±•çš„å†…ç½®åº“</h2><h3 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h3><p>é¦–å…ˆï¼Œæˆ‘ä»¬è¦æ˜ç™½<code>Library</code>å¯ä»¥ä½œä¸º<code>Swoole</code>å†…ç½®åº“çš„å·¥ä½œåŸç†ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€æ®µä»£ç ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;start\n&quot;</span>;</span><br><span class="line">$code = <span class="string">&#x27;</span></span><br><span class="line"><span class="string">    class Library</span></span><br><span class="line"><span class="string">    &#123;</span></span><br><span class="line"><span class="string">        public function func1() &#123;</span></span><br><span class="line"><span class="string">            echo &quot;codinghuang\n&quot;;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#x27;</span>;</span><br><span class="line"><span class="keyword">eval</span>($code);</span><br><span class="line">(<span class="keyword">new</span> Library)-&gt;func1();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;end\n&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">start</span><br><span class="line">codinghuang</span><br><span class="line">end</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œé€šè¿‡<code>eval</code>å¯ä»¥æŠŠ<code>$code</code>å¯¹åº”çš„å­—ç¬¦ä¸²ä½œä¸ºä»£ç æ¥æ‰§è¡Œã€‚<code>Swoole</code>ä¹Ÿæ˜¯ä½¿ç”¨äº†<code>eval</code>çš„èƒ½åŠ›ï¼ŒæŠŠ<code>PHP</code>ä»£ç ä½œä¸º<code>Swoole</code>æ‰©å±•çš„å†…ç½®åº“ã€‚åœ¨<code>Swoole</code>æ‰©å±•å±‚é¢ï¼Œå°±æ˜¯è°ƒç”¨äº†<code>zend_eval_stringl</code>æ¥æ‰§è¡Œ<code>PHP</code>ä»£ç çš„ã€‚</p>
<p>æ—¢ç„¶å¦‚æ­¤ï¼Œ<code>Swoole</code>è‚¯å®šå°±éœ€è¦è¯»å–å†™å¥½çš„<code>PHP Library</code>ï¼Œç„¶ååœ¨æ‰©å±•åŠ è½½çš„æ—¶å€™ï¼Œæ‰§è¡Œ<code>zend_eval_stringl</code>ã€‚ç„¶åï¼Œè¿™äº›ç±»ã€å‡½æ•°ã€å˜é‡ç­‰ç­‰å°±ç”Ÿæˆäº†ã€‚</p>
<h3 id="Swooleå¦‚ä½•è¯»å–åˆ°å†™å¥½çš„Libraryä»£ç "><a href="#Swooleå¦‚ä½•è¯»å–åˆ°å†™å¥½çš„Libraryä»£ç " class="headerlink" title="Swooleå¦‚ä½•è¯»å–åˆ°å†™å¥½çš„Libraryä»£ç "></a>Swooleå¦‚ä½•è¯»å–åˆ°å†™å¥½çš„Libraryä»£ç </h3><p>å…¶å®ï¼Œ<code>Library</code>ä»£ç éƒ½åœ¨æ–‡ä»¶<code>swoole-src/php_swoole_library.h</code>é‡Œé¢ã€‚æˆ‘ä»¬å…¶ä¸­ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* swoole_library_source_constants =</span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;/**\n&quot;</span></span><br><span class="line">    <span class="string">&quot; * This file is part of Swoole.\n&quot;</span></span><br><span class="line">    <span class="string">&quot; *\n&quot;</span></span><br><span class="line">    <span class="string">&quot; * @link     https://www.swoole.com\n&quot;</span></span><br><span class="line">    <span class="string">&quot; * @contact  team@swoole.com\n&quot;</span></span><br><span class="line">    <span class="string">&quot; * @license  https://github.com/swoole/library/blob/master/LICENSE\n&quot;</span></span><br><span class="line">    <span class="string">&quot; */\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;declare(strict_types=1);\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;define(&#x27;SWOOLE_LIBRARY&#x27;, true);\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°ï¼Œè¿™æ®µ<code>PHP</code>ä»£ç ä½œä¸º<code>C++</code>çš„å­—ç¬¦ä¸²å­˜åœ¨ã€‚ç„¶åï¼Œåœ¨å‡½æ•°<code>php_swoole_load_library</code>é‡Œé¢å°±è°ƒç”¨äº†ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zend::eval(swoole_library_source_constants, <span class="string">&quot;@swoole-src/library/constants.php&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>æ¥æ‰§è¡Œè¿™æ®µ<code>PHP</code>ä»£ç ã€‚è¿™æ ·ï¼Œå¸¸é‡<code>SWOOLE_LIBRARY</code>å°±è¢«å®šä¹‰äº†ã€‚æˆ‘ä»¬åœ¨æ¥çœ‹çœ‹å…¶ä»–çš„<code>Library</code>ä»£ç ï¼ˆå› ä¸ºå¤ªé•¿ï¼Œæˆ‘çœç•¥äº†éƒ¨åˆ†ï¼‰ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">char</span>* swoole_library_source_core_constant =</span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;/**\n&quot;</span></span><br><span class="line">    <span class="string">&quot; * This file is part of Swoole.\n&quot;</span></span><br><span class="line">    <span class="string">&quot; *\n&quot;</span></span><br><span class="line">    <span class="string">&quot; * @link     https://www.swoole.com\n&quot;</span></span><br><span class="line">    <span class="string">&quot; * @contact  team@swoole.com\n&quot;</span></span><br><span class="line">    <span class="string">&quot; * @license  https://github.com/swoole/library/blob/master/LICENSE\n&quot;</span></span><br><span class="line">    <span class="string">&quot; */\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;declare(strict_types=1);\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;namespace Swoole;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;class Constant\n&quot;</span></span><br><span class="line">    <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_BUFFER_INPUT_SIZE = &#x27;buffer_input_size&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_BUFFER_OUTPUT_SIZE = &#x27;buffer_output_size&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_MESSAGE_QUEUE_KEY = &#x27;message_queue_key&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_BACKLOG = &#x27;backlog&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_KERNEL_SOCKET_RECV_BUFFER_SIZE = &#x27;kernel_socket_recv_buffer_size&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_KERNEL_SOCKET_SEND_BUFFER_SIZE = &#x27;kernel_socket_send_buffer_size&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_TCP_DEFER_ACCEPT = &#x27;tcp_defer_accept&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_OPEN_TCP_KEEPALIVE = &#x27;open_tcp_keepalive&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_OPEN_HTTP_PROTOCOL = &#x27;open_http_protocol&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_OPEN_WEBSOCKET_PROTOCOL = &#x27;open_websocket_protocol&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_WEBSOCKET_SUBPROTOCOL = &#x27;websocket_subprotocol&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_OPEN_WEBSOCKET_CLOSE_FRAME = &#x27;open_websocket_close_frame&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_OPEN_HTTP2_PROTOCOL = &#x27;open_http2_protocol&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_OPEN_REDIS_PROTOCOL = &#x27;open_redis_protocol&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_TCP_KEEPIDLE = &#x27;tcp_keepidle&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_TCP_KEEPINTERVAL = &#x27;tcp_keepinterval&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_TCP_KEEPCOUNT = &#x27;tcp_keepcount&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_TCP_FASTOPEN = &#x27;tcp_fastopen&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_PACKAGE_BODY_START = &#x27;package_body_start&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_SSL_CLIENT_CERT_FILE = &#x27;ssl_client_cert_file&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_SSL_PREFER_SERVER_CIPHERS = &#x27;ssl_prefer_server_ciphers&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_SSL_CIPHERS = &#x27;ssl_ciphers&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_SSL_ECDH_CURVE = &#x27;ssl_ecdh_curve&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_SSL_DHPARAM = &#x27;ssl_dhparam&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    public const OPTION_OPEN_SSL = &#x27;open_ssl&#x27;;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="string">&quot;    /* &#125;&#125;&#125; OPTION */\n&quot;</span></span><br><span class="line">    <span class="string">&quot;&#125;\n&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œè¿™é‡Œæœ‰å¤ªå¤šçš„<code>PHP</code>å¸¸é‡äº†ï¼Œå¹¶ä¸”å¸¸é‡å¯¹åº”çš„å€¼å¾ˆå¤šéƒ½æ˜¯<code>Swoole</code>çš„é…ç½®é¡¹è¿™ç§ï¼Œä¾‹å¦‚<code>buffer_input_size</code>ã€‚æ‰€ä»¥ï¼Œè¿™äº›<code>php_swoole_library.h</code>æ–‡ä»¶é‡Œé¢çš„<code>Library</code>è‚¯å®šä¸æ˜¯æ‰‹å†™çš„ã€‚</p>
<p>å®é™…ä¸Šï¼Œ<code>php_swoole_library.h</code>é‡Œé¢çš„<code>Library</code>ä»£ç æ˜¯é€šè¿‡<code>swoole-src/remake_library.sh</code>å·¥å…·è‡ªåŠ¨ç”Ÿæˆçš„ã€‚</p>
<p>ä½†æ˜¯ï¼Œå¦‚æœä½ åœ¨æ¯”è¾ƒæ–°çš„<code>swoole-src</code>ä»£ç é‡Œé¢ç›´æ¥è·‘<code>remake_library.sh</code>è„šæœ¬ï¼Œæ˜¯ä¼šæŠ¥é”™çš„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@64fa874bf7d4 swoole-src]# ./remake_library.sh</span><br><span class="line">rm swoole.lo</span><br><span class="line">rm php_swoole_library.h</span><br><span class="line">sh: line 0: cd: /root/codeDir/cppCode/swoole-src/library: No such file or directory</span><br><span class="line">sh: line 0: cd: /root/codeDir/cppCode/swoole-src/library: No such file or directory</span><br><span class="line">âŒ Unable to get commit id of library in [/root/codeDir/cppCode/swoole-src/library]</span><br><span class="line">[root@64fa874bf7d4 swoole-src]#</span><br></pre></td></tr></table></figure>

<p>å› ä¸º<code>library</code>ä»£ç å·²ç»ä¸åœ¨<code>swoole-src</code>ä¸‹é¢äº†ã€‚</p>
<h3 id="å¦‚ä½•ç”ŸæˆLibraryä»£ç "><a href="#å¦‚ä½•ç”ŸæˆLibraryä»£ç " class="headerlink" title="å¦‚ä½•ç”ŸæˆLibraryä»£ç "></a>å¦‚ä½•ç”ŸæˆLibraryä»£ç </h3><p>æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå‡†å¤‡å¥½<code>library</code>ä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨<code>swoole-src</code>ä¸‹é¢<code>git clone</code>ä¸‹<code>library</code>ä»£ç ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:swoole/library.git</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œåœ¨ç›®å½•<code>swoole-src</code>ä¸‹æ‰§è¡Œ<code>remake_library.sh</code>è„šæœ¬å³å¯æŠŠ<code>library</code>çš„ä»£ç ç”Ÿæˆåœ¨<code>php_swoole_library.h</code>æ–‡ä»¶é‡Œé¢ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@64fa874bf7d4 swoole-src]# ./remake_library.sh</span><br><span class="line">ğŸš€ğŸš€ğŸš€Generated swoole php library successfully!ğŸš€ğŸš€ğŸš€</span><br><span class="line">remake...</span><br><span class="line">done</span><br><span class="line">[root@64fa874bf7d4 swoole-src]#</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·ï¼Œå°±å¯ä»¥æŠŠ<code>library</code>ä»“åº“æœ€æ–°çš„ä»£ç ç”Ÿæˆåˆ°<code>php_swoole_library.h</code>æ–‡ä»¶é‡Œé¢äº†ã€‚</p>
<h3 id="Swooleçš„é‚£äº›å¸¸é‡å¦‚ä½•ç¼–å†™çš„"><a href="#Swooleçš„é‚£äº›å¸¸é‡å¦‚ä½•ç¼–å†™çš„" class="headerlink" title="Swooleçš„é‚£äº›å¸¸é‡å¦‚ä½•ç¼–å†™çš„"></a>Swooleçš„é‚£äº›å¸¸é‡å¦‚ä½•ç¼–å†™çš„</h3><p>æˆ‘ä»¬å‘ç°ï¼Œåœ¨<code>library</code>é‡Œé¢æœ‰ä¸€ä¸ªæ–‡ä»¶<code>library/src/core/Constant.php</code>ï¼Œè¿™é‡Œé¢åŒ…å«äº†å¾ˆå¤š<code>Swoole</code>å†…æ ¸çš„å¸¸é‡å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚è¯´ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> EVENT_RECEIVE = <span class="string">&#x27;receive&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> EVENT_CONNECT = <span class="string">&#x27;connect&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> OPTION_SSL_CERT_FILE = <span class="string">&#x27;ssl_cert_file&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> OPTION_SSL_KEY_FILE = <span class="string">&#x27;ssl_key_file&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> OPTION_BUFFER_INPUT_SIZE = <span class="string">&#x27;buffer_input_size&#x27;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">const</span> OPTION_BUFFER_OUTPUT_SIZE = <span class="string">&#x27;buffer_output_size&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>ç­‰ç­‰ï¼Œè¿™äº›è¦å†™èµ·æ¥æ˜¯éå¸¸çš„ç¹çï¼Œè€Œä¸”å¾ˆå®¹æ˜“æ¼äº†ã€‚å¹¶ä¸”ï¼Œå¦‚æœä½ åœ¨<code>Swoole</code>å†…æ ¸ä¸­ä¿®æ”¹äº†é…ç½®é¡¹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦åœ¨<code>Constant.php</code>é‡Œé¢å»æ›´æ–°å¯¹åº”çš„å¸¸é‡ï¼Œéå¸¸çš„éº»çƒ¦ã€‚æ‰€ä»¥ï¼Œå®˜æ–¹æä¾›äº†ä¸€ä¸ªå·¥å…·<code>swoole-src/tools/constant-generator.php</code>ã€‚åªè¦æˆ‘ä»¬è·‘è¿™ä¸ª<code>PHP</code>è„šæœ¬ï¼Œå®ƒå°±ä¼šé€šè¿‡æ­£åˆ™åŒ¹é…ï¼ŒæŠŠ<code>Swoole</code>å†…æ ¸é‡Œé¢çš„é‚£äº›å¸¸é‡å­—ç¬¦ä¸²æ‰¾å‡ºæ¥ï¼Œç„¶åç”Ÿæˆåˆ°æ–‡ä»¶<code>library/src/core/Constant.php</code>é‡Œé¢ï¼Œå¤§å¤§çš„æé«˜äº†å·¥ä½œæ•ˆç‡ã€‚æˆ‘ä»¬æ¥æ¼”ç¤ºä¸€ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@64fa874bf7d4 tools]# php constant-generator.php</span><br><span class="line">ğŸš€ğŸš€ğŸš€Constant generator successfully done!ğŸš€ğŸš€ğŸš€</span><br><span class="line">[root@64fa874bf7d4 tools]#</span><br></pre></td></tr></table></figure>

<p>ä»è¿™é‡Œæˆ‘ä»¬å‘ç°ï¼Œ<code>library</code>çš„ä»£ç é™¤äº†æ‰‹åŠ¨ç¼–å†™çš„ä¹‹å¤–ï¼Œè¿˜æœ‰éƒ¨åˆ†æ˜¯å·¥å…·ç”Ÿæˆçš„ã€‚</p>
<p>ï¼ˆæœªå®Œï¼‰</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/02/07/Swoole-Library%E5%88%86%E6%9E%90/" data-id="ckkj72zrz003if6vx3rn8gtuv" data-title="Swoole Libraryåˆ†æ" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-2020å¹´å­¦ä¹ è®¡åˆ’" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/02/03/2020%E5%B9%B4%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/" class="article-date">
  <time class="dt-published" datetime="2020-02-03T03:51:58.000Z" itemprop="datePublished">2020-02-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/02/03/2020%E5%B9%B4%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/">2020å¹´å­¦ä¹ è®¡åˆ’</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>æƒ³ç»™è‡ªå·±çš„<code>2020</code>è§„åˆ’ä¸‹ã€‚<br>ä¸»çº¿ï¼š</p>
<ol>
<li>ç²¾é€š<code>Swoole</code>ï¼Œç†Ÿæ‚‰<code>PHP</code>å¸¸è§çš„å†…æ ¸ä»£ç </li>
<li>å­¦ä¹ ç¼–è¯‘åŸç†ï¼Œå‚è€ƒ<code>PHP</code>è¯­æ³•å†™ä¸€ä¸ª<code>tinyphp</code>ï¼Œåç»­å¼€ä¸€ä¸ªæ–°çš„ä¸“æ ï¼Œæ•´ç†æˆç±»ä¼¼äº<code>PHP</code>æ‰©å±•å¼€å‘æ•™ç¨‹çš„æ–‡ç« </li>
</ol>
<p>å…¶ä»–ï¼š</p>
<ol>
<li>å­¦ä¹ <code>C++</code></li>
<li>å­¦ä¹ è®¾è®¡æ¨¡å¼</li>
</ol>
<p>å¦‚æœå¯ä»¥å®Œæˆç¬¬ä¸€ç‚¹ï¼Œå¯ä»¥ç»™è‡ªå·±æ‰“<code>60</code>åˆ†ï¼Œè¯´æ˜æ­£å¸¸å®Œæˆäº†æ—¥å¸¸å·¥ä½œã€‚<br>å¦‚æœå¯ä»¥å®Œæˆç¬¬äºŒç‚¹ï¼Œå¯ä»¥ç»™è‡ªå·±æ‰“<code>80</code>åˆ†ï¼Œè¯´æ˜æŠŠå¤§å­¦æœŸé—´æ¬ ä¸‹çš„ç¼–è¯‘åŸç†è¿˜å®Œäº†ã€‚ï¼ˆå¤§å››èŠ±äº†ä¸€å¹´å»è¿˜æ“ä½œç³»ç»Ÿå’Œè®¡ç®—æœºç½‘ç»œçš„å€ºï¼Œç„¶è€Œï¼Œè‡ªå·±è¿˜æ²¡æœ‰å†™è¿‡ä¸€ä¸ªæ¯”è¾ƒå®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œè¿™ä¸ªä¼°è®¡è¦<code>2021</code>å¹´å»è¿˜å€ºäº†ï¼‰<br>å¦‚æœå¯ä»¥å®Œæˆç¬¬ä¸‰ç‚¹ï¼Œå¯ä»¥ç»™è‡ªå·±æ‰“<code>90</code>åˆ†ï¼Œè¯´æ˜é™¤äº†<code>PHP</code>å’Œ<code>C</code>è¯­è¨€ï¼Œåˆå¤šäº†ä¸€é—¨å¯ä»¥åƒé¥­çš„è¯­è¨€äº†ã€‚<br>å¦‚æœå¯ä»¥å®Œæˆç¬¬å››ç‚¹ï¼Œå¯ä»¥ç»™è‡ªå·±æ‰“<code>95</code>åˆ†ï¼Œè¯´æ˜å¯ä»¥æœ‰èƒ½åŠ›æ”¶æ‹¾è‡ªå·±çš„è‡­ä»£ç äº†ã€‚<br>å¦‚æœèƒ½å­¦ä¼šç‚’å‡ ç›†æ‹¿æ‰‹çš„èœï¼Œå°±å¯ä»¥ç»™è‡ªå·±æ‰“<code>100</code>åˆ†äº†ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/02/03/2020%E5%B9%B4%E5%AD%A6%E4%B9%A0%E8%AE%A1%E5%88%92/" data-id="ckkj72zqh0007f6vxhfytgvm3" data-title="2020å¹´å­¦ä¹ è®¡åˆ’" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Swoole-Serverä¸­masterè¿›ç¨‹æŠ•é€’æ•°æ®åˆ°workerè¿›ç¨‹çš„æ€§èƒ½ä¼˜åŒ–" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/22/Swoole-Server%E4%B8%ADmaster%E8%BF%9B%E7%A8%8B%E6%8A%95%E9%80%92%E6%95%B0%E6%8D%AE%E5%88%B0worker%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2020-01-22T02:43:46.000Z" itemprop="datePublished">2020-01-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/22/Swoole-Server%E4%B8%ADmaster%E8%BF%9B%E7%A8%8B%E6%8A%95%E9%80%92%E6%95%B0%E6%8D%AE%E5%88%B0worker%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/">Swoole Serverä¸­masterè¿›ç¨‹æŠ•é€’æ•°æ®åˆ°workerè¿›ç¨‹çš„æ€§èƒ½ä¼˜åŒ–</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>åœ¨<code>Swoole4.5</code>ç‰ˆæœ¬ä¸­ï¼ˆç›®å‰è¿˜æœªå‘å¸ƒï¼‰ï¼Œæˆ‘ä»¬çš„<code>Server</code>æœ‰ä¸€ä¸ªæ€§èƒ½éœ€è¦ä¼˜åŒ–çš„åœ°æ–¹ï¼Œå°±æ˜¯<code>worker</code>è¿›ç¨‹åœ¨æ”¶åˆ°<code>master</code>è¿›ç¨‹å‘æ¥çš„åŒ…çš„æ—¶å€™ï¼Œéœ€è¦è¿›è¡Œä¸¤æ¬¡çš„æ‹·è´ï¼Œæ‰å¯ä»¥æŠŠæ•°æ®ä»<code>PHP</code>æ‰©å±•å±‚ä¼ é€’åˆ°<code>PHP</code>ä¸Šå±‚ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬äº‹ä»¶å›è°ƒå‡½æ•°çš„<code>data</code>å‚æ•°ï¼‰ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆä¼šæœ‰æ€§èƒ½çš„é—®é¢˜ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä»½ä¼šæœ‰æ€§èƒ½é—®é¢˜çš„ä»£ç ã€‚æˆ‘ä»¬<code>git clone</code>ä¸‹<code>swoole-src</code>ä»£ç ï¼Œç„¶å<code>git checkout</code>åˆ°<code>8235c82fea2130534a16fd20771dcab3408a763e</code>è¿™ä¸ª<code>commit</code>ä½ç½®ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout 8235c82fea2130534a16fd20771dcab3408a763e</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ä»£ç ï¼Œé¦–å…ˆçœ‹<code>master</code>è¿›ç¨‹æ˜¯å¦‚ä½•å°è£…æ•°æ®ç„¶åå‘é€ç»™<code>worker</code>è¿›ç¨‹çš„ã€‚åœ¨å‡½æ•°<code>process_send_packet</code>é‡Œé¢ï¼Œæˆ‘ä»¬çœ‹æ ¸å¿ƒçš„åœ°æ–¹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">process_send_packet</span><span class="params">(swServer *serv, swPipeBuffer *buf, swSendData *resp, <span class="keyword">send_func_t</span> _send, <span class="keyword">void</span>* private_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* data = resp-&gt;data;</span><br><span class="line">    <span class="keyword">uint32_t</span> send_n = resp-&gt;info.len;</span><br><span class="line">    <span class="keyword">off_t</span> offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> max_length = serv-&gt;ipc_max_size - <span class="keyword">sizeof</span>(buf-&gt;info);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (send_n &lt;= max_length)</span><br><span class="line">    &#123;</span><br><span class="line">        buf-&gt;info.flags = <span class="number">0</span>;</span><br><span class="line">        buf-&gt;info.len = send_n;</span><br><span class="line">        <span class="built_in">memcpy</span>(buf-&gt;data, data, send_n);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> retval = _send(serv, buf, <span class="keyword">sizeof</span>(buf-&gt;info) + send_n, private_data);</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buf-&gt;info.flags = SW_EVENT_DATA_CHUNK;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (send_n &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (send_n &gt; max_length)</span><br><span class="line">        &#123;</span><br><span class="line">            buf-&gt;info.len = max_length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            buf-&gt;info.flags |= SW_EVENT_DATA_END;</span><br><span class="line">            buf-&gt;info.len = send_n;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(buf-&gt;data, data + offset, buf-&gt;info.len);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_send(serv, buf, <span class="keyword">sizeof</span>(buf-&gt;info) + buf-&gt;info.len, private_data) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> SW_ERR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        send_n -= buf-&gt;info.len;</span><br><span class="line">        offset += buf-&gt;info.len;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SW_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬æ¥è¯´ä¸€ä¸‹<code>process_send_packet</code>è¿™ä¸ªå‡½æ•°çš„å‚æ•°ï¼š</p>
<p>å…¶ä¸­ï¼Œ</p>
<p><code>swServer *serv</code>å°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„é‚£ä¸ª<code>Server</code>ã€‚</p>
<p><code>swPipeBuffer *buf</code>æŒ‡å‘çš„å†…å­˜é‡Œé¢çš„æ•°æ®éœ€è¦å‘é€ç»™<code>worker</code>è¿›ç¨‹ã€‚</p>
<p><code>swSendData *resp</code>é‡Œé¢å­˜æ”¾äº†<code>master</code>è¿›ç¨‹æ”¶åˆ°çš„å®¢æˆ·ç«¯æ•°æ®ä»¥åŠä¸€ä¸ª<code>swDataHead info</code>å¤´éƒ¨ã€‚</p>
<p><code>_send</code>æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¿™é‡Œé¢çš„é€»è¾‘å°±æ˜¯<code>master</code>è¿›ç¨‹æŠŠ<code>swPipeBuffer *buf</code>é‡Œé¢çš„æ•°æ®å‘é€ç»™<code>worker</code>è¿›ç¨‹ã€‚</p>
<p><code>void* private_data</code>è¿™é‡Œæ˜¯ä¸€ä¸ª<code>swWorker *worker</code>ç±»å‹çš„æŒ‡é’ˆè½¬æ¢è¿‡æ¥çš„ã€‚æŒ‡å®šäº†<code>master</code>è¿›ç¨‹éœ€è¦å‘é€çš„é‚£ä¸ª<code>worker</code>è¿›ç¨‹ã€‚</p>
<blockquote>
<p>è¯´æ˜ä¸€ç‚¹ï¼Œè¿™é‡Œæˆ‘ä»¬æ˜¯ä»¥<code>Server</code>è®¾ç½®äº†<code>eof</code>é€‰é¡¹ä¸ºä¾‹å­è®²è§£çš„ï¼ˆå‡è®¾è®¾ç½®äº†<code>&quot;\r\n&quot;</code>ï¼‰ã€‚å› ä¸º<code>TCP</code>æ˜¯é¢å‘å­—èŠ‚æµçš„ï¼Œå³ä½¿å®¢æˆ·ç«¯å‘é€äº†ä¸€ä¸ªå¾ˆå¤§çš„åŒ…è¿‡æ¥ï¼ŒæœåŠ¡å™¨ä¸€æ¬¡<code>read</code>å‡ºæ¥çš„æ•°æ®ä¹Ÿä¸è§å¾—éå¸¸å¤§ã€‚å¦‚æœä¸è®¾ç½®<code>eof</code>çš„è¯ï¼Œæ˜¯ä¸ä¼šå¯¼è‡´æˆ‘ä»¬è¿™ç¯‡æ–‡ç« æ‰€è¯´çš„æ€§èƒ½é—®é¢˜ã€‚</p>
</blockquote>
<p>ä»‹ç»å®Œäº†<code>process_send_packet</code>å‡½æ•°çš„å‚æ•°ä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span>* data = resp-&gt;data;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆï¼Œè®©<code>data</code>æŒ‡å‘<code>resp-&gt;data</code>ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯å‘æ¥çš„å®é™…æ•°æ®ã€‚ä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯å‘æ¥äº†å­—ç¬¦ä¸²<code>hello world\r\n</code>ï¼Œé‚£ä¹ˆ<code>data</code>é‡Œé¢å­˜æ”¾çš„å°±æ˜¯<code>hello world\r\n</code>ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> send_n = resp-&gt;info.len;</span><br></pre></td></tr></table></figure>

<p>æ ‡å¿—ç€<code>resp-&gt;data</code>æ•°æ®çš„é•¿åº¦ã€‚ä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯å¾€æœåŠ¡å™¨å‘é€äº†<code>1M</code>çš„æ•°æ®ï¼Œé‚£ä¹ˆ<code>resp-&gt;info.len</code>å°±æ˜¯<code>1048576</code>ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">off_t</span> offset = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p>ç”¨æ¥æ ‡å¿—å“ªäº›æ•°æ®<code>master</code>è¿›ç¨‹å·²ç»å‘é€ç»™äº†<code>worker</code>è¿›ç¨‹ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> max_length = serv-&gt;ipc_max_size - <span class="keyword">sizeof</span>(buf-&gt;info);</span><br></pre></td></tr></table></figure>

<p><code>max_length</code>è¡¨ç¤º<code>master</code>è¿›ç¨‹ä¸€æ¬¡å¾€<code>worker</code>è¿›ç¨‹å‘é€çš„åŒ…æœ€å¤§é•¿åº¦ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼š<code>master</code>è¿›ç¨‹å’Œ<code>worker</code>è¿›ç¨‹æ˜¯é€šè¿‡<code>udg</code>æ–¹å¼è¿›è¡Œé€šä¿¡çš„ã€‚æ‰€ä»¥ï¼Œ<code>master</code>è¿›ç¨‹å‘é€å¤šå°‘ï¼Œ<code>worker</code>è¿›ç¨‹å°±ç›´æ¥æ”¶å¤šå°‘</p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (send_n &lt;= max_length)</span><br><span class="line">&#123;</span><br><span class="line">    buf-&gt;info.flags = <span class="number">0</span>;</span><br><span class="line">    buf-&gt;info.len = send_n;</span><br><span class="line">    <span class="built_in">memcpy</span>(buf-&gt;data, data, send_n);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> retval = _send(serv, buf, <span class="keyword">sizeof</span>(buf-&gt;info) + send_n, private_data);</span><br><span class="line">    <span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>master</code>è¿›ç¨‹è¦å‘ç»™<code>worker</code>è¿›ç¨‹çš„æ•°æ®å°äº<code>max_length</code>ï¼Œé‚£ä¹ˆå°±ç›´æ¥è°ƒç”¨<code>_send</code>å‡½æ•°ï¼Œç›´æ¥æŠŠæ•°æ®å‘ç»™<code>worker</code>è¿›ç¨‹ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buf-&gt;info.flags = SW_EVENT_DATA_CHUNK;</span><br></pre></td></tr></table></figure>

<p>å½“<code>send_n</code>å¤§äº<code>max_length</code>çš„æ—¶å€™ï¼Œè®¾ç½®<code>buf-&gt;info.flags</code>ä¸º<code>CHUNK</code>ï¼Œä¹Ÿå°±æ„å‘³ç€éœ€è¦æŠŠå®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®å…ˆæ‹†åˆ†æˆä¸€å°æ®µä¸€å°æ®µçš„æ•°æ®ï¼Œç„¶åå†å‘é€ç»™<code>worker</code>è¿›ç¨‹ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (send_n &gt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (send_n &gt; max_length)</span><br><span class="line">    &#123;</span><br><span class="line">        buf-&gt;info.len = max_length;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        buf-&gt;info.flags |= SW_EVENT_DATA_END;</span><br><span class="line">        buf-&gt;info.len = send_n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memcpy</span>(buf-&gt;data, data + offset, buf-&gt;info.len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_send(serv, buf, <span class="keyword">sizeof</span>(buf-&gt;info) + buf-&gt;info.len, private_data) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> SW_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    send_n -= buf-&gt;info.len;</span><br><span class="line">    offset += buf-&gt;info.len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªåˆ†æ®µå‘é€çš„è¿‡ç¨‹ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„ä¸¤ç‚¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1ã€buf-&gt;info.lençš„é•¿åº¦éœ€è¦æ›´æ–°ä¸ºå°æ®µçš„chunkçš„é•¿åº¦ï¼Œè€Œä¸æ˜¯å¤§æ•°æ®åŒ…çš„é•¿åº¦</span><br><span class="line">2ã€æœ€åä¸€ä¸ªchunkçš„info.flagséœ€è¦å˜æˆSW_EVENT_DATA_ENDï¼Œæ„å‘³ç€ä¸€ä¸ªå®Œæ•´çš„åŒ…å·²ç»å‘å®Œäº†</span><br></pre></td></tr></table></figure>

<p><code>OK</code>ï¼Œåˆ†æå®Œäº†<code>master</code>è¿›ç¨‹å‘åŒ…çš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹<code>worker</code>è¿›ç¨‹æ”¶åŒ…çš„è¿‡ç¨‹ã€‚</p>
<p>æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å‡½æ•°<code>swWorker_onPipeReceive</code>ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">swWorker_onPipeReceive</span><span class="params">(swReactor *reactor, swEvent *event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    swServer *serv = (swServer *) reactor-&gt;ptr;</span><br><span class="line">    swFactory *factory = &amp;serv-&gt;factory;</span><br><span class="line">    swPipeBuffer *buffer = serv-&gt;pipe_buffers[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">    _read_from_pipe:</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (read(event-&gt;fd, buffer, serv-&gt;ipc_max_size) &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = swWorker_onTask(factory, (swEventData *) buffer);</span><br><span class="line">        <span class="keyword">if</span> (buffer-&gt;info.flags &amp; SW_EVENT_DATA_CHUNK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//no data</span></span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span> &amp;&amp; errno == EAGAIN)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> SW_OK;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ret &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">goto</span> _read_from_pipe;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SW_ERR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå°±æ˜¯<code>worker</code>è¿›ç¨‹æ¥æ”¶<code>master</code>è¿›ç¨‹å‘æ¥çš„æ•°æ®çš„ä»£ç ã€‚</p>
<p>æˆ‘ä»¬çœ‹çš„ï¼Œ<code>worker</code>è¿›ç¨‹ä¼šç›´æ¥æŠŠæ•°æ®å…ˆè¯»å–åˆ°<code>buffer</code>å†…å­˜é‡Œé¢ï¼Œç„¶åè°ƒç”¨<code>swWorker_onTask</code>ã€‚æˆ‘ä»¬å†æ¥çœ‹çœ‹<code>swWorker_onTask</code>å‡½æ•°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">swWorker_onTask</span><span class="params">(swFactory *factory, swEventData *task)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    swServer *serv = (swServer *) factory-&gt;ptr;</span><br><span class="line">    swWorker *worker = SwooleWG.worker;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//worker busy</span></span><br><span class="line">    worker-&gt;status = SW_WORKER_BUSY;</span><br><span class="line">    <span class="comment">//packet chunk</span></span><br><span class="line">    <span class="keyword">if</span> (task-&gt;info.flags &amp; SW_EVENT_DATA_CHUNK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (serv-&gt;merge_chunk(serv, task-&gt;info.reactor_id, task-&gt;data, task-&gt;info.len) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            swoole_error_log(SW_LOG_WARNING, SW_ERROR_SESSION_DISCARD_DATA,</span><br><span class="line">                    <span class="string">&quot;cannot merge chunk to worker buffer, data[fd=%d, size=%d] lost&quot;</span>, task-&gt;info.fd, task-&gt;info.len);</span><br><span class="line">            <span class="keyword">return</span> SW_OK;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//wait more data</span></span><br><span class="line">        <span class="keyword">if</span> (!(task-&gt;info.flags &amp; SW_EVENT_DATA_END))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> SW_OK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (task-&gt;info.type)</span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> SW_SERVER_EVENT_SEND_DATA:</span><br><span class="line">        <span class="comment">//discard data</span></span><br><span class="line">        <span class="keyword">if</span> (swWorker_discard_data(serv, task) == SW_TRUE)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        swWorker_do_task(serv, worker, task, serv-&gt;onReceive);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="comment">// çœç•¥å…¶ä»–çš„case</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        swWarn(<span class="string">&quot;[Worker] error event[type=%d]&quot;</span>, (<span class="keyword">int</span> )task-&gt;info.type);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//worker idle</span></span><br><span class="line">    worker-&gt;status = SW_WORKER_IDLE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//maximum number of requests, process will exit.</span></span><br><span class="line">    <span class="keyword">if</span> (!SwooleWG.run_always &amp;&amp; worker-&gt;request_count &gt;= SwooleWG.max_request)</span><br><span class="line">    &#123;</span><br><span class="line">        swWorker_stop(worker);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> SW_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬é‡ç‚¹çœ‹çœ‹æ€§èƒ½é—®é¢˜ä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (task-&gt;info.flags &amp; SW_EVENT_DATA_CHUNK)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (serv-&gt;merge_chunk(serv, task-&gt;info.reactor_id, task-&gt;data, task-&gt;info.len) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        swoole_error_log(SW_LOG_WARNING, SW_ERROR_SESSION_DISCARD_DATA,</span><br><span class="line">                <span class="string">&quot;cannot merge chunk to worker buffer, data[fd=%d, size=%d] lost&quot;</span>, task-&gt;info.fd, task-&gt;info.len);</span><br><span class="line">        <span class="keyword">return</span> SW_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//wait more data</span></span><br><span class="line">    <span class="keyword">if</span> (!(task-&gt;info.flags &amp; SW_EVENT_DATA_END))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> SW_OK;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œï¼Œ<code>worker</code>è¿›ç¨‹ä¼šå…ˆåˆ¤æ–­<code>master</code>å‘æ¥çš„æ•°æ®æ˜¯å¦æ˜¯<code>CHUNK</code>æ•°æ®ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆä¼šè¿›è¡Œ<code>merge_chunk</code>çš„æ“ä½œã€‚æˆ‘ä»¬çœ‹çœ‹<code>merge_chunk</code>å¯¹åº”çš„å‡½æ•°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">swServer_worker_merge_chunk</span><span class="params">(swServer *serv, <span class="keyword">int</span> key, <span class="keyword">const</span> <span class="keyword">char</span> *data, <span class="keyword">size_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    swString *package = swServer_worker_get_input_buffer(serv, key);</span><br><span class="line">    <span class="comment">//merge data to package buffer</span></span><br><span class="line">    <span class="keyword">return</span> swString_append_ptr(package, data, len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¼šå…ˆæ ¹æ®<code>key</code>çš„å€¼ï¼ˆå®é™…ä¸Šæ˜¯<code>reactor</code>çº¿ç¨‹çš„<code>id</code>ï¼‰ï¼Œè·å–ä¸€å—å…¨å±€çš„å†…å­˜ï¼Œç„¶åæŠŠæ¥æ”¶åˆ°çš„<code>chunk</code>æ•°æ®ï¼Œè¿½åŠ åˆ°è¿™ä¸ªå…¨å±€çš„å†…å­˜ä¸Šé¢ï¼Œè€Œ<code>swString_append_ptr</code>æ‰§è¡Œçš„å°±æ˜¯<code>memcpy</code>çš„æ“ä½œã€‚</p>
<p>æ‰€ä»¥ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ€§èƒ½é—®é¢˜äº†ã€‚<code>worker</code>è¿›ç¨‹æ¥æ”¶åˆ°çš„æ‰€æœ‰æ•°æ®éƒ½ä¼šè¢«å®Œæ•´çš„æ‹·è´ä¸€éã€‚å¦‚æœå®¢æˆ·ç«¯å‘æ¥çš„æ•°æ®å¾ˆå¤§ï¼Œè¿™ä¸ªæ‹·è´çš„å¼€é”€ä¹Ÿæ˜¯å¾ˆå¤§å£°çš„ã€‚</p>
<p>å› æ­¤ï¼Œæˆ‘ä»¬å¯¹è¿™éƒ¨åˆ†åˆå¹¶çš„ä»£ç è¿›è¡Œäº†ä¸€ä¸ªä¼˜åŒ–ã€‚æˆ‘ä»¬è®©<code>worker</code>è¿›ç¨‹åœ¨æ¥æ”¶<code>master</code>è¿›ç¨‹çš„æ•°æ®ä¹‹å‰ï¼Œå°±å‡†å¤‡å¥½ä¸€å—è¶³å¤Ÿå¤§çš„å†…å­˜ï¼Œç„¶åç›´æ¥æŠŠ<code>master</code>è¿›ç¨‹å‘æ¥çš„æ•°æ®ä¸‹æ¥å³å¯ã€‚</p>
<p>æˆ‘ä»¬å…ˆæ›´æ–°ä¸€ä¸‹<code>swoole-src</code>çš„æºç ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout 529ad44d578930b3607abedcfc278364df34bc73</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬ä¾æ—§å…ˆçœ‹çœ‹<code>process_send_packet</code>å‡½æ•°çš„ä»£ç ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">process_send_packet</span><span class="params">(swServer *serv, swPipeBuffer *buf, swSendData *resp, <span class="keyword">send_func_t</span> _send, <span class="keyword">void</span>* private_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* data = resp-&gt;data;</span><br><span class="line">    <span class="keyword">uint32_t</span> send_n = resp-&gt;info.len;</span><br><span class="line">    <span class="keyword">off_t</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> copy_n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint32_t</span> max_length = serv-&gt;ipc_max_size - <span class="keyword">sizeof</span>(buf-&gt;info);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (send_n &lt;= max_length)</span><br><span class="line">    &#123;</span><br><span class="line">        buf-&gt;info.flags = <span class="number">0</span>;</span><br><span class="line">        buf-&gt;info.len = send_n;</span><br><span class="line">        <span class="built_in">memcpy</span>(buf-&gt;data, data, send_n);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> retval = _send(serv, buf, <span class="keyword">sizeof</span>(buf-&gt;info) + send_n, private_data);</span><br><span class="line">        <span class="keyword">return</span> retval;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    buf-&gt;info.flags = SW_EVENT_DATA_CHUNK;</span><br><span class="line">    buf-&gt;info.len = send_n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (send_n &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (send_n &gt; max_length)</span><br><span class="line">        &#123;</span><br><span class="line">            copy_n = max_length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            buf-&gt;info.flags |= SW_EVENT_DATA_END;</span><br><span class="line">            copy_n = send_n;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memcpy</span>(buf-&gt;data, data + offset, copy_n);</span><br><span class="line"></span><br><span class="line">        swTrace(<span class="string">&quot;finish, type=%d|len=%d&quot;</span>, buf-&gt;info.type, copy_n);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (_send(serv, buf, <span class="keyword">sizeof</span>(buf-&gt;info) + copy_n, private_data) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> SW_ERR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        send_n -= copy_n;</span><br><span class="line">        offset += copy_n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SW_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬èšç„¦ä¿®æ”¹çš„åœ°æ–¹ï¼Œä¸»è¦æ˜¯å¯¹<code>CHUNK</code>çš„å¤„ç†ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">buf-&gt;info.flags = SW_EVENT_DATA_CHUNK;</span><br><span class="line">buf-&gt;info.len = send_n;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œ<code>buf-&gt;info.len</code>çš„é•¿åº¦ä¸æ˜¯æ¯ä¸ªå°æ®µ<code>chunk</code>çš„é•¿åº¦äº†ï¼Œè€Œæ˜¯æ•´ä¸ªå¤§åŒ…çš„é•¿åº¦äº†ã€‚ä¸ºä»€ä¹ˆå¯ä»¥è¿™æ ·åšå‘¢ï¼Ÿå› ä¸º<code>master</code>è¿›ç¨‹ä¸<code>worker</code>è¿›ç¨‹æ˜¯é€šè¿‡<code>udg</code>è¿›è¡Œé€šä¿¡çš„ï¼Œæ‰€ä»¥ï¼Œ<code>worker</code>è¿›ç¨‹åœ¨è°ƒç”¨<code>recv</code>çš„æ—¶å€™ï¼Œè¿”å›å€¼å®é™…ä¸Šå°±æ˜¯<code>chunk</code>çš„é•¿åº¦äº†ï¼Œæ‰€ä»¥<code>buf-&gt;info.len</code>é‡Œé¢å­˜å‚¨<code>chunk</code>çš„é•¿åº¦æ²¡æœ‰å¿…è¦ã€‚</p>
<p>å…¶ä»–åœ°æ–¹çš„é€»è¾‘å’Œä¹‹å‰çš„ä»£ç æ²¡æœ‰åŒºåˆ«ã€‚</p>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹<code>worker</code>è¿›ç¨‹æ˜¯å¦‚ä½•æ¥æ”¶<code>master</code>è¿›ç¨‹å‘æ¥çš„æ•°æ®çš„ã€‚åœ¨å‡½æ•°<code>swWorker_onPipeReceive</code>é‡Œé¢ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">swWorker_onPipeReceive</span><span class="params">(swReactor *reactor, swEvent *event)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="keyword">ssize_t</span> recv_n = <span class="number">0</span>;</span><br><span class="line">    swServer *serv = (swServer *) reactor-&gt;ptr;</span><br><span class="line">    swFactory *factory = &amp;serv-&gt;factory;</span><br><span class="line">    swPipeBuffer *pipe_buffer = serv-&gt;pipe_buffers[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">void</span> *buffer;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">iovec</span> <span class="title">buffers</span>[2];</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// peek</span></span><br><span class="line">    recv_n = recv(event-&gt;fd, &amp;pipe_buffer-&gt;info, <span class="keyword">sizeof</span>(pipe_buffer-&gt;info), MSG_PEEK);</span><br><span class="line">    <span class="keyword">if</span> (recv_n &lt; <span class="number">0</span> &amp;&amp; errno == EAGAIN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> SW_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (recv_n &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> SW_ERR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe_buffer-&gt;info.flags &amp; SW_EVENT_DATA_CHUNK)</span><br><span class="line">    &#123;</span><br><span class="line">        buffer = serv-&gt;get_buffer(serv, &amp;pipe_buffer-&gt;info);</span><br><span class="line">        _read_from_pipe:</span><br><span class="line"></span><br><span class="line">        buffers[<span class="number">0</span>].iov_base = &amp;pipe_buffer-&gt;info;</span><br><span class="line">        buffers[<span class="number">0</span>].iov_len = <span class="keyword">sizeof</span>(pipe_buffer-&gt;info);</span><br><span class="line">        buffers[<span class="number">1</span>].iov_base = buffer;</span><br><span class="line">        buffers[<span class="number">1</span>].iov_len = serv-&gt;ipc_max_size - <span class="keyword">sizeof</span>(pipe_buffer-&gt;info);</span><br><span class="line"></span><br><span class="line">        recv_n = readv(event-&gt;fd, buffers, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (recv_n &lt; <span class="number">0</span> &amp;&amp; errno == EAGAIN)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> SW_OK;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (recv_n &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            serv-&gt;add_buffer_len(serv, &amp;pipe_buffer-&gt;info, recv_n - <span class="keyword">sizeof</span>(pipe_buffer-&gt;info));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pipe_buffer-&gt;info.flags &amp; SW_EVENT_DATA_CHUNK)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//wait more chunk data</span></span><br><span class="line">            <span class="keyword">if</span> (!(pipe_buffer-&gt;info.flags &amp; SW_EVENT_DATA_END))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">goto</span> _read_from_pipe;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                pipe_buffer-&gt;info.flags |= SW_EVENT_DATA_OBJ_PTR;</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * Because we don&#x27;t want to split the swEventData parameters into swDataHead and data,</span></span><br><span class="line"><span class="comment">                 * we store the value of the worker_buffer pointer in swEventData.data.</span></span><br><span class="line"><span class="comment">                 * The value of this pointer will be fetched in the swServer_worker_get_packet function.</span></span><br><span class="line"><span class="comment">                 */</span></span><br><span class="line">                serv-&gt;copy_buffer_addr(serv, pipe_buffer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        recv_n = read(event-&gt;fd, pipe_buffer, serv-&gt;ipc_max_size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (recv_n &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ret = swWorker_onTask(factory, (swEventData *) pipe_buffer, recv_n - <span class="keyword">sizeof</span>(pipe_buffer-&gt;info));</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> SW_ERR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">recv_n = recv(event-&gt;fd, &amp;pipe_buffer-&gt;info, <span class="keyword">sizeof</span>(pipe_buffer-&gt;info), MSG_PEEK);</span><br><span class="line"><span class="keyword">if</span> (recv_n &lt; <span class="number">0</span> &amp;&amp; errno == EAGAIN)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> SW_OK;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (recv_n &lt; <span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> SW_ERR;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…ˆå¯¹å†…æ ¸ç¼“å†²åŒºé‡Œé¢çš„æ•°æ®è¿›è¡Œä¸€æ¬¡<code>peek</code>æ“ä½œï¼Œæ¥è·å–åˆ°<code>head</code>éƒ¨åˆ†ã€‚è¿™æ ·æˆ‘ä»¬å°±çŸ¥é“æ•°æ®æ˜¯å¦æ˜¯ä»¥<code>CHUNK</code>æ–¹å¼å‘æ¥çš„äº†ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (pipe_buffer-&gt;info.flags &amp; SW_EVENT_DATA_CHUNK)</span><br><span class="line">&#123;</span><br><span class="line">    buffer = serv-&gt;get_buffer(serv, &amp;pipe_buffer-&gt;info);</span><br><span class="line">    _read_from_pipe:</span><br><span class="line"></span><br><span class="line">    buffers[<span class="number">0</span>].iov_base = &amp;pipe_buffer-&gt;info;</span><br><span class="line">    buffers[<span class="number">0</span>].iov_len = <span class="keyword">sizeof</span>(pipe_buffer-&gt;info);</span><br><span class="line">    buffers[<span class="number">1</span>].iov_base = buffer;</span><br><span class="line">    buffers[<span class="number">1</span>].iov_len = serv-&gt;ipc_max_size - <span class="keyword">sizeof</span>(pipe_buffer-&gt;info);</span><br><span class="line"></span><br><span class="line">    recv_n = readv(event-&gt;fd, buffers, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (recv_n &lt; <span class="number">0</span> &amp;&amp; errno == EAGAIN)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> SW_OK;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (recv_n &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        serv-&gt;add_buffer_len(serv, &amp;pipe_buffer-&gt;info, recv_n - <span class="keyword">sizeof</span>(pipe_buffer-&gt;info));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pipe_buffer-&gt;info.flags &amp; SW_EVENT_DATA_CHUNK)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//wait more chunk data</span></span><br><span class="line">        <span class="keyword">if</span> (!(pipe_buffer-&gt;info.flags &amp; SW_EVENT_DATA_END))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">goto</span> _read_from_pipe;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            pipe_buffer-&gt;info.flags |= SW_EVENT_DATA_OBJ_PTR;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                * Because we don&#x27;t want to split the swEventData parameters into swDataHead and data,</span></span><br><span class="line"><span class="comment">                * we store the value of the worker_buffer pointer in swEventData.data.</span></span><br><span class="line"><span class="comment">                * The value of this pointer will be fetched in the swServer_worker_get_packet function.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line">            serv-&gt;copy_buffer_addr(serv, pipe_buffer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯<code>CHUNK</code>æ–¹å¼å‘æ¥çš„æ•°æ®ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‰§è¡Œå¦‚ä¸‹çš„æ“ä½œï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buffer = serv-&gt;get_buffer(serv, &amp;pipe_buffer-&gt;info);</span><br></pre></td></tr></table></figure>

<p><code>get_buffer</code>æ˜¯ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå¯¹åº”ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">swServer_worker_get_buffer</span><span class="params">(swServer *serv, swDataHead *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    swString *worker_buffer = swServer_worker_get_input_buffer(serv, info-&gt;reactor_id);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (worker_buffer-&gt;size &lt; info-&gt;len)</span><br><span class="line">    &#123;</span><br><span class="line">        swString_extend(worker_buffer, info-&gt;len);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> worker_buffer-&gt;str + worker_buffer-&gt;length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œï¼Œæˆ‘ä»¬ä¼šå…ˆåˆ¤æ–­è¿™å—å…¨å±€çš„<code>buffer</code>æ˜¯å¦è¶³å¤Ÿçš„å¤§ï¼Œå¯ä»¥æ¥æ”¶å®Œæ•´ä¸ªå¤§åŒ…ï¼Œå¦‚æœä¸å¤Ÿå¤§ï¼Œæˆ‘ä»¬æ‰©å®¹åˆ°è¶³å¤Ÿçš„å¤§ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">_read_from_pipe:</span><br><span class="line"></span><br><span class="line">buffers[<span class="number">0</span>].iov_base = &amp;pipe_buffer-&gt;info;</span><br><span class="line">buffers[<span class="number">0</span>].iov_len = <span class="keyword">sizeof</span>(pipe_buffer-&gt;info);</span><br><span class="line">buffers[<span class="number">1</span>].iov_base = buffer;</span><br><span class="line">buffers[<span class="number">1</span>].iov_len = serv-&gt;ipc_max_size - <span class="keyword">sizeof</span>(pipe_buffer-&gt;info);</span><br><span class="line"></span><br><span class="line">recv_n = readv(event-&gt;fd, buffers, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>ç„¶åï¼Œæˆ‘ä»¬è°ƒç”¨<code>readv</code>ï¼ŒæŠŠ<code>head</code>å’Œå®é™…çš„æ•°æ®åˆ†åˆ«å­˜åœ¨äº†ä¸¤ä¸ªåœ°æ–¹ã€‚è¿™ä¹ˆåšæ˜¯é¿å…ä¸ºäº†æŠŠ<code>head</code>å’Œå®é™…çš„æ•°æ®åšæ‹†åˆ†è€Œå¯¼è‡´çš„å†…å­˜æ‹·è´ã€‚</p>
<p>é€šè¿‡ä»¥ä¸Šæ–¹å¼ï¼Œ<code>Swoole Server</code>å‡å°‘äº†ä¸€æ¬¡å†…å­˜æ‹·è´ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/01/22/Swoole-Server%E4%B8%ADmaster%E8%BF%9B%E7%A8%8B%E6%8A%95%E9%80%92%E6%95%B0%E6%8D%AE%E5%88%B0worker%E8%BF%9B%E7%A8%8B%E7%9A%84%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" data-id="ckkj72zx400m6f6vx05uaazbu" data-title="Swoole Serverä¸­masterè¿›ç¨‹æŠ•é€’æ•°æ®åˆ°workerè¿›ç¨‹çš„æ€§èƒ½ä¼˜åŒ–" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-vscodeè°ƒè¯•swooleæºç " class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2020/01/14/vscode%E8%B0%83%E8%AF%95swoole%E6%BA%90%E7%A0%81/" class="article-date">
  <time class="dt-published" datetime="2020-01-14T10:39:08.000Z" itemprop="datePublished">2020-01-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2020/01/14/vscode%E8%B0%83%E8%AF%95swoole%E6%BA%90%E7%A0%81/">vscodeè°ƒè¯•swooleæºç </a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>ç¯å¢ƒï¼šMac OS X</p>
<p>æ­å»ºç¯å¢ƒå·¥å…·ï¼šDocker</p>
</blockquote>
<p>æ€è·¯æ˜¯é€šè¿‡<code>Docker</code>èµ·ä¸€ä¸ª<code>Linux</code>å®¹å™¨ï¼Œç„¶åé€šè¿‡<code>vscode</code>çš„<code>Remote-SSH</code>æ’ä»¶ç™»é™†è¿›è¿™ä¸ª<code>Linux</code>å®¹å™¨ã€‚è¿™æ ·å°±å¯ä»¥åœ¨<code>Mac OS X</code>æˆ–è€…<code>Windows</code>ä¸‹è°ƒè¯•å’Œ<code>Linux</code>ç³»ç»Ÿç›¸å…³çš„ä»£ç äº†ã€‚</p>
<p>é¦–å…ˆï¼Œ<code>git clone</code>ä¸‹æˆ‘å‡†å¤‡å¥½çš„<code>Dockerfile</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:dockero/php_centos.git</span><br></pre></td></tr></table></figure>

<p><code>php_centos</code>çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">tree</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ Dockerfile</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ docker-compose.yml</span><br><span class="line">â””â”€â”€ etc</span><br><span class="line">    â””â”€â”€ php.d</span><br><span class="line">        â”œâ”€â”€ curl.ini</span><br><span class="line">        â”œâ”€â”€ openssl.ini</span><br><span class="line">        â”œâ”€â”€ swoole.ini</span><br><span class="line">        â”œâ”€â”€ zip.ini</span><br><span class="line">        â””â”€â”€ zlib.ini</span><br><span class="line"></span><br><span class="line">2 directories, 8 files</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ï¼Œ</p>
<p><code>Dockerfile</code>ç”¨æ¥æ„å»ºé•œåƒçš„ï¼Œå·²ç»é¢„å…ˆå®‰è£…äº†<code>php</code>ã€<code>swoole</code>ä»¥åŠå…¶ä»–åŸºç¡€çš„æ‰©å±•ã€‚</p>
<p><code>docker-compose.yml</code>ä¸»è¦æ˜¯åœ¨åˆ›å»ºå®¹å™¨çš„æ—¶å€™è®¾ç½®ä¸€äº›ç¯å¢ƒå˜é‡ã€‚</p>
<p><code>etc</code>ç›®å½•åˆ™æ˜¯å­˜æ”¾<code>php</code>æ‰©å±•çš„<code>.ini</code>æ–‡ä»¶ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä¸€ä¸ªæ‰©å±•å¯¹åº”ä¸€ä¸ª<code>.ini</code>æ–‡ä»¶ã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œä½ åœ¨ç›®å½•<code>php_centos</code>ä¸‹éœ€è¦è‡ªå·±åˆ›å»ºä¸€ä¸ª<code>.env</code>æ–‡ä»¶ï¼Œç”¨æ¥æ§åˆ¶<code>swoole</code>çš„ç‰ˆæœ¬ï¼Œä»¥åŠè®¾ç½®å…¬é’¥ç­‰ã€‚</p>
<p>è¿™é‡Œæ˜¯æˆ‘çš„ä¸€ä»½æ¨¡æ¿ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HTTP_PROXY=http://127.0.0.1:8080</span><br><span class="line">HTTPS_PROXY=http://127.0.0.1:8080</span><br><span class="line">CODEDIR_VOLUME=~/codeDir:/root/codeDir</span><br><span class="line">HOST_SSH_PORT=9522</span><br><span class="line">PASSWORD=123456</span><br><span class="line">SWOOLE_VERSION=4.4.12</span><br><span class="line">SSH_PUB_KEY=å¡«å†™ä½ çš„å…¬é’¥</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªå‚æ•°åœ¨<code>README</code>é‡Œé¢éƒ½æœ‰è¯´æ˜ã€‚</p>
<p><code>OK</code>ï¼Œæˆ‘ä»¬ç¼–è¯‘é•œåƒï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose build</span><br></pre></td></tr></table></figure>

<p>ç„¶åå¯åŠ¨å®¹å™¨ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<p>ä¹‹åï¼Œæˆ‘ä»¬æ‰§è¡Œå‘½ä»¤ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh php</span><br></pre></td></tr></table></figure>

<p>å³å¯ç™»é™†å®¹å™¨äº†ã€‚ï¼ˆå¦‚æœåœ¨ç™»é™†å®¹å™¨çš„æ—¶å€™ï¼Œéœ€è¦è¾“å…¥å¯†ç ï¼Œä½ å¯ä»¥æ‰§è¡Œå‘½ä»¤<code>ssh-add ç§é’¥</code>æ¥å…å¯†ç™»é™†ï¼‰</p>
<p>ç„¶åï¼Œæˆ‘ä»¬éœ€è¦åœ¨<code>vscode</code>çš„åŒä¸€ä¸ªå·¥ä½œåŒºé‡Œé¢å­˜æ”¾<code>PHP</code>æºç ã€<code>Swoole</code>æºç ã€<code>PHP</code>æµ‹è¯•è„šæœ¬ã€<code>.vscode</code>ç›®å½•ã€‚æ‰€æœ‰éœ€è¦çš„ä¸œè¥¿å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tree -L 1</span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ test.php</span><br><span class="line">â”œâ”€â”€ php-7.3.12</span><br><span class="line">â”œâ”€â”€ swoole-src</span><br><span class="line">â””â”€â”€ .vscode</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨<code>.vscode</code>ç›®å½•é‡Œé¢åˆ›å»ºæ–‡ä»¶<code>launch.json</code>ï¼š</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ IntelliSense äº†è§£ç›¸å…³å±æ€§ã€‚ </span></span><br><span class="line">    <span class="comment">// æ‚¬åœä»¥æŸ¥çœ‹ç°æœ‰å±æ€§çš„æè¿°ã€‚</span></span><br><span class="line">    <span class="comment">// æ¬²äº†è§£æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®: https://go.microsoft.com/fwlink/?linkid=830387</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;0.2.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;configurations&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;debug swoole&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;cppdbg&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;request&quot;</span>: <span class="string">&quot;launch&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;program&quot;</span>: <span class="string">&quot;/usr/bin/php&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;args&quot;</span>: [<span class="string">&quot;$&#123;file&#125;&quot;</span>],</span><br><span class="line">            <span class="attr">&quot;stopAtEntry&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;cwd&quot;</span>: <span class="string">&quot;$&#123;workspaceFolder&#125;&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;environment&quot;</span>: [],</span><br><span class="line">            <span class="attr">&quot;externalConsole&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">&quot;MIMode&quot;</span>: <span class="string">&quot;gdb&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;setupCommands&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;ä¸º gdb å¯ç”¨æ•´é½æ‰“å°&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;text&quot;</span>: <span class="string">&quot;-enable-pretty-printing&quot;</span>,</span><br><span class="line">                    <span class="attr">&quot;ignoreFailures&quot;</span>: <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨<code>vscode</code>æ‰“å¼€æµ‹è¯•è„šæœ¬<code>test.php</code>ï¼Œå¹¶ä¸”åœç•™åœ¨è¿™ä¸ªçª—å£ï¼ˆæ³¨æ„ï¼Œå¿…é¡»åœ¨åœç•™<code>test.php</code>çª—å£çš„æ—¶å€™ç‚¹å‡»è°ƒè¯•æ‰è¡Œï¼‰ï¼Œç„¶åç‚¹å‡»è°ƒè¯•æŒ‰é’®å³å¯è¿›è¡Œ<code>Swoole</code>æºç çš„è°ƒè¯•äº†ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2020/01/14/vscode%E8%B0%83%E8%AF%95swoole%E6%BA%90%E7%A0%81/" data-id="ckkj72zsw005jf6vxa6zkdzd7" data-title="vscodeè°ƒè¯•swooleæºç " class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E8%B0%83%E8%AF%95/" rel="tag">è°ƒè¯•</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-æ·±å…¥ç†è§£è¿æ¥æ± " class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/12/09/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%BF%9E%E6%8E%A5%E6%B1%A0/" class="article-date">
  <time class="dt-published" datetime="2019-12-09T13:13:23.000Z" itemprop="datePublished">2019-12-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/12/09/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%BF%9E%E6%8E%A5%E6%B1%A0/">æ·±å…¥ç†è§£è¿æ¥æ± </a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <blockquote>
<p>é•¿è¿æ¥æœ€å¤§çš„é—®é¢˜å°±æ˜¯è¿æ¥å¤±æ•ˆã€‚</p>
</blockquote>
<h2 id="redis-mysqlç­‰æœåŠ¡å™¨ä¸ºä»€ä¹ˆä¼šé™åˆ¶æœ€å¤§è¿æ¥æ•°"><a href="#redis-mysqlç­‰æœåŠ¡å™¨ä¸ºä»€ä¹ˆä¼šé™åˆ¶æœ€å¤§è¿æ¥æ•°" class="headerlink" title="redis/mysqlç­‰æœåŠ¡å™¨ä¸ºä»€ä¹ˆä¼šé™åˆ¶æœ€å¤§è¿æ¥æ•°"></a>redis/mysqlç­‰æœåŠ¡å™¨ä¸ºä»€ä¹ˆä¼šé™åˆ¶æœ€å¤§è¿æ¥æ•°</h2><h3 id="å†…æ ¸è§’åº¦ï¼Œè¿‡å¤šçš„TCPè¿æ¥éå¸¸çš„ä¸ç¯ä¿"><a href="#å†…æ ¸è§’åº¦ï¼Œè¿‡å¤šçš„TCPè¿æ¥éå¸¸çš„ä¸ç¯ä¿" class="headerlink" title="å†…æ ¸è§’åº¦ï¼Œè¿‡å¤šçš„TCPè¿æ¥éå¸¸çš„ä¸ç¯ä¿"></a>å†…æ ¸è§’åº¦ï¼Œè¿‡å¤šçš„TCPè¿æ¥éå¸¸çš„ä¸ç¯ä¿</h3><p>é¦–å…ˆï¼Œè¿‡å¤šçš„å†…å­˜å ç”¨ï¼Œå°¤å…¶æ˜¯é˜»å¡çš„æƒ…å†µä¸‹ã€‚</p>
<p>ä¾‹å¦‚å¦‚ä¸‹ä»£ç ã€‚</p>
<p>æœåŠ¡å™¨ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$serv = <span class="keyword">new</span> Swoole\Server(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6666</span>, SWOOLE_BASE);</span><br><span class="line">$serv-&gt;set(<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;worker_num&#x27;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">));</span><br><span class="line"></span><br><span class="line">$serv-&gt;on(<span class="string">&#x27;connect&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd</span>) </span>&#123;</span><br><span class="line">    var_dump(<span class="string">&quot;Client: Connect <span class="subst">$fd</span>&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$serv-&gt;on(<span class="string">&#x27;receive&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd, $reactor_id, $data</span>) </span>&#123;</span><br><span class="line">    var_dump(strlen($data));</span><br><span class="line">    sleep(<span class="number">100000</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$serv-&gt;on(<span class="string">&#x27;close&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd</span>) </span>&#123;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$serv-&gt;start();</span><br></pre></td></tr></table></figure>

<p>ä»£ç å¾ˆç®€å•ï¼ŒæœåŠ¡å™¨åœ¨ç¬¬ä¸€æ¬¡æ”¶åˆ°æ•°æ®çš„æ—¶å€™ï¼Œå°±è°ƒç”¨<code>sleep</code>å‡½æ•°é˜»å¡èµ·æ¥ã€‚ï¼ˆå› ä¸ºåªæœ‰ä¸€ä¸ª<code>worker</code>è¿›ç¨‹ï¼Œæ‰€ä»¥åé¢ä¸ä¼šå¤„ç†å®¢æˆ·ç«¯å‘æ¥çš„å…¶ä»–æ•°æ®ï¼‰</p>
<p>å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Coroutine</span>\<span class="title">Socket</span>;</span><br><span class="line"></span><br><span class="line">$socket = <span class="keyword">new</span> Socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">go(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$socket</span>) </span>&#123;</span><br><span class="line">    $socket-&gt;connect(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">6666</span>);</span><br><span class="line"></span><br><span class="line">    $i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ($i++ &lt; <span class="number">100000000</span>) &#123;</span><br><span class="line">        var_dump($socket-&gt;send(str_repeat(<span class="string">&quot;1&quot;</span>, <span class="number">1024</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;done\n&quot;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>ä»£ç å¾ˆç®€å•ï¼Œå°±æ˜¯åˆ›å»ºä¸€ä¸ªåç¨‹ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå¾€æœåŠ¡å™¨å‘é€æ•°æ®ã€‚ä¸€å…±å‘é€äº†<code>100000000 * 1024</code>å­—èŠ‚çš„æ•°æ®ã€‚</p>
<p>æˆ‘ä»¬å…ˆå¯åŠ¨æœåŠ¡å™¨ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@aaeb2c267d0f test]# php server.php</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç„¶åå†å¯åŠ¨å®¢æˆ·ç«¯ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@aaeb2c267d0f test]# php client.php</span><br><span class="line"><span class="meta">#</span><span class="bash"> çœç•¥å…¶ä»–çš„è¾“å‡º</span></span><br><span class="line">int(1024)</span><br><span class="line">int(1024)</span><br><span class="line">int(1024)</span><br><span class="line">int(1024)</span><br><span class="line">int(1024)</span><br><span class="line">int(617)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œå®¢æˆ·ç«¯ç¨‹åºä¼šé˜»å¡ä½ã€‚</p>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹æœåŠ¡å™¨ç«¯è¿™è¾¹çš„è¾“å‡ºï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@aaeb2c267d0f test]# php server.php</span><br><span class="line">string(17) &quot;Client: Connect 1&quot;</span><br><span class="line">int(6144)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼ŒæœåŠ¡å™¨è¯»å–åˆ°äº†<code>6144</code>å­—èŠ‚çš„æ•°æ®ä¹‹åï¼Œå°±æ²¡æœ‰ç»§ç»­å†è¯»å–äº†ã€‚ï¼ˆæˆ‘ä»¬å‘ç°ï¼ŒæœåŠ¡å™¨ç«¯è¯»å–åˆ°çš„å­—èŠ‚å¤§å°ä¸ä¸€å®šæ˜¯<code>1024</code>ï¼Œè¿™ä¹Ÿè¯´æ˜äº†<code>TCP</code>æ˜¯é¢å‘å­—èŠ‚æµçš„ï¼Œæ¯æ¬¡è°ƒç”¨<code>send</code>å‡½æ•°ï¼Œæ•°æ®ä¸ä¸€å®šå°±ä¼šç«‹é©¬å‘é€è¿‡å»ã€‚åŒç†ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿä¸ä¼šæ”¶åˆ°æ•°æ®åå°±ç«‹é©¬è¯»å–ï¼‰</p>
<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å…³é—­å®¢æˆ·ç«¯è¿™è¾¹çš„è¿›ç¨‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">^C</span><br><span class="line">[root@aaeb2c267d0f test]#</span><br></pre></td></tr></table></figure>

<p>ç„¶åæŸ¥çœ‹<code>socket</code>å†…æ ¸ç¼“å­˜åŒºçš„çŠ¶æ€ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@aaeb2c267d0f test]# cat /proc/net/sockstat</span><br><span class="line">sockets: used 177</span><br><span class="line">TCP: inuse 7 orphan 1 tw 0 alloc 15 mem 1211</span><br><span class="line">UDP: inuse 1 mem 2</span><br><span class="line">UDPLITE: inuse 0</span><br><span class="line">RAW: inuse 0</span><br><span class="line">FRAG: inuse 0 memory 0</span><br><span class="line">[root@aaeb2c267d0f test]#</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°å†…æ ¸ç¼“å†²åŒºæ˜¯æœ‰æ•°æ®æ²¡æœ‰è¢«æ¸…ç©ºçš„ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å‘ç°ï¼Œå½“æœåŠ¡å™¨è¿›ç¨‹å› ä¸ºä¸€ä¸ª<code>socket</code>è€Œè¢«é˜»å¡èµ·æ¥äº†ï¼Œé‚£ä¹ˆåç»­çš„è¿æ¥éƒ½æ— æ³•è¢«å¤„ç†ï¼Œå¯¼è‡´å†…å­˜å ç”¨ä¸¥é‡ã€‚</p>
<p>å…¶æ¬¡ï¼Œè¿‡å¤šçš„ç«¯å£å ç”¨ã€fdå ç”¨ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª<code>TCP</code>è‡ªè¿æ¥çš„é—®é¢˜ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Coroutine</span>\<span class="title">Socket</span>;</span><br><span class="line"></span><br><span class="line">$socket = <span class="keyword">new</span> Socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">go(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$socket</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt; <span class="number">65536</span>; $i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($socket-&gt;connect(<span class="string">&#x27;127.0.0.1&#x27;</span>, $i)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;connected\n&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    var_dump($i);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@aaeb2c267d0f test]# php client.php</span><br><span class="line">connected</span><br><span class="line">int(43991)</span><br><span class="line">[root@aaeb2c267d0f test]#</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œå¦‚æœæˆ‘ä»¬ä¸é™åˆ¶è¿æ¥çš„ä¸ªæ•°ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯å¾ˆå¯èƒ½å°±ä¼šè€—å°½å¯ç”¨çš„ç«¯å£ã€‚å¯ç”¨çš„ç«¯å£èŒƒå›´å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@aaeb2c267d0f test]# sysctl -a | grep ip_local_port_range</span><br><span class="line">net.ipv4.ip_local_port_range = 32768    60999</span><br></pre></td></tr></table></figure>

<h4 id="ä¼ è¾“æ•ˆç‡é—®é¢˜"><a href="#ä¼ è¾“æ•ˆç‡é—®é¢˜" class="headerlink" title="ä¼ è¾“æ•ˆç‡é—®é¢˜"></a>ä¼ è¾“æ•ˆç‡é—®é¢˜</h4><p>å› ä¸ºé•¿è¿æ¥å¯ä»¥å‡å°‘<code>TCP</code>ä¸‰æ¬¡æ¡æ‰‹çš„æ—¶é—´ï¼Œæ‰€ä»¥é•¿è¿æ¥çš„æ•ˆç‡ä¼šé«˜äºçŸ­è¿æ¥ï¼ˆçŸ­è¿æ¥æ¯æ¬¡å‘é€æ•°æ®éœ€è¦è¿›è¡Œä¸‰æ¬¡æ¡æ‰‹ï¼‰ã€‚</p>
<p>ç»¼ä¸Šï¼Œæˆ‘ä»¬è¦æ§åˆ¶é•¿è¿æ¥çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨é™åˆ¶äº†æœ€å¤§è¿æ¥æ•°çš„æƒ…å†µä¸‹ï¼Œè¿æ¥å¼¥è¶³çè´µã€‚é‚£æˆ‘ä»¬ç¡®å®æœ‰é‚£ä¹ˆå¤šè¿›ç¨‹æ€ä¹ˆåŠï¼Œåªèƒ½å°½å¯èƒ½æé«˜åˆ©ç”¨ç‡ï¼Œå…±äº«è¿æ¥ã€‚</p>
<h2 id="å…±äº«è¿æ¥æ± "><a href="#å…±äº«è¿æ¥æ± " class="headerlink" title="å…±äº«è¿æ¥æ± "></a>å…±äº«è¿æ¥æ± </h2><h3 id="å¤šåç¨‹å…±äº«è¿æ¥"><a href="#å¤šåç¨‹å…±äº«è¿æ¥" class="headerlink" title="å¤šåç¨‹å…±äº«è¿æ¥"></a>å¤šåç¨‹å…±äº«è¿æ¥</h3><p>å½“åç¨‹éœ€è¦ä½¿ç”¨ä¸€ä¸ªè¿æ¥çš„æ—¶å€™ï¼Œå¯ä»¥ä»<code>Channel</code>é‡Œé¢<code>pop</code>å‡ºæ¥ä¸€ä¸ªè¿æ¥ã€‚</p>
<h3 id="å¤šè¿›ç¨‹å…±äº«è¿æ¥"><a href="#å¤šè¿›ç¨‹å…±äº«è¿æ¥" class="headerlink" title="å¤šè¿›ç¨‹å…±äº«è¿æ¥"></a>å¤šè¿›ç¨‹å…±äº«è¿æ¥</h3><h3 id="è·¨æœºå™¨å…±äº«è¿æ¥"><a href="#è·¨æœºå™¨å…±äº«è¿æ¥" class="headerlink" title="è·¨æœºå™¨å…±äº«è¿æ¥"></a>è·¨æœºå™¨å…±äº«è¿æ¥</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/12/09/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E8%BF%9E%E6%8E%A5%E6%B1%A0/" data-id="ckkj72zum00aqf6vx286dacjo" data-title="æ·±å…¥ç†è§£è¿æ¥æ± " class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swoole%E5%BE%AE%E8%AF%BE%E7%A8%8B/" rel="tag">Swooleå¾®è¯¾ç¨‹</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-php-stream-serveræºç åˆ†æ" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/11/27/php-stream-server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2019-11-27T14:14:14.000Z" itemprop="datePublished">2019-11-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/11/27/php-stream-server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">php stream serveræºç åˆ†æ--stream_socket_server</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å¼€å§‹æ¥åˆ†æä¸€ä¸‹<code>php stream server</code>çš„æºç ï¼Œä¸ºåé¢æˆ‘ä»¬<code>hook</code> <code>php stream server</code>åšå‡†å¤‡ã€‚<code>PHP</code>ç‰ˆæœ¬æ˜¯<code>7.1.0</code>ã€‚</p>
<p>æˆ‘ä»¬çš„è°ƒè¯•ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$socket = stream_socket_server(</span><br><span class="line">    <span class="string">&#x27;tcp://0.0.0.0:6666&#x27;</span>,</span><br><span class="line">    $errno, $errstr, STREAM_SERVER_BIND | STREAM_SERVER_LISTEN</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>å¼€å§‹è°ƒè¯•ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh-4.2# cgdb php</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…ˆåœ¨<code>php_init_stream_wrappers</code>å¤„æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b php_init_stream_wrappers</span><br><span class="line">Breakpoint 1 at 0x7df8aa: file /root/php-7.1.0/main/streams/streams.c, line 1651.</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿è¡Œä»£ç ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(gdb) r test.php</span><br><span class="line">Starting program: /home/codes/php/php-7.1.0/output/bin/php test.php</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library &quot;/lib64/libthread_db.so.1&quot;.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, php_init_stream_wrappers (module_number=0) at /root/php-7.1.0/main/streams/streams.c:1651</span><br><span class="line">Missing separate debuginfos, use: debuginfo-install glibc-2.17-260.el7_6.4.x86_64 libxml2-2.9.1-6.el7_2.3.x86_64 nss-softokn-freebl-3.36.0-5.el7_5.x86_64 xz-libs-5.2.2-1.el7.x86_64 zlib-1.2.7-18.el7.x86_6</span><br><span class="line">4</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line">1649â”‚ int php_init_stream_wrappers(int module_number)</span><br><span class="line">1650â”‚ &#123;</span><br><span class="line">1651â”œâ”€â”€â”€â”€â”€â”€â”€&gt; le_stream = zend_register_list_destructors_ex(stream_resource_regular_dtor, NULL, &quot;stream&quot;, module_number);</span><br><span class="line">1652â”‚         le_pstream = zend_register_list_destructors_ex(NULL, stream_resource_persistent_dtor, &quot;persistent stream&quot;, module_number);</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶æ–­ç‚¹è§¦å‘ã€‚</p>
<p>ç„¶åï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹å‡½æ•°è°ƒç”¨æ ˆï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line"><span class="meta">#</span><span class="bash">0  php_init_stream_wrappers (module_number=0) at /root/php-7.1.0/main/streams/streams.c:1651</span></span><br><span class="line"><span class="meta">#</span><span class="bash">1  0x00000000007bfe8b <span class="keyword">in</span> php_module_startup (sf=0x10b8c20 &lt;cli_sapi_module&gt;, additional_modules=0x0, num_additional_modules=0) at /root/php-7.1.0/main/main.c:2227</span></span><br><span class="line"><span class="meta">#</span><span class="bash">2  0x000000000092e814 <span class="keyword">in</span> php_cli_startup (sapi_module=0x10b8c20 &lt;cli_sapi_module&gt;) at /root/php-7.1.0/sapi/cli/php_cli.c:424</span></span><br><span class="line"><span class="meta">#</span><span class="bash">3  0x0000000000930767 <span class="keyword">in</span> main (argc=2, argv=0x10dc280) at /root/php-7.1.0/sapi/cli/php_cli.c:1345</span></span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨<code>PHP</code>å¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå»è°ƒç”¨<code>php_init_stream_wrappers</code>è¿™ä¸ªå‡½æ•°ã€‚æˆ‘ä»¬ç»§ç»­çœ‹çœ‹<code>php_init_stream_wrappers</code>è¿™ä¸ªå‡½æ•°åšäº†ä»€ä¹ˆäº‹æƒ…ã€‚è¿è¡Œåˆ°<code>1661</code>ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u 1661</span><br><span class="line"></span><br><span class="line">1661â”œâ”€â”€â”€â”€â”€â”€â”€&gt; return (php_stream_xport_register(&quot;tcp&quot;, php_stream_generic_socket_factory) == SUCCESS</span><br><span class="line">1662â”‚                         &amp;&amp;</span><br><span class="line">1663â”‚                         php_stream_xport_register(&quot;udp&quot;, php_stream_generic_socket_factory) == SUCCESS</span><br><span class="line">1664â”‚ #if defined(AF_UNIX) &amp;&amp; !(defined(PHP_WIN32) || defined(__riscos__) || defined(NETWARE))</span><br><span class="line">1665â”‚                         &amp;&amp;</span><br><span class="line">1666â”‚                         php_stream_xport_register(&quot;unix&quot;, php_stream_generic_socket_factory) == SUCCESS</span><br><span class="line">1667â”‚                         &amp;&amp;</span><br><span class="line">1668â”‚                         php_stream_xport_register(&quot;udg&quot;, php_stream_generic_socket_factory) == SUCCESS</span><br><span class="line">1669â”‚ #endif</span><br><span class="line">1670â”‚                 ) ? SUCCESS : FAILURE;</span><br></pre></td></tr></table></figure>

<p>åœåœ¨äº†æ‰§è¡Œ<code>php_stream_xport_register</code>è¿™ä¸ªä½ç½®ã€‚æ ¹æ®åå­—æˆ‘ä»¬å¤§æ¦‚å¯ä»¥çŒœå‡ºæ¥ï¼Œè¿™ä¸ªå‡½æ•°åº”è¯¥æ˜¯å»æ³¨å†ŒæŸä¸ªä¸œè¥¿ã€‚æˆ‘ä»¬è¿›å…¥è¿™ä¸ªå‡½æ•°ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">php_stream_xport_register (protocol=0xd770bf &quot;tcp&quot;, factory=0x7f006f &lt;php_stream_generic_socket_factory&gt;) at /root/php-7.1.0/main/streams/transports.c:34</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line"> 32â”‚ PHPAPI int php_stream_xport_register(const char *protocol, php_stream_transport_factory factory)</span><br><span class="line"> 33â”‚ &#123;</span><br><span class="line"> 34â”œâ”€â”€â”€â”€â”€â”€â”€&gt; return zend_hash_str_update_ptr(&amp;xport_hash, protocol, strlen(protocol), factory) ? SUCCESS : FAILURE;</span><br><span class="line"> 35â”‚ &#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªå‡½æ•°å®é™…ä¸Šå°±æ˜¯æ›´æ–°ä¸€ä¸‹<code>xport_hash</code>è¿™ä¸ª<code>hash</code>è¡¨ï¼Œå“ˆå¸Œè¡¨é‡Œé¢å­˜çš„ä¸œè¥¿æ˜¯<code>factory</code>ã€‚<code>factory</code>æ˜¯<code>php_stream_transport_factory</code>ç±»å‹ã€‚æˆ‘ä»¬çœ‹ä¸€çœ‹<code>php_stream_transport_factory</code>å…·ä½“æ˜¯ä»€ä¹ˆæ ·å­çš„ã€‚åœ¨æ–‡ä»¶<code>php_stream_transport.h</code>é‡Œé¢ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> php_stream *(php_stream_transport_factory_func)(<span class="keyword">const</span> <span class="keyword">char</span> *proto, <span class="keyword">size_t</span> protolen,</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *resourcename, <span class="keyword">size_t</span> resourcenamelen,</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *persistent_id, <span class="keyword">int</span> options, <span class="keyword">int</span> flags,</span><br><span class="line">        struct timeval *timeout,</span><br><span class="line">        php_stream_context *context STREAMS_DC);</span><br><span class="line"><span class="keyword">typedef</span> php_stream_transport_factory_func *php_stream_transport_factory;</span><br><span class="line">PHPAPI php_stream_transport_factory_func php_stream_generic_socket_factory;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹çš„ï¼Œ<code>php_stream_generic_socket_factory</code>æ˜¯<code>php_stream_transport_factory_func</code>ç±»å‹çš„å˜é‡ã€‚è€Œ<code>php_stream_transport_factory_func</code>æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆçš„ç±»å‹ã€‚è¿”å›å€¼æ˜¯<code>php_stream *</code>ï¼Œå‚æ•°æ˜¯ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *proto, <span class="keyword">size_t</span> protolen,</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *resourcename, <span class="keyword">size_t</span> resourcenamelen,</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *persistent_id, <span class="keyword">int</span> options, <span class="keyword">int</span> flags,</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> *<span class="title">timeout</span>,</span></span><br><span class="line"><span class="class"><span class="title">php_stream_context</span> *<span class="title">context</span> <span class="title">STREAMS_DC</span></span></span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šphp_stream_xport_registeræ³¨å†Œäº†ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè¿™ä¸ªå‡½æ•°æŒ‡é’ˆæ˜¯<code>php_stream_transport_factory_func</code>ç±»å‹çš„å‡½æ•°æŒ‡é’ˆã€‚</p>
<p><code>OK</code>ï¼Œæˆ‘ä»¬ç»§ç»­ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) finish</span><br><span class="line">Run till exit from #0  php_stream_xport_register (protocol=0xd770bf &quot;tcp&quot;, factory=0x7f006f &lt;php_stream_generic_socket_factory&gt;) at /root/php-7.1.0/main/streams/transports.c:34</span><br><span class="line">php_init_stream_wrappers (module_number=0) at /root/php-7.1.0/main/streams/streams.c:1670</span><br><span class="line">Value returned is $1 = 0</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line">1670â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt; ) ? SUCCESS : FAILURE;</span><br><span class="line">1671â”‚ &#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ï¼Œ<code>php_init_stream_wrappers</code>çš„ä½œç”¨å°±æ˜¯å»æ³¨å†Œ<code>PHP</code>é»˜è®¤çš„<code>php_stream</code>å‡½æ•°ã€‚ç„¶åï¼Œæˆ‘ä»¬åœ¨å‡½æ•°<code>zif_stream_socket_server</code>å¤„æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b zif_stream_socket_server</span><br><span class="line">Breakpoint 3 at 0x7a3c9a: file /root/php-7.1.0/ext/standard/streamsfuncs.c, line 179.</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>ç„¶åç»§ç»­è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 2, zif_stream_socket_server (execute_data=0x7ffff5e140d0, return_value=0x7ffff5e140b0) at /root/php-7.1.0/ext/standard/streamsfuncs.c:179</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line"> 175â”‚ PHP_FUNCTION(stream_socket_server)</span><br><span class="line"> 176â”‚ &#123;</span><br><span class="line"> 177â”‚         char *host;</span><br><span class="line"> 178â”‚         size_t host_len;</span><br><span class="line"> 179â”œâ”€â”€â”€â”€â”€â”€â”€&gt; zval *zerrno = NULL, *zerrstr = NULL, *zcontext = NULL;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ï¼Œå·²ç»è¿›å…¥äº†æˆ‘ä»¬<code>PHP</code>è„šæœ¬å†™çš„<code>stream_socket_server</code>é‡Œé¢äº†ã€‚æˆ‘ä»¬ç»§ç»­æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°å®ç°äº†ä»€ä¹ˆã€‚æˆ‘ä»¬è¿è¡Œåˆ°<code>207</code>è¡Œä¹‹å‰ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u 207</span><br><span class="line">zif_stream_socket_server (execute_data=0x7ffff5e140d0, return_value=0x7ffff5e140b0) at /root/php-7.1.0/ext/standard/streamsfuncs.c:207</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line"> 207â”œâ”€â”€â”€â”€â”€â”€â”€&gt; stream = php_stream_xport_create(host, host_len, REPORT_ERRORS,</span><br><span class="line"> 208â”‚                         STREAM_XPORT_SERVER | (int)flags,</span><br><span class="line"> 209â”‚                         NULL, NULL, context, &amp;errstr, &amp;err);</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>php_stream_xport_create</code>å‡½æ•°ä¼šä¾æ®æˆ‘ä»¬ä¼ å…¥çš„<code>host</code>ã€<code>flag</code>ç­‰ä¿¡æ¯åˆ›å»ºå‡ºä¸€ä¸ª<code>stream</code>ã€‚æˆ‘ä»¬å¾ˆå®¹æ˜“çš„å¯ä»¥çŒœåˆ°ï¼Œè¿™ä¸ªåº”è¯¥å°±æ˜¯<code>php_stream *</code>ç±»å‹çš„æŒ‡é’ˆã€‚æˆ‘ä»¬è¿›å…¥<code>php_stream_xport_create</code>å‡½æ•°é‡Œé¢ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">_php_stream_xport_create (name=0x7ffff5e027e8 &quot;tcp://0.0.0.0:6666&quot;, namelen=18, options=8, flags=13, persistent_id=0x0, timeout=0x0, context=0x7ffff5e01640, error_string=0x7fffffffb308, error_code=0x7ffff</span><br><span class="line">fffb31c, __php_stream_call_depth=0, __zend_filename=0xd6ffb0 &quot;/root/php-7.1.0/ext/standard/streamsfuncs.c&quot;, __zend_lineno=209, __zend_orig_filename=0x0, __zend_orig_lineno=0) at /root/php-7.1.0/main/strea</span><br><span class="line">ms/transports.c:60</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line"> 52â”‚ PHPAPI php_stream *_php_stream_xport_create(const char *name, size_t namelen, int options,</span><br><span class="line"> 53â”‚                 int flags, const char *persistent_id,</span><br><span class="line"> 54â”‚                 struct timeval *timeout,</span><br><span class="line"> 55â”‚                 php_stream_context *context,</span><br><span class="line"> 56â”‚                 zend_string **error_string,</span><br><span class="line"> 57â”‚                 int *error_code</span><br><span class="line"> 58â”‚                 STREAMS_DC)</span><br><span class="line"> 59â”‚ &#123;</span><br><span class="line"> 60â”œâ”€â”€â”€â”€â”€â”€â”€&gt; php_stream *stream = NULL;</span><br><span class="line"> 61â”‚         php_stream_transport_factory factory = NULL;</span><br><span class="line"> 62â”‚         const char *p, *protocol = NULL;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹çš„ï¼Œ<code>php_stream_xport_create</code>ç¡®å®ä¼šåˆ›å»ºä¸€ä¸ª<code>php_stream</code>ç±»å‹çš„æŒ‡é’ˆã€‚æˆ‘ä»¬ç»§ç»­è¿è¡Œåˆ°<code>109</code>è¡Œä¹‹å‰ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u 109</span><br><span class="line">_php_stream_xport_create (name=0x7ffff5e027ee &quot;0.0.0.0:6666&quot;, namelen=12, options=8, flags=13, persistent_id=0x0, timeout=0x7fffffffb230, context=0x7ffff5e01640, error_string=0x7fffffffb308, error_code=0x</span><br><span class="line">7fffffffb31c, __php_stream_call_depth=0, __zend_filename=0xd6ffb0 &quot;/root/php-7.1.0/ext/standard/streamsfuncs.c&quot;, __zend_lineno=209, __zend_orig_filename=0x0, __zend_orig_lineno=0) at /root/php-7.1.0/main/</span><br><span class="line">streams/transports.c:109</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line">109â”œâ”€â”€â”€â”€â”€â”€â”€&gt; if (protocol) &#123;</span><br><span class="line">110â”‚                 char *tmp = estrndup(protocol, n);</span><br><span class="line">111â”‚                 if (NULL == (factory = zend_hash_str_find_ptr(&amp;xport_hash, tmp, n))) &#123;</span><br><span class="line">112â”‚                         char wrapper_name[32];</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œåœ¨<code>111</code>è¡Œä¼šæ ¹æ®<code>protocol</code>çš„å†…å®¹ï¼ˆåœ¨è¿™ä¸ªæµ‹è¯•è„šæœ¬ä¸­<code>protocol</code>æ˜¯<code>tcp</code>ï¼‰å»<code>xport_hash</code>è¿™ä¸ª<code>hash</code>è¡¨é‡Œé¢æŸ¥æ‰¾<code>factory</code>ï¼Œè€Œè¿™ä¸ª<code>factory</code>åº”è¯¥å°±æ˜¯æˆ‘ä»¬ä¹‹å‰æ³¨å†Œçš„é‚£ä¸ªå‡½æ•°æŒ‡é’ˆã€‚æˆ‘ä»¬ç»§ç»­æ‰§è¡Œåˆ°<code>126</code>è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u 126</span><br><span class="line">_php_stream_xport_create (name=0x7ffff5e027ee &quot;0.0.0.0:6666&quot;, namelen=12, options=8, flags=13, persistent_id=0x0, timeout=0x7fffffffb230, context=0x7ffff5e01640, error_string=0x7fffffffb308, error_code=0x</span><br><span class="line">7fffffffb31c, __php_stream_call_depth=0, __zend_filename=0xd6ffb0 &quot;/root/php-7.1.0/ext/standard/streamsfuncs.c&quot;, __zend_lineno=209, __zend_orig_filename=0x0, __zend_orig_lineno=0) at /root/php-7.1.0/main/</span><br><span class="line">streams/transports.c:127</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line">127â”œâ”€â”€â”€â”€â”€â”€â”€&gt; if (factory == NULL) &#123;</span><br><span class="line">128â”‚                 /* should never happen */</span><br><span class="line">129â”‚                 php_error_docref(NULL, E_WARNING, &quot;Could not find a factory !?&quot;);</span><br><span class="line">130â”‚                 return NULL;</span><br><span class="line">131â”‚         &#125;</span><br><span class="line">132â”‚</span><br><span class="line">133â”‚         stream = (factory)(protocol, n,</span><br><span class="line">134â”‚                         (char*)name, namelen, persistent_id, options, flags, timeout,</span><br><span class="line">135â”‚                         context STREAMS_REL_CC);</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œåœ¨<code>133</code>è¡Œè¿™ä¸ªä½ç½®ä¼šå»è°ƒç”¨<code>factory</code>è¿™ä¸ªå‡½æ•°ï¼Œå¹¶ä¸”åˆ›å»ºå‡ºä¸€ä¸ª<code>stream</code>ã€‚æˆ‘ä»¬ç»§ç»­è¿è¡Œï¼Œè¿›å…¥<code>factory</code>å¯¹åº”çš„å‡½æ•°é‡Œé¢ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) s</span><br><span class="line">php_stream_generic_socket_factory (proto=0x7ffff5e027e8 &quot;tcp://0.0.0.0:6666&quot;, protolen=3, resourcename=0x7ffff5e027ee &quot;0.0.0.0:6666&quot;, resourcenamelen=12, persistent_id=0x0, options=8, flags=13, timeout=0x</span><br><span class="line">7fffffffb230, context=0x7ffff5e01640, __php_stream_call_depth=1, __zend_filename=0xd788d0 &quot;/root/php-7.1.0/main/streams/transports.c&quot;, __zend_lineno=135, __zend_orig_filename=0xd6ffb0 &quot;/root/php-7.1.0/ext</span><br><span class="line">/standard/streamsfuncs.c&quot;, __zend_orig_lineno=209) at /root/php-7.1.0/main/streams/xp_socket.c:884</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line">878â”‚ PHPAPI php_stream *php_stream_generic_socket_factory(const char *proto, size_t protolen,</span><br><span class="line">879â”‚                 const char *resourcename, size_t resourcenamelen,</span><br><span class="line">880â”‚                 const char *persistent_id, int options, int flags,</span><br><span class="line">881â”‚                 struct timeval *timeout,</span><br><span class="line">882â”‚                 php_stream_context *context STREAMS_DC)</span><br><span class="line">883â”‚ &#123;</span><br><span class="line">884â”œâ”€â”€â”€â”€â”€â”€â”€&gt; php_stream *stream = NULL;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œæˆ‘ä»¬è¿›å…¥äº†åœ¨<code>php_init_stream_wrappers</code>å‡½æ•°ä¸­æ³¨å†Œçš„<code>php_stream_generic_socket_factory</code>å‡½æ•°é‡Œé¢ã€‚</p>
<p>æˆ‘ä»¬çŸ¥é“ï¼Œæ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ª<code>socket</code>çš„ï¼Œè¿™æ ·å®¢æˆ·ç«¯æ‰å¯ä»¥å’ŒæœåŠ¡å™¨è¿›è¡Œé€šä¿¡ã€‚é‚£ä¹ˆï¼Œåˆ›å»ºå®Œ<code>php_stream</code>ä¹‹åï¼Œåœ¨å“ªä¸ªåœ°æ–¹åˆ›å»ºçš„<code>socket</code>å‘¢ï¼Ÿæˆ‘ä»¬ç»§ç»­è°ƒè¯•ï¼Œé€€å‡º<code>php_stream_generic_socket_factory</code>å‡½æ•°ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(gdb) finish</span><br><span class="line">Run till exit from #0  php_stream_generic_socket_factory (proto=0x7ffff5e027e8 &quot;tcp://0.0.0.0:6666&quot;, protolen=3, resourcename=0x7ffff5e027ee &quot;0.0.0.0:6666&quot;, resourcenamelen=12, persistent_id=0x0, options=</span><br><span class="line">8, flags=13, timeout=0x7fffffffb230, context=0x7ffff5e01640, __php_stream_call_depth=1, __zend_filename=0xd788d0 &quot;/root/php-7.1.0/main/streams/transports.c&quot;, __zend_lineno=135, __zend_orig_filename=0xd6ff</span><br><span class="line">b0 &quot;/root/php-7.1.0/ext/standard/streamsfuncs.c&quot;, __zend_orig_lineno=209) at /root/php-7.1.0/main/streams/xp_socket.c:884</span><br><span class="line">0x00000000007ed2f0 in _php_stream_xport_create (name=0x7ffff5e027ee &quot;0.0.0.0:6666&quot;, namelen=12, options=8, flags=13, persistent_id=0x0, timeout=0x7fffffffb230, context=0x7ffff5e01640, error_string=0x7ffff</span><br><span class="line">fffb308, error_code=0x7fffffffb31c, __php_stream_call_depth=0, __zend_filename=0xd6ffb0 &quot;/root/php-7.1.0/ext/standard/streamsfuncs.c&quot;, __zend_lineno=209, __zend_orig_filename=0x0, __zend_orig_lineno=0) at</span><br><span class="line"> /root/php-7.1.0/main/streams/transports.c:133</span><br><span class="line">Value returned is $4 = (php_stream *) 0x7ffff5e5fa00</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line">133â”œâ”€â”€â”€â”€â”€â”€â”€&gt; stream = (factory)(protocol, n,</span><br><span class="line">134â”‚                         (char*)name, namelen, persistent_id, options, flags, timeout,</span><br><span class="line">135â”‚                         context STREAMS_REL_CC);</span><br></pre></td></tr></table></figure>

<p>åœ¨<code>php_stream_xport_bind</code>å¤„æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b php_stream_xport_bind</span><br><span class="line">Breakpoint 5 at 0x7ed66c: file /root/php-7.1.0/main/streams/transports.c, line 205.</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>ç„¶åç»§ç»­è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 5, php_stream_xport_bind (stream=0x7ffff5e5fa00, name=0x7ffff5e027ee &quot;0.0.0.0:6666&quot;, namelen=12, error_text=0x7fffffffb240) at /root/php-7.1.0/main/streams/transports.c:205</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line">196â”‚ /* Bind the stream to a local address */</span><br><span class="line">197â”‚ PHPAPI int php_stream_xport_bind(php_stream *stream,</span><br><span class="line">198â”‚                 const char *name, size_t namelen,</span><br><span class="line">199â”‚                 zend_string **error_text</span><br><span class="line">200â”‚                 )</span><br><span class="line">201â”‚ &#123;</span><br><span class="line">202â”‚         php_stream_xport_param param;</span><br><span class="line">203â”‚         int ret;</span><br><span class="line">204â”‚</span><br><span class="line">205â”œâ”€â”€â”€â”€â”€â”€â”€&gt; memset(&amp;param, 0, sizeof(param));</span><br><span class="line">206â”‚         param.op = STREAM_XPORT_OP_BIND;</span><br><span class="line">207â”‚         param.inputs.name = (char*)name;</span><br><span class="line">208â”‚         param.inputs.namelen = namelen;</span><br><span class="line">209â”‚         param.want_errortext = error_text ? 1 : 0;</span><br><span class="line">210â”‚</span><br><span class="line">211â”‚         ret = php_stream_set_option(stream, PHP_STREAM_OPTION_XPORT_API, 0, &amp;param);</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®<code>php_stream_xport_bind</code>çš„æ³¨é‡Šï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“çŸ¥é“ï¼Œè¿™ä¸ªå‡½æ•°çš„ä½œç”¨è‚¯å®šæ˜¯ä¼šå»è°ƒç”¨<code>bind</code>å‡½æ•°æ¥ç»‘å®š<code>ip</code>å’Œç«¯å£ã€‚å¹¶ä¸”æˆ‘ä»¬å‘ç°ï¼Œ<code>php_stream_xport_bind</code>çš„æ ¸å¿ƒå‡½æ•°å°±æ˜¯<code>php_stream_set_option</code>ã€‚å› ä¸º<code>php_stream_set_option</code>æ˜¯ä¸€ä¸ªå®ï¼Œå¹¶ä¸”å®å±•å¼€ä¹‹åæ˜¯<code>_php_stream_set_option</code>ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨<code>_php_stream_set_option</code>å¤„æ‰“ä¸€ä¸ªæ–­ç‚¹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b _php_stream_set_option</span><br><span class="line">Breakpoint 7 at 0x7dee15: file /root/php-7.1.0/main/streams/streams.c, line 1347.</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>ç»§ç»­è¿è¡Œï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 7, _php_stream_set_option (stream=0x7ffff5e5fa00, option=7, value=0, ptrparam=0x7fffffffb110) at /root/php-7.1.0/main/streams/streams.c:1347</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line">1345â”‚ PHPAPI int _php_stream_set_option(php_stream *stream, int option, int value, void *ptrparam)</span><br><span class="line">1346â”‚ &#123;</span><br><span class="line">1347â”œâ”€â”€â”€â”€â”€â”€â”€&gt; int ret = PHP_STREAM_OPTION_RETURN_NOTIMPL;</span><br><span class="line">1348â”‚</span><br><span class="line">1349â”‚         if (stream-&gt;ops-&gt;set_option) &#123;</span><br><span class="line">1350â”‚                 ret = stream-&gt;ops-&gt;set_option(stream, option, value, ptrparam);</span><br><span class="line">1351â”‚         &#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°<code>_php_stream_set_option</code>å‡½æ•°çš„æ ¸å¿ƒå°±æ˜¯<code>stream-&gt;ops-&gt;set_option</code>ï¼Œè¿™ä¸ªå‡½æ•°é‡Œé¢åº”è¯¥æœ‰æˆ‘ä»¬å¸Œæœ›çœ‹åˆ°çš„ä»£ç ï¼Œæˆ‘ä»¬è¿›å…¥è¿™ä¸ªå‡½æ•°ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br><span class="line">(gdb) s</span><br><span class="line"></span><br><span class="line">846â”‚ static int php_tcp_sockop_set_option(php_stream *stream, int option, int value, void *ptrparam)</span><br><span class="line">847â”‚ &#123;</span><br><span class="line">848â”œâ”€â”€â”€â”€â”€â”€â”€&gt; php_netstream_data_t *sock = (php_netstream_data_t*)stream-&gt;abstract;</span><br><span class="line">849â”‚         php_stream_xport_param *xparam;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°è¿›å…¥äº†<code>php_tcp_sockop_set_option</code>å‡½æ•°é‡Œé¢ï¼Œè¿™ä¸ªå‡½æ•°é‡Œé¢æœ‰ä¸€æ®µæ ¸å¿ƒçš„ä»£ç ï¼Œé€šè¿‡<code>switch</code>è¯­å¥æ ¹æ®<code>xparam-&gt;op</code>æ¥é€‰æ‹©æ‰§è¡Œï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(option) &#123;</span><br><span class="line">    <span class="keyword">case</span> PHP_STREAM_OPTION_XPORT_API:</span><br><span class="line">        xparam = (php_stream_xport_param *)ptrparam;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span>(xparam-&gt;op) &#123;</span><br><span class="line">            <span class="keyword">case</span> STREAM_XPORT_OP_CONNECT:</span><br><span class="line">            <span class="keyword">case</span> STREAM_XPORT_OP_CONNECT_ASYNC:</span><br><span class="line">                xparam-&gt;outputs.returncode = php_tcp_sockop_connect(stream, sock, xparam);</span><br><span class="line">                <span class="keyword">return</span> PHP_STREAM_OPTION_RETURN_OK;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> STREAM_XPORT_OP_BIND:</span><br><span class="line">                xparam-&gt;outputs.returncode = php_tcp_sockop_bind(stream, sock, xparam);</span><br><span class="line">                <span class="keyword">return</span> PHP_STREAM_OPTION_RETURN_OK;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> STREAM_XPORT_OP_ACCEPT:</span><br><span class="line">                xparam-&gt;outputs.returncode = php_tcp_sockop_accept(stream, sock, xparam STREAMS_CC);</span><br><span class="line">                <span class="keyword">return</span> PHP_STREAM_OPTION_RETURN_OK;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="comment">/* fall through */</span></span><br><span class="line">                ;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä¸Šé¢çš„è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œæ­¤æ—¶çš„<code>option</code>çš„å€¼æ˜¯<code>PHP_STREAM_OPTION_XPORT_API</code>ã€‚ç„¶åæˆ‘ä»¬ç»§ç»­æ‰§è¡Œï¼Œçœ‹çœ‹ä¼šè¿›å…¥åé¢çš„é‚£ä¸ª<code>case</code>åˆ†æ”¯é‡Œé¢ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br><span class="line">(gdb)</span><br><span class="line">861â”‚                                 case STREAM_XPORT_OP_BIND:</span><br><span class="line">862â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€&gt; xparam-&gt;outputs.returncode = php_tcp_sockop_bind(stream, sock, xparam);</span><br><span class="line">863â”‚                                         return PHP_STREAM_OPTION_RETURN_OK;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œè¿›å…¥äº†<code>STREAM_XPORT_OP_BIND</code>è¿™ä¸ªåˆ†æ”¯é‡Œé¢ã€‚æˆ‘ä»¬è¿›å…¥å‡½æ•°<code>php_tcp_sockop_bind</code>é‡Œé¢ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">php_tcp_sockop_bind (stream=0x7ffff5e5fa00, sock=0x7ffff5e02870, xparam=0x7fffffffb110) at /root/php-7.1.0/main/streams/xp_socket.c:615</span><br><span class="line">(gdb)</span><br><span class="line"></span><br><span class="line">612â”‚ static inline int php_tcp_sockop_bind(php_stream *stream, php_netstream_data_t *sock,</span><br><span class="line">613â”‚                 php_stream_xport_param *xparam)</span><br><span class="line">614â”‚ &#123;</span><br><span class="line">615â”œâ”€â”€â”€â”€â”€â”€â”€&gt; char *host = NULL;</span><br><span class="line">616â”‚         int portno, err;</span><br><span class="line">617â”‚         long sockopts = STREAM_SOCKOP_NONE;</span><br><span class="line">618â”‚         zval *tmpzval = NULL;</span><br><span class="line">619â”‚</span><br><span class="line">620â”‚ #ifdef AF_UNIX</span><br><span class="line">621â”‚         if (stream-&gt;ops == &amp;php_stream_unix_socket_ops || stream-&gt;ops == &amp;php_stream_unixdg_socket_ops) &#123;</span><br><span class="line">622â”‚                 struct sockaddr_un unix_addr;</span><br><span class="line">623â”‚</span><br><span class="line">624â”‚                 sock-&gt;socket = socket(PF_UNIX, stream-&gt;ops == &amp;php_stream_unix_socket_ops ? SOCK_STREAM : SOCK_DGRAM, 0);</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œå‡½æ•°<code>php_tcp_sockop_bind</code>é‡Œé¢æœ‰åˆ›å»º<code>socket</code>çš„ä»£ç ã€‚è¯´æ˜åˆ›å»º<code>socket</code>çš„ä»£ç è¢«å°è£…åœ¨äº†<code>php_tcp_sockop_bind</code>é‡Œé¢ã€‚å¹¶ä¸”åœ¨è¿™ä¸ªå‡½æ•°çš„åé¢ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°äº†<code>bind</code>è¿™ä¸ªå‡½æ•°ã€‚</p>
<p><code>OK</code>ï¼Œæˆ‘ä»¬ç°åœ¨åˆ†æå®Œäº†<code>stream_socket_server</code>è¿™ä¸ª<code>PHP</code>å‡½æ•°çš„å·¥ä½œæµç¨‹ã€‚æˆ‘ä»¬åœ¨æƒ³ï¼Œå¦‚æœæˆ‘ä»¬è°ƒç”¨<code>php_stream_xport_register</code>å»æ›¿æ¢æ‰<code>xport_hash</code>é‡Œé¢ä¿å­˜çš„<code>php_stream_generic_socket_factory</code>å‡½æ•°æŒ‡é’ˆï¼Œæ˜¯ä¸æ˜¯å°±å¯ä»¥åç¨‹åŒ–äº†å‘¢ï¼Ÿ</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/11/27/php-stream-server%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" data-id="ckkj72zx500maf6vx4dg9engm" data-title="php stream serveræºç åˆ†æ--stream_socket_server" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-SwooleåŸºç¡€è¯¾ç¨‹ç¬¬ä¸‰è®²ï¼šå¦‚ä½•æ­£ç¡®æ­å»ºHTTPæœåŠ¡" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/10/22/Swoole%E5%9F%BA%E7%A1%80%E8%AF%BE%E7%A8%8B%E7%AC%AC%E4%B8%89%E8%AE%B2%EF%BC%9A%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E6%90%AD%E5%BB%BAHTTP%E6%9C%8D%E5%8A%A1/" class="article-date">
  <time class="dt-published" datetime="2019-10-22T00:10:19.000Z" itemprop="datePublished">2019-10-22</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/10/22/Swoole%E5%9F%BA%E7%A1%80%E8%AF%BE%E7%A8%8B%E7%AC%AC%E4%B8%89%E8%AE%B2%EF%BC%9A%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E6%90%AD%E5%BB%BAHTTP%E6%9C%8D%E5%8A%A1/">SwooleåŸºç¡€è¯¾ç¨‹ç¬¬ä¸‰è®²ï¼šå¦‚ä½•æ­£ç¡®æ­å»ºHTTPæœåŠ¡</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>å¤§éƒ¨åˆ†çš„ä¼ ç»Ÿ<code>FPM</code>é¡¹ç›®æ€§èƒ½ç“¶é¢ˆåœ¨äºæ¯æ¬¡è¯·æ±‚é‡æ–°åˆ›å»º<code>ZendVM</code>çš„å¼€é”€ã€IOé˜»å¡å¯¼è‡´çš„ä¸Šä¸‹æ–‡é¢‘ç¹åˆ‡æ¢ã€‚<code>Swoole</code>è§£å†³çš„å°±æ˜¯è¿™ç±»é—®é¢˜ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« æ•™å¤§å®¶å¦‚ä½•è®©<code>Swoole</code>çš„<code>HTTP</code>æœåŠ¡å™¨æ€§èƒ½è¾¾åˆ°æœ€å¤§ã€‚</p>
<p>å‹æµ‹è„šæœ¬å¦‚ä¸‹ï¼Œæœºå™¨çš„é…ç½®æ˜¯å•æ ¸ã€<code>2G</code>å†…å­˜ã€<code>50G</code>ç¡¬ç›˜ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"></span><br><span class="line">$process = <span class="keyword">new</span> Swoole\Process(<span class="function"><span class="keyword">function</span> (<span class="params">Swoole\Process $process</span>) </span>&#123;</span><br><span class="line">    $server = <span class="keyword">new</span> Swoole\Http\Server(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9501</span>, SWOOLE_BASE);</span><br><span class="line">    $server-&gt;set([</span><br><span class="line">        <span class="string">&#x27;log_file&#x27;</span> =&gt; <span class="string">&#x27;/dev/null&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;log_level&#x27;</span> =&gt; SWOOLE_LOG_INFO,</span><br><span class="line">        <span class="string">&#x27;worker_num&#x27;</span> =&gt; swoole_cpu_num() * <span class="number">2</span>,</span><br><span class="line">        <span class="comment">// &#x27;hook_flags&#x27; =&gt; SWOOLE_HOOK_ALL,</span></span><br><span class="line">    ]);</span><br><span class="line">    $server-&gt;on(<span class="string">&#x27;workerStart&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$process, $server</span>) </span>&#123;</span><br><span class="line">        $process-&gt;write(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    $server-&gt;on(<span class="string">&#x27;request&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">Request $request, Response $response</span>) <span class="title">use</span> (<span class="params">$server</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $redis = <span class="keyword">new</span> Redis;</span><br><span class="line">            $redis-&gt;connect(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">6379</span>);</span><br><span class="line">            $greeter = $redis-&gt;get(<span class="string">&#x27;greeter&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!$greeter) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RedisException(<span class="string">&#x27;get data failed&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $response-&gt;end(<span class="string">&quot;&lt;h1&gt;<span class="subst">&#123;$greeter&#125;</span>&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="built_in">Throwable</span> $th) &#123;</span><br><span class="line">            $response-&gt;status(<span class="number">500</span>);</span><br><span class="line">            $response-&gt;end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    $server-&gt;start();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($process-&gt;start()) &#123;</span><br><span class="line">    register_shutdown_function(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$process</span>) </span>&#123;</span><br><span class="line">        $process::kill($process-&gt;pid);</span><br><span class="line">        $process::wait();</span><br><span class="line">    &#125;);</span><br><span class="line">    $process-&gt;read(<span class="number">1</span>);</span><br><span class="line">    System(<span class="string">&#x27;ab -c 256 -n 10000 -k http://127.0.0.1:9501/ 2&gt;&amp;1&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª<code>Swoole\Process</code>å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šå¼€å¯ä¸€ä¸ªå­è¿›ç¨‹ï¼Œåœ¨å­è¿›ç¨‹ä¸­ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ª<code>HTTP Server</code>ï¼Œè¿™ä¸ªæœåŠ¡å™¨æ˜¯<code>BASE</code>æ¨¡å¼çš„ã€‚é™¤äº†<code>BASE</code>æ¨¡å¼ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§<code>PROCESS</code>æ¨¡å¼ã€‚åœ¨<code>PROCESS</code>æ¨¡å¼ä¸‹ï¼Œå¥—æ¥å­—è¿æ¥æ˜¯åœ¨<code>Master</code>è¿›ç¨‹ç»´æŒçš„ï¼Œ<code>Master</code>è¿›ç¨‹å’Œ<code>Worker</code>è¿›ç¨‹ä¼šå¤šä¸€å±‚<code>IPC</code>é€šä¿¡çš„å¼€é”€ï¼Œä½†æ˜¯ï¼Œå½“<code>Worker</code>è¿›ç¨‹å¥”æºƒçš„æ—¶å€™ï¼Œå› ä¸ºè¿æ¥æ˜¯åœ¨<code>Master</code>è¿›ç¨‹ç»´æŒçš„ï¼Œæ‰€ä»¥è¿æ¥ä¸ä¼šè¢«æ–­å¼€ã€‚æ‰€ä»¥ï¼Œ<code>Process</code>æ¨¡å¼é€‚ç”¨äºç»´æŠ¤å¤§é‡é•¿è¿æ¥çš„åœºæ™¯ã€‚<code>BASE</code>æ¨¡å¼æ˜¯åœ¨æ¯ä¸ªå·¥ä½œè¿›ç¨‹ç»´æŒè‡ªå·±çš„è¿æ¥ï¼Œæ‰€ä»¥æ€§èƒ½ä¼šæ¯”<code>Master</code>æ›´å¥½ã€‚å¹¶ä¸”ï¼Œåœ¨<code>HTTP Server</code>ä¸‹ï¼Œ<code>BASE</code>æ¨¡å¼ä¼šæ›´åŠ çš„é€‚ç”¨ã€‚</p>
<p>è¿™é‡Œï¼Œæˆ‘ä»¬å°†<code>worker_num</code>ï¼Œä¹Ÿå°±æ˜¯è¿›ç¨‹çš„æ•°é‡è®¾ç½®ä¸ºå½“å‰æœºå™¨<code>CPU</code>æ ¸æ•°çš„ä¸¤å€ã€‚ä½†æ˜¯ï¼Œåœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¸æ–­çš„å‹æµ‹ï¼Œæ¥è°ƒæ•´è¿™ä¸ªå‚æ•°ã€‚</p>
<p>åœ¨<code>workerStart</code>çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯å·¥ä½œè¿›ç¨‹å¯åŠ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬è®©å­è¿›ç¨‹å‘ç®¡é“ä¸­éšæ„å†™å…¥ä¸€ä¸ªæ•°æ®ç»™çˆ¶è¿›ç¨‹ï¼Œçˆ¶è¿›ç¨‹æ­¤æ—¶ä¼šè¯»åˆ°ä¸€ç‚¹æ•°æ®ï¼Œè¯»åˆ°æ•°æ®åï¼Œçˆ¶è¿›ç¨‹æ‰å¼€å§‹å‹æµ‹ã€‚</p>
<p>æ­¤æ—¶ï¼Œå‹æµ‹çš„è¯·æ±‚ä¼šè¿›å…¥<code>onRequest</code>å›è°ƒã€‚åœ¨è¿™ä¸ªå›è°ƒä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ª<code>Redis</code>å®¢æˆ·ç«¯ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯ä¼šè¿æ¥<code>Redis</code>æœåŠ¡å™¨ï¼Œå¹¶è¯·æ±‚ä¸€æ¡æ•°æ®ã€‚å¾—åˆ°æ•°æ®åï¼Œæˆ‘ä»¬è°ƒç”¨<code>end</code>æ–¹æ³•æ¥å“åº”å‹æµ‹çš„è¯·æ±‚ã€‚å½“é”™è¯¯æ—¶ï¼Œæˆ‘ä»¬è¿”å›ä¸€ä¸ªé”™è¯¯ç ä¸º<code>500</code>çš„å“åº”ã€‚</p>
<p>åœ¨å¼€å§‹å‹æµ‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…<code>Redis</code>æ‰©å±•ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pecl install redis</span><br></pre></td></tr></table></figure>

<p>ç„¶å<code>php.ini</code>é…ç½®ä¸­å¼€å¯<code>redis</code>æ‰©å±•å³å¯ã€‚</p>
<p>æˆ‘ä»¬è¿˜éœ€è¦åœ¨<code>Redis</code>æœåŠ¡å™¨é‡Œé¢æ’å…¥ä¸€æ¡æ•°æ®ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SET greeter swoole</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; GET greeter</span><br><span class="line">&quot;swoole&quot;</span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>

<p><code>OK</code>ï¼Œæˆ‘ä»¬ç°åœ¨è¿›è¡Œå‹æµ‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/phpCode/swoole/server # php server.php</span><br><span class="line">Concurrency Level:      256</span><br><span class="line">Time taken for tests:   2.293 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Keep-Alive requests:    10000</span><br><span class="line">Total transferred:      1680000 bytes</span><br><span class="line">HTML transferred:       150000 bytes</span><br><span class="line">Requests per second:    4361.00 [#/sec] (mean)</span><br><span class="line">Time per request:       58.702 [ms] (mean)</span><br><span class="line">Time per request:       0.229 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          715.48 [Kbytes/sec] received</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œç°åœ¨çš„<code>QPS</code>æ¯”è¾ƒä½ï¼Œåªæœ‰<code>4361.00</code>ã€‚</p>
<p>å› ä¸ºï¼Œæˆ‘ä»¬ç›®å‰ä½¿ç”¨çš„<code>Redis</code>æ‰©å±•æ˜¯<code>PHP</code>å®˜æ–¹çš„åŒæ­¥é˜»å¡å®¢æˆ·ç«¯ï¼Œæ²¡æœ‰åˆ©ç”¨åˆ°åç¨‹ï¼ˆæˆ–è€…è¯´å¼‚æ­¥çš„ç‰¹æ€§ï¼‰ã€‚å½“è¿›ç¨‹å»è¿æ¥<code>Redis</code>æœåŠ¡å™¨çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šé˜»å¡æ•´ä¸ªè¿›ç¨‹ï¼Œå¯¼è‡´è¿›ç¨‹æ— æ³•å¤„ç†å…¶ä»–çš„è¿æ¥ï¼Œè¿™æ ·ï¼Œè¿™ä¸ª<code>HTTP Server</code>å¤„ç†è¯·æ±‚çš„é€Ÿåº¦å°±ä¸å¯èƒ½å¿«ã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªå‹æµ‹ç»“æœä¼šæ¯”<code>FPM</code>ä¸‹å¥½ï¼Œå› ä¸º<code>Swoole</code>æ˜¯å¸¸é©»è¿›ç¨‹çš„ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥å¼€å¯<code>Swoole</code>æä¾›çš„<code>RuntimeHook</code>æœºåˆ¶ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€çš„å°†<code>PHP</code>åŒæ­¥é˜»å¡çš„æ–¹æ³•å…¨éƒ¨æ›¿æ¢ä¸ºå¼‚æ­¥éé˜»å¡çš„åç¨‹è°ƒåº¦çš„æ–¹æ³•ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨<code>server-&gt;set</code>é…ç½®ä¸­åŠ å…¥ä¸€è¡Œå³å¯ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;hook_flags&#x27;</span> =&gt; SWOOLE_HOOK_ALL</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶ï¼Œæˆ‘ä»¬å†æ¥è¿è¡Œè¿™ä¸ªè„šæœ¬ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Concurrency Level:      256</span><br><span class="line">Time taken for tests:   1.643 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Keep-Alive requests:    10000</span><br><span class="line">Total transferred:      1680000 bytes</span><br><span class="line">HTML transferred:       150000 bytes</span><br><span class="line">Requests per second:    6086.22 [#/sec] (mean)</span><br><span class="line">Time per request:       42.062 [ms] (mean)</span><br><span class="line">Time per request:       0.164 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          998.52 [Kbytes/sec] received</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œæ­¤æ—¶çš„<code>QPS</code>è¿˜æ˜¯æœ‰ä¸€å®šçš„æå‡çš„ã€‚ï¼ˆè¿™é‡Œï¼Œè§†é¢‘ä¸­å‹æµ‹çš„æ—¶å€™ï¼Œä¼šå¤¯ä½è¯·æ±‚ï¼Œå¯¼è‡´<code>QPS</code>éå¸¸çš„ä½ï¼Œä½†æ˜¯æˆ‘å®é™…æµ‹è¯•çš„æ—¶å€™æ²¡æœ‰å‘ç”Ÿè¿™ä¸ªæƒ…å†µï¼Œä¼°è®¡æ˜¯å’Œ<code>Redis</code>æœåŠ¡å™¨æœ¬èº«å¯¹è¿æ¥ä¸ªæ•°çš„çš„é…ç½®æœ‰å…³ï¼‰</p>
<p>ä½†æ˜¯ï¼Œä¸ºäº†é¿å…è¯·æ±‚æ•°é‡è¿‡å¤šï¼Œå¯¼è‡´åˆ›å»ºè¿æ¥ä¸ªæ•°è¿‡å¤šçš„é—®é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ä¸ª<code>Redis</code>è¿æ¥æ± æ¥è§£å†³ã€‚ï¼ˆåŒæ­¥é˜»å¡æ˜¯æ²¡æœ‰<code>Redis</code>è¿æ¥è¿‡å¤šçš„é—®é¢˜çš„ï¼Œå› ä¸ºä¸€æ—¦<code>worker</code>è¿›ç¨‹é˜»å¡ä½äº†ï¼Œé‚£ä¹ˆåé¢çš„è¯·æ±‚å°±ä¸ä¼šç»§ç»­æ‰§è¡Œäº†ï¼Œä¹Ÿå°±ä¸ä¼šåˆ›å»ºæ–°çš„<code>Redis</code>è¿æ¥äº†ã€‚å› æ­¤ï¼Œåœ¨åŒæ­¥é˜»å¡çš„æ¨¡å¼ä¸‹ï¼Œ<code>Redis</code>çš„è¿æ¥æ•°é‡æœ€å¤§æ˜¯<code>worker</code>è¿›ç¨‹çš„ä¸ªæ•°ï¼‰</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥å®ç°ä¸€ä¸‹<code>Redis</code>è¿æ¥æ± ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisQueue</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $pool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool = <span class="keyword">new</span> <span class="built_in">SplQueue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>): <span class="title">Redis</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;pool-&gt;isEmpty()) &#123;</span><br><span class="line">            $redis = <span class="keyword">new</span> \Redis();</span><br><span class="line">            $redis-&gt;connect(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">6379</span>);</span><br><span class="line">            <span class="keyword">return</span> $redis;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pool-&gt;dequeue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params">Redis $redis</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool-&gt;enqueue($redis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œé€šè¿‡<code>spl</code>çš„é˜Ÿåˆ—å®ç°çš„è¿æ¥æ± ã€‚å¦‚æœè¿æ¥æ± ä¸­æ²¡æœ‰è¿æ¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±æ–°å»ºä¸€ä¸ªè¿æ¥ï¼Œå¹¶ä¸”æŠŠåˆ›å»ºçš„è¿™ä¸ªè¿æ¥è¿”å›ï¼›å¦‚æœè¿æ¥æ± é‡Œé¢æœ‰è¿æ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬è·å–é˜Ÿåˆ—ä¸­å‰é¢çš„ä¸€ä¸ªè¿æ¥ã€‚å½“æˆ‘ä»¬ç”¨å®Œè¿æ¥çš„æ—¶å€™ï¼Œï¼Œå°±å¯ä»¥è°ƒç”¨<code>put</code>æ–¹æ³•å½’è¿˜è¿æ¥ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¤ç”¨<code>Redis</code>çš„è¿æ¥ï¼Œç¼“è§£<code>Redis</code>æœåŠ¡å™¨çš„å‹åŠ›ï¼Œä»¥åŠé¢‘ç¹åˆ›å»º<code>Redis</code>è¿æ¥çš„å¼€é”€ä¹Ÿä¼šé™ä½ã€‚</p>
<p>æˆ‘ä»¬ç°åœ¨ä½¿ç”¨è¿™ä¸ªè¿æ¥æ± é˜Ÿåˆ—ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"></span><br><span class="line">$process = <span class="keyword">new</span> Swoole\Process(<span class="function"><span class="keyword">function</span> (<span class="params">Swoole\Process $process</span>) </span>&#123;</span><br><span class="line">    $server = <span class="keyword">new</span> Swoole\Http\Server(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9501</span>, SWOOLE_BASE);</span><br><span class="line">    $server-&gt;set([</span><br><span class="line">        <span class="string">&#x27;log_file&#x27;</span> =&gt; <span class="string">&#x27;/dev/null&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;log_level&#x27;</span> =&gt; SWOOLE_LOG_INFO,</span><br><span class="line">        <span class="string">&#x27;worker_num&#x27;</span> =&gt; swoole_cpu_num() * <span class="number">2</span>,</span><br><span class="line">        <span class="string">&#x27;hook_flags&#x27;</span> =&gt; SWOOLE_HOOK_ALL,</span><br><span class="line">    ]);</span><br><span class="line">    $server-&gt;on(<span class="string">&#x27;workerStart&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$process, $server</span>) </span>&#123;</span><br><span class="line">        $server-&gt;pool = <span class="keyword">new</span> RedisQueue;</span><br><span class="line">        $process-&gt;write(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    $server-&gt;on(<span class="string">&#x27;request&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">Request $request, Response $response</span>) <span class="title">use</span> (<span class="params">$server</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $redis = $server-&gt;pool-&gt;get();</span><br><span class="line">            <span class="comment">// $redis = new Redis;</span></span><br><span class="line">            <span class="comment">// $redis-&gt;connect(&#x27;127.0.0.1&#x27;, 6379);</span></span><br><span class="line">            $greeter = $redis-&gt;get(<span class="string">&#x27;greeter&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!$greeter) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RedisException(<span class="string">&#x27;get data failed&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $server-&gt;pool-&gt;put($redis);</span><br><span class="line">            $response-&gt;end(<span class="string">&quot;&lt;h1&gt;<span class="subst">&#123;$greeter&#125;</span>&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="built_in">Throwable</span> $th) &#123;</span><br><span class="line">            $response-&gt;status(<span class="number">500</span>);</span><br><span class="line">            $response-&gt;end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    $server-&gt;start();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($process-&gt;start()) &#123;</span><br><span class="line">    register_shutdown_function(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$process</span>) </span>&#123;</span><br><span class="line">        $process::kill($process-&gt;pid);</span><br><span class="line">        $process::wait();</span><br><span class="line">    &#125;);</span><br><span class="line">    $process-&gt;read(<span class="number">1</span>);</span><br><span class="line">    System(<span class="string">&#x27;ab -c 256 -n 10000 -k http://127.0.0.1:9501/ 2&gt;&amp;1&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisQueue</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $pool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool = <span class="keyword">new</span> <span class="built_in">SplQueue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>): <span class="title">Redis</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;pool-&gt;isEmpty()) &#123;</span><br><span class="line">            $redis = <span class="keyword">new</span> \Redis();</span><br><span class="line">            $redis-&gt;connect(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">6379</span>);</span><br><span class="line">            <span class="keyword">return</span> $redis;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pool-&gt;dequeue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params">Redis $redis</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool-&gt;enqueue($redis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åœ¨<code>worker</code>è¿›ç¨‹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œåˆ›å»ºäº†è¿™ä¸ª<code>RedisQueue</code>ã€‚ç„¶ååœ¨<code>onRequest</code>çš„é˜¶æ®µï¼Œä»è¿™ä¸ª<code>RedisQueue</code>é‡Œé¢è·å–ä¸€ä¸ª<code>Redis</code>è¿æ¥ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥è¿›è¡Œå‹æµ‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Concurrency Level:      256</span><br><span class="line">Time taken for tests:   1.188 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Keep-Alive requests:    10000</span><br><span class="line">Total transferred:      1680000 bytes</span><br><span class="line">HTML transferred:       150000 bytes</span><br><span class="line">Requests per second:    8416.18 [#/sec] (mean)</span><br><span class="line">Time per request:       30.418 [ms] (mean)</span><br><span class="line">Time per request:       0.119 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          1380.78 [Kbytes/sec] received</span><br></pre></td></tr></table></figure>

<p><code>QPS</code>æå‡åˆ°äº†<code>8416.18</code>ã€‚</p>
<p>ä½†æ˜¯ï¼Œé€šè¿‡<code>splqueue</code>å®ç°çš„è¿æ¥æ± æ˜¯æœ‰ç¼ºé™·çš„ï¼Œå› ä¸ºè¿™ä¸ªé˜Ÿåˆ—æ˜¯å¯ä»¥æ— é™é•¿çš„ã€‚è¿™æ ·ï¼Œå½“å¹¶å‘é‡ç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œè¿˜æ˜¯ä¼šæœ‰å¯èƒ½åˆ›å»ºéå¸¸å¤šçš„è¿æ¥ï¼Œå› ä¸ºè¿æ¥æ± é‡Œé¢å¯èƒ½å§‹ç»ˆéƒ½æ˜¯ç©ºçš„ã€‚</p>
<p>è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>Channel</code>æ¥å®ç°è¿æ¥æ± ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisPool</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $pool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">int</span> $size = <span class="number">100</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool = <span class="keyword">new</span> \Swoole\Coroutine\Channel($size);</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $size; $i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    $redis = <span class="keyword">new</span> \Redis();</span><br><span class="line">                    $redis-&gt;connect(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">6379</span>);</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;put($redis);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (\<span class="built_in">Throwable</span> $th) &#123;</span><br><span class="line">                    usleep(<span class="number">1</span> * <span class="number">1000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>): \<span class="title">Redis</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pool-&gt;pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params">\Redis $redis</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool-&gt;push($redis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool-&gt;close();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨è¿™ä¸ªæ„é€ æ–¹æ³•ä¸­ï¼Œå°†è¿™ä¸ª<code>Channel</code>çš„<code>size</code>è®¾ç½®ä¸ºè¿™ä¸ªä¼ å…¥çš„å‚æ•°ã€‚å¹¶ä¸”ï¼Œåˆ›å»º<code>size</code>ä¸ªè¿æ¥ã€‚è¿™äº›è¿æ¥ä¼šåœ¨åˆå§‹åŒ–è¿æ¥æ± çš„æ—¶å€™å°±è¢«åˆ›å»ºï¼Œå¤„äºå°±å°±ç»ªçŠ¶æ€ã€‚è¿™ä¸ªæœ‰å¥½å¤„ä¹Ÿæœ‰åå¤„ï¼Œåå¤„å°±æ˜¯åœ¨æ¯ä¸ªè¿›ç¨‹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå°±ä¼šå ç”¨ä¸€äº›è¿æ¥ï¼Œä½†æ˜¯æ­¤æ—¶çš„è¿›ç¨‹å¹¶ä¸ä¼šæ¥æ”¶è¿æ¥ã€‚å¥½å¤„å°±æ˜¯æå‰åˆ›å»ºå¥½äº†<code>Redis</code>è¿æ¥ï¼Œè¿™æ ·æœåŠ¡å™¨å“åº”çš„å»¶è¿Ÿå°±ä¼šé™ä½ã€‚</p>
<p>è™½ç„¶ï¼Œå…¶ä»–åœ°æ–¹çš„ä»£ç å…¶å®å’Œ<code>RedisQueue</code>çš„å®ç°ä¸€æ ·ã€‚ä½†æ˜¯ï¼Œåº•å±‚æ˜¯å’Œ<code>RedisQueue</code>å¤§æœ‰ä¸åŒçš„ã€‚å› ä¸ºå½“<code>Channel</code>é‡Œé¢æ²¡æœ‰<code>Redis</code>è¿æ¥çš„æ—¶å€™ï¼Œä¼šè®©å½“å‰çš„åç¨‹æŒ‚èµ·ï¼Œè®©å…¶ä»–çš„åç¨‹ç»§ç»­è¢«æ‰§è¡Œã€‚ç­‰æœ‰åç¨‹æŠŠ<code>Redis</code>è¿æ¥è¿˜å›åˆ°è¿æ¥æ± é‡Œé¢çš„æ—¶å€™ï¼Œè¿™ä¸ªè¢«æŒ‚èµ·çš„åç¨‹æ‰ä¼šç»§ç»­æ‰§è¡Œã€‚è¿™å°±æ˜¯åç¨‹åä½œçš„åŸç†ã€‚</p>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬ä¿®æ”¹æœåŠ¡å™¨çš„ä»£ç ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Swoole</span>\<span class="title">Http</span>\<span class="title">Response</span>;</span><br><span class="line"></span><br><span class="line">$process = <span class="keyword">new</span> Swoole\Process(<span class="function"><span class="keyword">function</span> (<span class="params">Swoole\Process $process</span>) </span>&#123;</span><br><span class="line">    $server = <span class="keyword">new</span> Swoole\Http\Server(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9501</span>, SWOOLE_BASE);</span><br><span class="line">    $server-&gt;set([</span><br><span class="line">        <span class="string">&#x27;log_file&#x27;</span> =&gt; <span class="string">&#x27;/dev/null&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;log_level&#x27;</span> =&gt; SWOOLE_LOG_INFO,</span><br><span class="line">        <span class="string">&#x27;worker_num&#x27;</span> =&gt; swoole_cpu_num() * <span class="number">2</span>,</span><br><span class="line">        <span class="string">&#x27;hook_flags&#x27;</span> =&gt; SWOOLE_HOOK_ALL,</span><br><span class="line">    ]);</span><br><span class="line">    $server-&gt;on(<span class="string">&#x27;workerStart&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$process, $server</span>) </span>&#123;</span><br><span class="line">        $server-&gt;pool = <span class="keyword">new</span> RedisPool(<span class="number">64</span>);</span><br><span class="line">        $process-&gt;write(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    $server-&gt;on(<span class="string">&#x27;request&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">Request $request, Response $response</span>) <span class="title">use</span> (<span class="params">$server</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            $redis = $server-&gt;pool-&gt;get();</span><br><span class="line">            <span class="comment">// $redis = new Redis;</span></span><br><span class="line">            <span class="comment">// $redis-&gt;connect(&#x27;127.0.0.1&#x27;, 6379);</span></span><br><span class="line">            $greeter = $redis-&gt;get(<span class="string">&#x27;greeter&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!$greeter) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RedisException(<span class="string">&#x27;get data failed&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            $server-&gt;pool-&gt;put($redis);</span><br><span class="line">            $response-&gt;end(<span class="string">&quot;&lt;h1&gt;<span class="subst">&#123;$greeter&#125;</span>&lt;/h1&gt;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (\<span class="built_in">Throwable</span> $th) &#123;</span><br><span class="line">            $response-&gt;status(<span class="number">500</span>);</span><br><span class="line">            $response-&gt;end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    $server-&gt;start();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($process-&gt;start()) &#123;</span><br><span class="line">    register_shutdown_function(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">use</span> (<span class="params">$process</span>) </span>&#123;</span><br><span class="line">        $process::kill($process-&gt;pid);</span><br><span class="line">        $process::wait();</span><br><span class="line">    &#125;);</span><br><span class="line">    $process-&gt;read(<span class="number">1</span>);</span><br><span class="line">    System(<span class="string">&#x27;ab -c 256 -n 10000 -k http://127.0.0.1:9501/ 2&gt;&amp;1&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RedisPool</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $pool;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="keyword">int</span> $size = <span class="number">100</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool = <span class="keyword">new</span> \Swoole\Coroutine\Channel($size);</span><br><span class="line">        <span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $size; $i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    $redis = <span class="keyword">new</span> \Redis();</span><br><span class="line">                    $redis-&gt;connect(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">6379</span>);</span><br><span class="line">                    <span class="keyword">$this</span>-&gt;put($redis);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (\<span class="built_in">Throwable</span> $th) &#123;</span><br><span class="line">                    usleep(<span class="number">1</span> * <span class="number">1000</span>);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"></span>): \<span class="title">Redis</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;pool-&gt;pop();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">put</span>(<span class="params">\Redis $redis</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool-&gt;push($redis);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">close</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool-&gt;close();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;pool = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åªéœ€è¦ä¿®æ”¹<code>workerStart</code>é‡Œé¢çš„éƒ¨åˆ†å³å¯ï¼Œå…¶ä»–åœ°æ–¹ä¸éœ€è¦åšä¿®æ”¹ã€‚è¿™æ ·ï¼Œæ¯ä¸ªè¿›ç¨‹æœ€å¤šåªèƒ½åˆ›å»º<code>64</code>ä¸ª<code>Redis</code>è¿æ¥ã€‚</p>
<p>æˆ‘ä»¬ç»§ç»­å‹æµ‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Concurrency Level:      256</span><br><span class="line">Time taken for tests:   0.817 seconds</span><br><span class="line">Complete requests:      10000</span><br><span class="line">Failed requests:        0</span><br><span class="line">Keep-Alive requests:    10000</span><br><span class="line">Total transferred:      1680000 bytes</span><br><span class="line">HTML transferred:       150000 bytes</span><br><span class="line">Requests per second:    12234.30 [#/sec] (mean)</span><br><span class="line">Time per request:       20.925 [ms] (mean)</span><br><span class="line">Time per request:       0.082 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          2007.19 [Kbytes/sec] received</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°<code>QPS</code>è¿˜æ˜¯æœ‰æ‰€æå‡çš„ï¼Œä¸ºä»€ä¹ˆæˆ‘çš„<code>QPS</code>æ²¡æœ‰è§†é¢‘é‡Œé¢çš„æå‡æ˜æ˜¾å‘¢ï¼Ÿè¿™ä¸ªå’Œæµ‹è¯•ç¯å¢ƒæœ‰å…³ã€‚æˆ‘è‡ªå·±çš„æœºå™¨å·²ç»æ— æ³•å†æå‡äº†ã€‚å°±å¥½åƒå­¦éœ¸æœ€é«˜åªå¯ä»¥è€ƒ<code>100</code>åˆ†ä¸€æ ·çš„é“ç†ã€‚ï¼ˆå®é™…ä¸Šï¼Œç»è¿‡æˆ‘çš„æµ‹è¯•ï¼Œå¦‚æœæˆ‘è°ƒæ•´è¿æ¥æ± çš„æœ€å¤§è¿æ¥æ•°ï¼Œ<code>QPS</code>ä¼šæœ‰æ‰€æå‡ï¼‰</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/10/22/Swoole%E5%9F%BA%E7%A1%80%E8%AF%BE%E7%A8%8B%E7%AC%AC%E4%B8%89%E8%AE%B2%EF%BC%9A%E5%A6%82%E4%BD%95%E6%AD%A3%E7%A1%AE%E6%90%AD%E5%BB%BAHTTP%E6%9C%8D%E5%8A%A1/" data-id="ckkj72zsa0040f6vx54schafx" data-title="SwooleåŸºç¡€è¯¾ç¨‹ç¬¬ä¸‰è®²ï¼šå¦‚ä½•æ­£ç¡®æ­å»ºHTTPæœåŠ¡" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-ã€ŠPHPæ‰©å±•å¼€å‘-å¼•ç”¨è®¡æ•°çš„ä½¿ç”¨ã€‹" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/09/24/%E3%80%8APHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91-%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E7%9A%84%E4%BD%BF%E7%94%A8%E3%80%8B/" class="article-date">
  <time class="dt-published" datetime="2019-09-24T01:52:55.000Z" itemprop="datePublished">2019-09-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/09/24/%E3%80%8APHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91-%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E7%9A%84%E4%BD%BF%E7%94%A8%E3%80%8B/">ã€ŠPHPæ‰©å±•å¼€å‘--å¼•ç”¨è®¡æ•°çš„ä½¿ç”¨ã€‹</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>æ„Ÿè°¢<code>twosee</code>å¤§ä½¬çš„ç‚¹æ‹¨ã€‚</p>
<p>è¿™ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬æ¥è®²ä¸€ä¸‹<code>PHP</code>æ‰©å±•å¼€å‘çš„å¸¸è§é—®é¢˜ï¼Œå¼•ç”¨è®¡æ•°ç®¡ç†ã€‚å› ä¸ºç°æœ‰çš„ä¹¦ç±æœ‰äº›è€æ—§ï¼Œè·Ÿä¸ä¸Š<code>PHP</code>çš„å‘å±•ï¼Œæ‰€ä»¥å¾ˆæœ‰å¿…è¦å­¦ä¹ ä¸€ä¸‹ã€‚</p>
<p><code>PHP</code>ç‰ˆæœ¬æ˜¯<code>7.3.5</code>ã€‚</p>
<p>æˆ‘ä»¬æ¥å†™ä¸€ä¸ªæµ‹è¯•æ‰©å±•å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ZEND_BEGIN_ARG_INFO_EX(arginfo_study_test, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    ZEND_ARG_ARRAY_INFO(<span class="number">0</span>, arr, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">PHP_FUNCTION(test)</span><br><span class="line">&#123;</span><br><span class="line">    zval *arr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(zend_parse_parameters(ZEND_NUM_ARGS(), <span class="string">&quot;a&quot;</span>, &amp;arr) == FAILURE)&#123;</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    RETURN_ARR(Z_ARR_P(arr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°åšçš„äº‹æƒ…å¾ˆç®€å•ï¼Œæ¥æ”¶ä¸€ä¸ªæ•°ç»„ï¼Œç„¶åç›´æ¥è¿”å›å›å»ã€‚</p>
<p>(å°ä¼™ä¼´ä»¬è‡ªå·±è®°å¾—æ³¨å†Œä¸€ä¸‹åˆ›å»ºçš„è¿™ä¸ªæµ‹è¯•å‡½æ•°)</p>
<p><code>OK</code>ã€‚æˆ‘ä»¬ç¼–è¯‘ã€å®‰è£…æ‰©å±•ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/cppCode/study # make clean ; make ; make install</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Build complete.</span><br><span class="line">Don&#x27;t forget to run &#x27;make test&#x27;.</span><br><span class="line"></span><br><span class="line">Installing shared extensions:     /usr/local/lib/php/extensions/no-debug-non-zts-20180731/</span><br><span class="line">Installing header files:          /usr/local/include/php/</span><br><span class="line">~/codeDir/cppCode/study #</span><br></pre></td></tr></table></figure>

<p>ç„¶åç¼–å†™æµ‹è¯•è„šæœ¬ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">array</span>(<span class="string">&quot;time&quot;</span> =&gt; time());</span><br><span class="line">xdebug_debug_zval(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">$b = test($a);</span><br><span class="line">xdebug_debug_zval(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">xdebug_debug_zval(<span class="string">&quot;b&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">unset</span>($a);</span><br><span class="line"></span><br><span class="line">var_dump($b);</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/cppCode/study <span class="comment"># php test.php</span></span><br><span class="line">a: (refcount=<span class="number">1</span>, is_ref=<span class="number">0</span>)=<span class="keyword">array</span> (<span class="string">&#x27;time&#x27;</span> =&gt; (refcount=<span class="number">0</span>, is_ref=<span class="number">0</span>)=<span class="number">1569290383</span>)</span><br><span class="line">a: (refcount=<span class="number">1</span>, is_ref=<span class="number">0</span>)=<span class="keyword">array</span> (<span class="string">&#x27;time&#x27;</span> =&gt; (refcount=<span class="number">0</span>, is_ref=<span class="number">0</span>)=<span class="number">1569290383</span>)</span><br><span class="line">b: (refcount=<span class="number">1</span>, is_ref=<span class="number">0</span>)=<span class="keyword">array</span> (<span class="string">&#x27;time&#x27;</span> =&gt; (refcount=<span class="number">0</span>, is_ref=<span class="number">0</span>)=<span class="number">1569290383</span>)</span><br><span class="line">/root/codeDir/cppCode/study/test.php:<span class="number">11</span>:</span><br><span class="line">&amp;<span class="keyword">array</span></span><br><span class="line">~/codeDir/cppCode/study <span class="comment">#</span></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œæ²¡æœ‰æ‰“å°å‡º<code>$b</code>è¿™ä¸ªæ•°ç»„ã€‚å‡ºç°äº†<code>bug</code>ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹ã€‚</p>
<p>å› ä¸º<code>PHP</code>å¯¹äºå¤æ‚ç±»å‹ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ã€æ•°ç»„ã€å¯¹è±¡éƒ½æ˜¯é€šè¿‡å¼•ç”¨è®¡æ•°æ¥ç®¡ç†çš„ï¼Œä¸ä¼šæ‹·è´å‡ºä¸€ä¸ªå‰¯æœ¬ã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬åœ¨<code>PHP</code>è„šæœ¬ä¼ é€’ä¸€ä¸ªæ•°ç»„è¿›å…¥<code>PHP</code>æ‰©å±•çš„æ—¶å€™ï¼Œå®é™…ä¸Šåªæ˜¯å¢åŠ äº†è¿™ä¸ªæ•°ç»„çš„å¼•ç”¨è®¡æ•°ã€‚æˆ‘ä»¬å¯ä»¥ç”¨<code>gdb</code>æ¥è°ƒè¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> 34â”‚ PHP_FUNCTION(test)</span><br><span class="line"> 35â”‚ &#123;</span><br><span class="line"> 36â”‚     zval *arr;</span><br><span class="line"> 37â”‚</span><br><span class="line"> 38â”‚     if(zend_parse_parameters(ZEND_NUM_ARGS(), &quot;a&quot;, &amp;arr) == FAILURE)&#123;</span><br><span class="line"> 39â”‚         RETURN_FALSE;</span><br><span class="line"> 40â”‚     &#125;</span><br><span class="line"> 41â”œâ”€â”€â”€&gt; RETURN_ARR(Z_ARR_P(arr));</span><br><span class="line"> 42â”‚ &#125;</span><br><span class="line"></span><br><span class="line">(gdb) p *arr.value.arr</span><br><span class="line"><span class="meta">$</span><span class="bash">3 = &#123;gc = &#123;refcount = 2, u = &#123;type_info = 23&#125;&#125;, u = &#123;v = &#123;flags = 24 <span class="string">&#x27;\030&#x27;</span>, _unused = 0 <span class="string">&#x27;\000&#x27;</span>, nIteratorsCount = 0 <span class="string">&#x27;\000&#x27;</span>, _unused2 = 0 <span class="string">&#x27;\000&#x27;</span>&#125;, flags = 24&#125;, nTableMask = 4294967280, arData = 0x7ffff76</span></span><br><span class="line">66680, nNumUsed = 1, nNumOfElements = 1, nTableSize = 8, nInternalPointer = 0, nNextFreeElement = 0, pDestructor = 0x555555a46860 &lt;zval_ptr_dtor&gt;&#125;</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œåœ¨è°ƒç”¨äº†<code>zend_parse_parameters</code>è§£æå‡º<code>PHP</code>è„šæœ¬ä¼ é€’è¿‡æ¥çš„æ•°ç»„ä¹‹åï¼Œè¿™ä¸ªæ•°ç»„çš„å¼•ç”¨è®¡æ•°å˜æˆäº†<code>2</code>ã€‚è¿™ä¸€æ­¥å¢åŠ å¼•ç”¨è®¡æ•°çš„æ“ä½œæ˜¯<code>PHP</code>åº•å±‚è‡ªåŠ¨å¸®æˆ‘ä»¬åšçš„ã€‚</p>
<p>ç„¶åï¼Œé€šè¿‡<code>xdebug</code>æ‰“å°å‘ç°ï¼Œä»æ‰©å±•é‡Œé¢è¿”å›æ•°ç»„åˆ°<code>PHP</code>è„šæœ¬åï¼Œå®ƒçš„å¼•ç”¨è®¡æ•°åˆå˜å›äº†<code>1</code>ã€‚è¿™ä¸€æ­¥ä¹Ÿæ˜¯<code>PHP</code>å¸®æˆ‘ä»¬åšçš„ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬<code>unset</code>äº†<code>$a</code>ï¼Œä½¿å¾—è¿™ä¸ªæ•°ç»„çš„å¼•ç”¨è®¡æ•°å˜æˆäº†<code>0</code>ã€‚åˆå› ä¸º<code>$b</code>å’Œ<code>$a</code>æŒ‡å‘çš„æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ‰€ä»¥ï¼Œæ­¤æ—¶æˆ‘ä»¬å†ä½¿ç”¨<code>$b</code>ï¼Œå°±ä¼šæŠ¥é”™äº†ã€‚</p>
<p>ä»¥ä¸Š<code>bug</code>ä¼šåœ¨åŠ¨æ€ç”Ÿæˆæ•°ç»„æ—¶å‡ºç°ã€‚å¦‚æœæˆ‘ä»¬åˆå§‹çš„æ•°ç»„æ˜¯ä¸€ä¸ªä¸å¯å˜æ•°ç»„ï¼Œé‚£ä¹ˆï¼ŒåŒæ ·çš„ä»£ç æ˜¯ä¸ä¼šå‡ºç°<code>bug</code>çš„ã€‚å› ä¸ºä¸å¯å˜æ•°ç»„çš„åˆå§‹å¼•ç”¨è®¡æ•°æ˜¯<code>2</code>ï¼Œè€Œä¸æ˜¯<code>1</code>ã€‚æˆ‘ä»¬å¯ä»¥æµ‹è¯•ä¸€ä¸‹ï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">array</span>(<span class="string">&quot;time&quot;</span> =&gt; <span class="number">1111</span>);</span><br><span class="line">xdebug_debug_zval(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">$b = test($a);</span><br><span class="line">xdebug_debug_zval(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">xdebug_debug_zval(<span class="string">&quot;b&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">unset</span>($a);</span><br><span class="line"></span><br><span class="line">var_dump($b);</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æŠŠ<code>time</code>å¯¹åº”çš„<code>value</code>å†™æ­»ä¸º<code>1111</code>ã€‚ç„¶åæ‰§è¡Œè„šæœ¬ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/cppCode/study # php test.php</span><br><span class="line">a: (refcount=2, is_ref=0)=array (&#x27;time&#x27; =&gt; (refcount=0, is_ref=0)=1111)</span><br><span class="line">a: (refcount=2, is_ref=0)=array (&#x27;time&#x27; =&gt; (refcount=0, is_ref=0)=1111)</span><br><span class="line">b: (refcount=2, is_ref=0)=array (&#x27;time&#x27; =&gt; (refcount=0, is_ref=0)=1111)</span><br><span class="line">/root/codeDir/cppCode/study/test.php:11:</span><br><span class="line">array(1) &#123;</span><br><span class="line">  &#x27;time&#x27; =&gt;</span><br><span class="line">  int(1111)</span><br><span class="line">&#125;</span><br><span class="line">~/codeDir/cppCode/study #</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œå› ä¸ºä¸å¯å˜æ•°ç»„åˆå§‹çš„å¼•ç”¨è®¡æ•°æ˜¯<code>2</code>ï¼Œå½“æˆ‘ä»¬å¯¹<code>unset($a)</code>ä¹‹åï¼Œå®ƒçš„å¼•ç”¨è®¡æ•°å˜æˆäº†<code>1</code>ã€‚æ­¤æ—¶ï¼Œè¿™ä¸ªæ•°ç»„è¿˜æ˜¯å¯ä»¥ç”¨çš„ï¼Œæ‰€ä»¥åé¢ä½¿ç”¨<code>$b</code>ä¸ä¼šæŠ¥é”™ã€‚</p>
<p>æ­£æ˜¯å› ä¸ºä»<code>PHP</code>è„šæœ¬ä¼ å…¥åˆ°æ‰©å±•ï¼Œä»¥åŠä»æ‰©å±•ä¼ å‡ºåˆ°<code>PHP</code>è„šæœ¬çš„é‚£ä¸ªæ•°ç»„æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥ï¼Œ<code>$a</code>å’Œ<code>$b</code>éƒ½æ˜¯æŒ‡å‘åŒä¸€ä¸ªæ•°ç»„çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ‰©å±•å±‚é¢æ‰‹åŠ¨ä¸ºè¿™ä¸ªæ•°ç»„çš„å¼•ç”¨è®¡æ•°<code>+1</code>ã€‚æ‰€ä»¥ï¼Œæ‰©å±•ä»£ç åº”è¯¥æ”¹ä¸ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(test)</span><br><span class="line">&#123;</span><br><span class="line">    zval *arr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(zend_parse_parameters(ZEND_NUM_ARGS(), <span class="string">&quot;a&quot;</span>, &amp;arr) == FAILURE)&#123;</span><br><span class="line">        RETURN_FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">    Z_TRY_ADDREF_P(arr);</span><br><span class="line">    RETURN_ARR(Z_ARR_P(arr));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é‡æ–°ç¼–è¯‘ã€å®‰è£…æ‰©å±•ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/cppCode/study # make clean ; make ; make install</span><br><span class="line">----------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Build complete.</span><br><span class="line">Don&#x27;t forget to run &#x27;make test&#x27;.</span><br><span class="line"></span><br><span class="line">Installing shared extensions:     /usr/local/lib/php/extensions/no-debug-non-zts-20180731/</span><br><span class="line">Installing header files:          /usr/local/include/php/</span><br><span class="line">~/codeDir/cppCode/study #</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•è„šæœ¬ä¸ºï¼š</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">array</span>(<span class="string">&quot;time&quot;</span> =&gt; time());</span><br><span class="line">xdebug_debug_zval(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">$b = test($a);</span><br><span class="line">xdebug_debug_zval(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">xdebug_debug_zval(<span class="string">&quot;b&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">unset</span>($a);</span><br><span class="line"></span><br><span class="line">var_dump($b);</span><br></pre></td></tr></table></figure>

<p>æŒ‡å‘è„šæœ¬ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/cppCode/study # php test.php</span><br><span class="line">a: (refcount=1, is_ref=0)=array (&#x27;time&#x27; =&gt; (refcount=0, is_ref=0)=1569291353)</span><br><span class="line">a: (refcount=2, is_ref=0)=array (&#x27;time&#x27; =&gt; (refcount=0, is_ref=0)=1569291353)</span><br><span class="line">b: (refcount=2, is_ref=0)=array (&#x27;time&#x27; =&gt; (refcount=0, is_ref=0)=1569291353)</span><br><span class="line">/root/codeDir/cppCode/study/test.php:11:</span><br><span class="line">array(1) &#123;</span><br><span class="line">  &#x27;time&#x27; =&gt;</span><br><span class="line">  int(1569291353)</span><br><span class="line">&#125;</span><br><span class="line">~/codeDir/cppCode/study #</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å‘ç°ï¼Œä»æ‰©å±•ä¼ å›åˆ°<code>PHP</code>çš„æ—¶å€™ï¼Œè¿™ä¸ªæ•°ç»„çš„å¼•ç”¨è®¡æ•°å˜æˆäº†<code>2</code>ã€‚å› æ­¤ï¼Œå½“æˆ‘ä»¬<code>unset($a)</code>ä¹‹åï¼Œè¿™ä¸ªæ•°ç»„çš„å¼•ç”¨è®¡æ•°å˜æˆäº†<code>1</code>ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å†æ¬¡ä½¿ç”¨<code>$b</code>å°±ä¸ä¼šå‡ºé”™äº†ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/09/24/%E3%80%8APHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91-%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0%E7%9A%84%E4%BD%BF%E7%94%A8%E3%80%8B/" data-id="ckkj72zsz005sf6vx1ws1cuty" data-title="ã€ŠPHPæ‰©å±•å¼€å‘--å¼•ç”¨è®¡æ•°çš„ä½¿ç”¨ã€‹" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHPæ‰©å±•å¼€å‘</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/" rel="tag">å¼•ç”¨è®¡æ•°</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/9/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/11/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost/" rel="tag">Boost</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Composer/" rel="tag">Composer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C%E8%AF%AD%E8%A8%80/" rel="tag">Cè¯­è¨€</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dockerfile/" rel="tag">Dockerfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GRPC/" rel="tag">GRPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GraphQL/" rel="tag">GraphQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hyperf/" rel="tag">Hyperf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" rel="tag">I/Oå¤šè·¯å¤ç”¨</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JIT/" rel="tag">JIT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JWT/" rel="tag">JWT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Laravel/" rel="tag">Laravel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MacOS/" rel="tag">MacOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/" rel="tag">Mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OPcache/" rel="tag">OPcache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHP æ‰©å±•å¼€å‘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP7/" rel="tag">PHP7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHPå†…æ ¸</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95/" rel="tag">PHPæ‰©å±•</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHPæ‰©å±•å¼€å‘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/" rel="tag">PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Protobuf/" rel="tag">Protobuf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swoole%E5%BE%AE%E8%AF%BE%E7%A8%8B/" rel="tag">Swooleå¾®è¯¾ç¨‹</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vscode/" rel="tag">Vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xdebug/" rel="tag">Xdebug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/composer/" rel="tag">composer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c%E8%AF%AD%E8%A8%80/" rel="tag">cè¯­è¨€</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-compose/" rel="tag">docker-compose</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/epoll/" rel="tag">epoll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fpm/" rel="tag">fpm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gqlgen/" rel="tag">gqlgen</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/migrate/" rel="tag">migrate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swoole/" rel="tag">swoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swore/" rel="tag">swore</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tinyswoole/" rel="tag">tinyswoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unique-lock/" rel="tag">unique_lock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-js/" rel="tag">vue.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%B6%E4%BB%96/" rel="tag">å…¶ä»–</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">å‰ç«¯</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%8F%E7%A8%8B/" rel="tag">åç¨‹</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%96%E9%83%A8%E6%8E%92%E5%BA%8F/" rel="tag">å¤–éƒ¨æ’åº</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" rel="tag">å¤šçº¿ç¨‹ç¼–ç¨‹</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">å¹¶å‘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/" rel="tag">å¼•ç”¨è®¡æ•°</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD/" rel="tag">æ€§èƒ½</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" rel="tag">æ€§èƒ½ä¼˜åŒ–</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" rel="tag">æ€§èƒ½åˆ†æ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">æ“ä½œç³»ç»Ÿ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">æ•°æ®åº“</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">æ•°æ®ç»“æ„</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" rel="tag">æœåŠ¡å™¨å¼€å‘</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" rel="tag">æœåŠ¡å™¨ç¼–ç¨‹</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" rel="tag">æ±‡ç¼–è¯­è¨€</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" rel="tag">ç§’æ€ç³»ç»Ÿ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">ç®—æ³•</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B/" rel="tag">çº¿ç¨‹</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">çº¿ç¨‹æ± </a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A0%81/" rel="tag">ç¼–ç </a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">ç¼–è¯‘åŸç†</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" rel="tag">ç¼–è¯‘å™¨</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag">ç½‘ç»œç¼–ç¨‹</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag">è™šæ‹Ÿæœº</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" rel="tag">è®¡ç®—æœºåŸºç¡€</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" rel="tag">è®¡ç®—æœºç³»ç»Ÿ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">è®¡ç®—æœºç½‘ç»œ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">è®¾è®¡æ¨¡å¼</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E8%AF%BB%E4%BB%A3%E7%A0%81/" rel="tag">è¯»è¯»ä»£ç </a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B0%83%E8%AF%95/" rel="tag">è°ƒè¯•</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%92%E5%BD%92/" rel="tag">é€’å½’</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%94%81/" rel="tag">é”</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Boost/" style="font-size: 10px;">Boost</a> <a href="/tags/C/" style="font-size: 11.43px;">C</a> <a href="/tags/C/" style="font-size: 16.43px;">C++</a> <a href="/tags/Composer/" style="font-size: 10px;">Composer</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 15px;">Cè¯­è¨€</a> <a href="/tags/Docker/" style="font-size: 11.43px;">Docker</a> <a href="/tags/Dockerfile/" style="font-size: 10px;">Dockerfile</a> <a href="/tags/GRPC/" style="font-size: 10.71px;">GRPC</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/GraphQL/" style="font-size: 10px;">GraphQL</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Hyperf/" style="font-size: 10.71px;">Hyperf</a> <a href="/tags/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" style="font-size: 10.71px;">I/Oå¤šè·¯å¤ç”¨</a> <a href="/tags/JIT/" style="font-size: 10px;">JIT</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Laravel/" style="font-size: 10px;">Laravel</a> <a href="/tags/Linux/" style="font-size: 17.14px;">Linux</a> <a href="/tags/MacOS/" style="font-size: 10px;">MacOS</a> <a href="/tags/MySQL/" style="font-size: 10.71px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/OPcache/" style="font-size: 10px;">OPcache</a> <a href="/tags/PHP/" style="font-size: 20px;">PHP</a> <a href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size: 10.71px;">PHP æ‰©å±•å¼€å‘</a> <a href="/tags/PHP7/" style="font-size: 10px;">PHP7</a> <a href="/tags/PHP%E5%86%85%E6%A0%B8/" style="font-size: 17.86px;">PHPå†…æ ¸</a> <a href="/tags/PHP%E6%89%A9%E5%B1%95/" style="font-size: 13.57px;">PHPæ‰©å±•</a> <a href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size: 12.14px;">PHPæ‰©å±•å¼€å‘</a> <a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="/tags/Protobuf/" style="font-size: 10.71px;">Protobuf</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/Swoole/" style="font-size: 19.29px;">Swoole</a> <a href="/tags/Swoole%E5%BE%AE%E8%AF%BE%E7%A8%8B/" style="font-size: 10px;">Swooleå¾®è¯¾ç¨‹</a> <a href="/tags/Vscode/" style="font-size: 10px;">Vscode</a> <a href="/tags/Xdebug/" style="font-size: 10.71px;">Xdebug</a> <a href="/tags/c/" style="font-size: 10.71px;">c++</a> <a href="/tags/composer/" style="font-size: 10px;">composer</a> <a href="/tags/c%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">cè¯­è¨€</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/docker-compose/" style="font-size: 10px;">docker-compose</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/fpm/" style="font-size: 10px;">fpm</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/gqlgen/" style="font-size: 10px;">gqlgen</a> <a href="/tags/leetcode/" style="font-size: 12.14px;">leetcode</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/migrate/" style="font-size: 10px;">migrate</a> <a href="/tags/nginx/" style="font-size: 10.71px;">nginx</a> <a href="/tags/php/" style="font-size: 15.71px;">php</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/swoole/" style="font-size: 15.71px;">swoole</a> <a href="/tags/swore/" style="font-size: 10px;">swore</a> <a href="/tags/tinyswoole/" style="font-size: 10px;">tinyswoole</a> <a href="/tags/unique-lock/" style="font-size: 10px;">unique_lock</a> <a href="/tags/vue-js/" style="font-size: 10.71px;">vue.js</a> <a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 12.14px;">å…¶ä»–</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">å‰ç«¯</a> <a href="/tags/%E5%8D%8F%E7%A8%8B/" style="font-size: 15.71px;">åç¨‹</a> <a href="/tags/%E5%A4%96%E9%83%A8%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">å¤–éƒ¨æ’åº</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">å¤šçº¿ç¨‹ç¼–ç¨‹</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">å¹¶å‘</a> <a href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/" style="font-size: 10px;">å¼•ç”¨è®¡æ•°</a> <a href="/tags/%E6%80%A7%E8%83%BD/" style="font-size: 10px;">æ€§èƒ½</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 10px;">æ€§èƒ½ä¼˜åŒ–</a> <a href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" style="font-size: 10px;">æ€§èƒ½åˆ†æ</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 13.57px;">æ“ä½œç³»ç»Ÿ</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">æ•°æ®åº“</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 10.71px;">æ•°æ®ç»“æ„</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" style="font-size: 12.86px;">æœåŠ¡å™¨å¼€å‘</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">æœåŠ¡å™¨ç¼–ç¨‹</a> <a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">æ±‡ç¼–è¯­è¨€</a> <a href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">ç§’æ€ç³»ç»Ÿ</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">ç®—æ³•</a> <a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 10px;">çº¿ç¨‹</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 10px;">çº¿ç¨‹æ± </a> <a href="/tags/%E7%BC%96%E7%A0%81/" style="font-size: 10px;">ç¼–ç </a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" style="font-size: 18.57px;">ç¼–è¯‘åŸç†</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" style="font-size: 10px;">ç¼–è¯‘å™¨</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" style="font-size: 14.29px;">ç½‘ç»œç¼–ç¨‹</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 10px;">è™šæ‹Ÿæœº</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">è®¡ç®—æœºåŸºç¡€</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">è®¡ç®—æœºç³»ç»Ÿ</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 10.71px;">è®¡ç®—æœºç½‘ç»œ</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10.71px;">è®¾è®¡æ¨¡å¼</a> <a href="/tags/%E8%AF%BB%E8%AF%BB%E4%BB%A3%E7%A0%81/" style="font-size: 10.71px;">è¯»è¯»ä»£ç </a> <a href="/tags/%E8%B0%83%E8%AF%95/" style="font-size: 10px;">è°ƒè¯•</a> <a href="/tags/%E9%80%92%E5%BD%92/" style="font-size: 10px;">é€’å½’</a> <a href="/tags/%E9%94%81/" style="font-size: 10px;">é”</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/30/PHP%E5%87%BD%E6%95%B0%E7%BC%96%E8%AF%91%E4%B9%8B%E5%90%8E%E7%9A%84%E5%86%85%E5%AD%98%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/">PHPå‡½æ•°ç¼–è¯‘ä¹‹åçš„å†…å­˜å­˜å‚¨ç»“æ„</a>
          </li>
        
          <li>
            <a href="/2021/01/07/%E5%9C%A8PHP-RSHUTDOWN%E9%98%B6%E6%AE%B5%E8%B0%83%E7%94%A8zend-bailout%E5%AF%BC%E8%87%B4zend-mm-heap-corrupted%E9%97%AE%E9%A2%98/">åœ¨PHP RSHUTDOWNé˜¶æ®µè°ƒç”¨zend_bailoutå¯¼è‡´zend_mm_heap corruptedé—®é¢˜</a>
          </li>
        
          <li>
            <a href="/2021/01/07/PHP%E6%89%A9%E5%B1%95%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E7%A7%81%E6%9C%89%E5%B1%9E%E6%80%A7%E7%9A%84%E5%90%8D%E5%AD%97/">PHPæ‰©å±•å¦‚ä½•è·å–ç§æœ‰å±æ€§çš„åå­—</a>
          </li>
        
          <li>
            <a href="/2020/12/16/PHP%E6%89%A9%E5%B1%95%E5%A6%82%E4%BD%95%E5%8E%BB%E6%A3%80%E6%9F%A5%E4%BE%9D%E8%B5%96%E7%9A%84C-%E5%BA%93%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8/">PHPæ‰©å±•å¦‚ä½•å»æ£€æŸ¥ä¾èµ–çš„C++åº“æ˜¯å¦å­˜åœ¨</a>
          </li>
        
          <li>
            <a href="/2020/11/24/Swoole-native-curl%E5%8D%8F%E7%A8%8B%E5%8C%96%E6%80%9D%E8%B7%AF/">Swoole native curlåç¨‹åŒ–æ€è·¯</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 codinghuang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>