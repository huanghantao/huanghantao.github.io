<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>codinghuang的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="比PHP多一些">
<meta property="og:type" content="website">
<meta property="og:title" content="codinghuang的个人博客">
<meta property="og:url" content="http://huanghantao.github.io/page/14/index.html">
<meta property="og:site_name" content="codinghuang的个人博客">
<meta property="og:description" content="比PHP多一些">
<meta property="og:locale">
<meta property="article:author" content="codinghuang">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="codinghuang的个人博客" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.1.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">codinghuang的个人博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">简洁些、干净些、直接些...</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://huanghantao.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-《PHP扩展开发》-RETURN_*的使用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/05/28/%E3%80%8APHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E3%80%8B-RETURN_*%E7%9A%84%E4%BD%BF%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2019-05-28T10:54:33.000Z" itemprop="datePublished">2019-05-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/05/28/%E3%80%8APHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E3%80%8B-RETURN_*%E7%9A%84%E4%BD%BF%E7%94%A8/">《PHP扩展开发》--RETURN_*宏的使用</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>以<code>RETURN_FALSE</code>宏为例，我们展开后得到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RETURN_FALSE  					&#123; RETVAL_FALSE; return; &#125;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> RETVAL_FALSE  					ZVAL_FALSE(return_value)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZVAL_FALSE(z) do &#123;				\</span></span><br><span class="line">		Z_TYPE_INFO_P(z) = IS_FALSE;	\</span><br><span class="line">	&#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>所以，<code>RETURN_FALSE</code>的作用就是把<code>return_value</code>这个扩展函数的返回值设置为<code>false</code>，然后再执行<code>C</code>语言的<code>return;</code>，从而跳出扩展函数。所以，<code>RETURN_FALSE</code>后面是不需要分号结尾的。（当然，写了也没事）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/05/28/%E3%80%8APHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E3%80%8B-RETURN_*%E7%9A%84%E4%BD%BF%E7%94%A8/" data-id="ckkj72zsz005qf6vxg70rfcs0" data-title="《PHP扩展开发》--RETURN_*宏的使用" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95/" rel="tag">PHP扩展</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《就是要你懂Swoole》-虚拟机中断" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/05/27/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82Swoole%E3%80%8B-%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E6%96%AD/" class="article-date">
  <time class="dt-published" datetime="2019-05-27T06:09:29.000Z" itemprop="datePublished">2019-05-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/05/27/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82Swoole%E3%80%8B-%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E6%96%AD/">《就是要你懂Swoole》--虚拟机中断</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这篇文章是讲解<code>PHP7</code>虚拟机中断的用法，理解这篇文章之后就可以更好的理解<code>Swoole</code>在CPU密集型的情况下协程的调度原理。</p>
<p>Swoole之前尝试了多种方法来处理CPU密集型环境下协程的切换问题。分别是Hook for循环，使用<code>PHP</code>的<code>declare(ticks=N)</code>语法。因为种种原因，<code>Swoole</code>现在使用了虚拟机中断的方法来切换一直占用<code>CPU</code>的协程。具体原因可以查看PHP最近的<code>Issue</code>以及<code>PR</code>，里面写的很清楚了。</p>
<p>好的，我们现在来感受一下虚拟机中断的用法。</p>
<p>首先，我们实现一个扩展函数，它的作用是开启对虚拟机中断的使用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(start_interrupt) &#123;</span><br><span class="line">	init();</span><br><span class="line">	create_scheduler_thread();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>init的实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	orig_interrupt_function = zend_interrupt_function;</span><br><span class="line">	zend_interrupt_function = new_interrupt_function;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的核心是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zend_interrupt_function = new_interrupt_function;</span><br></pre></td></tr></table></figure>

<p>也就是说，我们需要实现<code>zend_interrupt_function</code>。<code>zend_interrupt_function</code>的作用是在虚拟机中断发生的时候，会去执行的函数。并且，<code>zend_interrupt_function</code>是<code>PHP</code>内核定义的一个函数指针。</p>
<p>（我们这篇文章不多讲<code>orig_interrupt_function = zend_interrupt_function;</code>，我们假设没有其他扩展实现了<code>zend_interrupt_function</code>）</p>
<p><code>new_interrupt_function</code>的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">new_interrupt_function</span><span class="params">(zend_execute_data *execute_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">		php_printf(<span class="string">&quot;yield coroutine\n&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (orig_interrupt_function)</span><br><span class="line">    &#123;</span><br><span class="line">        orig_interrupt_function(execute_data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出，我们的这个函数<code>&#39;模拟&#39;</code>了<code>yield</code>协程的过程。OK，我们接着看<code>create_scheduler_thread</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">create_scheduler_thread</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> pidt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (pthread_create(&amp;pidt, <span class="literal">NULL</span>, (<span class="keyword">void</span> * (*)(<span class="keyword">void</span> *)) schedule, <span class="literal">NULL</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        php_printf(<span class="string">&quot;pthread_create[PHPCoroutine Scheduler] failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数的作用是创建一个线程，这个线程的执行体是<code>schedule</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">schedule</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        EG(vm_interrupt) = <span class="number">1</span>;</span><br><span class="line">        usleep(<span class="number">5000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而这个<code>schedule</code>线程我们可以认为它是一个负责调用的一个线程。它设置<code>EG(vm_interrupt)</code>的值为1。设置完之后，当虚拟机检查到这个值为1的时候，就会去执行<code>new_interrupt_function</code>函数，从而实现了<code>yield</code>协程。</p>
<p>每次触发完虚拟机中断后，虚拟机会把<code>EG(vm_interrupt)</code>设置为0。因此，这里需要循环的去设置<code>EG(vm_interrupt)</code>的值为1。为什么这里需要使用<code>usleep</code>呢？因为中断不是每分每秒都在进行的，所以可以挂起这个线程，让其他线程跑。</p>
<p>好的，我们来写一段<code>PHP</code>脚本来测试一下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">start_interrupt();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;1\n&quot;</span>;</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/phpCode/test # php interrupt.php </span><br><span class="line">1</span><br><span class="line">yeild coroutine</span><br><span class="line">1</span><br><span class="line">yeild coroutine</span><br><span class="line">1</span><br><span class="line">yeild coroutine</span><br><span class="line">1</span><br><span class="line">yeild coroutine</span><br><span class="line">1</span><br><span class="line">yeild coroutine</span><br><span class="line">1</span><br><span class="line">......</span><br><span class="line">^C</span><br><span class="line">~/codeDir/phpCode/test # </span><br></pre></td></tr></table></figure>






      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/05/27/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82Swoole%E3%80%8B-%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E6%96%AD/" data-id="ckkj72zt40067f6vxebny1gcz" data-title="《就是要你懂Swoole》--虚拟机中断" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95/" rel="tag">PHP扩展</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《PHP扩展开发》-return-value的使用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/05/25/%E3%80%8APHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E3%80%8B-return-value%E7%9A%84%E4%BD%BF%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2019-05-25T07:31:40.000Z" itemprop="datePublished">2019-05-25</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/05/25/%E3%80%8APHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E3%80%8B-return-value%E7%9A%84%E4%BD%BF%E7%94%A8/">《PHP扩展开发》--return_value的使用</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>在PHP扩展中编写函数的时候，如果我们要从PHP扩展返回值给PHP脚本，可以使用<code>return_value</code>来做到。例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PHP_FUNCTION(hello_world) &#123;</span><br><span class="line">    ZVAL_STRINGL(return_value, <span class="string">&quot;hello world!&quot;</span>, <span class="built_in">strlen</span>(<span class="string">&quot;hello world!&quot;</span>));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZVAL_STRINGL(z, s, l) do &#123;				\</span></span><br><span class="line">		ZVAL_NEW_STR(z, zend_string_init(s, l, <span class="number">0</span>));		\</span><br><span class="line">	&#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> zend_always_inline zend_string *<span class="title">zend_string_init</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *str, <span class="keyword">size_t</span> len, <span class="keyword">int</span> persistent)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	zend_string *ret = zend_string_alloc(len, persistent);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memcpy</span>(ZSTR_VAL(ret), str, len);</span><br><span class="line">	ZSTR_VAL(ret)[len] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZSTR_VAL(zstr)  (zstr)-&gt;val</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZVAL_NEW_STR(z, s) do &#123;					\</span></span><br><span class="line">		zval *__z = (z);						\</span><br><span class="line">		zend_string *__s = (s);					\</span><br><span class="line">		Z_STR_P(__z) = __s;						\</span><br><span class="line">		Z_TYPE_INFO_P(__z) = IS_STRING_EX;		\</span><br><span class="line">	&#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>其中，<code>zend_string_init</code>的作用就是从堆中分配一块内存给<code>ret</code>。然后把字符串<code>hello world!</code>以及字符串的长度保存在<code>ret</code>里面，然后，返回包含<code>hello world!</code>字符串的地址。</p>
<p><code>ZVAL_NEW_STR(z, s)</code>的作用是让<code>z</code>指向<code>s</code>，也就是说，此时的<code>return_value</code>里面的<code>value.str</code>指向了<code>zend_string_init</code>返回的包含了<code>hello world!</code>字符串的<code>zend_string</code>。</p>
<p>所以说，通过<code>return_value</code>可以找到字符串<code>hello world!</code>。</p>
<p>一个问题是这个<code>return_value</code>是哪里来的？</p>
<p>我们展开<code>PHP_FUNCTION</code>可以看到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHP_FUNCTION			ZEND_FUNCTION</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_FUNCTION(name)				ZEND_NAMED_FUNCTION(ZEND_FN(name))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_FN(name) zif_##name</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZEND_NAMED_FUNCTION(name)		void name(INTERNAL_FUNCTION_PARAMETERS)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INTERNAL_FUNCTION_PARAMETERS zend_execute_data *execute_data, zval *return_value</span></span><br></pre></td></tr></table></figure>

<p>因此，我们对<code>PHP_FUNCTION(hello_world)</code>进行展开的话，可以得到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zif_hello_world(zend_execute_data *execute_data, zval *return_value)</span><br></pre></td></tr></table></figure>

<p>所以，我们可以在使用了<code>PHP_FUNCTION</code>宏里面使用<code>return_value</code>。我们往<code>return_value</code>里面填充值的话，<code>PHP</code>脚本就可以得到返回值了。</p>
<p>因此，我们执行如下脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$ret = hello_world();</span><br><span class="line">var_dump($ret);</span><br></pre></td></tr></table></figure>

<p>就可以打印出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/phpCode/test # php study.php </span><br><span class="line">string(12) &quot;hello world!&quot;</span><br></pre></td></tr></table></figure>










      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/05/25/%E3%80%8APHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E3%80%8B-return-value%E7%9A%84%E4%BD%BF%E7%94%A8/" data-id="ckkj72zt0005vf6vxbwdn778f" data-title="《PHP扩展开发》--return_value的使用" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95/" rel="tag">PHP扩展</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《就是要你懂Swoole》-使用Client的时候需要注意的地方" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/05/10/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82Swoole%E3%80%8B-%E4%BD%BF%E7%94%A8Client%E7%9A%84%E6%97%B6%E5%80%99%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9/" class="article-date">
  <time class="dt-published" datetime="2019-05-10T02:52:46.000Z" itemprop="datePublished">2019-05-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/05/10/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82Swoole%E3%80%8B-%E4%BD%BF%E7%94%A8Client%E7%9A%84%E6%97%B6%E5%80%99%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9/">《就是要你懂Swoole》—使用Swoole\Client的时候需要注意的地方</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>今早看Swoole修复了一个创建<code>Swoole\Client</code>的bug，我记得之前是没有的，应该是用C++重构Swoole的时候出现的。Issue在这里<a target="_blank" rel="noopener" href="https://github.com/swoole/swoole-src/issues/2568">#2568</a>，修复在这里 [<a target="_blank" rel="noopener" href="https://github.com/swoole/swoole-src/commit/e9fb220a1e835b967d643d88398d3d28246ea45a">e9fb220</a>]。</p>
<p>原来的代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cli-&gt;async)</span><br><span class="line">    &#123;</span><br><span class="line">        client_callback *cb = (client_callback *) swoole_get_property(getThis(), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (!cb)</span><br><span class="line">        &#123;</span><br><span class="line">            swoole_php_fatal_error(E_ERROR, <span class="string">&quot;no event callback function&quot;</span>);</span><br><span class="line">            RETURN_FALSE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (swSocket_is_stream(cli-&gt;type))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!cb-&gt;cache_onConnect.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                swoole_php_fatal_error(E_ERROR, <span class="string">&quot;no &#x27;onConnect&#x27; callback function&quot;</span>);</span><br><span class="line">                RETURN_FALSE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!cb-&gt;cache_onError.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                swoole_php_fatal_error(E_ERROR, <span class="string">&quot;no &#x27;onError&#x27; callback function&quot;</span>);</span><br><span class="line">                RETURN_FALSE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!cb-&gt;cache_onClose.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                swoole_php_fatal_error(E_ERROR, <span class="string">&quot;no &#x27;onClose&#x27; callback function&quot;</span>);</span><br><span class="line">                RETURN_FALSE;</span><br><span class="line">            &#125;</span><br><span class="line">            cli-&gt;onConnect = client_onConnect;</span><br><span class="line">            cli-&gt;onClose = client_onClose;</span><br><span class="line">            cli-&gt;onError = client_onError;</span><br><span class="line">            cli-&gt;onReceive = client_onReceive;</span><br><span class="line">            cli-&gt;reactor_fdtype = PHP_SWOOLE_FD_STREAM_CLIENT;</span><br><span class="line">            <span class="keyword">if</span> (cb-&gt;cache_onBufferFull.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                cli-&gt;onBufferFull = client_onBufferFull;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cb-&gt;cache_onBufferEmpty.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                cli-&gt;onBufferEmpty = client_onBufferEmpty;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!cb || !cb-&gt;cache_onReceive.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                swoole_php_fatal_error(E_ERROR, <span class="string">&quot;no &#x27;onReceive&#x27; callback function&quot;</span>);</span><br><span class="line">                RETURN_FALSE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cb-&gt;cache_onConnect.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                cli-&gt;onConnect = client_onConnect;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cb-&gt;cache_onClose.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                cli-&gt;onClose = client_onClose;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cb-&gt;cache_onError.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                cli-&gt;onError = client_onError;</span><br><span class="line">            &#125;</span><br><span class="line">            cli-&gt;onReceive = client_onReceive;</span><br><span class="line">            cli-&gt;reactor_fdtype = PHP_SWOOLE_FD_DGRAM_CLIENT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        zval *zobject = getThis();</span><br><span class="line">        cli-&gt;object = zobject;</span><br><span class="line">        sw_copy_to_stack(cli-&gt;object, cb-&gt;_object);</span><br><span class="line">        Z_TRY_ADDREF_P(zobject);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>现在代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cli-&gt;async)</span><br><span class="line">    &#123;</span><br><span class="line">        client_callback *cb = (client_callback *) swoole_get_property(getThis(), <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (!cb)</span><br><span class="line">        &#123;</span><br><span class="line">            swoole_php_fatal_error(E_ERROR, <span class="string">&quot;no event callback function&quot;</span>);</span><br><span class="line">            RETURN_FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!cb-&gt;cache_onReceive.function_handler)</span><br><span class="line">        &#123;</span><br><span class="line">            swoole_php_fatal_error(E_ERROR, <span class="string">&quot;no &#x27;onReceive&#x27; callback function&quot;</span>);</span><br><span class="line">            RETURN_FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (swSocket_is_stream(cli-&gt;type))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!cb-&gt;cache_onConnect.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                swoole_php_fatal_error(E_ERROR, <span class="string">&quot;no &#x27;onConnect&#x27; callback function&quot;</span>);</span><br><span class="line">                RETURN_FALSE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!cb-&gt;cache_onError.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                swoole_php_fatal_error(E_ERROR, <span class="string">&quot;no &#x27;onError&#x27; callback function&quot;</span>);</span><br><span class="line">                RETURN_FALSE;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!cb-&gt;cache_onClose.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                swoole_php_fatal_error(E_ERROR, <span class="string">&quot;no &#x27;onClose&#x27; callback function&quot;</span>);</span><br><span class="line">                RETURN_FALSE;</span><br><span class="line">            &#125;</span><br><span class="line">            cli-&gt;onConnect = client_onConnect;</span><br><span class="line">            cli-&gt;onClose = client_onClose;</span><br><span class="line">            cli-&gt;onError = client_onError;</span><br><span class="line">            cli-&gt;onReceive = client_onReceive;</span><br><span class="line">            cli-&gt;reactor_fdtype = PHP_SWOOLE_FD_STREAM_CLIENT;</span><br><span class="line">            <span class="keyword">if</span> (cb-&gt;cache_onBufferFull.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                cli-&gt;onBufferFull = client_onBufferFull;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cb-&gt;cache_onBufferEmpty.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                cli-&gt;onBufferEmpty = client_onBufferEmpty;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (cb-&gt;cache_onConnect.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                cli-&gt;onConnect = client_onConnect;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cb-&gt;cache_onClose.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                cli-&gt;onClose = client_onClose;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (cb-&gt;cache_onError.function_handler)</span><br><span class="line">            &#123;</span><br><span class="line">                cli-&gt;onError = client_onError;</span><br><span class="line">            &#125;</span><br><span class="line">            cli-&gt;onReceive = client_onReceive;</span><br><span class="line">            cli-&gt;reactor_fdtype = PHP_SWOOLE_FD_DGRAM_CLIENT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        zval *zobject = getThis();</span><br><span class="line">        cli-&gt;object = zobject;</span><br><span class="line">        sw_copy_to_stack(cli-&gt;object, cb-&gt;_object);</span><br><span class="line">        Z_TRY_ADDREF_P(zobject);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>之前是如果<code>socket</code>不是<code>stream</code>类型的时候才会判断是否定义了<code>onReceive</code>回调函数。现在把对是否定义了<code>onReceive</code>的判断放在了</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (swSocket_is_stream(cli-&gt;type))</span><br></pre></td></tr></table></figure>

<p>的上面，因此就变成了无论是不是<code>stream</code>类型的，都需要定义<code>onReceive</code>回调函数。</p>
<p>另外，<code>Swoole</code>创建的<code>Client</code>如果是<code>Stream</code>类型的，那么必须实现<code>onConnect</code>、<code>onReceive</code>、<code>onError</code>、<code>onClose</code>回调函数函数。如果不是<code>Stream</code>类型的，则可以不实现。当然，实现了这些回调函数也是可以的。从最近的一次修复来看。必须实现<code>onReceive</code>回调函数。（以上是在调用<code>client-&gt;connect</code>的时候进行判断的）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/05/10/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82Swoole%E3%80%8B-%E4%BD%BF%E7%94%A8Client%E7%9A%84%E6%97%B6%E5%80%99%E9%9C%80%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E5%9C%B0%E6%96%B9/" data-id="ckkj72zt30065f6vxeabz86a9" data-title="《就是要你懂Swoole》—使用Swoole\Client的时候需要注意的地方" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《就是要你懂Swoole》-package-eof的一个小细节" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/05/09/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82Swoole%E3%80%8B-package-eof%E7%9A%84%E4%B8%80%E4%B8%AA%E5%B0%8F%E7%BB%86%E8%8A%82/" class="article-date">
  <time class="dt-published" datetime="2019-05-09T01:29:11.000Z" itemprop="datePublished">2019-05-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/05/09/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82Swoole%E3%80%8B-package-eof%E7%9A%84%E4%B8%80%E4%B8%AA%E5%B0%8F%E7%BB%86%E8%8A%82/">《就是要你懂Swoole》--package_eof的一个小细节</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>有的同学在开启了<code>Swoole\Server</code>的<code>package_eof</code>的时候，发现并没有生效。<code>Server</code>端的代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$serv = <span class="keyword">new</span> Swoole\Server(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9501</span>);</span><br><span class="line"></span><br><span class="line">$serv-&gt;set(<span class="keyword">array</span>(</span><br><span class="line">    <span class="string">&#x27;worker_num&#x27;</span> =&gt; <span class="number">4</span>,</span><br><span class="line">    <span class="string">&#x27;package_eof&#x27;</span> =&gt; <span class="string">&quot;\r\n\r\n&quot;</span>,</span><br><span class="line">    <span class="string">&#x27;open_eof_check&#x27;</span> =&gt; <span class="number">1</span>,</span><br><span class="line">));</span><br><span class="line"></span><br><span class="line">$serv-&gt;on(<span class="string">&#x27;connect&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Client:Connect.\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$serv-&gt;on(<span class="string">&#x27;receive&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd, $reactor_id, $data</span>) </span>&#123;</span><br><span class="line">    $serv-&gt;send($fd, <span class="string">&#x27;Swoole: &#x27;</span>.$data);</span><br><span class="line">    $serv-&gt;close($fd);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$serv-&gt;on(<span class="string">&#x27;close&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">$serv, $fd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Client: Close.\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$serv-&gt;start();</span><br></pre></td></tr></table></figure>

<p><code>Client</code>端的代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$client = <span class="keyword">new</span> Swoole\Client(SWOOLE_SOCK_TCP, SWOOLE_SOCK_ASYNC);</span><br><span class="line"></span><br><span class="line">$client-&gt;on(<span class="string">&quot;connect&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">swoole_client $cli</span>) </span>&#123;</span><br><span class="line">    $cli-&gt;send(<span class="string">&#x27;hello world\r\n\r\n&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$client-&gt;on(<span class="string">&quot;receive&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">swoole_client $cli, $data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Receive: <span class="subst">$data</span>&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$client-&gt;on(<span class="string">&quot;error&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">swoole_client $cli</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;error\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$client-&gt;on(<span class="string">&quot;close&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">swoole_client $cli</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Connection close\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$client-&gt;connect(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9501</span>);</span><br></pre></td></tr></table></figure>

<p>我们打开两个终端，分别启动<code>Server</code>和<code>Client</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/phpCode/test # php server.php </span><br><span class="line">Client:Connect.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/phpCode/test # php client.php </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>讲道理来说，<code>client</code>连接上<code>server</code>之后，是会给<code>server</code>发生字符串<code>&#39;hello world\r\n\r\n&#39;</code>的，但是看样子<code>server</code>好像并没有解析出这个字符串对吧。</p>
<p>问题出在了<code>server</code>端的<code>package_eof</code>的值用的是双引号，而<code>client</code>发送给<code>server</code>的字符串用的是单引号。而PHP在单引号和双引号中解析<code>\r\n\r\n</code>是不一样的（至少在字符串的长度来说都是不同的）。所以我们需要统一一下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$client = <span class="keyword">new</span> Swoole\Client(SWOOLE_SOCK_TCP, SWOOLE_SOCK_ASYNC);</span><br><span class="line"></span><br><span class="line">$client-&gt;on(<span class="string">&quot;connect&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">swoole_client $cli</span>) </span>&#123;</span><br><span class="line">    $cli-&gt;send(<span class="string">&quot;hello world\r\n\r\n&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$client-&gt;on(<span class="string">&quot;receive&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">swoole_client $cli, $data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Receive: <span class="subst">$data</span>&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$client-&gt;on(<span class="string">&quot;error&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">swoole_client $cli</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;error\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$client-&gt;on(<span class="string">&quot;close&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">swoole_client $cli</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;Connection close\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$client-&gt;connect(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">9501</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/phpCode/test # php client.php </span><br><span class="line">Receive: Swoole: hello world</span><br><span class="line"></span><br><span class="line">Connection close</span><br><span class="line">~/codeDir/phpCode/test # </span><br></pre></td></tr></table></figure>

<p>此时，<code>server</code>就可以解析出这个<code>\r\n\r\n</code>了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/05/09/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82Swoole%E3%80%8B-package-eof%E7%9A%84%E4%B8%80%E4%B8%AA%E5%B0%8F%E7%BB%86%E8%8A%82/" data-id="ckkj72zt20060f6vx26zqel3k" data-title="《就是要你懂Swoole》--package_eof的一个小细节" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-《就是要你懂swoole》-协程创建" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/05/04/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-%E5%8D%8F%E7%A8%8B%E5%88%9B%E5%BB%BA/" class="article-date">
  <time class="dt-published" datetime="2019-05-04T09:56:35.000Z" itemprop="datePublished">2019-05-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/05/04/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-%E5%8D%8F%E7%A8%8B%E5%88%9B%E5%BB%BA/">《就是要你懂swoole》--协程创建</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这篇文章我们来调试一下swoole的协程创建过程。</p>
<p>PHP版本是<code>7.2.14</code>，Swoole的版本是<code>4.4.0-alpha</code>。</p>
<p>我们测试的代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// file: test.php</span></span><br><span class="line"></span><br><span class="line">go(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;co1\n&quot;</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">go(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&quot;co2\n&quot;</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>需要打断点地方有：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、zif_swoole_coroutine_create</span><br><span class="line"><span class="number">2</span>、swoole::PHPCoroutine::create</span><br><span class="line"><span class="number">3</span>、swoole::Coroutine::create</span><br></pre></td></tr></table></figure>

<p>OK，开始调试：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">cgdb php</span><br><span class="line">GNU gdb (GDB) 8.0.1</span><br><span class="line">Copyright (C) 2017 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span><br><span class="line">and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-alpine-linux-musl&quot;.</span><br><span class="line">Type &quot;show configuration&quot; for configuration details.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class="line">Find the GDB manual and other documentation resources online at:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class="line">For help, type &quot;help&quot;.</span><br><span class="line">Type &quot;apropos word&quot; to search for commands related to &quot;word&quot;...</span><br><span class="line">Reading symbols from php...(no debugging symbols found)...done.</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>分别在上面的两个函数打断点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b zif_swoole_coroutine_create</span><br><span class="line">Function &quot;zif_swoole_coroutine_create&quot; not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 1 (zif_swoole_coroutine_create) pending.</span><br><span class="line">(gdb) b swoole::PHPCoroutine::create</span><br><span class="line">Function &quot;swoole::PHPCoroutine::create&quot; not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 2 (swoole::PHPCoroutine::create) pending.</span><br><span class="line">(gdb) b swoole::Coroutine::create</span><br><span class="line">Function &quot;swoole::Coroutine::create&quot; not defined.</span><br><span class="line">Make breakpoint pending on future shared library load? (y or [n]) y</span><br><span class="line">Breakpoint 3 (swoole::Coroutine::create) pending.</span><br></pre></td></tr></table></figure>

<p>然后运行测试脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) r test.php </span><br><span class="line">Starting program: /usr/local/bin/php test.php</span><br><span class="line"></span><br><span class="line">Breakpoint 1, zif_swoole_coroutine_create (execute_data=0x7ffff681c0d0, return_value=0x7fffffffb090) at /root/codeDir/cCode/swoole-src/swoole_coroutine_util.cc:416</span><br><span class="line">warning: Source file is more recent than executable.</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">415</span>│ PHP_FUNCTION(swoole_coroutine_create)</span><br><span class="line"> <span class="number">416</span>├&gt;&#123;</span><br><span class="line"> <span class="number">417</span>│     zend_fcall_info fci = empty_fcall_info;</span><br><span class="line"> <span class="number">418</span>│     zend_fcall_info_cache fci_cache = empty_fcall_info_cache;</span><br><span class="line"> <span class="number">419</span>│</span><br><span class="line"> <span class="number">420</span>│     ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">-1</span>)</span><br><span class="line"> <span class="number">421</span>│         Z_PARAM_FUNC(fci, fci_cache)</span><br><span class="line"> <span class="number">422</span>│         Z_PARAM_VARIADIC(<span class="string">&#x27;*&#x27;</span>, fci.params, fci.param_count)</span><br><span class="line"> <span class="number">423</span>│     ZEND_PARSE_PARAMETERS_END_EX(RETURN_FALSE);</span><br></pre></td></tr></table></figure>

<p>接下来我们会看到<code>zend_fcall_info</code>和<code>zend_fcall_info_cache</code>，这两个结构体用来保存协程函数的信息（也就是<code>go()</code>这个函数里面的那个函数）。而<code>empty_fcall_info</code>也是<code>zend_fcall_info</code>类型的变量，它是只读的，并且里面的内容都为空：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p &amp;empty_fcall_info</span><br><span class="line"><span class="meta">$</span><span class="bash">1 = (const zend_fcall_info *) 0x5555561d42e0 &lt;empty_fcall_info&gt;</span></span><br><span class="line">(gdb) p empty_fcall_info</span><br><span class="line"><span class="meta">$</span><span class="bash">2 = &#123;size = 0, function_name = &#123;value = &#123;lval = 0, dval = 0, counted = 0x0, str = 0x0, arr = 0x0, obj = 0x0, res = 0x0, ref = 0x0, ast = 0x0, zv = 0x0, ptr = 0x0, ce = 0x0, func = 0x0, ww = &#123;w1 = 0, w2 =</span></span><br><span class="line"> 0&#125;&#125;, u1 = &#123;v = &#123;type = 0 &#x27;\000&#x27;, type_flags = 0 &#x27;\000&#x27;, const_flags = 0 &#x27;\000&#x27;, reserved = 0 &#x27;\000&#x27;&#125;, type_info = 0&#125;, u2 = &#123;next = 0, cache_slot = 0, lineno = 0, num_args = 0, fe_pos = 0, fe_iter_idx = 0</span><br><span class="line">, access_flags = 0, property_guard = 0, extra = 0&#125;&#125;, retval = 0x0, params = 0x0, object = 0x0, no_separation = 0 &#x27;\000&#x27;, param_count = 0&#125;</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>我们继续执行到420行之前：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u 420</span><br><span class="line">zif_swoole_coroutine_create (execute_data=0x7ffff681c0d0, return_value=0x7fffffffb090) at /root/codeDir/cCode/swoole-src/swoole_coroutine_util.cc:420</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">420</span>├───&gt; ZEND_PARSE_PARAMETERS_START(<span class="number">1</span>, <span class="number">-1</span>)</span><br><span class="line"><span class="number">421</span>│         Z_PARAM_FUNC(fci, fci_cache)</span><br><span class="line"><span class="number">422</span>│         Z_PARAM_VARIADIC(<span class="string">&#x27;*&#x27;</span>, fci.params, fci.param_count)</span><br><span class="line"><span class="number">423</span>│     ZEND_PARSE_PARAMETERS_END_EX(RETURN_FALSE);</span><br></pre></td></tr></table></figure>

<p>这段代码是用来获取协程函数然后保存它的信息到<code>fci</code>和<code>fci_cache</code>两个变量里面。我们执行完这3行代码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u 425</span><br><span class="line">zif_swoole_coroutine_create (execute_data=0x7ffff681c0d0, return_value=0x7fffffffb090) at /root/codeDir/cCode/swoole-src/swoole_coroutine_util.cc:425</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>然后打印一下里面的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p fci</span><br><span class="line"><span class="meta">$</span><span class="bash">3 = &#123;size = 56, function_name = &#123;value = &#123;lval = 140737329383616, dval = 6.9533479535888483e-310, counted = 0x7ffff68648c0, str = 0x7ffff68648c0, arr = 0x7ffff68648c0, obj = 0x7ffff68648c0, res = 0x7ffff</span></span><br><span class="line">68648c0, ref = 0x7ffff68648c0, ast = 0x7ffff68648c0, zv = 0x7ffff68648c0, ptr = 0x7ffff68648c0, ce = 0x7ffff68648c0, func = 0x7ffff68648c0, ww = &#123;w1 = 4135995584, w2 = 32767&#125;&#125;, u1 = &#123;v = &#123;type = 8 &#x27;\b&#x27;, t</span><br><span class="line">ype_flags = 4 &#x27;\004&#x27;, const_flags = 0 &#x27;\000&#x27;, reserved = 0 &#x27;\000&#x27;&#125;, type_info = 1032&#125;, u2 = &#123;next = 0, cache_slot = 0, lineno = 0, num_args = 0, fe_pos = 0, fe_iter_idx = 0, access_flags = 0, property_gua</span><br><span class="line">rd = 0, extra = 0&#125;&#125;, retval = 0x0, params = 0x0, object = 0x0, no_separation = 1 &#x27;\001&#x27;, param_count = 0&#125;</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>然后函数调用的参数以及参数个数保存了下来，我们查看一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p fci.params</span><br><span class="line"><span class="meta">$</span><span class="bash">9 = (zval *) 0x0</span></span><br><span class="line">(gdb) p fci.param_count</span><br><span class="line"><span class="meta">$</span><span class="bash">10 = 0</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>因为我们这里只给<code>go()</code>函数传递了一个协程函数，所以参数为空。</p>
<p>OK，我们继续往下走：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 2, 0x00007ffff485ad00 in swoole::PHPCoroutine::create(_zend_fcall_info_cache*, unsigned int, _zval_struct*)@plt () from /usr/local/lib/php/extensions/no-debug-non-zts-20170718/swoole.so</span><br><span class="line">(gdb) n</span><br><span class="line">Single stepping until exit from function _ZN6swoole12PHPCoroutine6createEP22_zend_fcall_info_cachejP12_zval_struct@plt,</span><br><span class="line">which has no line number information.</span><br><span class="line"></span><br><span class="line">Breakpoint 2, swoole::PHPCoroutine::create (fci_cache=fci_cache@entry=0x7fffffffafa0, argc=0, argv=0x0) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:418</span><br><span class="line">warning: Source file is more recent than executable.</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">417</span>│ <span class="function"><span class="keyword">long</span> <span class="title">PHPCoroutine::create</span><span class="params">(zend_fcall_info_cache *fci_cache, <span class="keyword">uint32_t</span> argc, zval *argv)</span></span></span><br><span class="line">418├&gt;&#123;</span><br><span class="line"><span class="number">419</span>│     <span class="keyword">if</span> (unlikely(!active))</span><br><span class="line"><span class="number">420</span>│     &#123;</span><br><span class="line"><span class="number">421</span>│         <span class="keyword">if</span> (zend_hash_str_find_ptr(&amp;module_registry, ZEND_STRL(<span class="string">&quot;xdebug&quot;</span>)))</span><br><span class="line"><span class="number">422</span>│         &#123;</span><br><span class="line"><span class="number">423</span>│             swoole_php_fatal_error(E_WARNING, <span class="string">&quot;Using Xdebug in coroutines is extremely dangerous, please notice that it may lead to coredump!&quot;</span>);</span><br><span class="line"><span class="number">424</span>│         &#125;</span><br><span class="line"><span class="number">425</span>│         php_swoole_check_reactor();</span><br><span class="line"><span class="number">426</span>│         <span class="comment">// PHPCoroutine::enable_hook(SW_HOOK_ALL); // <span class="doctag">TODO:</span> enable it in version 4.3.0</span></span><br><span class="line"><span class="number">427</span>│         active = <span class="literal">true</span>;</span><br><span class="line"><span class="number">428</span>│     &#125;</span><br></pre></td></tr></table></figure>

<p>此时就进入了<code>swoole::PHPCoroutine::create</code>这个函数。</p>
<p>421行是查找是否安装了<code>xdebug</code>这个扩展，因为这个扩展可能会导致<code>coredump</code>。</p>
<p>然后我们继续运行到425行之前：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u 425</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">425</span>├─<span class="number">555555</span>&gt; php_swoole_check_reactor();</span><br><span class="line"><span class="number">426</span>│         <span class="comment">// PHPCoroutine::enable_hook(SW_HOOK_ALL); // <span class="doctag">TODO:</span> enable it in version 4.3.0</span></span><br><span class="line"><span class="number">427</span>│         active = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p><code>php_swoole_check_reactor</code>是用来检测是否开启<code>reactor</code>，如果没有开启，那么会在这个函数里面开启<code>reactor</code>。我们进入这个函数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">php_swoole_check_reactor () at /root/codeDir/cCode/swoole-src/php_swoole.h:368</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">366</span>│ <span class="function"><span class="keyword">static</span> sw_inline <span class="keyword">void</span> <span class="title">php_swoole_check_reactor</span><span class="params">()</span></span></span><br><span class="line">367│ &#123;</span><br><span class="line"><span class="number">368</span>├───&gt; <span class="keyword">if</span> (unlikely(!SwooleWG.reactor_init))</span><br><span class="line"><span class="number">369</span>│     &#123;</span><br><span class="line"><span class="number">370</span>│         php_swoole_reactor_init();</span><br><span class="line"><span class="number">371</span>│     &#125;</span><br><span class="line"><span class="number">372</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p>我们进入<code>php_swoole_reactor_init</code>这个函数看看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b php_swoole_reactor_init</span><br><span class="line">Breakpoint 3 at 0x7ffff4825eb6: file /root/codeDir/cCode/swoole-src/swoole_event.c, line 190.</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 3, php_swoole_reactor_init () at /root/codeDir/cCode/swoole-src/swoole_event.c:190</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">190</span>├───&gt; <span class="keyword">if</span> (!SWOOLE_G(cli))</span><br><span class="line"><span class="number">191</span>│     &#123;</span><br><span class="line"><span class="number">192</span>│         swoole_php_fatal_error(E_ERROR, <span class="string">&quot;async-io must be used in PHP CLI mode&quot;</span>);</span><br><span class="line"><span class="number">193</span>│         <span class="keyword">return</span>;</span><br><span class="line"><span class="number">194</span>│     &#125;</span><br></pre></td></tr></table></figure>

<p>190到194是用来判断当前的环境是否是<code>cli</code>模式。因为异步IO必须被使用在<code>cli</code>模式。</p>
<p>继续往下走：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u 196</span><br><span class="line">php_swoole_reactor_init () at /root/codeDir/cCode/swoole-src/swoole_event.c:196</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">196</span>├───&gt; <span class="keyword">if</span> (SwooleG.serv)</span><br><span class="line"><span class="number">197</span>│     &#123;</span><br><span class="line"><span class="number">198</span>│         <span class="keyword">if</span> (swIsTaskWorker() &amp;&amp; !SwooleG.serv-&gt;task_enable_coroutine)</span><br><span class="line"><span class="number">199</span>│         &#123;</span><br><span class="line"><span class="number">200</span>│             swoole_php_fatal_error(E_ERROR, <span class="string">&quot;Unable to use async-io in task processes, please set `task_enable_coroutine` to true&quot;</span>);</span><br><span class="line"><span class="number">201</span>│             <span class="keyword">return</span>;</span><br><span class="line"><span class="number">202</span>│         &#125;</span><br><span class="line"><span class="number">203</span>│         <span class="keyword">if</span> (swIsManager())</span><br><span class="line"><span class="number">204</span>│         &#123;</span><br><span class="line"><span class="number">205</span>│             swoole_php_fatal_error(E_ERROR, <span class="string">&quot;Unable to use async-io in manager process&quot;</span>);</span><br><span class="line"><span class="number">206</span>│             <span class="keyword">return</span>;</span><br><span class="line"><span class="number">207</span>│         &#125;</span><br><span class="line"><span class="number">208</span>│     &#125;</span><br></pre></td></tr></table></figure>

<p>196到208行之间的代码在开启了<code>Swoole</code>服务器的情况下会执行。在调用了<code>swServer_init()</code>的时候<code>SwooleG.serv</code>的值会被赋值为全局的那个<code>serv</code>，我们可以在<code>swoole_server.cc</code>里面的<code>PHP_METHOD(swoole_server, __construct)</code>这个构造函数里面找到调用了<code>swServer_init()</code>这个函数。</p>
<p>我们继续往下走：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">210</span>├───&gt; <span class="keyword">if</span> (SwooleG.main_reactor == <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">211</span>│     &#123;</span><br><span class="line"><span class="number">212</span>│         swTraceLog(SW_TRACE_PHP, <span class="string">&quot;init reactor&quot;</span>);</span><br><span class="line"><span class="number">213</span>│</span><br><span class="line"><span class="number">214</span>│         SwooleG.main_reactor = (swReactor *) sw_malloc(<span class="keyword">sizeof</span>(swReactor));</span><br><span class="line"><span class="number">215</span>│         <span class="keyword">if</span> (SwooleG.main_reactor == <span class="literal">NULL</span>)</span><br><span class="line"><span class="number">216</span>│         &#123;</span><br><span class="line"><span class="number">217</span>│             swoole_php_fatal_error(E_ERROR, <span class="string">&quot;malloc failed&quot;</span>);</span><br><span class="line"><span class="number">218</span>│             <span class="keyword">return</span>;</span><br><span class="line"><span class="number">219</span>│         &#125;</span><br><span class="line"><span class="number">220</span>│         <span class="keyword">if</span> (swReactor_create(SwooleG.main_reactor, SW_REACTOR_MAXEVENTS) &lt; <span class="number">0</span>)</span><br><span class="line"><span class="number">221</span>│         &#123;</span><br><span class="line"><span class="number">222</span>│             swoole_php_fatal_error(E_ERROR, <span class="string">&quot;failed to create reactor&quot;</span>);</span><br><span class="line"><span class="number">223</span>│             <span class="keyword">return</span>;</span><br><span class="line"><span class="number">224</span>│         &#125;</span><br><span class="line"><span class="number">225</span>│ </span><br><span class="line"><span class="number">226</span>│         SwooleG.main_reactor-&gt;can_exit = php_coroutine_reactor_can_exit;</span><br><span class="line"><span class="number">227</span>│ </span><br><span class="line"><span class="number">228</span>│         <span class="comment">//client, swoole_event_exit will set swoole_running = 0</span></span><br><span class="line"><span class="number">229</span>│         SwooleWG.in_client = <span class="number">1</span>;</span><br><span class="line"><span class="number">230</span>│         SwooleWG.reactor_wait_onexit = <span class="number">1</span>;</span><br><span class="line"><span class="number">231</span>│         SwooleWG.reactor_ready = <span class="number">0</span>;</span><br><span class="line"><span class="number">232</span>│         <span class="comment">//only client side</span></span><br><span class="line"><span class="number">233</span>│         php_swoole_register_shutdown_function_prepend(<span class="string">&quot;swoole_event_wait&quot;</span>);</span><br><span class="line"><span class="number">234</span>│     &#125;</span><br></pre></td></tr></table></figure>

<p>210行到224行之间的代码是为全局的这个<code>SwooleG.main_reactor</code>分配内存以及完成一些基本的初始化操作。226行是设置回调函数<code>php_coroutine_reactor_can_exit</code>。这个函数内容如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">php_coroutine_reactor_can_exit</span><span class="params">(swReactor *reactor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Coroutine::count() == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很容易可以理解，当协程个数为0的时候，<code>main_reactor</code>可以退出了。</p>
<p>我们继续执行到236行之前：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u 236</span><br><span class="line">php_swoole_reactor_init () at /root/codeDir/cCode/swoole-src/swoole_event.c:236</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">236</span>├───&gt; SwooleG.main_reactor-&gt;setHandle(SwooleG.main_reactor, SW_FD_USER | SW_EVENT_READ, php_swoole_event_onRead);</span><br><span class="line"><span class="number">237</span>│     SwooleG.main_reactor-&gt;setHandle(SwooleG.main_reactor, SW_FD_USER | SW_EVENT_WRITE, php_swoole_event_onWrite);</span><br><span class="line"><span class="number">238</span>│     SwooleG.main_reactor-&gt;setHandle(SwooleG.main_reactor, SW_FD_USER | SW_EVENT_ERROR, php_swoole_event_onError);</span><br><span class="line"><span class="number">239</span>│     SwooleG.main_reactor-&gt;setHandle(SwooleG.main_reactor, SW_FD_WRITE, swReactor_onWrite);</span><br><span class="line"><span class="number">240</span>│</span><br><span class="line"><span class="number">241</span>│     SwooleWG.reactor_init = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>这是设置<code>main_reactor</code>的一些事件处理器，用于处理不同状态的事件。最后，赋值<code>SwooleWG.reactor_init</code>为1，代表<code>SwooleG.main_reactor</code>初始化成功了。</p>
<p>我们继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) finish</span><br><span class="line">Run till exit from #0  php_swoole_reactor_init () at /root/codeDir/cCode/swoole-src/swoole_event.c:236</span><br><span class="line">swoole::PHPCoroutine::create (fci_cache=0x7fffffffafc0, argc=0, argv=0x0) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:427</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">427</span>├─<span class="number">777777</span>&gt; active = <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>

<p>赋值active为true代表协程可以使用了。</p>
<p>OK，继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">429</span>├───&gt; <span class="keyword">if</span> (unlikely(Coroutine::count() &gt;= max_num))</span><br><span class="line"><span class="number">430</span>│     &#123;</span><br><span class="line"><span class="number">431</span>│         swoole_php_fatal_error(E_WARNING, <span class="string">&quot;exceed max number of coroutine %zu&quot;</span>, (<span class="keyword">uintmax_t</span>) Coroutine::count());</span><br><span class="line"><span class="number">432</span>│         <span class="keyword">return</span> SW_CORO_ERR_LIMIT;</span><br><span class="line"><span class="number">433</span>│     &#125;</span><br></pre></td></tr></table></figure>

<p>这个好理解，就是判断当前协程的个数是否已经达到了可以创建的协程最大值，如果超过了，就报PHP的<code>fetal error</code>。我们可以看看这个<code>max_num</code>默认是多大：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p max_num</span><br><span class="line"><span class="meta">$</span><span class="bash">2 = 3000</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>所以，默认情况是3000。但是，理论上来说，只要你的内存是足够的，就可以创建无数个协程。很显然，此时的协程个数没有超过3000，可以看看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p Coroutine::count()</span><br><span class="line"><span class="meta">$</span><span class="bash">3 = 0</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>我们继续往下走：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">434</span>├───&gt; <span class="keyword">if</span> (unlikely(!fci_cache || !fci_cache-&gt;function_handler))</span><br><span class="line"><span class="number">435</span>│     &#123;</span><br><span class="line"><span class="number">436</span>│         swoole_php_fatal_error(E_ERROR, <span class="string">&quot;invalid function call info cache&quot;</span>);</span><br><span class="line"><span class="number">437</span>│         <span class="keyword">return</span> SW_CORO_ERR_INVALID;</span><br><span class="line"><span class="number">438</span>│     &#125;</span><br></pre></td></tr></table></figure>

<p>判断这个协程函数是否有效，如果无效会抛出PHP的<code>fetal error</code>。</p>
<p>我们继续往下走：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">439</span>├───&gt; zend_uchar type = fci_cache-&gt;function_handler-&gt;type;</span><br><span class="line"><span class="number">440</span>│     <span class="keyword">if</span> (unlikely(type != ZEND_USER_FUNCTION &amp;&amp; type != ZEND_INTERNAL_FUNCTION))</span><br><span class="line"><span class="number">441</span>│     &#123;</span><br><span class="line"><span class="number">442</span>│         swoole_php_fatal_error(E_ERROR, <span class="string">&quot;invalid function type %u&quot;</span>, fci_cache-&gt;function_handler-&gt;type);</span><br><span class="line"><span class="number">443</span>│         <span class="keyword">return</span> SW_CORO_ERR_INVALID;</span><br><span class="line"><span class="number">444</span>│     &#125;</span><br></pre></td></tr></table></figure>



<p>439到444行代码是用来判断协程函数的类型。其中的<code>ZEND_USER_FUNCTION</code>是用户定义的函数，这种函数是用户在PHP脚本中定义的函数，<code>ZEND_INTERNAL_FUNCTION</code>是PHP内置的函数，这种函数是由扩展或者Zend/PHP内核提供的。也就是说，<code>Swoole</code>协程只支持这两种类型。</p>
<p>我们继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u 446</span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">446</span>├───&gt; php_coro_args php_coro_args;</span><br><span class="line"><span class="number">447</span>│     php_coro_args.fci_cache = fci_cache;</span><br><span class="line"><span class="number">448</span>│     php_coro_args.argv = argv;</span><br><span class="line"><span class="number">449</span>│     php_coro_args.argc = argc;</span><br></pre></td></tr></table></figure>

<p>446行到449行是简单的赋值操作。我们继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u 450</span><br><span class="line">swoole::PHPCoroutine::create (fci_cache=0x7fffffffafc0, argc=0, argv=0x0) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:450</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">450</span>├───&gt; save_task(get_task());</span><br></pre></td></tr></table></figure>

<p>其中<code>get_task</code>的作用是获取当前正在执行的协程。我们进入这个函数看看：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">swoole::PHPCoroutine::get_task () at /root/codeDir/cCode/swoole-src/swoole_coroutine.h:113</span><br><span class="line">warning: Source file is more recent than executable.</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">111</span>│     <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> php_coro_task* <span class="title">get_task</span><span class="params">()</span></span></span><br><span class="line">112│     &#123;</span><br><span class="line"><span class="number">113</span>├─<span class="number">333333</span>&gt; php_coro_task *task = (php_coro_task *) Coroutine::get_current_task();</span><br><span class="line"><span class="number">114</span>│         <span class="keyword">return</span> task ? task : &amp;main_task;</span><br><span class="line"><span class="number">115</span>│     &#125;</span><br></pre></td></tr></table></figure>

<p>因为当前还没有创建协程，所以<code> Coroutine::get_current_task</code>自然就获取不到当前正在运行的协程。我们继续执行，来看看<code>task</code>的值：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p task</span><br><span class="line"><span class="meta">$</span><span class="bash">5 = (php_coro_task *) 0x0</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">114</span>├─<span class="number">444444</span>&gt; <span class="keyword">return</span> task ? task : &amp;main_task;</span><br></pre></td></tr></table></figure>

<p>此时返回<code>main_task</code>。实际上它是一个空的<code>php_coro_task</code>结构：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p main_task</span><br><span class="line"><span class="meta">$</span><span class="bash">6 = &#123;bailout = 0x0, vm_stack_top = 0x0, vm_stack_end = 0x0, vm_stack = 0x0, vm_stack_page_size = 0, execute_data = 0x0, error_handling = EH_NORMAL, exception_class = 0x0, exception = 0x0, output_ptr = 0x</span></span><br><span class="line">0, co = 0x0, defer_tasks = 0x0, pcid = 0, context = 0x0&#125;</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>我们继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) finish</span><br><span class="line">Run till exit from #0  swoole::PHPCoroutine::get_task () at /root/codeDir/cCode/swoole-src/swoole_coroutine.h:115</span><br><span class="line">0x00007ffff481721f in swoole::PHPCoroutine::create (fci_cache=0x7fffffffafc0, argc=0, argv=0x0) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:450</span><br><span class="line">Value returned is $7 = (php_coro_task *) 0x7ffff4b82620 &lt;swoole::PHPCoroutine::main_task&gt;</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">450</span>├───&gt; save_task(get_task());</span><br><span class="line"><span class="number">451</span>│</span><br><span class="line"><span class="number">452</span>│     <span class="keyword">return</span> Coroutine::create(create_func, (<span class="keyword">void</span>*) &amp;php_coro_args);</span><br><span class="line"><span class="number">453</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p>450行是用来保存当前的上下文内容到<code>get_task()</code>返回的<code>php_coro_task</code>结构里面，此时是<code>main_task</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">swoole::PHPCoroutine::save_task (task=0x7ffff4b82620 &lt;swoole::PHPCoroutine::main_task&gt;) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:200</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">198</span>│ <span class="function"><span class="keyword">void</span> <span class="title">PHPCoroutine::save_task</span><span class="params">(php_coro_task *task)</span></span></span><br><span class="line">199│ &#123;</span><br><span class="line"><span class="number">200</span>├───&gt; save_vm_stack(task);</span><br><span class="line"><span class="number">201</span>│     save_og(task);</span><br><span class="line"><span class="number">202</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p><code>save_vm_stack</code>的作用是保存<code>zend</code>虚拟机的栈相关信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">swoole::PHPCoroutine::save_vm_stack (task=0x7ffff4b82620 &lt;swoole::PHPCoroutine::main_task&gt;) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:135</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">132</span>│ <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">PHPCoroutine::save_vm_stack</span><span class="params">(php_coro_task *task)</span></span></span><br><span class="line">133│ &#123;</span><br><span class="line"><span class="number">134</span>│ <span class="meta">#<span class="meta-keyword">ifdef</span> SW_CORO_SWAP_BAILOUT</span></span><br><span class="line"><span class="number">135</span>├───&gt; task-&gt;bailout = EG(bailout);</span><br><span class="line"><span class="number">136</span>│ <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="number">137</span>│     task-&gt;vm_stack_top = EG(vm_stack_top);</span><br><span class="line"><span class="number">138</span>│     task-&gt;vm_stack_end = EG(vm_stack_end);</span><br><span class="line"><span class="number">139</span>│     task-&gt;vm_stack = EG(vm_stack);</span><br><span class="line"><span class="number">140</span>│ <span class="meta">#<span class="meta-keyword">if</span> PHP_VERSION_ID &gt;= 70300</span></span><br><span class="line"><span class="number">141</span>│     task-&gt;vm_stack_page_size = EG(vm_stack_page_size);</span><br><span class="line"><span class="number">142</span>│ <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="number">143</span>│     task-&gt;execute_data = EG(current_execute_data);</span><br><span class="line"><span class="number">144</span>│     task-&gt;error_handling = EG(error_handling);</span><br><span class="line"><span class="number">145</span>│     task-&gt;exception_class = EG(exception_class);</span><br><span class="line"><span class="number">146</span>│     task-&gt;exception = EG(exception);</span><br><span class="line"><span class="number">147</span>│     SW_SAVE_EG_SCOPE(task-&gt;scope);</span><br><span class="line"><span class="number">148</span>│ <span class="meta">#<span class="meta-keyword">ifdef</span> SW_CORO_SCHEDULER_TICK</span></span><br><span class="line"><span class="number">149</span>│     task-&gt;ticks_count = EG(ticks_count);</span><br><span class="line"><span class="number">150</span>│ <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="number">151</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p>我们继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) finish</span><br><span class="line">Run till exit from #0  swoole::PHPCoroutine::save_vm_stack (task=0x7ffff4b82620 &lt;swoole::PHPCoroutine::main_task&gt;) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:135</span><br><span class="line">swoole::PHPCoroutine::save_task (task=0x7ffff4b82620 &lt;swoole::PHPCoroutine::main_task&gt;) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:201</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">198</span>│ <span class="function"><span class="keyword">void</span> <span class="title">PHPCoroutine::save_task</span><span class="params">(php_coro_task *task)</span></span></span><br><span class="line">199│ &#123;</span><br><span class="line"><span class="number">200</span>│     save_vm_stack(task);</span><br><span class="line"><span class="number">201</span>├───&gt; save_og(task);</span><br><span class="line"><span class="number">202</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p><code>save_og</code>用来是保存与输出缓存管理相关的信息：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">swoole::PHPCoroutine::save_og (task=0x7ffff4b82620 &lt;swoole::PHPCoroutine::main_task&gt;) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:176</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">174</span>│ <span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">PHPCoroutine::save_og</span><span class="params">(php_coro_task *task)</span></span></span><br><span class="line">175│ &#123;</span><br><span class="line"><span class="number">176</span>├───&gt; <span class="keyword">if</span> (OG(handlers).elements)</span><br><span class="line"><span class="number">177</span>│     &#123;</span><br><span class="line"><span class="number">178</span>│         task-&gt;output_ptr = (zend_output_globals *) emalloc(<span class="keyword">sizeof</span>(zend_output_globals));</span><br><span class="line"><span class="number">179</span>│         <span class="built_in">memcpy</span>(task-&gt;output_ptr, SWOG, <span class="keyword">sizeof</span>(zend_output_globals));</span><br><span class="line"><span class="number">180</span>│         php_output_activate();</span><br><span class="line"><span class="number">181</span>│     &#125;</span><br><span class="line"><span class="number">182</span>│     <span class="keyword">else</span></span><br><span class="line"><span class="number">183</span>│     &#123;</span><br><span class="line"><span class="number">184</span>│         task-&gt;output_ptr = <span class="literal">NULL</span>;</span><br><span class="line"><span class="number">185</span>│     &#125;</span><br><span class="line"><span class="number">186</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p>继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) finish</span><br><span class="line">Run till exit from #0  swoole::PHPCoroutine::save_og (task=0x7ffff4b82620 &lt;swoole::PHPCoroutine::main_task&gt;) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:186</span><br><span class="line">swoole::PHPCoroutine::save_task (task=0x7ffff4b82620 &lt;swoole::PHPCoroutine::main_task&gt;) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:202</span><br><span class="line">(gdb) finish</span><br><span class="line">Run till exit from #0  swoole::PHPCoroutine::save_task (task=0x7ffff4b82620 &lt;swoole::PHPCoroutine::main_task&gt;) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:202</span><br><span class="line">swoole::PHPCoroutine::create (fci_cache=0x7fffffffafc0, argc=0, argv=0x0) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:452</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">452</span>├───&gt; <span class="keyword">return</span> Coroutine::create(create_func, (<span class="keyword">void</span>*) &amp;php_coro_args);</span><br><span class="line"><span class="number">453</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p>然后，我们进入这个函数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line"></span><br><span class="line">Breakpoint 8, 0x00007ffff4767120 in swoole::Coroutine::create(void (*)(void*), void*)@plt () from /usr/local/lib/php/extensions/no-debug-non-zts-20170718/swoole.so</span><br><span class="line">(gdb) n</span><br><span class="line">Single stepping until exit from function _ZN6swoole9Coroutine6createEPFvPvES1_@plt,</span><br><span class="line">which has no line number information.</span><br><span class="line">swoole::Coroutine::create (fn=0x7ffff4817ab6 &lt;swoole::PHPCoroutine::save_task(php_coro_task*)+36&gt;, args=0x7fffffffaea0) at /root/codeDir/cCode/swoole-src/include/coroutine.h:133</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">133</span>├───&gt; <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">long</span> <span class="title">create</span><span class="params">(<span class="keyword">coroutine_func_t</span> fn, <span class="keyword">void</span>* args = <span class="literal">nullptr</span>)</span></span></span><br><span class="line">134│     &#123;</span><br><span class="line"><span class="number">135</span>│         <span class="keyword">return</span> (<span class="keyword">new</span> Coroutine(fn, args))-&gt;run();</span><br><span class="line"><span class="number">136</span>│     &#125;</span><br></pre></td></tr></table></figure>

<p>可以看出，这里创建了协程之后，立马让这个协程运行（这与进程的创建不同，子进程被创建之后，不一定会立马被调度）。</p>
<p>我们现在进入<code>swoole::Coroutine::Coroutine</code>这个构造函数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line"></span><br><span class="line">Breakpoint 8, swoole::Coroutine::create (fn=0x7ffff481633e &lt;swoole::PHPCoroutine::create_func(void*)&gt;, args=0x7fffffffaf00) at /root/codeDir/cCode/swoole-src/include/coroutine.h:135</span><br><span class="line">(gdb) </span><br><span class="line">swoole::Coroutine::Coroutine (this=0x5555566de6c0, fn=0x7ffff481633e &lt;swoole::PHPCoroutine::create_func(void*)&gt;, private_data=0x7fffffffaf00) at /root/codeDir/cCode/swoole-src/include/coroutine.h:215</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">214</span>│     Coroutine(<span class="keyword">coroutine_func_t</span> fn, <span class="keyword">void</span> *private_data) :</span><br><span class="line"><span class="number">215</span>├─<span class="number">555555</span>────&gt; ctx(stack_size, fn, private_data)</span><br><span class="line"><span class="number">216</span>│     &#123;</span><br><span class="line"><span class="number">217</span>│         cid = ++last_cid;</span><br><span class="line"><span class="number">218</span>│         coroutines[cid] = <span class="keyword">this</span>;</span><br><span class="line"><span class="number">219</span>│         <span class="keyword">if</span> (unlikely(count() &gt; peak_num))</span><br><span class="line"><span class="number">220</span>│         &#123;</span><br><span class="line"><span class="number">221</span>│             peak_num = count();</span><br><span class="line"><span class="number">222</span>│         &#125;</span><br><span class="line"><span class="number">223</span>│     &#125;</span><br></pre></td></tr></table></figure>

<p>可以看出，这里会得到这个被创建的协程的id，是在最后一个协程id的基础上进行加一的。我们来看看最开始的情况<code>last_cid</code>的值：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p last_cid</span><br><span class="line"><span class="meta">$</span><span class="bash">11 = 0</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>所以，我们Swoole创建的第一个协程的id是1，然后保存<code>this</code>指针到对应的<code>coroutines</code>里面，<code>coroutines</code>是一个无序的<code>map</code>，定义如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="built_in">std</span>::<span class="built_in">unordered_map</span>&lt;<span class="keyword">long</span>, Coroutine*&gt; coroutines;</span><br></pre></td></tr></table></figure>

<p>继续运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) finish</span><br><span class="line">Run till exit from #0  swoole::Coroutine::Coroutine (this=0x5555566de6c0, fn=0x7ffff481633e &lt;swoole::PHPCoroutine::create_func(void*)&gt;, private_data=0x7fffffffaf00) at /root/codeDir/cCode/swoole-src/inclu</span><br><span class="line">de/coroutine.h:215</span><br><span class="line">0x00007ffff481752e in swoole::Coroutine::create (fn=0x7ffff481633e &lt;swoole::PHPCoroutine::create_func(void*)&gt;, args=0x7fffffffaf00) at /root/codeDir/cCode/swoole-src/include/coroutine.h:135</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">133</span>│     <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">long</span> <span class="title">create</span><span class="params">(<span class="keyword">coroutine_func_t</span> fn, <span class="keyword">void</span>* args = <span class="literal">nullptr</span>)</span></span></span><br><span class="line">134│     &#123;</span><br><span class="line"><span class="number">135</span>├─<span class="number">555555</span>&gt; <span class="keyword">return</span> (<span class="keyword">new</span> Coroutine(fn, args))-&gt;run();</span><br><span class="line"><span class="number">136</span>│     &#125;</span><br></pre></td></tr></table></figure>

<p>继续运行进入<code>swoole::Coroutine::run()</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">swoole::Coroutine::run (this=0x5555566de6c0) at /root/codeDir/cCode/swoole-src/include/coroutine.h:227</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">225</span>│     <span class="function"><span class="keyword">inline</span> <span class="keyword">long</span> <span class="title">run</span><span class="params">()</span></span></span><br><span class="line">226│     &#123;</span><br><span class="line"><span class="number">227</span>├─<span class="number">555555</span>&gt; <span class="keyword">long</span> cid = <span class="keyword">this</span>-&gt;cid;</span><br><span class="line"><span class="number">228</span>│         origin = current;</span><br><span class="line"><span class="number">229</span>│         current = <span class="keyword">this</span>;</span><br><span class="line"><span class="number">230</span>│         ctx.swap_in();</span><br><span class="line"><span class="number">231</span>│         <span class="keyword">if</span> (ctx.end)</span><br><span class="line"><span class="number">232</span>│         &#123;</span><br><span class="line"><span class="number">233</span>│             close();</span><br><span class="line"><span class="number">234</span>│         &#125;</span><br><span class="line"><span class="number">235</span>│         <span class="keyword">return</span> cid;</span><br><span class="line"><span class="number">236</span>│     &#125;</span><br></pre></td></tr></table></figure>

<p>把当前的上下文换出去之后，目前的<code>current</code>就是上一个协程了；而此时需要调度的协程则是接下来需要被调度的协程了，所以<code>current</code>替换为<code>this</code>。    </p>
<p>230行是实现<code>origin</code>与<code>current</code>的切换，载入<code>current</code>的上下文。我们进入这个函数：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">swoole::Context::swap_in (this=0x5555566de6d8) at /root/codeDir/cCode/swoole-src/src/coroutine/context.cc:112</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">110</span>│ <span class="function"><span class="keyword">bool</span> <span class="title">Context::swap_in</span><span class="params">()</span></span></span><br><span class="line">111│ &#123;</span><br><span class="line"><span class="number">112</span>├───&gt; jump_fcontext(&amp;swap_ctx_, ctx_, (<span class="keyword">intptr_t</span>) <span class="keyword">this</span>, <span class="literal">true</span>);</span><br><span class="line"><span class="number">113</span>│     <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="number">114</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p>112行这个函数式用汇编协程的，是<code>boost</code>的一个库：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">jump_fcontext () at /root/codeDir/cCode/swoole-src/thirdparty/boost/asm/jump_x86_64_sysv_elf_gas.S:39</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">34│ .text</span><br><span class="line">35│ .globl jump_fcontext</span><br><span class="line">36│ .type jump_fcontext,@function</span><br><span class="line">37│ .align 16</span><br><span class="line">38│ jump_fcontext:</span><br><span class="line">39├───&gt; pushq  %rbp  &#x2F;* save RBP *&#x2F;</span><br><span class="line">40│     pushq  %rbx  &#x2F;* save RBX *&#x2F;</span><br><span class="line">41│     pushq  %r15  &#x2F;* save R15 *&#x2F;</span><br><span class="line">42│     pushq  %r14  &#x2F;* save R14 *&#x2F;</span><br><span class="line">43│     pushq  %r13  &#x2F;* save R13 *&#x2F;</span><br><span class="line">44│     pushq  %r12  &#x2F;* save R12 *&#x2F;</span><br></pre></td></tr></table></figure>

<p>（只展示了一部分汇编代码）</p>
<p>它会跳到一个协程入口函数<code>swoole::Context::context_func(void*)</code>，然后这个协程入口函数会调用协程函数，我们给这个函数打一个断点，然后继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b swoole::Context::context_func(void*)</span><br><span class="line">Breakpoint 9 at 0x7ffff477e6d6: file /root/codeDir/cCode/swoole-src/src/coroutine/context.cc, line 124.</span><br><span class="line">(gdb) c </span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 9, swoole::Context::context_func (arg=0x5555566de6d8) at /root/codeDir/cCode/swoole-src/src/coroutine/context.cc:124</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">122</span>│ <span class="function"><span class="keyword">void</span> <span class="title">Context::context_func</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line">123│ &#123;</span><br><span class="line"><span class="number">124</span>├───&gt; Context *_this = (Context *) arg;</span><br><span class="line"><span class="number">125</span>│     _this-&gt;fn_(_this-&gt;private_data_);</span><br><span class="line"><span class="number">126</span>│     _this-&gt;end = <span class="literal">true</span>;</span><br><span class="line"><span class="number">127</span>│     _this-&gt;swap_out();</span><br><span class="line"><span class="number">128</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p>这个就是协程函数的入口函数。125行就是去调用协程函数。调用完之后，会在屏幕打印出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">co1</span><br></pre></td></tr></table></figure>

<p>继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br><span class="line">co1</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">122</span>│ <span class="function"><span class="keyword">void</span> <span class="title">Context::context_func</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line">123│ &#123;</span><br><span class="line"><span class="number">124</span>│     Context *_this = (Context *) arg;</span><br><span class="line"><span class="number">125</span>│     _this-&gt;fn_(_this-&gt;private_data_);</span><br><span class="line"><span class="number">126</span>├───&gt; _this-&gt;end = <span class="literal">true</span>;</span><br><span class="line"><span class="number">127</span>│     _this-&gt;swap_out();</span><br><span class="line"><span class="number">128</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p>此时，协程1跑完了，所以设置<code>end</code>标志为<code>true</code>。然后切换上下文。</p>
<p><code>ctx.end</code>是用来判断协程函数是执行完毕的标志。</p>
<p>继续运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) finish</span><br><span class="line">Run till exit from #0  swoole::Coroutine::run (this=0x5555566de6c0) at /root/codeDir/cCode/swoole-src/include/coroutine.h:236</span><br><span class="line">0x00007ffff4817536 in swoole::Coroutine::create (fn=0x7ffff481633e &lt;swoole::PHPCoroutine::create_func(void*)&gt;, args=0x7fffffffaf00) at /root/codeDir/cCode/swoole-src/include/coroutine.h:135</span><br><span class="line">Value returned is $18 = 1</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">133</span>│     <span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">long</span> <span class="title">create</span><span class="params">(<span class="keyword">coroutine_func_t</span> fn, <span class="keyword">void</span>* args = <span class="literal">nullptr</span>)</span></span></span><br><span class="line">134│     &#123;</span><br><span class="line"><span class="number">135</span>├─<span class="number">555555</span>&gt; <span class="keyword">return</span> (<span class="keyword">new</span> Coroutine(fn, args))-&gt;run();</span><br><span class="line"><span class="number">136</span>│     &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) finish</span><br><span class="line">Run till exit from #0  swoole::Coroutine::create (fn=0x7ffff481633e &lt;swoole::PHPCoroutine::create_func(void*)&gt;, args=0x7fffffffaf00) at /root/codeDir/cCode/swoole-src/include/coroutine.h:136</span><br><span class="line">swoole::PHPCoroutine::create (fci_cache=0x7fffffffafc0, argc=0, argv=0x0) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:453</span><br><span class="line">Value returned is $19 = 1</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">452</span>│     <span class="keyword">return</span> Coroutine::create(create_func, (<span class="keyword">void</span>*) &amp;php_coro_args);</span><br><span class="line"><span class="number">453</span>├&gt;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) finish</span><br><span class="line">Run till exit from #0  swoole::PHPCoroutine::create (fci_cache=0x7fffffffafc0, argc=0, argv=0x0) at /root/codeDir/cCode/swoole-src/swoole_coroutine.cc:453</span><br><span class="line">0x00007ffff481d033 in zif_swoole_coroutine_create (execute_data=0x7ffff681c0c0, return_value=0x7fffffffb090) at /root/codeDir/cCode/swoole-src/swoole_coroutine_util.cc:435</span><br><span class="line">Value returned is $20 = 1</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">435</span>├───&gt; <span class="keyword">long</span> cid = PHPCoroutine::create(&amp;fci_cache, fci.param_count, fci.params);</span><br><span class="line"><span class="number">436</span>│     <span class="keyword">if</span> (likely(cid &gt; <span class="number">0</span>))</span><br><span class="line"><span class="number">437</span>│     &#123;</span><br><span class="line"><span class="number">438</span>│         RETURN_LONG(cid);</span><br><span class="line"><span class="number">439</span>│     &#125;</span><br><span class="line"><span class="number">440</span>│     <span class="keyword">else</span></span><br><span class="line"><span class="number">441</span>│     &#123;</span><br><span class="line"><span class="number">442</span>│         RETURN_FALSE;</span><br><span class="line"><span class="number">443</span>│     &#125;</span><br><span class="line"><span class="number">444</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p>​    此时，可以获取到被创建的协程的id：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) p cid</span><br><span class="line"><span class="meta">$</span><span class="bash">21 = 1</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>然后，<code>go()</code>函数返回协程的id。</p>
<p>到此，<code>Swoole</code>协程的创建分析完毕。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/05/04/%E3%80%8A%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82swoole%E3%80%8B-%E5%8D%8F%E7%A8%8B%E5%88%9B%E5%BB%BA/" data-id="ckkj72zx500mcf6vx5nao9e2r" data-title="《就是要你懂swoole》--协程创建" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/swoole/" rel="tag">swoole</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-PHP7源码分析-数组" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/04/28/PHP7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E6%95%B0%E7%BB%84/" class="article-date">
  <time class="dt-published" datetime="2019-04-28T07:09:03.000Z" itemprop="datePublished">2019-04-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/04/28/PHP7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E6%95%B0%E7%BB%84/">PHP7源码分析--数组</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这是一篇调试PHP数组的文章，希望对大家有所帮助。PHP的版本是<strong>7.1.0</strong>。这里，不会长篇大论的去讲解原因，只会告诉小伙伴们需要如何去做。至于为什么需要这么做，网上应该是有这种源码剖析的文章。</p>
<p>我们需要调试的脚本如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">array</span>(); <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line">$a[<span class="number">1</span>] = <span class="string">&#x27;a&#x27;</span>; <span class="comment">// 5</span></span><br><span class="line"></span><br><span class="line">$a[] = <span class="string">&#x27;b&#x27;</span>; <span class="comment">// 7</span></span><br><span class="line"></span><br><span class="line">$a[<span class="string">&#x27;key1&#x27;</span>] = <span class="string">&#x27;value1&#x27;</span>; <span class="comment">// 9</span></span><br><span class="line">$a[<span class="string">&#x27;key2&#x27;</span>] = <span class="string">&#x27;value2&#x27;</span>; <span class="comment">// 10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $a[<span class="string">&#x27;key1&#x27;</span>]; <span class="comment">// 12</span></span><br><span class="line"></span><br><span class="line">$a[<span class="string">&#x27;key1&#x27;</span>] = <span class="string">&#x27;c&#x27;</span>; <span class="comment">// 14</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">unset</span>($a[<span class="string">&#x27;key2&#x27;</span>]); <span class="comment">// 16</span></span><br></pre></td></tr></table></figure>

<p>OK，我们开始进行调试，分析数组初始化的过程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">sh-4.2# cgdb php</span><br><span class="line">Copyright (C) 2013 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">This is free software: you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.  Type &quot;show copying&quot;</span><br><span class="line">and &quot;show warranty&quot; for details.</span><br><span class="line">This GDB was configured as &quot;x86_64-redhat-linux-gnu&quot;.</span><br><span class="line">For bug reporting instructions, please see:</span><br><span class="line">&lt;http://www.gnu.org/software/gdb/bugs/&gt;...</span><br><span class="line">Reading symbols from /home/codes/php/php-7.1.0/output/bin/php...done.</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>然后，我们需要知道PHP7数组初始化的过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1、申请内存</span><br><span class="line">&#x2F;* fast cache for HashTables *&#x2F;</span><br><span class="line">#define ALLOC_HASHTABLE(ht)	\</span><br><span class="line">	(ht) &#x3D; (HashTable *) emalloc(sizeof(HashTable))</span><br><span class="line">2、调用_zend_hash_init方法</span><br></pre></td></tr></table></figure>

<p>并且，对于array()这种方式，PHP7会在编译阶段就创建一个数组常量。因此，数组的初始化发生在编译阶段。</p>
<p>我们在<code>zend_compile</code>处打一个断点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b zend_compile</span><br><span class="line">Breakpoint 1 at 0x7f85f8: file Zend/zend_language_scanner.l, line 578.</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>然后运行脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(gdb) r array.php </span><br><span class="line">Starting program: /home/codes/php/php-7.1.0/output/bin/php array.php</span><br><span class="line">[Thread debugging using libthread_db enabled]</span><br><span class="line">Using host libthread_db library &quot;/lib64/libthread_db.so.1&quot;.</span><br><span class="line"></span><br><span class="line">Breakpoint 1, zend_compile (type=2) at Zend/zend_language_scanner.l:578</span><br><span class="line">Missing separate debuginfos, use: debuginfo-install glibc-2.17-260.el7_6.4.x86_64</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>然后，我们在<code>_zend_hash_init</code>处打一个断点：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b _zend_hash_init</span><br><span class="line">Breakpoint 2 at 0x86167d: file /root/php-7.1.0/Zend/zend_hash.c, line 173.</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 2, _zend_hash_init (ht=0x7ffff5e59360, nSize=0, pDestructor=0x84d18f &lt;_zval_ptr_dtor_wrapper&gt;, persistent=0 &#x27;\000&#x27;, __zend_filename=0xd871c8 &quot;/root/php-7.1.0/Zend/zend_compile.c&quot;, __zend_lineno</span><br><span class="line">=6597) at /root/php-7.1.0/Zend/zend_hash.c:173</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<p><code>_zend_hash_init</code>的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ZEND_API <span class="keyword">void</span> ZEND_FASTCALL _zend_hash_init(HashTable *ht, <span class="keyword">uint32_t</span> nSize, <span class="keyword">dtor_func_t</span> pDestructor, zend_bool persistent ZEND_FILE_LINE_DC)</span><br><span class="line"> <span class="number">172</span>│ &#123;</span><br><span class="line"> <span class="number">173</span>├───────&gt; GC_REFCOUNT(ht) = <span class="number">1</span>;</span><br><span class="line"> <span class="number">174</span>│         GC_TYPE_INFO(ht) = IS_ARRAY;</span><br><span class="line"> <span class="number">175</span>│         ht-&gt;u.flags = (persistent ? HASH_FLAG_PERSISTENT : <span class="number">0</span>) | HASH_FLAG_APPLY_PROTECTION | HASH_FLAG_STATIC_KEYS;</span><br><span class="line"> <span class="number">176</span>│         ht-&gt;nTableSize = zend_hash_check_size(nSize);</span><br><span class="line"> <span class="number">177</span>│         ht-&gt;nTableMask = HT_MIN_MASK;</span><br><span class="line"> <span class="number">178</span>│         HT_SET_DATA_ADDR(ht, &amp;uninitialized_bucket);</span><br><span class="line"> <span class="number">179</span>│         ht-&gt;nNumUsed = <span class="number">0</span>;</span><br><span class="line"> <span class="number">180</span>│         ht-&gt;nNumOfElements = <span class="number">0</span>;</span><br><span class="line"> <span class="number">181</span>│         ht-&gt;nInternalPointer = HT_INVALID_IDX;</span><br><span class="line"> <span class="number">182</span>│         ht-&gt;nNextFreeElement = <span class="number">0</span>;</span><br><span class="line"> <span class="number">183</span>│         ht-&gt;pDestructor = pDestructor;</span><br><span class="line"> <span class="number">184</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p>可以看出，<code>HashTable</code>即<code>zend_array</code>的地址为<code>0x7ffff5e59360</code>。</p>
<p>我们继续往下走，即初始化<code>zend_array</code>的引用计数为1：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>我们查看一下这个<code>zend_array</code>里面的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	*ht</span><br><span class="line"><span class="meta">$</span><span class="bash">1 = &#123;gc = &#123;refcount = 1, u = &#123;v = &#123;<span class="built_in">type</span> = 255 <span class="string">&#x27;\377&#x27;</span>, flags = 127 <span class="string">&#x27;\177&#x27;</span>, gc_info = 0&#125;, type_info = 32767&#125;&#125;, u = &#123;v = &#123;flags = 0 <span class="string">&#x27;\000&#x27;</span>, nApplyCount = 0 <span class="string">&#x27;\000&#x27;</span>, nIteratorsCount = 0 <span class="string">&#x27;\000&#x27;</span>, consistency =</span></span><br><span class="line">0 &#x27;\000&#x27;&#125;, flags = 0&#125;, nTableMask = 0, arData = 0x0, nNumUsed = 0, nNumOfElements = 0, nTableSize = 0, nInternalPointer = 0, nNextFreeElement = 0, pDestructor = 0x0&#125;</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>可以看出<code>zend_array.gc.refcount</code>为1。即初始化一个数组的时候，它的引用计数是1。<code>arData</code>里面存放的地址为<code>0x0</code>，所以，还没有为<code>bucket</code>分配内存。</p>
<p>继续执行代码到<code>zend_hash.c:177</code>之前：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u	177</span><br><span class="line">_zend_hash_init	(ht=0x10d6f40 &lt;sapi_globals+448&gt;, nSize=8, pDestructor=0x7cac14 &lt;_type_dtor&gt;, persistent=1 &#x27;\001&#x27;, __zend_filename=0xd75821 &quot;/root/php-7.1.0/main/SAPI.c&quot;, __zend_lineno=65) at /root/php-7.</span><br><span class="line">1.0/Zend/zend_hash.c:177</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">171</span>│ ZEND_API <span class="keyword">void</span> ZEND_FASTCALL _zend_hash_init(HashTable *ht, <span class="keyword">uint32_t</span> nSize, <span class="keyword">dtor_func_t</span> pDestructor, zend_bool persistent ZEND_FILE_LINE_DC)</span><br><span class="line"><span class="number">172</span>│ &#123;</span><br><span class="line"><span class="number">173</span>│         GC_REFCOUNT(ht) = <span class="number">1</span>;</span><br><span class="line"><span class="number">174</span>│         GC_TYPE_INFO(ht) = IS_ARRAY;</span><br><span class="line"><span class="number">175</span>│         ht-&gt;u.flags = (persistent ? HASH_FLAG_PERSISTENT : <span class="number">0</span>) | HASH_FLAG_APPLY_PROTECTION | HASH_FLAG_STATIC_KEYS;</span><br><span class="line"><span class="number">176</span>│         ht-&gt;nTableSize = zend_hash_check_size(nSize);</span><br><span class="line"><span class="number">177</span>├───────&gt; ht-&gt;nTableMask = HT_MIN_MASK;</span><br><span class="line"><span class="number">178</span>│         HT_SET_DATA_ADDR(ht, &amp;uninitialized_bucket);</span><br><span class="line"><span class="number">179</span>│         ht-&gt;nNumUsed = <span class="number">0</span>;</span><br><span class="line"><span class="number">180</span>│         ht-&gt;nNumOfElements = <span class="number">0</span>;</span><br><span class="line"><span class="number">181</span>│         ht-&gt;nInternalPointer = HT_INVALID_IDX;</span><br><span class="line"><span class="number">182</span>│         ht-&gt;nNextFreeElement = <span class="number">0</span>;</span><br><span class="line"><span class="number">183</span>│         ht-&gt;pDestructor = pDestructor;</span><br><span class="line"><span class="number">184</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p><code>_zend_hash_init</code>中174到176行的代码都是一些初始化的操作。</p>
<p>重点看执行完176行之后<code>nTableSize</code>的值：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p ht-&gt;nTableSize </span><br><span class="line"><span class="meta">$</span><span class="bash">3 = 8</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p><code>nTableSize</code>是<code>zend_array</code>的大小，而这个8就是<code>zend_array</code>的最小大小。</p>
<p>继续往下运行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">177│         ht-&gt;nTableMask = HT_MIN_MASK;</span><br><span class="line">178├───────&gt; HT_SET_DATA_ADDR(ht, &amp;uninitialized_bucket);</span><br></pre></td></tr></table></figure>

<p>执行完177行之后，我们来看一下<code>nTableMask</code>的值：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	ht-&gt;nTableMask</span><br><span class="line"><span class="meta">$</span><span class="bash">4 = 4294967294</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>这是以无符号整型打印出来的数字，我们需要以有符号的格式来打印：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p (int32_t)ht-&gt;nTableMask</span><br><span class="line"><span class="meta">$</span><span class="bash">5 = -2</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>可以看出，在<code>zend_array</code>初始化的时候，<code>nTableMask</code>的值为-2。</p>
<p>继续执行178行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">178│         HT_SET_DATA_ADDR(ht, &amp;uninitialized_bucket);</span><br><span class="line">179├───────&gt; ht-&gt;nNumUsed = 0;</span><br></pre></td></tr></table></figure>

<p><code>HT_SET_DATA_ADDR</code>是一个宏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HT_SET_DATA_ADDR(ht, ptr) do &#123; \</span></span><br><span class="line">		(ht)-&gt;arData = (Bucket*)(((<span class="keyword">char</span>*)(ptr)) + HT_HASH_SIZE((ht)-&gt;nTableMask)); \</span><br><span class="line">	&#125; <span class="keyword">while</span> (<span class="number">0</span>)</span><br></pre></td></tr></table></figure>

<p>它的作用初始化<code>arData</code>的地址，我们来打印一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p ht-&gt;arData</span><br><span class="line"><span class="meta">$</span><span class="bash">7 = (Bucket *) 0xd8eacc</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>OK，<code>_zend_hash_init</code>函数剩下的部分都是简单的初始化了，我们直接走完：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u	184</span><br><span class="line">_zend_hash_init	(ht=0x10d6f40 &lt;sapi_globals+448&gt;, nSize=8, pDestructor=0x7cac14 &lt;_type_dtor&gt;, persistent=1 &#x27;\001&#x27;, __zend_filename=0xd75821 &quot;/root/php-7.1.0/main/SAPI.c&quot;, __zend_lineno=65) at /root/php-7.</span><br><span class="line">1.0/Zend/zend_hash.c:184</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">172</span>│ &#123;</span><br><span class="line"><span class="number">173</span>│         GC_REFCOUNT(ht) = <span class="number">1</span>;</span><br><span class="line"><span class="number">174</span>│         GC_TYPE_INFO(ht) = IS_ARRAY;</span><br><span class="line"><span class="number">175</span>│         ht-&gt;u.flags = (persistent ? HASH_FLAG_PERSISTENT : <span class="number">0</span>) | HASH_FLAG_APPLY_PROTECTION | HASH_FLAG_STATIC_KEYS;</span><br><span class="line"><span class="number">176</span>│         ht-&gt;nTableSize = zend_hash_check_size(nSize);</span><br><span class="line"><span class="number">177</span>│         ht-&gt;nTableMask = HT_MIN_MASK;</span><br><span class="line"><span class="number">178</span>│         HT_SET_DATA_ADDR(ht, &amp;uninitialized_bucket);</span><br><span class="line"><span class="number">179</span>│         ht-&gt;nNumUsed = <span class="number">0</span>;</span><br><span class="line"><span class="number">180</span>│         ht-&gt;nNumOfElements = <span class="number">0</span>;</span><br><span class="line"><span class="number">181</span>│         ht-&gt;nInternalPointer = HT_INVALID_IDX;</span><br><span class="line"><span class="number">182</span>│         ht-&gt;nNextFreeElement = <span class="number">0</span>;</span><br><span class="line"><span class="number">183</span>│         ht-&gt;pDestructor = pDestructor;</span><br><span class="line"><span class="number">184</span>├&gt;&#125;</span><br></pre></td></tr></table></figure>

<p>我们来看一下<code>zend_array</code> 的游标<code>nInternalPointer</code>的值：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p (int32_t)ht-&gt;nInternalPointer</span><br><span class="line"><span class="meta">$</span><span class="bash">9 = -1</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>可以看出，在<code>zend_init</code>初始化的时候，游标的值为-1。</p>
<p>OK，数组现在初始化完毕。以上过程是发生在PHP脚本被编译的过程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line"><span class="meta">#</span><span class="bash">0  _zend_hash_init (ht=0x7ffff5e59360, nSize=0, pDestructor=0x84d18f &lt;_zval_ptr_dtor_wrapper&gt;, persistent=0 <span class="string">&#x27;\000&#x27;</span>, __zend_filename=0xd871c8 <span class="string">&quot;/root/php-7.1.0/Zend/zend_compile.c&quot;</span>, __zend_lineno=6597) at</span></span><br><span class="line">/root/php-7.1.0/Zend/zend_hash.c:184</span><br><span class="line"><span class="meta">#</span><span class="bash">1  0x0000000000855499 <span class="keyword">in</span> _array_init (arg=0x7fffffffb018, size=0, __zend_filename=0xd871c8 <span class="string">&quot;/root/php-7.1.0/Zend/zend_compile.c&quot;</span>, __zend_lineno=6597) at /root/php-7.1.0/Zend/zend_API.c:1061</span></span><br><span class="line"><span class="meta">#</span><span class="bash">2  0x000000000082f11a <span class="keyword">in</span> zend_try_ct_eval_array (result=0x7fffffffb018, ast=0x7ffff5e72070) at /root/php-7.1.0/Zend/zend_compile.c:6597</span></span><br><span class="line"><span class="meta">#</span><span class="bash">3  0x0000000000830bc3 <span class="keyword">in</span> zend_compile_array (result=0x7fffffffb010, ast=0x7ffff5e72070) at /root/php-7.1.0/Zend/zend_compile.c:7203</span></span><br><span class="line"><span class="meta">#</span><span class="bash">4  0x0000000000832f20 <span class="keyword">in</span> zend_compile_expr (result=0x7fffffffb010, ast=0x7ffff5e72070) at /root/php-7.1.0/Zend/zend_compile.c:7951</span></span><br><span class="line"><span class="meta">#</span><span class="bash">5  0x00000000008247d3 <span class="keyword">in</span> zend_compile_assign (result=0x7fffffffb0d0, ast=0x7ffff5e720a0) at /root/php-7.1.0/Zend/zend_compile.c:2975</span></span><br><span class="line"><span class="meta">#</span><span class="bash">6  0x0000000000832ce0 <span class="keyword">in</span> zend_compile_expr (result=0x7fffffffb0d0, ast=0x7ffff5e720a0) at /root/php-7.1.0/Zend/zend_compile.c:7873</span></span><br><span class="line"><span class="meta">#</span><span class="bash">7  0x00000000008329b4 <span class="keyword">in</span> zend_compile_stmt (ast=0x7ffff5e720a0) at /root/php-7.1.0/Zend/zend_compile.c:7839</span></span><br><span class="line"><span class="meta">#</span><span class="bash">8  0x0000000000832590 <span class="keyword">in</span> zend_compile_top_stmt (ast=0x7ffff5e720a0) at /root/php-7.1.0/Zend/zend_compile.c:7725</span></span><br><span class="line"><span class="meta">#</span><span class="bash">9  0x0000000000832572 <span class="keyword">in</span> zend_compile_top_stmt (ast=0x7ffff5e722c0) at /root/php-7.1.0/Zend/zend_compile.c:7720</span></span><br><span class="line"><span class="meta">#</span><span class="bash">10 0x00000000007f871f <span class="keyword">in</span> zend_compile (<span class="built_in">type</span>=2) at Zend/zend_language_scanner.l:601</span></span><br><span class="line"><span class="meta">#</span><span class="bash">11 0x00000000007f886f <span class="keyword">in</span> compile_file (file_handle=0x7fffffffe920, <span class="built_in">type</span>=8) at Zend/zend_language_scanner.l:635</span></span><br><span class="line"><span class="meta">#</span><span class="bash">12 0x0000000000692a03 <span class="keyword">in</span> phar_compile_file (file_handle=0x7fffffffe920, <span class="built_in">type</span>=8) at /root/php-7.1.0/ext/phar/phar.c:3305</span></span><br><span class="line"><span class="meta">#</span><span class="bash">13 0x000000000085063c <span class="keyword">in</span> zend_execute_scripts (<span class="built_in">type</span>=8, retval=0x0, file_count=3) at /root/php-7.1.0/Zend/zend.c:1468</span></span><br><span class="line"><span class="meta">#</span><span class="bash">14 0x00000000007c077f <span class="keyword">in</span> php_execute_script (primary_file=0x7fffffffe920) at /root/php-7.1.0/main/main.c:2533</span></span><br><span class="line"><span class="meta">#</span><span class="bash">15 0x000000000092f855 <span class="keyword">in</span> do_cli (argc=2, argv=0x10dc280) at /root/php-7.1.0/sapi/cli/php_cli.c:990</span></span><br><span class="line"><span class="meta">#</span><span class="bash">16 0x0000000000930814 <span class="keyword">in</span> main (argc=2, argv=0x10dc280) at /root/php-7.1.0/sapi/cli/php_cli.c:1378</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>OK，分析完数组初始化的过程，现在我们来分析一下脚本的第5行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$a[<span class="number">1</span>] = <span class="string">&#x27;a&#x27;</span>; <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<p>也就是把字符<code>&#39;a&#39;</code>插入到数组里面。</p>
<p>这个过程是发生在<code>zend</code>虚拟机执行opcode阶段。所以我们在<code>zend_execute</code>处打一个断点，并且执行到<code>zend_execute</code>位置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b	zend_execute</span><br><span class="line">Breakpoint 3 at 0x8aea82: file /root/php-7.1.0/Zend/zend_vm_execute.h, line 461.</span><br><span class="line">(gdb) c    </span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Breakpoint 3, zend_execute (op_array=0x7ffff5e7b000, return_value=0x0) at /root/php-7.1.0/Zend/zend_vm_execute.h:461</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">457</span>│ <span class="function">ZEND_API <span class="keyword">void</span> <span class="title">zend_execute</span><span class="params">(zend_op_array *op_array, zval *return_value)</span></span></span><br><span class="line">458│ &#123;</span><br><span class="line"><span class="number">459</span>│         zend_execute_data *execute_data;</span><br><span class="line"><span class="number">460</span>│</span><br><span class="line"><span class="number">461</span>├───────&gt; <span class="keyword">if</span> (EG(exception) != <span class="literal">NULL</span>) &#123;</span><br><span class="line"><span class="number">462</span>│                 <span class="keyword">return</span>;</span><br><span class="line"><span class="number">463</span>│         &#125;</span><br></pre></td></tr></table></figure>

<p>我们继续执行，执行到474行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u	474</span><br><span class="line">zend_execute (op_array=0x7ffff5e7b000, return_value=0x0) at /root/php-7.1.0/Zend/zend_vm_execute.h:474</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">472</span>│         EX(prev_execute_data) = EG(current_execute_data);</span><br><span class="line"><span class="number">473</span>│         i_init_execute_data(execute_data, op_array, return_value);</span><br><span class="line"><span class="number">474</span>├───────&gt; zend_execute_ex(execute_data);</span><br><span class="line"><span class="number">475</span>│         zend_vm_stack_free_call_frame(execute_data);</span><br><span class="line"><span class="number">476</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p>OK，我们进入<code>zend_execute_ex</code>函数里面：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">execute_ex (ex=0x7ffff5e14030) at /root/php-7.1.0/Zend/zend_vm_execute.h:411</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">406</span>│ <span class="function">ZEND_API <span class="keyword">void</span> <span class="title">execute_ex</span><span class="params">(zend_execute_data *ex)</span></span></span><br><span class="line">407│ &#123;</span><br><span class="line"><span class="number">408</span>│         DCL_OPLINE</span><br><span class="line"><span class="number">409</span>│</span><br><span class="line"><span class="number">410</span>│ <span class="meta">#<span class="meta-keyword">ifdef</span> ZEND_VM_IP_GLOBAL_REG</span></span><br><span class="line"><span class="number">411</span>├───────&gt; <span class="keyword">const</span> zend_op *orig_opline = opline;</span><br><span class="line"><span class="number">412</span>│ <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="number">413</span>│ <span class="meta">#<span class="meta-keyword">ifdef</span> ZEND_VM_FP_GLOBAL_REG</span></span><br><span class="line"><span class="number">414</span>│         zend_execute_data *orig_execute_data = execute_data;</span><br><span class="line"><span class="number">415</span>│         execute_data = ex;</span><br><span class="line"><span class="number">416</span>│ <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="number">417</span>│         zend_execute_data *execute_data = ex;</span><br><span class="line"><span class="number">418</span>│ <span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>我们继续让代码执行到429行之前：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u	429</span><br><span class="line">execute_ex (ex=0x7ffff5e14030) at /root/php-7.1.0/Zend/zend_vm_execute.h:429</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">425</span>│ <span class="meta">#<span class="meta-keyword">if</span> !defined(ZEND_VM_FP_GLOBAL_REG) || !defined(ZEND_VM_IP_GLOBAL_REG)</span></span><br><span class="line"><span class="number">426</span>│                         <span class="keyword">int</span> ret;</span><br><span class="line"><span class="number">427</span>│ <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="number">428</span>│ <span class="meta">#<span class="meta-keyword">if</span> defined(ZEND_VM_FP_GLOBAL_REG) &amp;&amp; defined(ZEND_VM_IP_GLOBAL_REG)</span></span><br><span class="line"><span class="number">429</span>├───────────────&gt; ((<span class="keyword">opcode_handler_t</span>)OPLINE-&gt;handler)(ZEND_OPCODE_HANDLER_ARGS_PASSTHRU);</span><br><span class="line"><span class="number">430</span>│                 <span class="keyword">if</span> (UNEXPECTED(!OPLINE)) &#123;</span><br><span class="line"><span class="number">431</span>│ <span class="meta">#<span class="meta-keyword">else</span></span></span><br></pre></td></tr></table></figure>

<p>然后进入这个handler里面：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">ZEND_ASSIGN_SPEC_CV_CONST_RETVAL_UNUSED_HANDLER () at /root/php-7.1.0/Zend/zend_vm_execute.h:39440</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">39433</span>│ <span class="function"><span class="keyword">static</span> ZEND_OPCODE_HANDLER_RET ZEND_FASTCALL <span class="title">ZEND_ASSIGN_SPEC_CV_CONST_RETVAL_UNUSED_HANDLER</span><span class="params">(ZEND_OPCODE_HANDLER_ARGS)</span></span></span><br><span class="line">39434│ &#123;</span><br><span class="line"><span class="number">39435</span>│         USE_OPLINE</span><br><span class="line"><span class="number">39436</span>│</span><br><span class="line"><span class="number">39437</span>│         zval *value;</span><br><span class="line"><span class="number">39438</span>│         zval *variable_ptr;</span><br><span class="line"><span class="number">39439</span>│</span><br><span class="line"><span class="number">39440</span>├───────&gt; SAVE_OPLINE();</span><br><span class="line"><span class="number">39441</span>│         value = EX_CONSTANT(opline-&gt;op2);</span><br><span class="line"><span class="number">39442</span>│         variable_ptr = _get_zval_ptr_cv_undef_BP_VAR_W(execute_data, opline-&gt;op1.var);</span><br></pre></td></tr></table></figure>

<p>我们继续执行完39441处的代码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u	39442</span><br><span class="line">ZEND_ASSIGN_SPEC_CV_CONST_RETVAL_UNUSED_HANDLER () at /root/php-7.1.0/Zend/zend_vm_execute.h:39442</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">39440</span>│         SAVE_OPLINE();</span><br><span class="line"><span class="number">39441</span>│         value = EX_CONSTANT(opline-&gt;op2);</span><br><span class="line"><span class="number">39442</span>├───────&gt; variable_ptr = _get_zval_ptr_cv_undef_BP_VAR_W(execute_data, opline-&gt;op1.var);</span><br></pre></td></tr></table></figure>

<p>此时，我们得到了一个<code>value</code>。我们打印一下这个<code>value</code>的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	value</span><br><span class="line"><span class="meta">$</span><span class="bash">1 = (zval *) 0x7ffff5e7b100</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>可以看到，这是一个<code>zval</code>结构，我们看看这个<code>zval</code>里面的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	*value</span><br><span class="line"><span class="meta">$</span><span class="bash">2 = &#123;value = &#123;lval = 140737318851424, dval = 6.9533474332294241e-310, counted = 0x7ffff5e59360, str = 0x7ffff5e59360, arr = 0x7ffff5e59360, obj = 0x7ffff5e59360, res = 0x7ffff5e59360, ref = 0x7ffff5e5936</span></span><br><span class="line">0, ast = 0x7ffff5e59360, zv = 0x7ffff5e59360, ptr = 0x7ffff5e59360, ce = 0x7ffff5e59360, func = 0x7ffff5e59360, ww = &#123;w1 = 4125463392, w2 = 32767&#125;&#125;, u1 = &#123;v = &#123;type = 7 &#x27;\a&#x27;, type_flags = 28 &#x27;\034&#x27;, const</span><br><span class="line">_flags = 0 &#x27;\000&#x27;, reserved = 0 &#x27;\000&#x27;&#125;, type_info = 7175&#125;, u2 = &#123;next = 4294967295, cache_slot = 4294967295, lineno = 4294967295, num_args = 4294967295, fe_pos = 4294967295, fe_iter_idx = 4294967295, acc</span><br><span class="line">ess_flags = 4294967295, property_guard = 4294967295&#125;&#125;</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>因为<code>zval.u1.v.type</code>为7，所以这个<code>zval.value</code>是<code>zend_array</code>类型。所以我们应该取<code>zval</code>里面的<code>arr</code>，我们发现<code>arr</code>里面存放的地址是<code>0x7ffff5e59360</code>，而这个地址正是我们之前讲解数组初始化时候的那个<code>zend_array</code>的地址。</p>
<p>我们继续往下执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">39450</span>├───────────────&gt; value = zend_assign_to_variable(variable_ptr, value, IS_CONST);</span><br><span class="line"><span class="number">39451</span>│                 <span class="keyword">if</span> (UNEXPECTED(<span class="number">0</span>)) &#123;</span><br><span class="line"><span class="number">39452</span>│                         ZVAL_COPY(EX_VAR(opline-&gt;result.var), value);</span><br><span class="line"><span class="number">39453</span>│                 &#125;</span><br><span class="line"><span class="number">39454</span>│</span><br><span class="line"><span class="number">39455</span>│                 <span class="comment">/* zend_assign_to_variable() always takes care of op2, never free it! */</span></span><br><span class="line"><span class="number">39456</span>│         &#125;</span><br><span class="line"><span class="number">39457</span>│</span><br><span class="line"><span class="number">39458</span>│         ZEND_VM_NEXT_OPCODE_CHECK_EXCEPTION();</span><br><span class="line"><span class="number">39459</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p><code>zend_assign_to_variable</code>把<code>value</code>这个<code>zval</code>assign到<code>variable_ptr</code>这里。我们打印一下<code>variable_ptr</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	variable_ptr</span><br><span class="line"><span class="meta">$</span><span class="bash">4 = (zval *) 0x7ffff5e14080</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>此时打印出来的是zend虚拟机的栈的起始地址。在执行<code>zend_assign_to_variable</code>之前，我们打印一下这个<code>zend_array</code>里面的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	*value.value.arr</span><br><span class="line"><span class="meta">$</span><span class="bash">9 = &#123;gc = &#123;refcount = 1, u = &#123;v = &#123;<span class="built_in">type</span> = 7 <span class="string">&#x27;\a&#x27;</span>, flags = 0 <span class="string">&#x27;\000&#x27;</span>, gc_info = 0&#125;, type_info = 7&#125;&#125;, u = &#123;v = &#123;flags = 18 <span class="string">&#x27;\022&#x27;</span>, nApplyCount = 0 <span class="string">&#x27;\000&#x27;</span>, nIteratorsCount = 0 <span class="string">&#x27;\000&#x27;</span>, consistency = 0 <span class="string">&#x27;\000&#x27;</span>&#125;</span></span><br><span class="line">, flags = 18&#125;, nTableMask = 4294967294, arData = 0xd8eacc, nNumUsed = 0, nNumOfElements = 0, nTableSize = 8, nInternalPointer = 4294967295, nNextFreeElement = 0, pDestructor = 0x84d18f &lt;_zval_ptr_dtor_wra</span><br><span class="line"><span class="meta">pper&gt;</span><span class="bash">&#125;</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>可以看到，这里的<code>refcount</code>仍然是1，也就是此时只有<code>value</code>指向这个<code>zend_array</code>。</p>
<p>我们继续往下执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>然后重新打印一下这个value的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p *value.value.arr</span><br><span class="line"><span class="meta">$</span><span class="bash">10 = &#123;gc = &#123;refcount = 2, u = &#123;v = &#123;<span class="built_in">type</span> = 7 <span class="string">&#x27;\a&#x27;</span>, flags = 0 <span class="string">&#x27;\000&#x27;</span>, gc_info = 0&#125;, type_info = 7&#125;&#125;, u = &#123;v = &#123;flags = 18 <span class="string">&#x27;\022&#x27;</span>, nApplyCount = 0 <span class="string">&#x27;\000&#x27;</span>, nIteratorsCount = 0 <span class="string">&#x27;\000&#x27;</span>, consistency = 0 <span class="string">&#x27;\000&#x27;</span></span></span><br><span class="line">&#125;, flags = 18&#125;, nTableMask = 4294967294, arData = 0xd8eacc, nNumUsed = 0, nNumOfElements = 0, nTableSize = 8, nInternalPointer = 4294967295, nNextFreeElement = 0, pDestructor = 0x84d18f &lt;_zval_ptr_dtor_wr</span><br><span class="line"><span class="meta">apper&gt;</span><span class="bash">&#125;</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>我们发现，此时的<code>zend_array.gc.refcount</code>的值为2了。说明<code>zend_assign_to_variable</code>操作使得多了一个<code>zval</code>使用了这个<code>zend_array</code>。</p>
<p>我们继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br><span class="line">execute_ex (ex=0x7ffff5e14030) at /root/php-7.1.0/Zend/zend_vm_execute.h:430</span><br><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">428│ #if defined(ZEND_VM_FP_GLOBAL_REG) &amp;&amp; defined(ZEND_VM_IP_GLOBAL_REG)</span><br><span class="line">429├───────────────&gt; ((opcode_handler_t)OPLINE-&gt;handler)(ZEND_OPCODE_HANDLER_ARGS_PASSTHRU);</span><br><span class="line">430│                 if (UNEXPECTED(!OPLINE)) &#123;</span><br><span class="line">431│ #else</span><br><span class="line">432│                 if (UNEXPECTED((ret = ((opcode_handler_t)OPLINE-&gt;handler)(ZEND_OPCODE_HANDLER_ARGS_PASSTHRU)) != 0)) &#123;</span><br><span class="line">433│ #endif</span><br></pre></td></tr></table></figure>

<p>我们进入这个handler：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">ZEND_ASSIGN_DIM_SPEC_CV_CONST_OP_DATA_CONST_HANDLER () at /root/php-7.1.0/Zend/zend_vm_execute.h:39077</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">39077</span>├───────&gt; SAVE_OPLINE();</span><br><span class="line"><span class="number">39078</span>│         object_ptr = _get_zval_ptr_cv_undef_BP_VAR_W(execute_data, opline-&gt;op1.var);</span><br></pre></td></tr></table></figure>

<p>我们继续执行完39078行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) u	39079</span><br><span class="line">ZEND_ASSIGN_DIM_SPEC_CV_CONST_OP_DATA_CONST_HANDLER () at /root/php-7.1.0/Zend/zend_vm_execute.h:39080</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>然后打印这个<code>object_ptr</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	object_ptr</span><br><span class="line"><span class="meta">$</span><span class="bash">12 = (zval *) 0x7ffff5e14080</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>这个和之前打印的那个zend虚拟机的栈的起始地址一致。我们查看一下里面的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	*object_ptr    </span><br><span class="line"><span class="meta">$</span><span class="bash">13 = &#123;value = &#123;lval = 140737318851424, dval = 6.9533474332294241e-310, counted = 0x7ffff5e59360, str = 0x7ffff5e59360, arr = 0x7ffff5e59360, obj = 0x7ffff5e59360, res = 0x7ffff5e59360, ref = 0x7ffff5e593</span></span><br><span class="line">60, ast = 0x7ffff5e59360, zv = 0x7ffff5e59360, ptr = 0x7ffff5e59360, ce = 0x7ffff5e59360, func = 0x7ffff5e59360, ww = &#123;w1 = 4125463392, w2 = 32767&#125;&#125;, u1 = &#123;v = &#123;type = 7 &#x27;\a&#x27;, type_flags = 28 &#x27;\034&#x27;, cons</span><br><span class="line">t_flags = 0 &#x27;\000&#x27;, reserved = 0 &#x27;\000&#x27;&#125;, type_info = 7175&#125;, u2 = &#123;next = 0, cache_slot = 0, lineno = 0, num_args = 0, fe_pos = 0, fe_iter_idx = 0, access_flags = 0, property_guard = 0&#125;&#125;</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>因为<code>zval.u1.v.typle</code>为7，所以它是一个数组。我们查看一下这个数组的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	$13.value.arr </span><br><span class="line"><span class="meta">$</span><span class="bash">14 = (zend_array *) 0x7ffff5e59360</span></span><br><span class="line">(gdb) p *$13.value.arr</span><br><span class="line"><span class="meta">$</span><span class="bash">15 = &#123;gc = &#123;refcount = 2, u = &#123;v = &#123;<span class="built_in">type</span> = 7 <span class="string">&#x27;\a&#x27;</span>, flags = 0 <span class="string">&#x27;\000&#x27;</span>, gc_info = 0&#125;, type_info = 7&#125;&#125;, u = &#123;v = &#123;flags = 18 <span class="string">&#x27;\022&#x27;</span>, nApplyCount = 0 <span class="string">&#x27;\000&#x27;</span>, nIteratorsCount = 0 <span class="string">&#x27;\000&#x27;</span>, consistency = 0 <span class="string">&#x27;\000&#x27;</span></span></span><br><span class="line">&#125;, flags = 18&#125;, nTableMask = 4294967294, arData = 0xd8eacc, nNumUsed = 0, nNumOfElements = 0, nTableSize = 8, nInternalPointer = 4294967295, nNextFreeElement = 0, pDestructor = 0x84d18f &lt;_zval_ptr_dtor_wr</span><br><span class="line"><span class="meta">apper&gt;</span><span class="bash">&#125;</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">39081</span>│ try_assign_dim_array:</span><br><span class="line"><span class="number">39082</span>├───────────────&gt; SEPARATE_ARRAY(object_ptr);</span><br><span class="line"><span class="number">39083</span>│                 <span class="keyword">if</span> (IS_CONST == IS_UNUSED) &#123;</span><br></pre></td></tr></table></figure>

<p><code>SEPARATE_ARRAY</code>会进行写时分离，我们执行一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">39089│                 &#125; else &#123;</span><br><span class="line">39090├───────────────────────&gt; dim = EX_CONSTANT(opline-&gt;op2);</span><br><span class="line">39091│                         if (IS_CONST == IS_CONST) &#123;</span><br></pre></td></tr></table></figure>

<p>我们来看一下<code>object_ptr</code>里面的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p *object_ptr </span><br><span class="line"><span class="meta">$</span><span class="bash">16 = &#123;value = &#123;lval = 140737318851520, dval = 6.9533474332341671e-310, counted = 0x7ffff5e593c0, str =	0x7ffff5e593c0, arr = 0x7ffff5e593c0, obj = 0x7ffff5e593c0, res = 0x7ffff5e593c0, ref = 0x7ffff5e593</span></span><br><span class="line">c0, ast = 0x7ffff5e593c0, zv = 0x7ffff5e593c0, ptr = 0x7ffff5e593c0, ce = 0x7ffff5e593c0, func = 0x7ffff5e593c0, ww = &#123;w1 = 4125463488, w2 = 32767&#125;&#125;, u1 = &#123;v = &#123;type = 7 &#x27;\a&#x27;, type_flags = 28 &#x27;\034&#x27;, cons</span><br><span class="line">t_flags = 0 &#x27;\000&#x27;, reserved = 0 &#x27;\000&#x27;&#125;, type_info = 7175&#125;, u2 = &#123;next = 0, cache_slot = 0, lineno = 0, num_args = 0, fe_pos = 0, fe_iter_idx = 0, access_flags = 0, property_guard = 0&#125;&#125;</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>此时，<code>object_ptr.u1.v.type</code>为7，所以依然是一个数组。但是，此时的<code>object_ptr.value.arr</code>存放的地址为<code>0x7ffff5e593c0</code>（<code>$a</code>中<code>zend_array</code>里面存放的地址），不再是之前的<code>0x7ffff5e59360</code>了，即不再是最初我们初始化的那个<code>zend_array</code>了。</p>
<p>我们来看看这个<code>object_ptr</code>中<code>zend_array</code>的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p *object_ptr.value.arr</span><br><span class="line"><span class="meta">$</span><span class="bash">17 = &#123;gc = &#123;refcount = 1, u = &#123;v = &#123;<span class="built_in">type</span> = 7 <span class="string">&#x27;\a&#x27;</span>, flags = 0 <span class="string">&#x27;\000&#x27;</span>, gc_info = 0&#125;, type_info = 7&#125;&#125;, u = &#123;v = &#123;flags = 18 <span class="string">&#x27;\022&#x27;</span>, nApplyCount = 0 <span class="string">&#x27;\000&#x27;</span>, nIteratorsCount = 0 <span class="string">&#x27;\000&#x27;</span>, consistency = 0 <span class="string">&#x27;\000&#x27;</span></span></span><br><span class="line">&#125;, flags = 18&#125;, nTableMask = 4294967294, arData = 0xd8eacc, nNumUsed = 0, nNumOfElements = 0, nTableSize = 8, nInternalPointer = 4294967295, nNextFreeElement = 0, pDestructor = 0x84d18f &lt;_zval_ptr_dtor_wr</span><br><span class="line"><span class="meta">apper&gt;</span><span class="bash">&#125;</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>可以看到，这个<code>refcount</code>不再是2了，因为进行了写时分离，所以变成了1。</p>
<p>同时，我们再来看看之前初始化的那个<code>zend_array</code>的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	*(zend_array *)0x7ffff5e59360</span><br><span class="line"><span class="meta">$</span><span class="bash">18 = &#123;gc = &#123;refcount = 1, u = &#123;v = &#123;<span class="built_in">type</span> = 7 <span class="string">&#x27;\a&#x27;</span>, flags = 0 <span class="string">&#x27;\000&#x27;</span>, gc_info = 0&#125;, type_info = 7&#125;&#125;, u = &#123;v = &#123;flags = 18 <span class="string">&#x27;\022&#x27;</span>, nApplyCount = 0 <span class="string">&#x27;\000&#x27;</span>, nIteratorsCount = 0 <span class="string">&#x27;\000&#x27;</span>, consistency = 0 <span class="string">&#x27;\000&#x27;</span></span></span><br><span class="line">&#125;, flags = 18&#125;, nTableMask = 4294967294, arData = 0xd8eacc, nNumUsed = 0, nNumOfElements = 0, nTableSize = 8, nInternalPointer = 4294967295, nNextFreeElement = 0, pDestructor = 0x84d18f &lt;_zval_ptr_dtor_wr</span><br><span class="line"><span class="meta">apper&gt;</span><span class="bash">&#125;</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>可以看到，它的<code>refcount</code>也变了1。我们继续往下执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb)</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">39090</span>│                         dim = EX_CONSTANT(opline-&gt;op2);</span><br><span class="line"><span class="number">39091</span>│                         <span class="keyword">if</span> (IS_CONST == IS_CONST) &#123;</span><br><span class="line"><span class="number">39092</span>├───────────────────────────────&gt; variable_ptr = zend_fetch_dimension_address_inner_W_CONST(Z_ARRVAL_P(object_ptr), dim);</span><br></pre></td></tr></table></figure>

<p>我们打印一下这个<code>dim</code>的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	dim</span><br><span class="line"><span class="meta">$</span><span class="bash">19 = (zval *) 0x7ffff5e7b110</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>发现这是一个zval，我们看看这个zval的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	*dim</span><br><span class="line"><span class="meta">$</span><span class="bash">20 = &#123;value = &#123;lval = 1, dval = 4.9406564584124654e-324, counted = 0x1, str = 0x1, arr = 0x1, obj = 0x1, res = 0x1, ref = 0x1, ast = 0x1, zv = 0x1, ptr = 0x1, ce = 0x1, func = 0x1, ww = &#123;w1 = 1, w2 = 0&#125;&#125;</span></span><br><span class="line">, u1 = &#123;v = &#123;type = 4 &#x27;\004&#x27;, type_flags = 0 &#x27;\000&#x27;, const_flags = 0 &#x27;\000&#x27;, reserved = 0 &#x27;\000&#x27;&#125;, type_info = 4&#125;, u2 = &#123;next = 4294967295, cache_slot = 4294967295, lineno = 4294967295, num_args = 4294967</span><br><span class="line">295, fe_pos = 4294967295, fe_iter_idx = 4294967295, access_flags = 4294967295, property_guard = 4294967295&#125;&#125;</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>因为<code>zval.u1.v.type</code>为4，所以它是一个整形，我们打印一下这个内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	dim.value.lval </span><br><span class="line"><span class="meta">$</span><span class="bash">21 = 1</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>发现是1。而这个1就是PHP脚本中第5行：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$a[<span class="number">1</span>] = <span class="string">&#x27;a&#x27;</span>; <span class="comment">// 5</span></span><br></pre></td></tr></table></figure>

<p>中数组的索引1。</p>
<p>我们进入<code>zend_fetch_dimension_address_inner_W_CONST</code>这个函数里面：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">zend_fetch_dimension_address_inner_W_CONST (ht=0x7ffff5e593c0, dim=0x7ffff5e7b110) at /root/php-7.1.0/Zend/zend_execute.c:1651</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1649</span>│ <span class="function"><span class="keyword">static</span> zend_never_inline zval* ZEND_FASTCALL <span class="title">zend_fetch_dimension_address_inner_W_CONST</span><span class="params">(HashTable *ht, <span class="keyword">const</span> zval *dim)</span></span></span><br><span class="line">1650│ &#123;</span><br><span class="line"><span class="number">1651</span>├───────&gt; <span class="keyword">return</span> zend_fetch_dimension_address_inner(ht, dim, IS_CONST, BP_VAR_W);</span><br><span class="line"><span class="number">1652</span>│ &#125;</span><br></pre></td></tr></table></figure>

<p>继续进入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) s</span><br><span class="line">zend_fetch_dimension_address_inner (ht=0x7ffff5e593c0, dim=0x7ffff5e7b110, dim_type=1, type=1) at /root/php-7.1.0/Zend/zend_execute.c:1540</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1539</span>│ try_again:</span><br><span class="line"><span class="number">1540</span>├───────&gt; <span class="keyword">if</span> (EXPECTED(Z_TYPE_P(dim) == IS_LONG)) &#123;</span><br><span class="line"><span class="number">1541</span>│                 hval = Z_LVAL_P(dim);</span><br><span class="line"><span class="number">1542</span>│ num_index:</span><br><span class="line"><span class="number">1543</span>│                 ZEND_HASH_INDEX_FIND(ht, hval, retval, num_undef);</span><br><span class="line"><span class="number">1544</span>│                 <span class="keyword">return</span> retval;</span><br></pre></td></tr></table></figure>

<p>因为<code>dim</code>是一个long类型，所以，直接取出dim里面的内容。我们继续执行，取出dim里面的lval：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1539│ try_again:</span><br><span class="line">1540│         if (EXPECTED(Z_TYPE_P(dim) == IS_LONG)) &#123;</span><br><span class="line">1541│                 hval = Z_LVAL_P(dim);</span><br><span class="line">1542│ num_index:</span><br><span class="line">1543├───────────────&gt; ZEND_HASH_INDEX_FIND(ht, hval, retval, num_undef);</span><br><span class="line">1544│                 return retval;</span><br></pre></td></tr></table></figure>

<p>我们确认一下<code>hval</code>的是不是1：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	hval</span><br><span class="line"><span class="meta">$</span><span class="bash">22 = 1</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>没问题。</p>
<p>我们继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1542│ num_index:</span><br><span class="line">1543│                 ZEND_HASH_INDEX_FIND(ht, hval, retval, num_undef);</span><br><span class="line">1544│                 return retval;</span><br><span class="line">1545│ num_undef:</span><br><span class="line">1546├───────────────&gt; switch (type) &#123;</span><br></pre></td></tr></table></figure>

<p>显然，数组<code>$a</code>索引为1的元素是不存在的：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	type</span><br><span class="line"><span class="meta">$</span><span class="bash">23 = 1</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>这个type为1，说明zval的类型是<code>IS_NULL</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IS_NULL						1</span></span><br></pre></td></tr></table></figure>

<p>我们继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br><span class="line">zend_fetch_dimension_address_inner_W_CONST (ht=0x7ffff5e593c0, dim=0x7ffff5e7b110) at /root/php-7.1.0/Zend/zend_execute.c:1652</span><br><span class="line">(gdb) n</span><br><span class="line">ZEND_ASSIGN_DIM_SPEC_CV_CONST_OP_DATA_CONST_HANDLER () at /root/php-7.1.0/Zend/zend_vm_execute.h:39096</span><br><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br><span class="line">(gdb) n</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">39100</span>│                 value = EX_CONSTANT((opline+<span class="number">1</span>)-&gt;op1);</span><br><span class="line"><span class="number">39101</span>├───────────────&gt; value = zend_assign_to_variable(variable_ptr, value, IS_CONST);</span><br></pre></td></tr></table></figure>

<p>我们打印一下<code>value</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	value</span><br><span class="line"><span class="meta">$</span><span class="bash">24 = (zval *) 0x7ffff5e7b120</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>这是一个zval类型，我们看看里面的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	*value</span><br><span class="line"><span class="meta">$</span><span class="bash">25 = &#123;value = &#123;lval = 140737318491520, dval = 6.9533474154478039e-310, counted = 0x7ffff5e01580, str =	0x7ffff5e01580, arr = 0x7ffff5e01580, obj = 0x7ffff5e01580, res = 0x7ffff5e01580, ref =	0x7ffff5e015</span></span><br><span class="line">80, ast = 0x7ffff5e01580, zv = 0x7ffff5e01580, ptr = 0x7ffff5e01580, ce = 0x7ffff5e01580, func = 0x7ffff5e01580, ww = &#123;w1 = 4125103488, w2 = 32767&#125;&#125;, u1 = &#123;v = &#123;type = 6 &#x27;\006&#x27;, type_flags = 0 &#x27;\000&#x27;, con</span><br><span class="line">st_flags = 0 &#x27;\000&#x27;, reserved = 0 &#x27;\000&#x27;&#125;, type_info = 6&#125;, u2 = &#123;next = 4294967295, cache_slot = 4294967295, lineno = 4294967295, num_args = 4294967295, fe_pos = 4294967295, fe_iter_idx = 4294967295, acce</span><br><span class="line">ss_flags = 4294967295, property_guard = 4294967295&#125;&#125;</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>因为type是一个6，所以是字符串类型。我们打印一下<code>zend_string</code>里面的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p *value.value.str</span><br><span class="line"><span class="meta">$</span><span class="bash">27 = &#123;gc = &#123;refcount = 0, u = &#123;v = &#123;<span class="built_in">type</span> = 6 <span class="string">&#x27;\006&#x27;</span>, flags = 2 <span class="string">&#x27;\002&#x27;</span>, gc_info = 0&#125;, type_info = 518&#125;&#125;, h = 9223372036854953478, len = 1, val = <span class="string">&quot;a&quot;</span>&#125;</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>发现字符串的len是1，所以我们可以查看一下字符串的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p *value.value.str.val@1</span><br><span class="line"><span class="meta">$</span><span class="bash">28 = <span class="string">&quot;a&quot;</span></span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>发现它是字符<code>&#39;a&#39;</code>。与我们脚本第5行的一致。</p>
<p>可想而知，接下来39101行<code>zend_assign_to_variable</code>的操作字符串的分配操作了。</p>
<p>我们继续执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) n</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">39102</span>├───────────────&gt; <span class="keyword">if</span> (UNEXPECTED(RETURN_VALUE_USED(opline))) &#123;</span><br><span class="line"><span class="number">39103</span>│                         ZVAL_COPY(EX_VAR(opline-&gt;result.var), value);</span><br><span class="line"><span class="number">39104</span>│                 &#125;</span><br></pre></td></tr></table></figure>

<p>我们打印一下数组<code>$a</code>对应的<code>zend_array</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p *(zend_array *)0x7ffff5e593c0</span><br><span class="line"><span class="meta">$</span><span class="bash">31 = &#123;gc = &#123;refcount = 1, u = &#123;v = &#123;<span class="built_in">type</span> = 7 <span class="string">&#x27;\a&#x27;</span>, flags = 0 <span class="string">&#x27;\000&#x27;</span>, gc_info = 0&#125;, type_info = 7&#125;&#125;, u = &#123;v = &#123;flags = 30 <span class="string">&#x27;\036&#x27;</span>, nApplyCount = 0 <span class="string">&#x27;\000&#x27;</span>, nIteratorsCount = 0 <span class="string">&#x27;\000&#x27;</span>, consistency = 0 <span class="string">&#x27;\000&#x27;</span></span></span><br><span class="line">&#125;, flags = 30&#125;, nTableMask = 4294967294, arData = 0x7ffff5e5fa08, nNumUsed = 2, nNumOfElements = 1, nTableSize = 8, nInternalPointer = 1, nNextFreeElement = 2, pDestructor = 0x84d18f &lt;_zval_ptr_dtor_wrapp</span><br><span class="line"><span class="meta">er&gt;</span><span class="bash">&#125;</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>此时，<code>nNumUsed</code>的值为2了。</p>
<p>此时，<code>arData</code>里面是有内容的了，我们打印一下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	$31.arData[1]</span><br><span class="line"><span class="meta">$</span><span class="bash">32 = &#123;val = &#123;value = &#123;lval = 140737318491520, dval = 6.9533474154478039e-310, counted = 0x7ffff5e01580, str = 0x7ffff5e01580, arr = 0x7ffff5e01580, obj = 0x7ffff5e01580, res = 0x7ffff5e01580, ref = 0x7ff</span></span><br><span class="line">ff5e01580, ast = 0x7ffff5e01580, zv = 0x7ffff5e01580, ptr = 0x7ffff5e01580, ce = 0x7ffff5e01580, func = 0x7ffff5e01580, ww = &#123;w1 = 4125103488, w2 = 32767&#125;&#125;, u1 = &#123;v = &#123;type = 6 &#x27;\006&#x27;, type_flags = 0 &#x27;\00</span><br><span class="line">0&#x27;, const_flags = 0 &#x27;\000&#x27;, reserved = 0 &#x27;\000&#x27;&#125;, type_info = 6&#125;, u2 = &#123;next = 32767, cache_slot = 32767, lineno = 32767, num_args = 32767, fe_pos = 32767, fe_iter_idx = 32767, access_flags = 32767, prope</span><br><span class="line">rty_guard = 32767&#125;&#125;, h = 1, key = 0x0&#125;</span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>这是一个<code>Bucket</code>类型，里面直接嵌入了一个zval，这个zval的type为6，是一个字符串，所以，我们打印一下这个<code>zend_string</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p *$31.arData[1].val.value.str</span><br><span class="line"><span class="meta">$</span><span class="bash">36 = &#123;gc = &#123;refcount = 0, u = &#123;v = &#123;<span class="built_in">type</span> = 6 <span class="string">&#x27;\006&#x27;</span>, flags = 2 <span class="string">&#x27;\002&#x27;</span>, gc_info = 0&#125;, type_info = 518&#125;&#125;, h = 9223372036854953478, len = 1, val = <span class="string">&quot;a&quot;</span>&#125;</span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>字符串的长度是1，我们继续打印字符串的内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) p	*$31.arData[1].val.value.str.val@1</span><br><span class="line"><span class="meta">$</span><span class="bash">37 = <span class="string">&quot;a&quot;</span></span></span><br><span class="line">(gdb) </span><br></pre></td></tr></table></figure>

<p>至此，调试完了PHP脚本的第5行。</p>
<p>（未完）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/04/28/PHP7%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-%E6%95%B0%E7%BB%84/" data-id="ckkj72zx200m1f6vx7pf8dbng" data-title="PHP7源码分析--数组" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP7/" rel="tag">PHP7</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-通过hprose-php构建你的RPC服务" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/04/03/%E9%80%9A%E8%BF%87hprose-php%E6%9E%84%E5%BB%BA%E4%BD%A0%E7%9A%84RPC%E6%9C%8D%E5%8A%A1/" class="article-date">
  <time class="dt-published" datetime="2019-04-03T12:58:09.000Z" itemprop="datePublished">2019-04-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/04/03/%E9%80%9A%E8%BF%87hprose-php%E6%9E%84%E5%BB%BA%E4%BD%A0%E7%9A%84RPC%E6%9C%8D%E5%8A%A1/">通过hprose-php构建你的RPC服务</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>RPC的概念我们不过多的解释，我们直接来演示一下如何使用<code>hprose-php</code>构建RPC服务。</p>
<p>我们通过<code>composer</code>来安装<code>hprose-php</code>。项目初始化：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir rpc-server &amp;&amp; cd rpc-server &amp;&amp; touch composer.json &amp;&amp; echo &#x27;&#123;</span><br><span class="line">    &quot;require&quot;: &#123;</span><br><span class="line">        &quot;hprose/hprose&quot;: &quot;&gt;=2.0.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;&#x27; &gt; composer.json &amp;&amp; composer update</span><br></pre></td></tr></table></figure>

<p>在rpc-server目录下创建文件<code>callee.php</code>，内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Hprose</span>\<span class="title">Http</span>\<span class="title">Server</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">say</span>(<span class="params">$words</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $words;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$server = <span class="keyword">new</span> Server();</span><br><span class="line"></span><br><span class="line">$server-&gt;addFunction(<span class="string">&#x27;say&#x27;</span>);</span><br><span class="line">$server-&gt;start();</span><br></pre></td></tr></table></figure>

<p>然后在rpc-server目录下执行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/phpCode/rpc-server # php -S localhost:80</span><br><span class="line">PHP 7.2.14 Development Server started at Wed Apr  3 13:33:11 2019</span><br><span class="line">Listening on http://localhost:80</span><br><span class="line">Document root is /root/codeDir/phpCode/rpc-server</span><br><span class="line">Press Ctrl-C to quit.</span><br></pre></td></tr></table></figure>

<p>然后在rpc-server目录下创建文件<code>caller.php</code>，内容如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require_once</span> <span class="string">&#x27;vendor/autoload.php&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Hprose</span>\<span class="title">Http</span>\<span class="title">Client</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Hprose</span>\<span class="title">InvokeSettings</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Hprose</span>\<span class="title">ResultMode</span>;</span><br><span class="line"></span><br><span class="line">$client = <span class="keyword">new</span> Client(<span class="string">&#x27;localhost/callee.php&#x27;</span>, <span class="literal">false</span>);</span><br><span class="line">var_dump($client-&gt;say(<span class="string">&#x27;hello world&#x27;</span>));</span><br></pre></td></tr></table></figure>

<p>然后执行脚本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/phpCode/rpc-server # php caller.php</span><br><span class="line">string(11) &quot;hello world&quot;</span><br></pre></td></tr></table></figure>

<p>发现，调用RPC服务的<code>say</code>方法成功。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/04/03/%E9%80%9A%E8%BF%87hprose-php%E6%9E%84%E5%BB%BA%E4%BD%A0%E7%9A%84RPC%E6%9C%8D%E5%8A%A1/" data-id="ckkj72zv700ccf6vxc28jh038" data-title="通过hprose-php构建你的RPC服务" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-关于协程的共享栈和独立栈的思考" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/04/03/%E5%85%B3%E4%BA%8E%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%85%B1%E4%BA%AB%E6%A0%88%E5%92%8C%E7%8B%AC%E7%AB%8B%E6%A0%88%E7%9A%84%E6%80%9D%E8%80%83/" class="article-date">
  <time class="dt-published" datetime="2019-04-03T03:00:39.000Z" itemprop="datePublished">2019-04-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/04/03/%E5%85%B3%E4%BA%8E%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%85%B1%E4%BA%AB%E6%A0%88%E5%92%8C%E7%8B%AC%E7%AB%8B%E6%A0%88%E7%9A%84%E6%80%9D%E8%80%83/">关于协程的共享栈和独立栈的思考</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>先解释一下这两个的概念：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">共享栈指的是在所有协程运行的过程中，它们用的任务栈是同一个栈</span><br><span class="line">独立栈指的是在所有协程运行的过程中，它们用的任务栈是各自的栈</span><br></pre></td></tr></table></figure>

<p>那么，它们有什么优缺点呢？</p>
<p>独立栈往往会更加的<strong>浪费</strong>内存。因为，我们需要为每一个协程预先分配一个栈空间，但是问题是协程不一定会用完这个栈空间，而那些多出来的栈空间就是被浪费掉了的。如图所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">+---------+   +---------+  +---------+</span><br><span class="line">|         |   |         |  |         |</span><br><span class="line">|  used   |   |  used   |  |  used   |</span><br><span class="line">|         |   |         |  |         |</span><br><span class="line">+---------+   +---------+  +---------+</span><br><span class="line">|         |   |         |  |         |</span><br><span class="line">|         |   |         |  |         |</span><br><span class="line">|  unused |   |  unused |  |  unused |</span><br><span class="line">|         |   |         |  |         |</span><br><span class="line">|         |   |         |  |         |</span><br><span class="line">+---------+   +---------+  +---------+</span><br></pre></td></tr></table></figure>

<p>或许有同学会说，那我给每个协程分配少一点的栈，那不就可以了嘛？但是，你只给协程分配一点点栈，万一协程跑着跑着栈溢出了怎么办？又有同学说，那我在写代码的时候就注意一下，不要在协程中分配一个很大的局部数组不就好了咪？但是，这样只可以保证你自己写的代码不会出现栈溢出，万一你调用了一个库函数，这个库函数它分配了一个比较大的局部数组怎么办，还是有可能会导致栈溢出的对吧。</p>
<p>OK，这是独立栈的缺点。现在说说优点。</p>
<p>优点就是，每次切换协程的时候，不需要对栈进行拷贝。这样说同学们可能不太好理解。我们稍后对比一下共享栈就好理解了。</p>
<p>共享栈的优点就是，可以更加的节省内存。因为，我们只需要让协程使用这个共享的栈即可，然后，当协程挂起的时候，依据当前协程使用的栈空间大小来分配内存备份协程的栈内容。但是，这样的话，就会使得每次换入和换出协程的时候，都要进行协程的栈数据的拷贝。</p>
<p>那么，有没有一个折中的办法呢？</p>
<p>有，这里给出一个折中的方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">协程栈的栈底在CO_STACK_BOTTOM位置，所有协程共享这个线性地址。</span><br><span class="line">|____________|_____________________|</span><br><span class="line">0           128K                   4M</span><br><span class="line">|            |                     |</span><br><span class="line">|            |                     &#96;MMAP_STACK - 大于128K小于4M的栈称为&#96;mmap栈&#96;</span><br><span class="line">|            &#96;COPY_STACK - 小于128K的栈称为&#96;copy栈&#96;</span><br><span class="line">&#96;CO_STACK_BOTTOM - 栈底</span><br><span class="line"></span><br><span class="line">协程栈的消耗小于COPY_STACK时，采用copy方式：</span><br><span class="line">      1) 协程换出时，把协程栈从[co_t::rsp - CO_STACK_BOTTOM)拷贝到co_t::stack中(malloc的内存)</span><br><span class="line">      2) 协程换入时，把协程从co_t::stack中拷贝到[co_t::rsp - CO_STACK_BOTTOM)内存</span><br><span class="line">  协程栈消耗大于COPY_STACK时，采用mmap方式：</span><br><span class="line">      3) 协程换出时：</span><br><span class="line">          5) 首次换出，先申请MMAP_STACK大小的共享内存shm_open，然后把协程栈从</span><br><span class="line">             [co_t::rsp - CO_STACK_BOTTOM)拷贝到共享内存中(称为&#96;从copy栈切换到mmap栈&#96;)</span><br><span class="line">          6) 非首次换出，如果next不使用mmap栈则需要&#96;重建copy栈&#96;。</span><br><span class="line">      4) 协程换入时，&#96;建立mmap栈&#96;</span><br><span class="line">  重建copy栈：在[CO_STACK_BOTTOM-COPY_STACK, CO_STACK_BOTTOM] 建立线性映射，向下生长(MAP_GROWSDOWN)</span><br><span class="line">  建立mmap栈：把协程的mmap栈映射到 [CO_STACK_BOTTOM-MMAP_STACK, CO_STACK_BOTTOM] 线性地址</span><br></pre></td></tr></table></figure>

<p>总结起来就是：协程使用的栈空间比较小的时候用共享栈，比较大的时候用独立栈。</p>
<p>除了这种方法之外，还可以如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、协程系统初始化时，使用 mmap 系统调用“占用”一块连续的虚拟地址空间，称为“共享栈区”，大小比如 8MB。访问权限设置为 PROT_NONE。</span><br><span class="line">2、协程任务结构中有一个“栈页数组”，项数最高可以容纳 8MB，任务创建时数据全部清 0。</span><br><span class="line">3、协程任务切换时，将“共享栈区”整体 mprotect 为 PROT_NONE。</span><br><span class="line">4、协程任务执行时，当产生对栈的读写访问时，产生段错误，触发 SIGSEGV，在信号处理函数中，查询当前任务“栈页数组”，如果已经分配， mmap 至 ”共享栈区“ 对应偏移处，权限为 PROT_READ | PORT_WRTIE，必要的情况下允许执行，完成栈页装填。如果未分配，从“栈页分配器”中分配一页栈页，先放入当前任务的“栈页数组”中，再 mmap 至 “共享栈区” 对应偏移处，完成栈空间动态增配。</span><br></pre></td></tr></table></figure>

<p>这里，或许有同学会问：使用<code>SIGSEGV</code>信号的话，会不会出现多线程情况下，<code>SIGSEGV</code>信号发送给任意的一个线程呢？我们可以看看文档如何说的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A signal may be generated (and thus pending) for a process as a whole (e.g., when sent using kill(2)) or for a specific thread (e.g., certain signals, such as SIGSEGV and SIGFPE, generated as a consequence of executing a specific machine-language instruction are thread directed, as are signals targeted at a specific thread using pthread_kill(3)).  A process-directed signal may be delivered to any one of the threads that does not currently have the signal blocked. If more than one of the threads has the signal unblocked, then the kernel chooses an arbitrary thread to which to deliver the signal.</span><br></pre></td></tr></table></figure>

<p>可以看出，<code>SIGSEGV</code>在多线程情况下，系统会将其发送给产生这个异常的线程。</p>
<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><p>1、<a target="_blank" rel="noopener" href="https://github.com/duanery/coroutine">duanery/coroutine</a></p>
<p>2、<a target="_blank" rel="noopener" href="https://github.com/Tencent/libco/issues/80">协程任务栈技术交流</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/04/03/%E5%85%B3%E4%BA%8E%E5%8D%8F%E7%A8%8B%E7%9A%84%E5%85%B1%E4%BA%AB%E6%A0%88%E5%92%8C%E7%8B%AC%E7%AB%8B%E6%A0%88%E7%9A%84%E6%80%9D%E8%80%83/" data-id="ckkj72ztt008df6vxg45310li" data-title="关于协程的共享栈和独立栈的思考" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E5%8D%8F%E7%A8%8B/" rel="tag">协程</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-PHP-版本7-2-14中，一个数除以0会发生什么" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2019/04/02/PHP-%E7%89%88%E6%9C%AC7-2-14%E4%B8%AD%EF%BC%8C%E4%B8%80%E4%B8%AA%E6%95%B0%E9%99%A4%E4%BB%A50%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88/" class="article-date">
  <time class="dt-published" datetime="2019-04-02T05:09:28.000Z" itemprop="datePublished">2019-04-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2019/04/02/PHP-%E7%89%88%E6%9C%AC7-2-14%E4%B8%AD%EF%BC%8C%E4%B8%80%E4%B8%AA%E6%95%B0%E9%99%A4%E4%BB%A50%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88/">PHP 版本7.2.14中，一个数除以0会发生什么</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>PHP版本：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/phpCode/test # php -v</span><br><span class="line">PHP 7.2.14 (cli) (built: Jan 11 2019 01:35:56) ( NTS )</span><br><span class="line">Copyright (c) 1997-2018 The PHP Group</span><br><span class="line">Zend Engine v3.2.0, Copyright (c) 1998-2018 Zend Technologies</span><br><span class="line">    with Zend OPcache v7.2.14, Copyright (c) 1999-2018, by Zend Technologies</span><br></pre></td></tr></table></figure>

<p>代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$a = <span class="number">10</span>;</span><br><span class="line">$b = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $a / $b;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/phpCode/test # php test.php </span><br><span class="line"></span><br><span class="line">Warning: Division by zero in /root/codeDir/phpCode/test/test.php on line 6</span><br><span class="line">INF~/codeDir/phpCode/test #</span><br></pre></td></tr></table></figure>

<p>我们发现，报了<code>Warning</code>问题，这是PHP错误的一种等级。说明，就<code>7.2.14</code>版本的PHP而言：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一个数除以0，PHP会当作错误来看待</span><br></pre></td></tr></table></figure>

<p>自然，我们就不可以通过捕获异常的方式来处理除0问题了：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">$a = <span class="number">10</span>;</span><br><span class="line">$b = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> $a / $b;</span><br><span class="line">&#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $e-&gt;getMessage() . PHP_EOL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/phpCode/test # php test.php </span><br><span class="line"></span><br><span class="line">Warning: Division by zero in /root/codeDir/phpCode/test/test.php on line 7</span><br><span class="line">INF~/codeDir/phpCode/test #</span><br></pre></td></tr></table></figure>

<p>捕获异常失败了对吧。</p>
<p>所以，对于这种情况，我们还是需要单独去判断<code>$b</code>是否为0。</p>
<p>（注意，这是在目前的PHP版本中，除以0是当作错误来处理，在其他语言例如Java中，是当作异常来处理的）</p>
<p>如果可以的话，能够使用<code>set_error_handler</code>来接管PHP错误处理：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">customError</span>(<span class="params">$errno, $errstr</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>($errno . <span class="string">&#x27;|&#x27;</span> . $errstr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">set_error_handler(<span class="string">&#x27;customError&#x27;</span>, E_WARNING | E_STRICT);</span><br><span class="line"></span><br><span class="line">$a = <span class="number">10</span>;</span><br><span class="line">$b = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> $a / $b;</span><br><span class="line">&#125; <span class="keyword">catch</span> (\<span class="built_in">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $e-&gt;getMessage() . PHP_EOL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~/codeDir/phpCode/test # php test.php </span><br><span class="line">2|Division by zero</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://huanghantao.github.io/2019/04/02/PHP-%E7%89%88%E6%9C%AC7-2-14%E4%B8%AD%EF%BC%8C%E4%B8%80%E4%B8%AA%E6%95%B0%E9%99%A4%E4%BB%A50%E4%BC%9A%E5%8F%91%E7%94%9F%E4%BB%80%E4%B9%88/" data-id="ckkj72zr10019f6vx7d0f867a" data-title="PHP 版本7.2.14中，一个数除以0会发生什么" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/13/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><a class="page-number" href="/page/16/">16</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/15/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Boost/" rel="tag">Boost</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Composer/" rel="tag">Composer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/C%E8%AF%AD%E8%A8%80/" rel="tag">C语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Dockerfile/" rel="tag">Dockerfile</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GRPC/" rel="tag">GRPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Golang/" rel="tag">Golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/GraphQL/" rel="tag">GraphQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTML/" rel="tag">HTML</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP/" rel="tag">HTTP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hyperf/" rel="tag">Hyperf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" rel="tag">I/O多路复用</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JIT/" rel="tag">JIT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JWT/" rel="tag">JWT</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Laravel/" rel="tag">Laravel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MacOS/" rel="tag">MacOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/" rel="tag">Mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OPcache/" rel="tag">OPcache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP/" rel="tag">PHP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHP 扩展开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP7/" rel="tag">PHP7</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E5%86%85%E6%A0%B8/" rel="tag">PHP内核</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95/" rel="tag">PHP扩展</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" rel="tag">PHP扩展开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PostgreSQL/" rel="tag">PostgreSQL</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Protobuf/" rel="tag">Protobuf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/RPC/" rel="tag">RPC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis/" rel="tag">Redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swoole/" rel="tag">Swoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Swoole%E5%BE%AE%E8%AF%BE%E7%A8%8B/" rel="tag">Swoole微课程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vscode/" rel="tag">Vscode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xdebug/" rel="tag">Xdebug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/" rel="tag">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/composer/" rel="tag">composer</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c%E8%AF%AD%E8%A8%80/" rel="tag">c语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker-compose/" rel="tag">docker-compose</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/epoll/" rel="tag">epoll</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fpm/" rel="tag">fpm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/" rel="tag">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gqlgen/" rel="tag">gqlgen</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/leetcode/" rel="tag">leetcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/migrate/" rel="tag">migrate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/" rel="tag">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/" rel="tag">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swoole/" rel="tag">swoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/swore/" rel="tag">swore</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tinyswoole/" rel="tag">tinyswoole</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/unique-lock/" rel="tag">unique_lock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vue-js/" rel="tag">vue.js</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%85%B6%E4%BB%96/" rel="tag">其他</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%89%8D%E7%AB%AF/" rel="tag">前端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%8F%E7%A8%8B/" rel="tag">协程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%96%E9%83%A8%E6%8E%92%E5%BA%8F/" rel="tag">外部排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" rel="tag">多线程编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B9%B6%E5%8F%91/" rel="tag">并发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/" rel="tag">引用计数</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD/" rel="tag">性能</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" rel="tag">性能优化</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" rel="tag">性能分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag">操作系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" rel="tag">服务器开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" rel="tag">服务器编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" rel="tag">汇编语言</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" rel="tag">秒杀系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B/" rel="tag">线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" rel="tag">线程池</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A0%81/" rel="tag">编码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" rel="tag">编译原理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" rel="tag">编译器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" rel="tag">网络编程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag">虚拟机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" rel="tag">计算机基础</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" rel="tag">计算机系统</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" rel="tag">计算机网络</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AF%BB%E8%AF%BB%E4%BB%A3%E7%A0%81/" rel="tag">读读代码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%B0%83%E8%AF%95/" rel="tag">调试</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%80%92%E5%BD%92/" rel="tag">递归</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%94%81/" rel="tag">锁</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Boost/" style="font-size: 10px;">Boost</a> <a href="/tags/C/" style="font-size: 11.43px;">C</a> <a href="/tags/C/" style="font-size: 16.43px;">C++</a> <a href="/tags/Composer/" style="font-size: 10px;">Composer</a> <a href="/tags/C%E8%AF%AD%E8%A8%80/" style="font-size: 15px;">C语言</a> <a href="/tags/Docker/" style="font-size: 11.43px;">Docker</a> <a href="/tags/Dockerfile/" style="font-size: 10px;">Dockerfile</a> <a href="/tags/GRPC/" style="font-size: 10.71px;">GRPC</a> <a href="/tags/Golang/" style="font-size: 10px;">Golang</a> <a href="/tags/GraphQL/" style="font-size: 10px;">GraphQL</a> <a href="/tags/HTML/" style="font-size: 10px;">HTML</a> <a href="/tags/HTTP/" style="font-size: 10px;">HTTP</a> <a href="/tags/Hyperf/" style="font-size: 10.71px;">Hyperf</a> <a href="/tags/I-O%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/" style="font-size: 10.71px;">I/O多路复用</a> <a href="/tags/JIT/" style="font-size: 10px;">JIT</a> <a href="/tags/JWT/" style="font-size: 10px;">JWT</a> <a href="/tags/Laravel/" style="font-size: 10px;">Laravel</a> <a href="/tags/Linux/" style="font-size: 17.14px;">Linux</a> <a href="/tags/MacOS/" style="font-size: 10px;">MacOS</a> <a href="/tags/MySQL/" style="font-size: 10.71px;">MySQL</a> <a href="/tags/Mysql/" style="font-size: 10px;">Mysql</a> <a href="/tags/OPcache/" style="font-size: 10px;">OPcache</a> <a href="/tags/PHP/" style="font-size: 20px;">PHP</a> <a href="/tags/PHP-%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size: 10.71px;">PHP 扩展开发</a> <a href="/tags/PHP7/" style="font-size: 10px;">PHP7</a> <a href="/tags/PHP%E5%86%85%E6%A0%B8/" style="font-size: 17.86px;">PHP内核</a> <a href="/tags/PHP%E6%89%A9%E5%B1%95/" style="font-size: 13.57px;">PHP扩展</a> <a href="/tags/PHP%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91/" style="font-size: 12.14px;">PHP扩展开发</a> <a href="/tags/PostgreSQL/" style="font-size: 10px;">PostgreSQL</a> <a href="/tags/Protobuf/" style="font-size: 10.71px;">Protobuf</a> <a href="/tags/RPC/" style="font-size: 10px;">RPC</a> <a href="/tags/Redis/" style="font-size: 10px;">Redis</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/Swoole/" style="font-size: 19.29px;">Swoole</a> <a href="/tags/Swoole%E5%BE%AE%E8%AF%BE%E7%A8%8B/" style="font-size: 10px;">Swoole微课程</a> <a href="/tags/Vscode/" style="font-size: 10px;">Vscode</a> <a href="/tags/Xdebug/" style="font-size: 10.71px;">Xdebug</a> <a href="/tags/c/" style="font-size: 10.71px;">c++</a> <a href="/tags/composer/" style="font-size: 10px;">composer</a> <a href="/tags/c%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">c语言</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/docker-compose/" style="font-size: 10px;">docker-compose</a> <a href="/tags/epoll/" style="font-size: 10px;">epoll</a> <a href="/tags/fpm/" style="font-size: 10px;">fpm</a> <a href="/tags/golang/" style="font-size: 10px;">golang</a> <a href="/tags/gqlgen/" style="font-size: 10px;">gqlgen</a> <a href="/tags/leetcode/" style="font-size: 12.14px;">leetcode</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/migrate/" style="font-size: 10px;">migrate</a> <a href="/tags/nginx/" style="font-size: 10.71px;">nginx</a> <a href="/tags/php/" style="font-size: 15.71px;">php</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/swoole/" style="font-size: 15.71px;">swoole</a> <a href="/tags/swore/" style="font-size: 10px;">swore</a> <a href="/tags/tinyswoole/" style="font-size: 10px;">tinyswoole</a> <a href="/tags/unique-lock/" style="font-size: 10px;">unique_lock</a> <a href="/tags/vue-js/" style="font-size: 10.71px;">vue.js</a> <a href="/tags/%E5%85%B6%E4%BB%96/" style="font-size: 12.14px;">其他</a> <a href="/tags/%E5%89%8D%E7%AB%AF/" style="font-size: 10px;">前端</a> <a href="/tags/%E5%8D%8F%E7%A8%8B/" style="font-size: 15.71px;">协程</a> <a href="/tags/%E5%A4%96%E9%83%A8%E6%8E%92%E5%BA%8F/" style="font-size: 10px;">外部排序</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">多线程编程</a> <a href="/tags/%E5%B9%B6%E5%8F%91/" style="font-size: 10px;">并发</a> <a href="/tags/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/" style="font-size: 10px;">引用计数</a> <a href="/tags/%E6%80%A7%E8%83%BD/" style="font-size: 10px;">性能</a> <a href="/tags/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/" style="font-size: 10px;">性能优化</a> <a href="/tags/%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90/" style="font-size: 10px;">性能分析</a> <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" style="font-size: 13.57px;">操作系统</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 10.71px;">数据结构</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BC%80%E5%8F%91/" style="font-size: 12.86px;">服务器开发</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BC%96%E7%A8%8B/" style="font-size: 10px;">服务器编程</a> <a href="/tags/%E6%B1%87%E7%BC%96%E8%AF%AD%E8%A8%80/" style="font-size: 10px;">汇编语言</a> <a href="/tags/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">秒杀系统</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 15px;">算法</a> <a href="/tags/%E7%BA%BF%E7%A8%8B/" style="font-size: 10px;">线程</a> <a href="/tags/%E7%BA%BF%E7%A8%8B%E6%B1%A0/" style="font-size: 10px;">线程池</a> <a href="/tags/%E7%BC%96%E7%A0%81/" style="font-size: 10px;">编码</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" style="font-size: 18.57px;">编译原理</a> <a href="/tags/%E7%BC%96%E8%AF%91%E5%99%A8/" style="font-size: 10px;">编译器</a> <a href="/tags/%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B/" style="font-size: 14.29px;">网络编程</a> <a href="/tags/%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 10px;">虚拟机</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%9F%BA%E7%A1%80/" style="font-size: 10px;">计算机基础</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%B3%BB%E7%BB%9F/" style="font-size: 10px;">计算机系统</a> <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/" style="font-size: 10.71px;">计算机网络</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10.71px;">设计模式</a> <a href="/tags/%E8%AF%BB%E8%AF%BB%E4%BB%A3%E7%A0%81/" style="font-size: 10.71px;">读读代码</a> <a href="/tags/%E8%B0%83%E8%AF%95/" style="font-size: 10px;">调试</a> <a href="/tags/%E9%80%92%E5%BD%92/" style="font-size: 10px;">递归</a> <a href="/tags/%E9%94%81/" style="font-size: 10px;">锁</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/12/">December 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/09/">September 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/08/">August 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">July 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/05/">May 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/03/03/PHP%E5%86%85%E6%A0%B8%E4%B8%AD%E4%B8%8E%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9C%89%E5%85%B3%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93/">PHP内核中与异常处理有关的结构体</a>
          </li>
        
          <li>
            <a href="/2021/03/01/Swoole-reload-async%E6%9C%BA%E5%88%B6/">Swoole reload_async机制</a>
          </li>
        
          <li>
            <a href="/2021/02/24/PHP%E4%B8%AD%E7%9A%84if%E8%AF%AD%E5%8F%A5%E5%92%8Cswitch%E8%AF%AD%E5%8F%A5%E7%94%9F%E6%88%90%E7%9A%84opcode%E5%AF%B9%E6%AF%94/">PHP中的if语句和switch语句生成的opcode对比</a>
          </li>
        
          <li>
            <a href="/2021/02/02/ptrace%E4%BD%BF%E7%94%A8/">ptrace使用</a>
          </li>
        
          <li>
            <a href="/2021/01/30/PHP%E5%87%BD%E6%95%B0%E7%BC%96%E8%AF%91%E4%B9%8B%E5%90%8E%E7%9A%84%E5%86%85%E5%AD%98%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84/">PHP函数编译之后的内存存储结构</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 codinghuang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>