---
title: PHP内核编译for语句
date: 2020-11-08 19:28:29
tags:
- PHP
- PHP内核
- 编译原理
---

我们有如下脚本：

```php
<?php

for ($i = 0; $i < 10; $i = $i + 1) {
    echo $i;
}
```

对应的`opcode`为：

```bash
L3    #0     ASSIGN                  $i                   0
L3    #1     JMP                     J5
L4    #2     ECHO                    $i
L3    #3     ADD                     $i                   1                    ~1
L3    #4     ASSIGN                  $i                   ~1
L3    #5     IS_SMALLER              $i                   10                   ~3
L3    #6     JMPNZ                   ~3                   J2
L6    #7     RETURN<-1>              1
```

首先，我们把`for`语句的组成部分说一下：

```bison
T_FOR '(' init_exprs ';' cond_exprs ';' loop_exprs ')' for_statement
```

对应：

```bison
T_FOR => for
init_exprs => $i = 0
cond_exprs => $i < 10
loop_exprs => $i = $i + 1
for_statement => echo $i;
```

因为，这些`opcode`是没有经过任何优化的，所以，我们看到的`opcode`顺序就是`PHP`解释器去编译的顺序。

`OK`，我们来从编译出来的`opcode`总结出编译`for`语句的一般规律。

首先是：

```bash
L3    #0     ASSIGN                  $i                   0
```

这对应着我们的`init_exprs`。

接着是：

```bash
L3    #1     JMP                     J5
```

没有对应的代码。

接着是：

```bash
L4    #2     ECHO                    $i
```

对应着我们的`for_statement`。

接着是：

```bash
L3    #3     ADD                     $i                   1                    ~1
L3    #4     ASSIGN                  $i                   ~1
```

对应着我们的`loop_exprs`。

接着是：

```bash
L3    #5     IS_SMALLER              $i                   10                   ~3
```

对应着我们的`cond_exprs`。

最后是：

```bash
L3    #6     JMPNZ                   ~3                   J2
```

没有对应的代码。

我们可以得到如下图：

```bash
   ┌──────────────────────────────┐   
   │                              │   
   │          init_exprs          │   
   │                              │   
   └──────────────────────────────┘   
                   │                  
                   │                  
                   ▼                  
   ┌──────────────────────────────┐   
   │                              │   
┌──│             JMP              │◀─┐
│  │                              │  │
│  └──────────────────────────────┘  │
│                  │                 │
│                  │                 │
│                  │                 │
│                  ▼                 │
│  ┌──────────────────────────────┐  │
│  │                              │  │
│  │        for_statement         │  │
│  │                              │  │
│  └──────────────────────────────┘  │
│                  │                 │
│                  │                 │
│                  │                 │
│                  ▼                 │
│  ┌──────────────────────────────┐  │
│  │                              │  │
│  │          loop_exprs          │  │
│  │                              │  │
│  └──────────────────────────────┘  │
│                  │                 │
│                  │                 │
│                  │                 │
│                  ▼                 │
│  ┌──────────────────────────────┐  │
│  │                              │  │
└─▶│          cond_exprs          │  │
   │                              │  │
   └──────────────────────────────┘  │
                   │                 │
                   │                 │
                   │                 │
                   ▼                 │
   ┌──────────────────────────────┐  │
   │                              │  │
   │            JMPNZ             │──┘
   │                              │   
   └──────────────────────────────┘   
```

这实际上，就是通过`if`和`goto`来实现`for`循环。

我们在写编译器的时候，就可以借鉴这个模型。
