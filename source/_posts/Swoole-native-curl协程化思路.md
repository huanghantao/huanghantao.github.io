---
title: Swoole native curl协程化思路
date: 2020-11-24 12:22:34
tags:
- Swoole
---

这个还是有点复杂的，记录一下：

```bash
 ┌──────────────────────────┐                                                                                                                           
 │                          │                                                                                                                           
 │                          │                                                                                                                           
 │           co 1           │                                                                                                                           
 │                          │                                                                                                                           
 │       1. curl exec       │                                                                                                                           
 │                          │                                                                                                                           
 │                          │                                                                                                                           
 └──────────────────────────┘                                                                                                                           
               │                                                                                                                                        
               │                                                                                                                                        
               ▼                                                                                                                                        
 ┌──────────────────────────┐                                                                                                                           
 │                          │                                                                                                                           
 │                          │                                                                                                                           
 │           co 1           │                                                                                                                           
 │                          │                                                                                                                           
 │       2. add timer       │                                                                                                                           
 │                          │                                                                                                                           
 │                          │                                                                                                                           
 └──────────────────────────┘                                                                                                                           
               │                                                                                                                                        
               │                                                                                                                                        
               ▼                                                                                                                                        
 ┌──────────────────────────┐                                     ┌──────────────────────────────────┐           ┌──────────────────────────────────┐   
 │                          │                                     │                                  │           │                                  │   
 │                          │                                     │                                  │           │                                  │   
 │           co 1           │                                     │            event loop            │           │   curl_multi_socket_action ->    │   
 │                          │────────────────────────────────────▶│                                  │──────────▶│  connect -> add write event ->   │   
 │        3. yield_m        │                                     │            4. timeout            │           │       return to event loop       │   
 │                          │                                     │                                  │           │                                  │   
 │                          │                                     │                                  │           │                                  │   
 └──────────────────────────┘                                     └──────────────────────────────────┘           └──────────────────────────────────┘   
                                                                                    │                                                                   
                                                                                    │                                                                   
                                                                                    │                                                                   
                                                                                    ▼                                                                   
                                                                  ┌──────────────────────────────────┐           ┌──────────────────────────────────┐   
                                                                  │                                  │           │                                  │   
                                                                  │                                  │           │                                  │   
                                                                  │            event loop            │           │ curl_multi_socket_action -> send │   
                                                                  │                                  │──────────▶│   request -> add read event ->   │   
                                                                  │           5. writeable           │           │       return to event loop       │   
                                                                  │                                  │           │                                  │   
                                                                  │                                  │           │                                  │   
                                                                  └──────────────────────────────────┘           └──────────────────────────────────┘   
                                                                                    │                                                                   
                                                                                    │                                                                   
                                                                                    │                                                                   
                                                                                    │                                                                   
                                                                                    │                                                                   
                                                                                    ▼                                                                   
                                                                  ┌──────────────────────────────────┐            ┌──────────────────────────────────┐  
                                                                  │                                  │            │                                  │  
                                                                  │                                  │            │ curl_multi_socket_action -> call │  
                                                                  │            event loop            │            │  CURLOPT_HEADERFUNCTION -> set   │  
                                                                  │                                  │───────────▶│  write_header for coroutine ->   │  
                                                                  │           6. readable            │            │             resume_m             │  
                                                                  │                                  │            │                                  │  
                                                                  │                                  │            │                                  │  
                                                                  └──────────────────────────────────┘            └──────────────────────────────────┘  
                                                                                                                                    │                   
                                                                                                                                    │                   
                                                                                                                                    │                   
                                                                                                                                    │                   
   ┌────────────────────────────────────────────┐                                                                                   │                   
   │                                            │                                                                                   │                   
   │                                            │                                                                                   │                   
   │                                            │                                                                                   │                   
   │                                            │                                                                                   │                   
   │                    co 1                    │                                                                                   │                   
   │                                            │                                                                                   │                   
   │7. write_header func to get response header │                                                                                   │                   
   │     -> yield_m (Notice: Every time the     │◀──────────────────────────────────────────────────────────────────────────────────┘                   
   │fn_write_header reads a row of headers in a │                                                                                                       
   │callback, a scheduler-to-coroutine switch is│                                                                                                       
   │                 required)                  │                                                                                                       
   │                                            │                                                                                                       
   │                                            │                                                                                                       
   │                                            │                                                                                                       
   │                                            │                                                                                                       
   └────────────────────────────────────────────┘                  ┌──────────────────────────────────┐             ┌──────────────────────────────────┐
                          │                                        │                                  │             │                                  │
                          │                                        │                                  │             │   curl_multi_socket_action ->    │
                          │                                        │            event loop            │             │CURLOPT_WRITEFUNCTION func -> read│
                          └───────────────────────────────────────▶│                                  │────────────▶│body -> delete all event -> delete│
                                                                   │            8. timeout            │             │        timer -> resume_m         │
                                                                   │                                  │             │                                  │
                                                                   │                                  │             │                                  │
                                                                   └──────────────────────────────────┘             └──────────────────────────────────┘
                                                                                                                                      │                 
                                                                                                                                      │                 
                                                                                                                                      │                 
                                                                                                                                      │                 
   ┌──────────────────────────────────────────────┐                                                                                   │                 
   │                                              │                                                                                   │                 
   │                                              │                                                                                   │                 
   │                     co 1                     │                                                                                   │                 
                                                  │◀──────────────────────────────────────────────────────────────────────────────────┘                 
   │            10. continue to run...            │                                                                                                     
   │                                              │                                                                                                     
   │                                              │                                                                                                     
   └──────────────────────────────────────────────┘                                                                                                     
```
