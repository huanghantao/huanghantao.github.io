---
title: 理解汇编代码和它与高级语言的联系
date: 2017-09-24 14:12:51
tags:
- 汇编语言
- C语言
---

我们知道，现代编程很少有人会去用低级语言来编写代码了。因为写代码的效率很低，而且就算编写出了程序，可以在自己的机器上面跑，也不一定可以在其他的计算机上面跑，也就是说可移植性很差，与特定的机器有关（例如，就算都是x86，每个平台上语法也会不一样）。

而使用高级语言的话，通常情况下，现代的优化编译器产生的代码至少与一个熟练的汇编语言程序员手工编写的代码一样有效。**最大的优点是，用高级语言编写的程序可以在很多不同的机器上编译和执行，而汇编代码则是与特定机器密切相关**。但是这不意味着我们不需要知道汇编语言。我们必须了解典型的编译器在将C程序结构变换成机器代码时所做的转换。相对于C代码表示的计算操作，**优化编译器能够重新排列执行顺序，消除不必要的计算，用快速操作替换慢速操作，甚至将递归计算变换成迭代计算**。

好的，让我们以C语言为例，了解高级语言和汇编的关系：

```c
int accum = 0;

int sum(int x, int y) {
	int t = x + y;
	accum += t;
	return t;
}
```

我们把它命名为`hht.c`，然后使用gcc编译器来编译它，在shell中使用如下命令：

```shell
gcc -o1 -S hht.c
```

其中的`-o1`参数是告诉编译器使用第一个优化（从得到的程序性能方面考虑，第二级 -o2 被认为是较好的选择）。其中的`-S`指定生成汇编代码。之后，我们可以看到一个汇编文件：

![](http://oklbfi1yj.bkt.clouddn.com/%E7%90%86%E8%A7%A3%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E5%92%8C%E5%AE%83%E4%B8%8E%E9%AB%98%E7%BA%A7%E8%AF%AD%E8%A8%80%E7%9A%84%E8%81%94%E7%B3%BB/1.PNG)

我们查看它：

![](http://oklbfi1yj.bkt.clouddn.com/%E7%90%86%E8%A7%A3%E6%B1%87%E7%BC%96%E4%BB%A3%E7%A0%81%E5%92%8C%E5%AE%83%E4%B8%8E%E9%AB%98%E7%BA%A7%E8%AF%AD%E8%A8%80%E7%9A%84%E8%81%94%E7%B3%BB/2.png)

如图所示，大多数GCC生成的汇编代码都有一个字符后缀，其中`pushq`、`movl`等等指令后面以q、l结尾。这些后缀是操作数大小的提示符。例如，数据传送指令有三种变体：movb（传送字节）、movw（传送字）和movl（传送双字，注意，汇编代码使用`l`表示4字节整数和8字节双精度浮点数。这不会产生歧义，因为浮点数使用的是一组完全不同的指令和寄存器）

所有以`.`开头的行都是指导汇编器和链接器的命令。通常可以忽略这些行。

每条汇编代码都对应一条机器指令。比如，`pushq`指令表示将寄存器`%rbq`的内容压入程序栈。这段汇编代码没有所有关于局部变量名或数据类型的信息。我们还看到了一个对全局变量`accum`的引用，这是因为编译器还不能确定这个变量会放在存储器中的哪个位置。

（未完，happy no ending）

