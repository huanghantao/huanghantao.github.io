---
title: PHP内核编译if语句
date: 2020-11-12 15:23:06
tags:
- PHP
- PHP内核
- 编译原理
---

我们有如下脚本：

```php
<?php

$i = 4;

if ($i < 5) {
    echo 1;
} else {
    echo 2;
}
```

对应的`opcode`为：

```bash
L3    #0     ASSIGN                  $i                   4
L5    #1     IS_SMALLER              $i                   5                    ~1
L5    #2     JMPZ                    ~1                   J5
L6    #3     ECHO                    1
L6    #4     JMP                     J6
L8    #5     ECHO                    2
L10   #6     RETURN<-1>              1
```

首先，我们把if语句的组成部分说一下（当然，这是一个没有包含递归的语法，简化版）：

```bison
T_IF '(' cond_expr ')' true_statement T_ELSE false_statement
```

对应：

```bash
T_IF => if
cond_exprs => $i < 5
true_statement => echo 1;
T_ELSE => else
false_statement => echo 2;
```

OK，我们来从编译出来的opcode总结出编译for语句的一般规律：

```bash
   ┌─────────────────────────────────┐   
   │                                 │   
   │                                 │   
   │           cond_exprs            │   
   │                                 │   
   │                                 │   
   └─────────────────────────────────┘   
                    │                    
                    │                    
                    │                    
                    ▼                    
   ┌─────────────────────────────────┐   
   │                                 │   
   │                                 │   
   │              JMPZ               │──┐
   │                                 │  │
   │                                 │  │
   └─────────────────────────────────┘  │
                    │                   │
                    │                   │
                    │                   │
                    ▼                   │
   ┌─────────────────────────────────┐  │
   │                                 │  │
   │                                 │  │
   │         true_statement          │  │
   │                                 │  │
   │                                 │  │
   └─────────────────────────────────┘  │
                    │                   │
                    │                   │
                    │                   │
                    ▼                   │
   ┌─────────────────────────────────┐  │
   │                                 │  │
   │                                 │  │
┌──│               JMP               │  │
│  │                                 │  │
│  │                                 │  │
│  └─────────────────────────────────┘  │
│                   │                   │
│                   │                   │
│                   │                   │
│                   ▼                   │
│  ┌─────────────────────────────────┐  │
│  │                                 │  │
│  │                                 │  │
│  │         false_statement         │◀─┘
│  │                                 │   
│  │                                 │   
│  └─────────────────────────────────┘   
│                   │                    
│                   │                    
│                   │                    
│                   │                    
│                   ▼                    
│  ┌─────────────────────────────────┐   
│  │                                 │   
│  │                                 │   
└─▶│           out_if_stmt           │   
   │                                 │   
   │                                 │   
   └─────────────────────────────────┘   
```
